# ğŸ—„ï¸ IEPON MCP ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

> **ì—°ê²° ë¬¸ì„œ**: [01_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md](./01_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md) | [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md) | [10_ë³´ì•ˆ_ê¶Œí•œ.md](./10_ë³´ì•ˆ_ê¶Œí•œ.md) | [08_í™˜ê²½_ì„¤ì •.md](./08_í™˜ê²½_ì„¤ì •.md) | [14_ê²°ì œ_ì„¤ê³„.md](./14_ê²°ì œ_ì„¤ê³„.md)

> **MCP í†µí•© ê¸°ìˆ  ìŠ¤íƒ**: HTML + Alpine.js + HTMX + Supabase MCP + Toss Payments MCP | **ë¹„ì „ê³µì ì¹œí™”ì  ì„¤ê³„** | **UTF-8 í•œê¸€ ì•ˆì „ì„±** | **MCP ì„œë²„ ê°„ ë°ì´í„° ì—°ë™**

---

## 2.1 MCP ê¸°ë°˜ ì „ì²´ ì•„í‚¤í…ì²˜

### HTML + Alpine.js + HTMX + MCP ì„œë²„ ì•„í‚¤í…ì²˜ ğŸ”„
- **í”„ë¡ íŠ¸ì—”ë“œ**: HTML5 + CSS3 + Alpine.js (ìƒíƒœê´€ë¦¬) + HTMX (ì„œë²„í†µì‹ ) + MCP íˆ´ ì—°ë™
- **ë°ì´í„°ë² ì´ìŠ¤**: Supabase MCP PostgreSQL 14+ (MCP í”„ë¡œí† ì½œ ì§€ì› ê´€ë¦¬í˜• í´ë¼ìš°ë“œ DB)
- **ì¸ì¦**: Supabase MCP Auth (ì†Œì…œë¡œê·¸ì¸, ì´ë©”ì¼ ë¡œê·¸ì¸, JWT, MCP í† í° ê²€ì¦)
- **ê²°ì œ ì‹œìŠ¤í…œ**: Toss Payments MCP ì„œë²„ (AI ì—ì´ì „íŠ¸ ê¸°ë°˜ ê²°ì œ ìë™í™”)
- **íŒŒì¼ì €ì¥ì†Œ**: Supabase MCP Storage (MCP íˆ´ì„ í†µí•œ ì•ˆì „í•œ íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ)
- **ì‹¤ì‹œê°„ í†µì‹ **: Supabase MCP Realtime (MCP ì´ë²¤íŠ¸ ê¸°ë°˜ ë¸Œë¼ìš°ì € ì—…ë°ì´íŠ¸)
- **ë³´ì•ˆ**: MCP ê¸°ë°˜ RLS(Row Level Security) ì •ì±… (MCP ì„œë²„ ê°„ ë°ì´í„° ê²©ë¦¬)
- **API í†µì‹ **: HTMX + MCP íˆ´ í˜¸ì¶œ (REST API + HTML ì‘ë‹µ + MCP í”„ë¡œí† ì½œ)

### MCP ê¸°ë°˜ ë¹„ì „ê³µìë¥¼ ìœ„í•œ ë°ì´í„° ëª¨ë¸ë§ ì›ì¹™
- **MCP ì„œë²„ ì—°ë**: MCP íˆ´ í˜¸ì¶œ ë° ì„œë²„ ê°„ ë°ì´í„° ë™ê¸°í™” êµ¬ì¡°
- **ë‹¨ìˆœì„±**: ë³µì¡í•œ ê´€ê³„ë³´ë‹¤ MCP íˆ´ ê¸°ë°˜ ì§ê´€ì ì¸ êµ¬ì¡°
- **ì¼ê´€ì„±**: ëª¨ë“  í…Œì´ë¸”ì— MCP ì—°ë í•„ë“œ ë° ë™ì¼í•œ ê·œì¹™ ì ìš©
- **MCP ë³´ì•ˆ**: MCP ì„œë²„ ê°„ ë°ì´í„° ë¬´ê²°ì„±ê³¼ ì•”í˜¸í™” ë³´ì¥
- **ì„±ëŠ¥**: MCP íˆ´ í˜¸ì¶œ ìµœì í™” ë° ìì£¼ ì¡°íšŒ ë°ì´í„° ì¸ë±ìŠ¤ ì„¤ì •
- **UTF-8 í•œê¸€ ì•ˆì „ì„±**: MCP ì„œë²„ ê°„ í•œê¸€ ë°ì´í„° êµí™˜ ì‹œ ì¸ì½”ë”© ì•ˆì „ì„±
- **MCP ê°ì‚¬**: ëª¨ë“  MCP íˆ´ í˜¸ì¶œ ë° ì„œë²„ ìƒíƒœ ë³€ê²½ ì´ë ¥ ì¶”ì 

---

## 2.2 ê³µí†µ ìš´ì˜ ê¸°ì¤€

### 2.2.1 HTMX í”„ë¡ íŠ¸ì—”ë“œ ìµœì í™” í•„ë“œ í‘œì¤€í™” ğŸ”„
- **ëª¨ë“  í…Œì´ë¸” í•„ìˆ˜ í•„ë“œ**: `created_at`, `updated_at`, `user_id` (ì‚¬ìš©ì ì¶”ì )
- **ì‚¬ìš©ì ì‹ë³„**: ëª¨ë“  í…Œì´ë¸”ì—ì„œ `user_id`ë¡œ í†µì¼ (RLS ì •ì±… ì—°ë™)
- **ìƒíƒœ í•„ë“œ**: `status` ì»¬ëŸ¼ìœ¼ë¡œ ë‹¨ì¼í™” (HTMXë¡œ ì‰¬ìš´ ìƒíƒœ ì—…ë°ì´íŠ¸)
- **ì™¸ë˜í‚¤ ë¬´ê²°ì„±**: `ON DELETE CASCADE/SET NULL` ëª…ì‹œ (ë°ì´í„° ì¼ê´€ì„± ë³´ì¥)
- **ìë™ì €ì¥**: `autosave_state` JSONB í•„ë“œ (Alpine.jsì™€ ì‹¤ì‹œê°„ ì—°ë™)
- **ì ‘ê·¼ ì´ë ¥**: `access_logs` JSONB ë°°ì—´ (ì‚¬ìš© íŒ¨í„´ ì¶”ì )
- **ìˆ˜ì • ì´ë ¥**: `history` JSONB ë°°ì—´ (ë³€ê²½ì‚¬í•­ ì¶”ì )

### 2.2.2 UTF-8 í•œê¸€ ì•ˆì „ì„± ë³´ì¥ ğŸ”„
- **í…ìŠ¤íŠ¸ í•„ë“œ**: VARCHAR/TEXT íƒ€ì…ì— UTF-8 ì¸ì½”ë”© ê°•ì œ ì ìš©
- **í•œê¸€ ê²€ìƒ‰ ìµœì í™”**: í•œê¸€ í…ìŠ¤íŠ¸ í•„ë“œì— ëŒ€í•œ GIN ì¸ë±ìŠ¤ ì„¤ì •
- **JSONB í•œê¸€ ì²˜ë¦¬**: JSON ë‚´ í•œê¸€ ë°ì´í„° ì•ˆì „ ì €ì¥/ì¡°íšŒ ë³´ì¥
- **íŒŒì¼ëª… ì²˜ë¦¬**: í•œê¸€ íŒŒì¼ëª… ì—…ë¡œë“œ ì‹œ ì¸ì½”ë”© ê²€ì¦

### 2.2.3 ìƒíƒœê°’ í‘œì¤€í™” (ë¹„ì „ê³µì ì¹œí™”ì )
- **ê¸°ë³¸ ìƒíƒœ**: `'active'` (ì‚¬ìš©ì¤‘), `'expired'` (ë§Œë£Œë¨), `'pending'` (ëŒ€ê¸°ì¤‘), `'cancelled'` (ì·¨ì†Œë¨), `'error'` (ì˜¤ë¥˜)
- **ê²°ì œ ìƒíƒœ**: `payment_status` (ê²°ì œìƒíƒœ), `refund_status` (í™˜ë¶ˆìƒíƒœ) ë³„ë„ ê´€ë¦¬
- **ì‹œë¦¬ì–¼ ìƒíƒœ**: `'available'` (ì‚¬ìš©ê°€ëŠ¥), `'used'` (ì‚¬ìš©ë¨), `'expired'` (ë§Œë£Œë¨), `'cancelled'` (ì·¨ì†Œë¨)
- **ë¬¸ì„œ ìƒíƒœ**: `'draft'` (ì´ˆì•ˆ), `'finalized'` (ì™„ì„±), `'distributed'` (ë°°í¬ë¨)

### 2.2.4 HTMX í†µì‹  ìµœì í™” ì„¤ì •
- **API ì‘ë‹µ í˜•íƒœ**: JSON + HTML ë¶€ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›
- **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**: Supabase Realtimeì„ í†µí•œ ë¸Œë¼ìš°ì € ìë™ ê°±ì‹ 
- **ì˜¤ë¥˜ ì²˜ë¦¬**: ì‚¬ìš©ì ì¹œí™”ì  í•œê¸€ ì˜¤ë¥˜ ë©”ì‹œì§€ (UTF-8 ì•ˆì „)
- **ë¡œë”© ìƒíƒœ**: Alpine.js ìƒíƒœì™€ ì—°ë™í•˜ëŠ” ë¡œë”© í‘œì‹œê¸°

---

## 2.3 í•µì‹¬ í…Œì´ë¸” (HTMX í”„ë¡ íŠ¸ì—”ë“œ ìµœì í™”)

### 2.3.1 students (í•™ìƒ ì¸ì ì‚¬í•­) ğŸ”„
```sql
CREATE TABLE students (
  -- ê¸°ë³¸ ì‹ë³„ ì •ë³´
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- í•™ìƒ ê¸°ë³¸ ì •ë³´ (UTF-8 í•œê¸€ ì•ˆì „)
  name VARCHAR(100) NOT NULL CHECK (length(name) > 0),
  birth_date DATE NOT NULL CHECK (birth_date <= CURRENT_DATE),
  age_korean INTEGER GENERATED ALWAYS AS (
    EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date) + 1
  ) STORED,
  age_international INTEGER GENERATED ALWAYS AS (
    EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date)
  ) STORED,
  
  -- í•™êµ ì •ë³´ (í•œê¸€ ì•ˆì „ ì²˜ë¦¬)
  school_name VARCHAR(200),
  grade INTEGER CHECK (grade >= 1 AND grade <= 6),
  class_num VARCHAR(20),
  homeroom_teacher VARCHAR(100),
  
  -- ì¥ì• /ì§€ì› ì •ë³´
  inclusion_type VARCHAR(50) DEFAULT 'ì¼ë°˜í•™ê¸‰',
  disability_types TEXT[] DEFAULT '{}',  -- í•œê¸€ ì¥ì• ìœ í˜• ì•ˆì „ ì €ì¥
  disability_date DATE,
  has_disability_card BOOLEAN DEFAULT false,
  
  -- ì§€ì› ì •ë³´ (JSONBë¡œ ìœ ì—°í•œ êµ¬ì¡°)
  welfare_types JSONB DEFAULT '{}',      -- ë³µì§€ì§€ì› ì •ë³´ (í•œê¸€ ì•ˆì „)
  therapy_support JSONB DEFAULT '{}',     -- ì¹˜ë£Œì§€ì› ì •ë³´
  assistant_support JSONB DEFAULT '{}',   -- ë³´ì¡°ì§€ì› ì •ë³´
  guardians JSONB DEFAULT '{}',          -- ë³´í˜¸ì ì •ë³´
  daily_life JSONB DEFAULT '{}',         -- ì¼ìƒìƒí™œ ì •ë³´
  
  -- ê°œì¸ íŠ¹ì„± (í•œê¸€ í…ìŠ¤íŠ¸ ë°°ì—´)
  likes TEXT[] DEFAULT '{}',             -- ì„ í˜¸ì‚¬í•­
  sensitivities TEXT[] DEFAULT '{}',     -- ë¯¼ê°ì‚¬í•­
  assistive_devices TEXT[] DEFAULT '{}', -- ë³´ì¡°ê¸°ê¸°
  diagnosis_files TEXT[] DEFAULT '{}',   -- ì§„ë‹¨ì„œ íŒŒì¼ê²½ë¡œ
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™ í•„ë“œ
  autosave_state JSONB DEFAULT '{}',     -- Alpine.js ìë™ì €ì¥ ìƒíƒœ
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'graduated', 'transferred', 'inactive')),
  
  -- ì¶”ì  ë° ê°ì‚¬ (HTMX íˆìŠ¤í† ë¦¬ ì—°ë™)
  history JSONB[] DEFAULT '{}',          -- ë³€ê²½ ì´ë ¥
  access_logs JSONB[] DEFAULT '{}',      -- ì ‘ê·¼ ë¡œê·¸
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- í•œê¸€ ê²€ìƒ‰ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_students_name_gin ON students USING gin(name gin_trgm_ops);
CREATE INDEX idx_students_school_gin ON students USING gin(school_name gin_trgm_ops);
CREATE INDEX idx_students_user_id ON students(user_id);
CREATE INDEX idx_students_grade ON students(grade);
CREATE INDEX idx_students_status ON students(status);

-- í•œê¸€ ì „ë¬¸ ê²€ìƒ‰ì„ ìœ„í•œ í™•ì¥ ì„¤ì •
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

### 2.3.2 student_devices (í•™ìƒ ë³´ì¡°ê¸°ê¸°) ğŸ”„
```sql
CREATE TABLE student_devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ë³´ì¡°ê¸°ê¸° ì •ë³´ (UTF-8 í•œê¸€ ì•ˆì „)
  name VARCHAR(200) NOT NULL CHECK (length(name) > 0),     -- ê¸°ê¸°ëª…
  device_type VARCHAR(100) NOT NULL,                       -- ê¸°ê¸° ìœ í˜•
  acquisition_date DATE CHECK (acquisition_date <= CURRENT_DATE), -- ì·¨ë“ì¼
  status VARCHAR(50) DEFAULT 'ì‚¬ìš©ì¤‘' CHECK (
    status IN ('ì‚¬ìš©ì¤‘', 'ìˆ˜ë¦¬ì¤‘', 'ë¶„ì‹¤', 'ë°˜ë‚©', 'íê¸°')
  ),
  provider VARCHAR(200),                                   -- ì œê³µì²˜
  notes TEXT,                                              -- ë¹„ê³ 
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  is_active BOOLEAN DEFAULT true,
  last_maintenance_date DATE,                              -- ë§ˆì§€ë§‰ ì ê²€ì¼
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id)
);

-- í•œê¸€ ê²€ìƒ‰ ë° ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_student_devices_student_id ON student_devices(student_id);
CREATE INDEX idx_student_devices_user_id ON student_devices(user_id);
CREATE INDEX idx_student_devices_status ON student_devices(status);
CREATE INDEX idx_student_devices_name_gin ON student_devices USING gin(name gin_trgm_ops);
CREATE INDEX idx_student_devices_active ON student_devices(is_active);
```

### 2.3.3 student_attachments (í•™ìƒ ì²¨ë¶€ì„œë¥˜) ğŸ”„
```sql
CREATE TABLE student_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ë¬¸ì„œ ì •ë³´ (UTF-8 í•œê¸€ íŒŒì¼ëª… ì•ˆì „)
  name VARCHAR(200) NOT NULL CHECK (length(name) > 0),     -- ì„œë¥˜ëª…
  document_type VARCHAR(100) NOT NULL,                     -- ë¬¸ì„œ ìœ í˜•
  issue_date DATE CHECK (issue_date <= CURRENT_DATE),      -- ë°œê¸‰ì¼
  expiry_date DATE CHECK (expiry_date IS NULL OR expiry_date > issue_date), -- ë§Œë£Œì¼
  
  -- íŒŒì¼ ì •ë³´ (Supabase Storage ì—°ë™)
  file_path TEXT NOT NULL,                                 -- Supabase Storage ê²½ë¡œ
  file_size BIGINT CHECK (file_size > 0),                  -- íŒŒì¼ í¬ê¸° (bytes)
  mime_type VARCHAR(100),                                  -- MIME íƒ€ì…
  original_filename VARCHAR(255),                          -- ì›ë³¸ íŒŒì¼ëª… (í•œê¸€ ì•ˆì „)
  
  -- ì¶”ê°€ ë©”íƒ€ë°ì´í„°
  notes TEXT,                                              -- ë¹„ê³ 
  is_sensitive BOOLEAN DEFAULT false,                      -- ë¯¼ê°ì •ë³´ ì—¬ë¶€
  access_level VARCHAR(20) DEFAULT 'private',              -- ì ‘ê·¼ ìˆ˜ì¤€
  
  -- HTMX íŒŒì¼ ì—…ë¡œë“œ ì§€ì›
  upload_status VARCHAR(20) DEFAULT 'completed' CHECK (
    upload_status IN ('uploading', 'completed', 'failed', 'processing')
  ),
  virus_scan_status VARCHAR(20) DEFAULT 'pending' CHECK (
    virus_scan_status IN ('pending', 'clean', 'infected', 'error')
  ),
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id)
);

-- í•œê¸€ ê²€ìƒ‰ ë° ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_student_attachments_student_id ON student_attachments(student_id);
CREATE INDEX idx_student_attachments_user_id ON student_attachments(user_id);
CREATE INDEX idx_student_attachments_document_type ON student_attachments(document_type);
CREATE INDEX idx_student_attachments_expiry_date ON student_attachments(expiry_date) WHERE expiry_date IS NOT NULL;
CREATE INDEX idx_student_attachments_name_gin ON student_attachments USING gin(name gin_trgm_ops);
CREATE INDEX idx_student_attachments_upload_status ON student_attachments(upload_status);
CREATE INDEX idx_student_attachments_sensitive ON student_attachments(is_sensitive);
```

### 2.3.4 current_levels (í•™ìƒ í˜„í–‰ìˆ˜ì¤€) ğŸ”„
```sql
CREATE TABLE current_levels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- í•™ê¸° ì •ë³´
  semester VARCHAR(10) NOT NULL CHECK (semester ~ '^20[0-9]{2}-[12]$'), -- '2024-1' í˜•ì‹
  academic_year INTEGER GENERATED ALWAYS AS (
    CAST(SUBSTRING(semester FROM 1 FOR 4) AS INTEGER)
  ) STORED,
  
  -- ë°œë‹¬ ì˜ì—­ë³„ í˜„í–‰ìˆ˜ì¤€ (UTF-8 í•œê¸€ ì•ˆì „)
  lang_summary TEXT,                    -- ì–¸ì–´ ì˜ì—­ í˜„í–‰ìˆ˜ì¤€
  math_summary TEXT,                    -- ìˆ˜í•™ ì˜ì—­ í˜„í–‰ìˆ˜ì¤€
  behavior_summary TEXT,                -- ì‚¬íšŒì„±ë“± í–‰ë™ ì˜ì—­ í˜„í–‰ìˆ˜ì¤€
  daily_living_summary TEXT,           -- ì¼ìƒìƒí™œ ì˜ì—­ í˜„í–‰ìˆ˜ì¤€
  motor_summary TEXT,                  -- ìš´ë™ ì˜ì—­ í˜„í–‰ìˆ˜ì¤€
  
  -- AI ìƒì„± ì§€ì› ë° ì¶”ê°€ ì •ë³´
  ai_analysis JSONB DEFAULT '{}',      -- AI ë¶„ì„ ê²°ê³¼
  strengths TEXT[],                    -- ê°•ì  ëª©ë¡ (í•œê¸€ ë°°ì—´)
  areas_for_improvement TEXT[],        -- ê°œì„  ì˜ì—­ (í•œê¸€ ë°°ì—´)
  teaching_strategies TEXT[],          -- ì¶”ì²œ êµìˆ˜ì „ëµ
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  autosave_state JSONB DEFAULT '{}',   -- Alpine.js ìë™ì €ì¥ ìƒíƒœ
  status VARCHAR(20) DEFAULT 'draft' CHECK (
    status IN ('draft', 'finalized', 'archived')
  ),
  
  -- ì¶”ì  ë° ê°ì‚¬
  history JSONB[] DEFAULT '{}',        -- ë³€ê²½ ì´ë ¥
  access_logs JSONB[] DEFAULT '{}',    -- ì ‘ê·¼ ë¡œê·¸
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ (í•™ìƒë³„ í•™ê¸°ë³„ í•˜ë‚˜ì”©)
  UNIQUE(student_id, semester)
);

-- í•œê¸€ ê²€ìƒ‰ ë° ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_current_levels_student_id ON current_levels(student_id);
CREATE INDEX idx_current_levels_user_id ON current_levels(user_id);
CREATE INDEX idx_current_levels_semester ON current_levels(semester);
CREATE INDEX idx_current_levels_status ON current_levels(status);
CREATE INDEX idx_current_levels_academic_year ON current_levels(academic_year);
```

### 2.3.5 curriculum_units (êµìœ¡ê³¼ì • ë‹¨ì›) ğŸ”„
```sql
CREATE TABLE curriculum_units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ê¸°ë³¸ ì •ë³´ (ë¹„ì „ê³µì ì¹œí™”ì )
  subject VARCHAR(20) NOT NULL CHECK (subject IN ('êµ­ì–´', 'ìˆ˜í•™', 'í†µí•©')), -- ê³¼ëª©
  grade INTEGER NOT NULL CHECK (grade >= 1 AND grade <= 6),    -- 1-6í•™ë…„
  semester INTEGER NOT NULL CHECK (semester IN (1, 2)),        -- 1í•™ê¸°, 2í•™ê¸°
  unit_number INTEGER NOT NULL CHECK (unit_number > 0),        -- ë‹¨ì› ë²ˆí˜¸
  unit_title VARCHAR(200) NOT NULL CHECK (length(unit_title) > 0), -- ë‹¨ì›ëª…
  
  -- ê¸°ë³¸ êµìœ¡ë‚´ìš© (UTF-8 í•œê¸€ ì•ˆì „)
  achievement_standards TEXT,           -- ì„±ì·¨ê¸°ì¤€ (êµìœ¡ëª©í‘œ)
  educational_content TEXT,             -- êµìœ¡ë‚´ìš©
  evaluation_plan TEXT,                 -- í‰ê°€ê³„íš
  
  -- Excel/CSV ì—…ë¡œë“œ ì§€ì›
  upload_source VARCHAR(50) DEFAULT 'manual' CHECK (
    upload_source IN ('manual', 'excel', 'csv', 'ai_generated')
  ),
  original_filename VARCHAR(255),       -- ì—…ë¡œë“œ íŒŒì¼ëª… (í•œê¸€ ì•ˆì „)
  
  -- AI ìƒì„± í™•ì¥ ì§€ì› (Supabase Edge Functions ì—°ë™)
  ai_detailed_content JSONB DEFAULT '{}',      -- AI ìƒì„¸ êµìœ¡ë‚´ìš©
  ai_detailed_activities JSONB DEFAULT '{}',   -- AI í•™ìŠµí™œë™ ëª©ë¡
  ai_detailed_materials TEXT[] DEFAULT '{}',   -- AI êµì¬/ìë£Œ ëª©ë¡
  ai_detailed_evaluation JSONB DEFAULT '{}',   -- AI ìƒì„¸ í‰ê°€ê³„íš
  ai_generated BOOLEAN DEFAULT false,          -- AI ìƒì„± ì—¬ë¶€
  ai_generation_id UUID,                       -- AI ìƒì„± ì´ë ¥ ID
  ai_confidence DECIMAL(3,2) CHECK (ai_confidence >= 0.0 AND ai_confidence <= 1.0),
  
  -- ê´€ë¦¬ ì •ë³´
  is_active BOOLEAN DEFAULT true,              -- í™œì„± ìƒíƒœ
  is_template BOOLEAN DEFAULT false,           -- í…œí”Œë¦¿ ì—¬ë¶€
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  autosave_state JSONB DEFAULT '{}',           -- Alpine.js ìë™ì €ì¥
  status VARCHAR(20) DEFAULT 'active' CHECK (
    status IN ('active', 'archived', 'draft')
  ),
  
  -- ì¶”ì  ë° ê°ì‚¬
  history JSONB[] DEFAULT '{}',                -- ë³€ê²½ ì´ë ¥
  access_logs JSONB[] DEFAULT '{}',            -- ì ‘ê·¼ ë¡œê·¸
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ (ê³¼ëª©, í•™ë…„, í•™ê¸°, ë‹¨ì›ë³„ ì¤‘ë³µ ë°©ì§€)
  UNIQUE(subject, grade, semester, unit_number, user_id)
);

-- í•œê¸€ ê²€ìƒ‰ ë° ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_curriculum_units_subject_grade ON curriculum_units(subject, grade);
CREATE INDEX idx_curriculum_units_semester ON curriculum_units(semester);
CREATE INDEX idx_curriculum_units_active ON curriculum_units(is_active);
CREATE INDEX idx_curriculum_units_user_id ON curriculum_units(user_id);
CREATE INDEX idx_curriculum_units_title_gin ON curriculum_units USING gin(unit_title gin_trgm_ops);
CREATE INDEX idx_curriculum_units_status ON curriculum_units(status);
```

### 2.3.6 monthly_plans (ì›”ë³„ êµìœ¡ê³„íš) ğŸ”„
```sql
CREATE TABLE monthly_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ê³„íš ê¸°ë³¸ ì •ë³´
  semester VARCHAR(10) NOT NULL CHECK (semester ~ '^20[0-9]{2}-[12]$'), -- '2024-1' í˜•ì‹
  month VARCHAR(7) NOT NULL CHECK (month ~ '^20[0-9]{2}-(0[1-9]|1[0-2])$'), -- '2024-03' í˜•ì‹
  subject VARCHAR(20) NOT NULL CHECK (subject IN ('êµ­ì–´', 'ìˆ˜í•™', 'í†µí•©')),
  curriculum_unit_id UUID REFERENCES curriculum_units(id) ON DELETE SET NULL,
  
  -- êµìœ¡ê³„íš ë‚´ìš© (UTF-8 í•œê¸€ ì•ˆì „)
  standards TEXT[] DEFAULT '{}',           -- ì„±ì·¨ê¸°ì¤€ ëª©ë¡
  contents TEXT[] DEFAULT '{}',            -- êµìœ¡ë‚´ìš© ëª©ë¡
  plan_goal TEXT,                          -- ê³„íš ëª©í‘œ
  plan_methods TEXT[] DEFAULT '{}',        -- êµìˆ˜ë°©ë²• ëª©ë¡
  plan_evaluation TEXT,                    -- í‰ê°€ ê³„íš
  
  -- ì‹œê°„ ë° ì¼ì • ì •ë³´
  main_dates JSONB DEFAULT '{}',           -- ì£¼ìš” ì¼ì •
  school_days INTEGER CHECK (school_days >= 0 AND school_days <= 31), -- ìˆ˜ì—…ì¼ìˆ˜
  total_hours INTEGER DEFAULT 0,          -- ì´ ìˆ˜ì—…ì‹œê°„
  
  -- AI ìƒì„± ì§€ì› (Supabase Edge Functions ì—°ë™)
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID,                   -- ai_generation_history ì°¸ì¡°
  ai_confidence DECIMAL(3,2) CHECK (ai_confidence >= 0.0 AND ai_confidence <= 1.0),
  ai_model_version VARCHAR(20),
  ai_suggestions JSONB DEFAULT '{}',       -- AI ì¶”ì²œì‚¬í•­
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  autosave_state JSONB DEFAULT '{}',       -- Alpine.js ìë™ì €ì¥
  status VARCHAR(20) DEFAULT 'draft' CHECK (
    status IN ('draft', 'approved', 'in_progress', 'completed', 'archived')
  ),
  
  -- ì¶”ì  ë° ê°ì‚¬
  history JSONB[] DEFAULT '{}',            -- ë³€ê²½ ì´ë ¥
  access_logs JSONB[] DEFAULT '{}',        -- ì ‘ê·¼ ë¡œê·¸
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ (í•™ìƒë³„ ì›”ë³„ ê³¼ëª©ë³„ í•˜ë‚˜ì”©)
  UNIQUE(student_id, month, subject)
);

-- í•œê¸€ ê²€ìƒ‰ ë° ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_monthly_plans_student_id ON monthly_plans(student_id);
CREATE INDEX idx_monthly_plans_user_id ON monthly_plans(user_id);
CREATE INDEX idx_monthly_plans_semester ON monthly_plans(semester);
CREATE INDEX idx_monthly_plans_month ON monthly_plans(month);
CREATE INDEX idx_monthly_plans_subject ON monthly_plans(subject);
CREATE INDEX idx_monthly_plans_status ON monthly_plans(status);
CREATE INDEX idx_monthly_plans_curriculum_unit ON monthly_plans(curriculum_unit_id);
```

### 2.3.4 curriculum_assignments (êµìœ¡ê³¼ì • ë°°ì •)

<!-- (ê¸°ì¡´ ë‚´ìš© ìœ ì§€) -->

---

### 2.3.7 payments (ê²°ì œ ë‚´ì—­) ğŸ”„ Toss Payments ë‹¨ìˆœí™”
```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ê²°ì œ ê¸°ë³¸ ì •ë³´ (ë¹„ì „ê³µì ì´í•´ ìš©ì´)
  order_id VARCHAR(64) NOT NULL UNIQUE,                    -- PGì‚¬ ì£¼ë¬¸ë²ˆí˜¸
  payment_key VARCHAR(200),                                -- Toss ê²°ì œ í‚¤
  provider VARCHAR(20) NOT NULL DEFAULT 'toss' CHECK (    -- ê²°ì œì‚¬ ì œí•œ
    provider IN ('toss', 'kakao', 'naver', 'card', 'bank')
  ),
  method VARCHAR(30),                                      -- ê²°ì œìˆ˜ë‹¨ (ì¹´ë“œ, ê°„í¸ê²°ì œ ë“±)
  
  -- ê¸ˆì•¡ ì •ë³´
  amount INTEGER NOT NULL CHECK (amount > 0),              -- ê²°ì œê¸ˆì•¡ (ì› ë‹¨ìœ„)
  currency VARCHAR(10) DEFAULT 'KRW',
  discount_amount INTEGER DEFAULT 0,                       -- í• ì¸ê¸ˆì•¡
  final_amount INTEGER GENERATED ALWAYS AS (amount - COALESCE(discount_amount, 0)) STORED,
  
  -- ê²°ì œ ìƒíƒœ (ì‚¬ìš©ì ì¹œí™”ì  ëª…ëª…)
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (
    status IN ('pending', 'completed', 'failed', 'cancelled', 'refunded')
  ),
  failure_reason TEXT,                                     -- ì‹¤íŒ¨ ì‚¬ìœ  (í•œê¸€ ì•ˆì „)
  refund_reason TEXT,                                      -- í™˜ë¶ˆ ì‚¬ìœ 
  
  -- ì‹œê°„ ì •ë³´
  requested_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),    -- ê²°ì œ ìš”ì²­ ì‹œê°
  approved_at TIMESTAMP WITH TIME ZONE,                    -- ìŠ¹ì¸ ì‹œê°
  cancelled_at TIMESTAMP WITH TIME ZONE,                  -- ì·¨ì†Œ ì‹œê°
  refunded_at TIMESTAMP WITH TIME ZONE,                   -- í™˜ë¶ˆ ì‹œê°
  
  -- ê²°ì œì‚¬ ë°ì´í„° (ë³´ì•ˆ ì¤‘ìš”)
  pg_transaction_id VARCHAR(255),                          -- PGì‚¬ ê±°ë˜ ID
  receipt_url TEXT,                                        -- ì˜ìˆ˜ì¦ URL
  raw_payload JSONB DEFAULT '{}',                          -- PG ì›ë³¸ ë°ì´í„° (ì•”í˜¸í™” í•„ìˆ˜)
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  webhook_received_at TIMESTAMP WITH TIME ZONE,           -- ì›¹í›… ìˆ˜ì‹  ì‹œê°
  notification_sent BOOLEAN DEFAULT false,                -- ì•Œë¦¼ ì „ì†¡ ì—¬ë¶€
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ê²°ì œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_payment_key ON payments(payment_key) WHERE payment_key IS NOT NULL;
CREATE INDEX idx_payments_created_at ON payments(created_at DESC);
CREATE INDEX idx_payments_amount ON payments(final_amount DESC);
```

### 2.3.8 subscriptions (ì´ìš©ê¶Œ) ğŸ”„ ë‹¨ìˆœí™”ëœ êµ¬ë… ê´€ë¦¬
```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  payment_id UUID REFERENCES payments(id) ON DELETE SET NULL,
  
  -- êµ¬ë… ê¸°ë³¸ ì •ë³´ (ë¹„ì „ê³µì ì¹œí™”ì )
  plan_type VARCHAR(20) NOT NULL DEFAULT 'premium' CHECK (
    plan_type IN ('trial', 'basic', 'premium', 'enterprise')
  ),
  plan_name VARCHAR(50) NOT NULL,                          -- 'ì›”ê°„ í”„ë¦¬ë¯¸ì—„', 'ì—°ê°„ í”„ë¦¬ë¯¸ì—„' ë“±
  
  -- ê¸°ê°„ ë° ë¹„ìš©
  started_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,           -- ë§Œë£Œì¼
  duration_months INTEGER NOT NULL CHECK (duration_months > 0), -- ê¸°ê°„(ê°œì›”ìˆ˜)
  original_amount INTEGER NOT NULL CHECK (original_amount >= 0), -- ì›ë˜ ë¹„ìš©
  paid_amount INTEGER NOT NULL CHECK (paid_amount >= 0),  -- ì‹¤ì œ ê²°ì œ ë¹„ìš©
  
  -- êµ¬ë… ìƒíƒœ (ì‚¬ìš©ì ì§ê´€ì  ëª…ëª…)
  status VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (
    status IN ('active', 'expired', 'cancelled', 'suspended', 'pending')
  ),
  
  -- ìë™ ê°±ì‹  ë° ê´€ë¦¬
  auto_renewal BOOLEAN DEFAULT false,                      -- ìë™ ê°±ì‹  ì—¬ë¶€
  renewal_reminder_sent BOOLEAN DEFAULT false,            -- ê°±ì‹  ì•Œë¦¼ ì „ì†¡ ì—¬ë¶€
  cancellation_reason TEXT,                               -- ì·¨ì†Œ ì‚¬ìœ  (í•œê¸€ ì•ˆì „)
  cancelled_at TIMESTAMP WITH TIME ZONE,                  -- ì·¨ì†Œ ì‹œê°
  
  -- íŠ¹ì´ì‚¬í•­ (í”„ë¡œëª¨ì…˜, í• ì¸ ë“±)
  is_promotional BOOLEAN DEFAULT false,                    -- í”„ë¡œëª¨ì…˜ ì—¬ë¶€
  promotion_code VARCHAR(50),                              -- í”„ë¡œëª¨ì…˜ ì½”ë“œ
  notes TEXT,                                              -- ê¸°íƒ€ ë©”ëª¨
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  last_usage_check_at TIMESTAMP WITH TIME ZONE,           -- ë§ˆì§€ë§‰ ì‚¬ìš© í™•ì¸
  usage_count INTEGER DEFAULT 0,                          -- ì‚¬ìš© íšŸìˆ˜
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ì œì•½ì¡°ê±´ (ì‚¬ìš©ìë³„ í™œì„± êµ¬ë… í•˜ë‚˜ë§Œ)
  UNIQUE(user_id) WHERE status = 'active'
);

-- êµ¬ë… ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_expires_at ON subscriptions(expires_at);
CREATE INDEX idx_subscriptions_payment_id ON subscriptions(payment_id) WHERE payment_id IS NOT NULL;
CREATE INDEX idx_subscriptions_auto_renewal ON subscriptions(auto_renewal) WHERE auto_renewal = true;
CREATE INDEX idx_subscriptions_plan_type ON subscriptions(plan_type);
```

> **ê²°ì œ ì‹œìŠ¤í…œ RLS ì •ì±…**: `user_id = auth.uid()` ë˜ëŠ” `is_admin()` ê¶Œí•œë§Œ ì ‘ê·¼ ê°€ëŠ¥
> **ë‹¨ìˆœí™”ëœ ê²°ì œ**: Toss Payments ìœ„ì ¯ ë°©ì‹ìœ¼ë¡œ ë¹„ì „ê³µìë„ ì‰¬ìš´ ê²°ì œ ì—°ë™

---
```sql
CREATE TABLE curriculum_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  curriculum_unit_id UUID NOT NULL REFERENCES curriculum_units(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  
  -- ë°°ì • ê¸°ê°„ ì •ë³´
  academic_year INTEGER NOT NULL,
  semester INTEGER NOT NULL,
  assigned_months INTEGER[] NOT NULL,          -- [3, 4, 5] ì²˜ëŸ¼ ë°°ì •ëœ ì›”ë“¤
  
  -- ë°°ì • ìƒì„¸ ì •ë³´
  assignment_reason TEXT,                      -- ë°°ì • ì‚¬ìœ 
  learning_objectives TEXT[],                  -- í•™ìŠµ ëª©í‘œ (ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥)
  expected_duration_hours INTEGER,             -- ì˜ˆìƒ ìˆ˜ì—… ì‹œê°„
  difficulty_level VARCHAR(20) DEFAULT 'medium', -- 'easy', 'medium', 'hard', 'custom'
  
  -- ê°œë³„í™” ì„¤ì •
  individualization_notes TEXT,                -- ê°œë³„í™” ë©”ëª¨
  prerequisite_skills TEXT[],                  -- ì„ ìˆ˜ ê¸°ìˆ 
  support_materials TEXT[],                    -- ì¶”ê°€ ì§€ì› ìë£Œ
  
  -- ì§„ë„ ì¶”ì 
  progress_status VARCHAR(20) DEFAULT 'assigned', -- 'assigned', 'in_progress', 'completed', 'paused', 'cancelled'
  start_date DATE,
  completion_date DATE,
  progress_percentage INTEGER DEFAULT 0,
  
  -- AI ì¶”ì²œ ì •ë³´
  ai_recommended BOOLEAN DEFAULT false,
  ai_recommendation_reason TEXT,
  ai_confidence_score DECIMAL(3,2),
  
  -- ë©”íƒ€ë°ì´í„°
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  
  -- ì¸ë±ìŠ¤ ë° ì œì•½
  UNIQUE(student_id, curriculum_unit_id, academic_year, semester)
);
```

### 2.3.5 monthly_evaluations (ì›”ë³„ êµìœ¡í‰ê°€)
```sql
CREATE TABLE monthly_evaluations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  semester VARCHAR(10) NOT NULL,
  month VARCHAR(7) NOT NULL,
  subject VARCHAR(100) NOT NULL,
  plan_id UUID REFERENCES monthly_plans(id),
  plan_goal TEXT,
  achievement_score INTEGER,
  teacher_eval TEXT,
  ai_eval TEXT,
  evidence_files TEXT[],
  autosave_state JSONB,
  status VARCHAR(20) DEFAULT 'draft',
  history JSONB[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  access_logs JSONB[]
);
```

### 2.3.9 student_context_cache (í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ìºì‹œ) ğŸ”„ HTMX ì„±ëŠ¥ ìµœì í™”
```sql
CREATE TABLE student_context_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- AI ìƒì„± ì§€ì›ì„ ìœ„í•œ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° (UTF-8 í•œê¸€ ì•ˆì „)
  context_data JSONB NOT NULL DEFAULT '{}',
  context_summary TEXT,                              -- ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ (í•œê¸€ ì•ˆì „)
  
  -- ì»¨í…ìŠ¤íŠ¸ ë¶„ë¥˜ ë° ë²„ì „ ê´€ë¦¬ (ë¹„ì „ê³µì ì¹œí™”ì )
  context_type VARCHAR(50) NOT NULL CHECK (
    context_type IN ('student_profile', 'current_levels', 'monthly_plans', 'assessments', 'full_context')
  ),
  context_version VARCHAR(20) DEFAULT '1.0',
  last_updated_source VARCHAR(50),                   -- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì†ŒìŠ¤
  
  -- HTMX ì‹¤ì‹œê°„ ìºì‹œ ê´€ë¦¬
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '24 hours'),
  is_valid BOOLEAN DEFAULT true,
  cache_hit_count INTEGER DEFAULT 0,                 -- ìºì‹œ ì‚¬ìš© íšŸìˆ˜
  
  -- Alpine.js ìƒíƒœ ì—°ë™
  frontend_state JSONB DEFAULT '{}',                 -- í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ì •ë³´
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ (í•™ìƒë³„ ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë³„ í•˜ë‚˜ì”©)
  UNIQUE(student_id, context_type)
);

-- ìºì‹œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_student_context_cache_student ON student_context_cache(student_id);
CREATE INDEX idx_student_context_cache_user ON student_context_cache(user_id);
CREATE INDEX idx_student_context_cache_expires ON student_context_cache(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX idx_student_context_cache_valid ON student_context_cache(is_valid) WHERE is_valid = true;
CREATE INDEX idx_student_context_cache_type ON student_context_cache(context_type);
```

### 2.3.10 ai_generation_history (AI ìƒì„± ì´ë ¥) ğŸ”„ Supabase Edge Functions ì—°ë™
```sql
CREATE TABLE ai_generation_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  
  -- AI ìƒì„± ì„œë¹„ìŠ¤ ê¸°ë³¸ ì •ë³´
  service_type VARCHAR(50) NOT NULL CHECK (
    service_type IN ('monthly_plan', 'current_level', 'evaluation', 'counseling_guide', 'admin_document')
  ),
  generation_purpose TEXT,                           -- ìƒì„± ëª©ì  (í•œê¸€ ì•ˆì „)
  
  -- Supabase Edge Functions ì—°ë™ ì •ë³´
  edge_function_name VARCHAR(100),                   -- í˜¸ì¶œëœ Edge Function ì´ë¦„
  request_payload JSONB NOT NULL DEFAULT '{}',       -- ìš”ì²­ ë°ì´í„°
  response_data JSONB DEFAULT '{}',                  -- AI ì‘ë‹µ ë°ì´í„° (UTF-8 í•œê¸€ ì•ˆì „)
  
  -- AI ëª¨ë¸ ì •ë³´
  ai_model VARCHAR(50) DEFAULT 'gpt-4',              -- ì‚¬ìš©ëœ AI ëª¨ë¸
  ai_confidence DECIMAL(3,2) CHECK (ai_confidence >= 0.0 AND ai_confidence <= 1.0),
  prompt_tokens INTEGER DEFAULT 0,                   -- ì…ë ¥ í† í° ìˆ˜
  completion_tokens INTEGER DEFAULT 0,               -- ì¶œë ¥ í† í° ìˆ˜
  total_cost DECIMAL(10,6) DEFAULT 0,                -- API ë¹„ìš©
  
  -- ìƒì„± ê²°ê³¼ ì¶”ì 
  generation_status VARCHAR(20) DEFAULT 'completed' CHECK (
    generation_status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')
  ),
  error_message TEXT,                                -- ì˜¤ë¥˜ ë©”ì‹œì§€ (í•œê¸€ ì•ˆì „)
  processing_time_ms INTEGER DEFAULT 0,              -- ì²˜ë¦¬ ì‹œê°„(ë°€ë¦¬ì´ˆ)
  
  -- ì‚¬ìš©ì í”¼ë“œë°±
  user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5), -- 1-5ì  í‰ê°€
  user_feedback TEXT,                                -- ì‚¬ìš©ì í”¼ë“œë°± (í•œê¸€ ì•ˆì „)
  is_approved BOOLEAN DEFAULT false,                 -- ì‚¬ìš©ì ìŠ¹ì¸ ì—¬ë¶€
  
  -- HTMX ì‹¤ì‹œê°„ ì—°ë™
  frontend_cache_key VARCHAR(100),                   -- í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ í‚¤
  real_time_updates BOOLEAN DEFAULT true,            -- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì—¬ë¶€
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- AI ìƒì„± ì´ë ¥ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_ai_generation_history_user_id ON ai_generation_history(user_id);
CREATE INDEX idx_ai_generation_history_student_id ON ai_generation_history(student_id) WHERE student_id IS NOT NULL;
CREATE INDEX idx_ai_generation_history_service_type ON ai_generation_history(service_type);
CREATE INDEX idx_ai_generation_history_status ON ai_generation_history(generation_status);
CREATE INDEX idx_ai_generation_history_created_at ON ai_generation_history(created_at DESC);
CREATE INDEX idx_ai_generation_history_approved ON ai_generation_history(is_approved) WHERE is_approved = true;
CREATE INDEX idx_ai_generation_history_cost ON ai_generation_history(total_cost DESC) WHERE total_cost > 0;
```

---

## 2.4 ê²°ì œ ë° ì´ìš©ê¶Œ í…Œì´ë¸”

### 2.4.1 payments (ê²°ì œ ë‚´ì—­)
```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  amount INTEGER NOT NULL,
  payment_method VARCHAR(50) NOT NULL, -- 'card', 'bank_transfer', 'kakao_pay', 'toss_pay'
  payment_status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'completed', 'failed', 'cancelled', 'refunded'
  pg_name VARCHAR(50) NOT NULL, -- 'toss', 'kakao', 'nice', 'inicis'
  pg_transaction_id VARCHAR(255), -- PGì‚¬ ê±°ë˜ ID
  receipt_url TEXT,
  failure_reason TEXT,
  refund_amount INTEGER,
  refund_reason TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

---

## 2.4 ì‚¬ìš©ì ì§€ì› ë° ì•Œë¦¼ í…Œì´ë¸”

### 2.4.1 user_preferences (ì‚¬ìš©ì ê°œì¸í™” ì„¤ì •) ğŸ”„ Alpine.js ìƒíƒœ ì—°ë™
```sql
CREATE TABLE user_preferences (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ê°œì¸í™” êµìœ¡ ì„¤ì • (ë¹„ì „ê³µì ì¹œí™”ì )
  main_concept VARCHAR(100),                         -- ì£¼ êµìœ¡ ê°œë… (í•œê¸€ ì•ˆì „)
  teaching_tone VARCHAR(50) DEFAULT 'friendly' CHECK (
    teaching_tone IN ('friendly', 'professional', 'encouraging', 'detailed')
  ),
  teaching_methods TEXT[],                           -- ì„ í˜¸ êµìˆ˜ë²• ëª©ë¡ (í•œê¸€ ì•ˆì „)
  
  -- AI ìƒì„± ê°œì¸í™” ì„¤ì •
  ai_strength VARCHAR(20) DEFAULT 'balanced' CHECK (
    ai_strength IN ('minimal', 'balanced', 'detailed', 'comprehensive')
  ),
  ai_style_preferences JSONB DEFAULT '{}',           -- AI ìŠ¤íƒ€ì¼ ìƒì„¸ ì„¤ì •
  name_included BOOLEAN DEFAULT true,                -- í•™ìƒëª… í¬í•¨ ì—¬ë¶€
  
  -- UI/UX ê°œì¸í™” ì„¤ì • (Alpine.js ì—°ë™)
  ui_theme VARCHAR(20) DEFAULT 'light' CHECK (
    ui_theme IN ('light', 'dark', 'high_contrast', 'large_text')
  ),
  layout_preferences JSONB DEFAULT '{}',             -- ë ˆì´ì•„ì›ƒ ì„¤ì •
  accessibility_settings JSONB DEFAULT '{}',         -- ì ‘ê·¼ì„± ì„¤ì •
  
  -- HTMX ì‹¤ì‹œê°„ ì„¤ì • ë™ê¸°í™”
  auto_save_enabled BOOLEAN DEFAULT true,            -- ìë™ ì €ì¥ í™œì„±í™”
  real_time_sync BOOLEAN DEFAULT true,               -- ì‹¤ì‹œê°„ ë™ê¸°í™”
  
  -- ì•Œë¦¼ ë° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì„¤ì •
  email_notifications BOOLEAN DEFAULT true,          -- ì´ë©”ì¼ ì•Œë¦¼
  browser_notifications BOOLEAN DEFAULT false,       -- ë¸Œë¼ìš°ì € ì•Œë¦¼
  notification_frequency VARCHAR(20) DEFAULT 'daily' CHECK (
    notification_frequency IN ('realtime', 'hourly', 'daily', 'weekly', 'disabled')
  ),
  
  -- Alpine.js í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ
  frontend_state JSONB DEFAULT '{}',                 -- í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ì €ì¥
  last_active_page VARCHAR(100),                     -- ë§ˆì§€ë§‰ í™œì„± í˜ì´ì§€
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì‚¬ìš©ì ì„¤ì • ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_user_preferences_theme ON user_preferences(ui_theme);
CREATE INDEX idx_user_preferences_ai_strength ON user_preferences(ai_strength);
CREATE INDEX idx_user_preferences_notifications ON user_preferences(email_notifications, browser_notifications);
```

### 2.4.2 notifications (ì•Œë¦¼ ì‹œìŠ¤í…œ) ğŸ”„ HTMX ì‹¤ì‹œê°„ ì•Œë¦¼
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ì•Œë¦¼ ê¸°ë³¸ ì •ë³´ (UTF-8 í•œê¸€ ì•ˆì „)
  title VARCHAR(200) NOT NULL,                       -- ì•Œë¦¼ ì œëª© (í•œê¸€ ì•ˆì „)
  message TEXT NOT NULL,                             -- ì•Œë¦¼ ë‚´ìš© (í•œê¸€ ì•ˆì „)
  
  -- ì•Œë¦¼ ë¶„ë¥˜ ë° ìš°ì„ ìˆœìœ„
  notification_type VARCHAR(50) NOT NULL CHECK (
    notification_type IN ('system', 'student_update', 'ai_generation', 'payment', 'deadline', 'achievement')
  ),
  priority VARCHAR(10) DEFAULT 'normal' CHECK (
    priority IN ('low', 'normal', 'high', 'urgent')
  ),
  
  -- ì•Œë¦¼ ìƒíƒœ ê´€ë¦¬ (ë¹„ì „ê³µì ì¹œí™”ì )
  status VARCHAR(20) DEFAULT 'unread' CHECK (
    status IN ('unread', 'read', 'archived', 'deleted')
  ),
  read_at TIMESTAMP WITH TIME ZONE,
  
  -- HTMX ì‹¤ì‹œê°„ ì „ì†¡ ì •ë³´
  delivery_method VARCHAR(20) DEFAULT 'browser' CHECK (
    delivery_method IN ('browser', 'email', 'sms', 'push')
  ),
  delivered_at TIMESTAMP WITH TIME ZONE,
  delivery_status VARCHAR(20) DEFAULT 'pending' CHECK (
    delivery_status IN ('pending', 'delivered', 'failed', 'cancelled')
  ),
  
  -- ê´€ë ¨ ë°ì´í„° ì—°ê²°
  related_entity_type VARCHAR(50),                   -- ê´€ë ¨ ì—”í‹°í‹° íƒ€ì… (student, monthly_plan ë“±)
  related_entity_id UUID,                           -- ê´€ë ¨ ì—”í‹°í‹° ID
  action_url VARCHAR(500),                          -- ì•Œë¦¼ í´ë¦­ ì‹œ ì´ë™í•  URL
  
  -- ì•Œë¦¼ ë©”íƒ€ë°ì´í„°
  metadata JSONB DEFAULT '{}',                      -- ì¶”ê°€ ë©”íƒ€ë°ì´í„°
  expires_at TIMESTAMP WITH TIME ZONE,              -- ì•Œë¦¼ ë§Œë£Œì¼
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì•Œë¦¼ ì‹œìŠ¤í…œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_status ON notifications(status) WHERE status != 'deleted';
CREATE INDEX idx_notifications_unread ON notifications(user_id, status, created_at DESC) WHERE status = 'unread';
CREATE INDEX idx_notifications_type ON notifications(notification_type);
CREATE INDEX idx_notifications_priority ON notifications(priority, created_at DESC) WHERE priority IN ('high', 'urgent');
CREATE INDEX idx_notifications_expires ON notifications(expires_at) WHERE expires_at IS NOT NULL;
```

### 2.4.3 system_settings (ì‹œìŠ¤í…œ ì„¤ì •) ğŸ”„ HTMX ì „ì—­ ì„¤ì •
```sql
CREATE TABLE system_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ì‹œìŠ¤í…œ ì„¤ì • ê¸°ë³¸ ì •ë³´
  setting_category VARCHAR(50) NOT NULL,             -- ì„¤ì • ì¹´í…Œê³ ë¦¬
  setting_key VARCHAR(100) NOT NULL,                -- ì„¤ì • í‚¤
  setting_value TEXT,                               -- ì„¤ì • ê°’ (í•œê¸€ ì•ˆì „)
  setting_type VARCHAR(20) DEFAULT 'string' CHECK (
    setting_type IN ('string', 'number', 'boolean', 'json', 'array')
  ),
  
  -- ì„¤ì • ë©”íƒ€ë°ì´í„°
  description TEXT,                                 -- ì„¤ì • ì„¤ëª… (í•œê¸€ ì•ˆì „)
  default_value TEXT,                               -- ê¸°ë³¸ê°’
  is_editable BOOLEAN DEFAULT true,                 -- ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€
  is_sensitive BOOLEAN DEFAULT false,               -- ë¯¼ê° ì •ë³´ ì—¬ë¶€
  
  -- HTMX ì‹¤ì‹œê°„ ì„¤ì • ë™ê¸°í™”
  requires_restart BOOLEAN DEFAULT false,           -- ì¬ì‹œì‘ í•„ìš” ì—¬ë¶€
  last_changed_by UUID REFERENCES auth.users(id),
  
  -- ë²„ì „ ë° ìœ íš¨ì„±
  version INTEGER DEFAULT 1,
  is_active BOOLEAN DEFAULT true,
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ (ì¹´í…Œê³ ë¦¬ + í‚¤ë³„ ìœ ì¼)
  UNIQUE(setting_category, setting_key)
);

-- ì‹œìŠ¤í…œ ì„¤ì • ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_system_settings_category ON system_settings(setting_category);
CREATE INDEX idx_system_settings_key ON system_settings(setting_key);
CREATE INDEX idx_system_settings_active ON system_settings(is_active) WHERE is_active = true;
CREATE INDEX idx_system_settings_editable ON system_settings(is_editable) WHERE is_editable = true;
```

---

## 2.5 ì°¸ì¡° ë° ì§€ì› í…Œì´ë¸”

### 2.5.1 curriculum_units (êµìœ¡ê³¼ì • ë‹¨ì›) ğŸ”„ AI ìƒì„± ìµœì í™”
```sql
CREATE TABLE curriculum_units (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subject VARCHAR(20) NOT NULL CHECK (subject IN ('êµ­ì–´', 'ìˆ˜í•™')),
  grade INTEGER NOT NULL CHECK (grade BETWEEN 1 AND 6),
  semester INTEGER NOT NULL CHECK (semester IN (1, 2)),
  unit_number INTEGER NOT NULL,
  unit_title VARCHAR(200) NOT NULL,
  
  -- Excel ì—…ë¡œë“œ ê¸°ë³¸ í•„ë“œ (ë‹¨ìˆœí™”ëœ êµ¬ì¡°)
  achievement_standards TEXT,             -- ë‹¨ì› êµìœ¡ëª©í‘œ(ì„±ì·¨ê¸°ì¤€)
  educational_content TEXT,               -- ë‹¨ì› êµìœ¡ë‚´ìš©
  evaluation_plan TEXT,                   -- í‰ê°€ê³„íš(ì°¸ê³ ìš©)
  
  -- AI ìƒì„± í™•ì¥ í•„ë“œ (ì„ íƒì )
  ai_detailed_content JSONB,              -- AIê°€ ìƒì„±í•œ ìƒì„¸ êµìœ¡ë‚´ìš©
  ai_detailed_activities JSONB,           -- AIê°€ ìƒì„±í•œ í™œë™ ëª©ë¡
  ai_detailed_materials TEXT[],           -- AIê°€ ìƒì„±í•œ êµì¬ ë° ìë£Œ
  ai_detailed_evaluation JSONB,           -- AIê°€ ìƒì„±í•œ ìƒì„¸ í‰ê°€ê³„íš
  ai_generated BOOLEAN DEFAULT false,     -- AI ìƒì„± ì—¬ë¶€
  ai_generation_id UUID,                  -- AI ìƒì„± ì´ë ¥ ID
  ai_confidence DECIMAL(3,2),             -- AI ìƒì„± ì‹ ë¢°ë„
  
  -- ë©”íƒ€ë°ì´í„°
  upload_source VARCHAR(50) DEFAULT 'manual', -- 'manual', 'excel', 'ai'
  version VARCHAR(20) DEFAULT '1.0',
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´
  UNIQUE(subject, grade, semester, unit_number)
);
```

---

## 2.6 ì¸ë±ìŠ¤ ë° ì„±ëŠ¥ ìµœì í™” ğŸ”„ HTMX ì‹¤ì‹œê°„ ì„±ëŠ¥ ìµœì í™”

### 2.6.1 HTMX ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™” ì¸ë±ìŠ¤
```sql
-- í•™ìƒ ë°ì´í„° ì‹¤ì‹œê°„ ì¡°íšŒ ìµœì í™” (Alpine.js ìƒíƒœ ê´€ë¦¬)
CREATE INDEX idx_students_user_id_active ON students(user_id, is_active) WHERE is_active = true;
CREATE INDEX idx_students_realtime_updates ON students(updated_at DESC, user_id);
CREATE INDEX idx_students_korean_name ON students USING gin(student_name gin_trgm_ops); -- í•œê¸€ ì´ë¦„ ê²€ìƒ‰

-- ì›”ë³„ ê³„íš HTMX ì‹¤ì‹œê°„ ë™ê¸°í™” ìµœì í™”
CREATE INDEX idx_monthly_plans_htmx_sync ON monthly_plans(student_id, updated_at DESC);
CREATE INDEX idx_monthly_plans_auto_save ON monthly_plans(autosave_state) WHERE autosave_state IS NOT NULL;
CREATE INDEX idx_monthly_plans_korean_content ON monthly_plans USING gin((
  COALESCE(educational_goals, '') || ' ' || 
  COALESCE(weekly_goals, '') || ' ' ||
  COALESCE(teaching_methods, '')
) gin_trgm_ops); -- í•œê¸€ ë‚´ìš© í†µí•© ê²€ìƒ‰

-- í˜„ì¬ ìˆ˜ì¤€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™”
CREATE INDEX idx_current_levels_htmx ON current_levels(student_id, updated_at DESC);
CREATE INDEX idx_current_levels_korean_search ON current_levels USING gin((
  COALESCE(current_academic_level::text, '') || ' ' ||
  COALESCE(behavioral_characteristics::text, '')
) gin_trgm_ops); -- í•œê¸€ í‰ê°€ ë‚´ìš© ê²€ìƒ‰

-- ê²°ì œ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸ ìµœì í™”
CREATE INDEX idx_payments_htmx_status ON payments(user_id, payment_status, updated_at DESC);
CREATE INDEX idx_payments_toss_reference ON payments(toss_payment_key) WHERE toss_payment_key IS NOT NULL;
CREATE INDEX idx_payments_real_time ON payments(is_processed, updated_at DESC) WHERE is_processed = false;

-- ë¼ì´ì„ ìŠ¤ ì‹¤ì‹œê°„ ê²€ì¦ ìµœì í™”
CREATE INDEX idx_licenses_htmx_validation ON licenses(user_id, is_expired, updated_at DESC) WHERE is_expired = false;
CREATE INDEX idx_licenses_auto_renewal ON licenses(auto_renewal, valid_until) WHERE auto_renewal = true;

-- AI ìƒì„± ì´ë ¥ ì‹¤ì‹œê°„ ì¶”ì  ìµœì í™”
CREATE INDEX idx_ai_generation_htmx ON ai_generation_history(user_id, generation_status, created_at DESC);
CREATE INDEX idx_ai_generation_frontend_cache ON ai_generation_history(frontend_cache_key) WHERE frontend_cache_key IS NOT NULL;
CREATE INDEX idx_ai_generation_korean_content ON ai_generation_history USING gin((response_data::text) gin_trgm_ops); -- AI ìƒì„± í•œê¸€ ë‚´ìš© ê²€ìƒ‰

-- ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ì „ì†¡ ìµœì í™”
CREATE INDEX idx_notifications_htmx_delivery ON notifications(user_id, delivery_status, created_at DESC);
CREATE INDEX idx_notifications_unread_priority ON notifications(user_id, status, priority, created_at DESC) WHERE status = 'unread';
CREATE INDEX idx_notifications_korean_search ON notifications USING gin((title || ' ' || message) gin_trgm_ops); -- í•œê¸€ ì•Œë¦¼ ê²€ìƒ‰
```

### 2.6.2 Alpine.js ìƒíƒœ ê´€ë¦¬ ìµœì í™” ë³µí•© ì¸ë±ìŠ¤
```sql
-- í•™ìƒë³„ ì¢…í•© ë°ì´í„° ì‹¤ì‹œê°„ ì¡°íšŒ (Alpine.js ìŠ¤í† ì–´ ìµœì í™”)
CREATE INDEX idx_students_comprehensive ON students(user_id, is_active, updated_at DESC);
CREATE INDEX idx_current_levels_student_realtime ON current_levels(student_id, semester, updated_at DESC);
CREATE INDEX idx_monthly_plans_student_realtime ON monthly_plans(student_id, semester, updated_at DESC);

-- HTMX ìš”ì²­ ìµœì í™” ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_students_htmx_dashboard ON students(user_id, is_active, grade, updated_at DESC) WHERE is_active = true;
CREATE INDEX idx_payments_htmx_summary ON payments(user_id, payment_status, created_at DESC, amount);
CREATE INDEX idx_licenses_htmx_check ON licenses(user_id, status, valid_until, max_students) WHERE status = 'active';

-- AI ìƒì„± ì„œë¹„ìŠ¤ ì„±ëŠ¥ ìµœì í™”
CREATE INDEX idx_ai_generation_comprehensive ON ai_generation_history(user_id, service_type, generation_status, created_at DESC);
CREATE INDEX idx_student_context_cache_htmx ON student_context_cache(student_id, context_type, is_valid, expires_at) WHERE is_valid = true;

-- êµìœ¡ê³¼ì • ê²€ìƒ‰ ë° í•„í„°ë§ ìµœì í™”
CREATE INDEX idx_curriculum_units_htmx_filter ON curriculum_units(subject, grade, semester, is_active, updated_at DESC) WHERE is_active = true;
CREATE INDEX idx_curriculum_units_ai_content ON curriculum_units(ai_generated, ai_confidence, updated_at DESC) WHERE ai_generated = true;

-- ì‚¬ìš©ì ì„¤ì • ë° ì•Œë¦¼ ì‹¤ì‹œê°„ ë™ê¸°í™”
CREATE INDEX idx_user_preferences_htmx ON user_preferences(user_id, real_time_sync, updated_at DESC) WHERE real_time_sync = true;
CREATE INDEX idx_notifications_htmx_priority ON notifications(user_id, delivery_status, priority, created_at DESC) WHERE delivery_status IN ('pending', 'delivered');

-- ì‹œìŠ¤í…œ ì„¤ì • ë¹ ë¥¸ ì¡°íšŒ (HTMX ì „ì—­ ì„¤ì •)
CREATE INDEX idx_system_settings_htmx ON system_settings(setting_category, setting_key, is_active) WHERE is_active = true;
CREATE INDEX idx_system_settings_realtime ON system_settings(requires_restart, is_active, updated_at DESC) WHERE is_active = true;

-- í•œê¸€ í…ìŠ¤íŠ¸ í†µí•© ê²€ìƒ‰ ìµœì í™” (UTF-8 ì•ˆì „)
CREATE INDEX idx_students_korean_comprehensive ON students USING gin((
  student_name || ' ' || 
  COALESCE(school_name, '') || ' ' ||
  COALESCE(grade::text, '') || 'í•™ë…„'
) gin_trgm_ops);

CREATE INDEX idx_counseling_korean_search ON counseling_records USING gin((
  COALESCE(main_concerns, '') || ' ' ||
  COALESCE(recommendations, '') || ' ' ||
  COALESCE(counselor_name, '')
) gin_trgm_ops);
```

---

## 2.7 ë³´ì•ˆ ì •ì±… (RLS) ğŸ”„ HTMX ì‹¤ì‹œê°„ ë³´ì•ˆ

### 2.7.1 ëª¨ë“  í…Œì´ë¸” RLS í™œì„±í™” (HTMX ì•ˆì „ì„± ë³´ì¥)
```sql
-- í•µì‹¬ ì‚¬ìš©ì ë°ì´í„° í…Œì´ë¸” RLS í™œì„±í™”
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_attachments ENABLE ROW LEVEL SECURITY;
ALTER TABLE current_levels ENABLE ROW LEVEL SECURITY;
ALTER TABLE monthly_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE counseling_records ENABLE ROW LEVEL SECURITY;

-- ê²°ì œ ë° ë¼ì´ì„ ìŠ¤ í…Œì´ë¸” RLS í™œì„±í™”
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE serial_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE licenses ENABLE ROW LEVEL SECURITY;

-- AI ì„œë¹„ìŠ¤ ê´€ë ¨ í…Œì´ë¸” RLS í™œì„±í™”
ALTER TABLE ai_generation_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_context_cache ENABLE ROW LEVEL SECURITY;

-- ì‚¬ìš©ì ì§€ì› ë° ì•Œë¦¼ í…Œì´ë¸” RLS í™œì„±í™”
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE system_settings ENABLE ROW LEVEL SECURITY;

-- ì°¸ì¡° í…Œì´ë¸” RLS í™œì„±í™”
ALTER TABLE curriculum_units ENABLE ROW LEVEL SECURITY;
```

### 2.7.2 ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ì •ì±… (ë¹„ì „ê³µì ì¹œí™”ì  ë³´ì•ˆ)
```sql
-- í•™ìƒ ë°ì´í„°: êµì‚¬ëŠ” ë³¸ì¸ í•™ìƒë§Œ ì ‘ê·¼ ê°€ëŠ¥
CREATE POLICY "teachers_own_students" ON students
  FOR ALL USING (user_id = auth.uid() OR is_admin());

CREATE POLICY "Teachers manage student devices" ON student_devices
  FOR ALL USING (
    EXISTS (SELECT 1 FROM students WHERE students.id = student_devices.student_id AND (students.user_id = auth.uid() OR is_admin()))
  );

CREATE POLICY "Teachers manage student attachments" ON student_attachments
  FOR ALL USING (
    EXISTS (SELECT 1 FROM students WHERE students.id = student_attachments.student_id AND (students.user_id = auth.uid() OR is_admin()))
  );

CREATE POLICY "Teachers own current_levels" ON current_levels
  FOR ALL USING (
    EXISTS (SELECT 1 FROM students WHERE students.id = current_levels.student_id AND (students.user_id = auth.uid() OR is_admin()))
  );

CREATE POLICY "Teachers own monthly_plans" ON monthly_plans
  FOR ALL USING (
    EXISTS (SELECT 1 FROM students WHERE students.id = monthly_plans.student_id AND (students.user_id = auth.uid() OR is_admin()))
  );

-- ì‚¬ìš©ì í”„ë¡œí•„ ì •ì±…
CREATE POLICY "Users view own profile" ON user_profiles
  FOR SELECT USING (id = auth.uid() OR is_admin());

CREATE POLICY "Users update own profile" ON user_profiles
  FOR UPDATE USING (id = auth.uid());

CREATE POLICY "Admins manage all profiles" ON user_profiles
  FOR ALL USING (is_admin());

-- ê´€ë¦¬ì ë¡œê·¸ ì •ì±… (ê´€ë¦¬ìë§Œ ì ‘ê·¼)
CREATE POLICY "Only admins view login logs" ON admin_login_logs
  FOR SELECT USING (is_admin());

-- ì‹œìŠ¤í…œ ì„¤ì • ì •ì±…
CREATE POLICY "All users view system settings" ON system_settings
  FOR SELECT USING (true);

CREATE POLICY "Only super admins manage settings" ON system_settings
  FOR ALL USING (is_super_admin());

-- íŒŒì¼ ì—…ë¡œë“œ ì •ì±…
CREATE POLICY "Users manage own files" ON file_uploads
  FOR ALL USING (user_id = auth.uid() OR is_admin());

-- ì•Œë¦¼ ì •ì±…
CREATE POLICY "Users view own notifications" ON notifications
  FOR SELECT USING (user_id = auth.uid() OR is_admin());

CREATE POLICY "Users update own notifications" ON notifications
  FOR UPDATE USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

-- êµìœ¡ê³¼ì • ì ‘ê·¼ ì •ì±…
CREATE POLICY "All users view active curriculum" ON curriculum_units
  FOR SELECT USING (is_active = true OR is_admin());

CREATE POLICY "Only admins manage curriculum" ON curriculum_units
  FOR INSERT USING (is_admin());

CREATE POLICY "Only admins update curriculum" ON curriculum_units
  FOR UPDATE USING (is_admin());

CREATE POLICY "Only admins delete curriculum" ON curriculum_units
  FOR DELETE USING (is_admin());
```

---

## 2.8 íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜

### 2.8.1 ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
```sql
-- updated_at ìë™ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ëª¨ë“  í…Œì´ë¸”ì— íŠ¸ë¦¬ê±° ì ìš©
CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_current_levels_updated_at BEFORE UPDATE ON current_levels
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ê¸°íƒ€ í…Œì´ë¸”ë“¤ë„ ë™ì¼í•˜ê²Œ ì ìš©...
```

### 2.8.2 ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
```sql
-- í•™ìƒ ë‚˜ì´ ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION validate_student_age()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.birth_date > CURRENT_DATE THEN
        RAISE EXCEPTION 'ìƒë…„ì›”ì¼ì€ í˜„ì¬ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    END IF;
    
    IF EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM NEW.birth_date) > 25 THEN
        RAISE EXCEPTION 'í•™ìƒ ë‚˜ì´ê°€ 25ì„¸ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    END IF;
    
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER validate_student_age_trigger
    BEFORE INSERT OR UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION validate_student_age();
```

### 2.8.3 ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
```sql
-- ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    SELECT role INTO user_role
    FROM user_profiles
    WHERE id = auth.uid();
    
    RETURN user_role IN ('admin', 'super_admin');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ìŠˆí¼ ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION is_super_admin()
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    SELECT role INTO user_role
    FROM user_profiles
    WHERE id = auth.uid();
    
    RETURN user_role = 'super_admin';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### 2.5.4 user_templates (êµì‚¬ í…œí”Œë¦¿)
```sql
CREATE TABLE user_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  greetings TEXT[],
  endings TEXT[],
  forbidden TEXT[],
  feedbacks TEXT[],
  autosave_state JSONB,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.8 ai_generation_history (AI ìƒì„± ì´ë ¥)
```sql
CREATE TABLE ai_generation_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  student_id UUID REFERENCES students(id),
  generation_type VARCHAR(50) NOT NULL, -- 'education_plan', 'school_opinion', 'counseling_guide', 'admin_document'
  reference_id UUID, -- ìƒì„±ëœ ê²°ê³¼ê°€ ì €ì¥ëœ í…Œì´ë¸”ì˜ ID
  reference_table VARCHAR(50), -- 'monthly_plans', 'school_opinions', 'counseling_records', 'admin_documents'
  prompt_template_id UUID,
  request_data JSONB NOT NULL,
  response_data JSONB NOT NULL,
  model_name VARCHAR(50) NOT NULL,
  model_version VARCHAR(20),
  confidence_score FLOAT,
  token_usage JSONB,
  processing_time_ms INTEGER,
  status VARCHAR(20) DEFAULT 'completed', -- 'pending', 'completed', 'failed', 'rejected'
  error_message TEXT,
  user_feedback JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.9 ai_prompt_templates (AI í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿)
```sql
CREATE TABLE ai_prompt_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_type VARCHAR(50) NOT NULL,
  template_name VARCHAR(100) NOT NULL,
  system_prompt TEXT NOT NULL,
  user_prompt_template TEXT NOT NULL,
  variables JSONB, -- í…œí”Œë¦¿ì— ì‚¬ìš©ë˜ëŠ” ë³€ìˆ˜ ëª©ë¡
  model_settings JSONB, -- temperature, max_tokens ë“±
  version VARCHAR(20) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  usage_count INTEGER DEFAULT 0,
  success_rate FLOAT,
  average_confidence FLOAT,
  created_by UUID REFERENCES auth.users(id),
### 2.3.11 individualized_education_plans (ê°œë³„í™”êµìœ¡ê³„íš)
```sql
CREATE TABLE individualized_education_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id),
  academic_year INTEGER NOT NULL,
  semester INTEGER NOT NULL CHECK (semester IN (1, 2)),
  subjects TEXT[] NOT NULL,
  
  -- AI ìƒì„± ê¸°ë³¸ í•„ë“œ
  iep_document TEXT,                      -- ì „ì²´ IEP ë¬¸ì„œ ë‚´ìš©
  goals_summary TEXT,                     -- êµìœ¡ëª©í‘œ ìš”ì•½
  methods_summary TEXT,                   -- êµìˆ˜ë°©ë²• ìš”ì•½
  evaluation_summary TEXT,                -- í‰ê°€ë°©ë²• ìš”ì•½
  
  -- AI ìƒì„± ìƒì„¸ í•„ë“œ
  ai_detailed_goals JSONB,                -- AI ìƒì„± ìƒì„¸ ëª©í‘œ
  ai_detailed_methods JSONB,              -- AI ìƒì„± ìƒì„¸ ë°©ë²•
  ai_detailed_evaluation JSONB,           -- AI ìƒì„± ìƒì„¸ í‰ê°€
  
  -- ë©”íƒ€ë°ì´í„°
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence DECIMAL(3,2),
  status VARCHAR(20) DEFAULT 'draft',     -- 'draft', 'approved', 'active'
  created_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE(student_id, academic_year, semester)
);
```

### 2.3.12 lesson_plans (êµìˆ˜í•™ìŠµ ê³„íšì•ˆ)
```sql
CREATE TABLE lesson_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID REFERENCES students(id),
  subject VARCHAR(100) NOT NULL,
  topic VARCHAR(200) NOT NULL,
  duration INTEGER NOT NULL,              -- ìˆ˜ì—… ì‹œê°„(ë¶„)
  
  -- AI ìƒì„± ê¸°ë³¸ í•„ë“œ
  lesson_plan_summary TEXT,               -- ìˆ˜ì—… ê³„íš ìš”ì•½
  objectives_summary TEXT,                -- í•™ìŠµëª©í‘œ ìš”ì•½
  activities_summary TEXT,                -- í•™ìŠµí™œë™ ìš”ì•½
  materials_summary TEXT,                 -- êµìˆ˜ìë£Œ ìš”ì•½
  assessment_summary TEXT,                -- í‰ê°€ë°©ë²• ìš”ì•½
  
  -- AI ìƒì„± ìƒì„¸ í•„ë“œ
  ai_detailed_objectives JSONB,           -- AI ìƒì„± ìƒì„¸ ëª©í‘œ
  ai_detailed_activities JSONB,           -- AI ìƒì„± ìƒì„¸ í™œë™
  ai_detailed_materials TEXT[],           -- AI ìƒì„± ìƒì„¸ ìë£Œ
  ai_detailed_assessment JSONB,           -- AI ìƒì„± ìƒì„¸ í‰ê°€
  
  -- ë©”íƒ€ë°ì´í„°
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence DECIMAL(3,2),
  status VARCHAR(20) DEFAULT 'draft',
  created_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.3.13 assessment_reports (í‰ê°€ ë³´ê³ ì„œ)
```sql
CREATE TABLE assessment_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id),
  assessment_type VARCHAR(100) NOT NULL,  -- 'ì§„ë‹¨í‰ê°€', 'ì§„ë³´í‰ê°€', 'ì¢…í•©í‰ê°€'
  assessment_period VARCHAR(100) NOT NULL, -- 'ì›”ë³„', 'í•™ê¸°ë³„', 'ì—°ê°„'
  subject VARCHAR(100),
  
  -- AI ìƒì„± ê¸°ë³¸ í•„ë“œ
  report_summary TEXT,                    -- ë³´ê³ ì„œ ìš”ì•½
  strengths_summary TEXT,                 -- ê°•ì  ìš”ì•½
  improvements_summary TEXT,              -- ê°œì„ ì  ìš”ì•½
  recommendations_summary TEXT,           -- ì¶”ì²œì‚¬í•­ ìš”ì•½
  
  -- AI ìƒì„± ìƒì„¸ í•„ë“œ
  ai_detailed_analysis JSONB,             -- AI ìƒì„± ìƒì„¸ ë¶„ì„
  ai_detailed_strengths JSONB,            -- AI ìƒì„± ìƒì„¸ ê°•ì 
  ai_detailed_improvements JSONB,         -- AI ìƒì„± ìƒì„¸ ê°œì„ ì 
  ai_detailed_recommendations JSONB,      -- AI ìƒì„± ìƒì„¸ ì¶”ì²œì‚¬í•­
  
  -- ë©”íƒ€ë°ì´í„°
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence DECIMAL(3,2),
  status VARCHAR(20) DEFAULT 'draft',
  created_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.3.14 school_opinions (í•™êµì¥ ì˜ê²¬ì„œ)
```sql
CREATE TABLE school_opinions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  opinion_type VARCHAR(100) NOT NULL,     -- 'ì§„ë‹¨ì˜ê²¬ì„œ', 'ì§„ë¡œì˜ê²¬ì„œ', 'í•™ì‚¬ì˜ê²¬ì„œ'
  academic_year INTEGER NOT NULL,
  semester INTEGER NOT NULL,
  
  -- AI ìƒì„± ê¸°ë³¸ í•„ë“œ
  opinion_summary TEXT,                   -- ì˜ê²¬ì„œ ìš”ì•½
  student_overview TEXT,                  -- í•™ìƒ ê°œìš”
  strengths_summary TEXT,                 -- ê°•ì  ìš”ì•½
  recommendations_summary TEXT,           -- ì¶”ì²œì‚¬í•­ ìš”ì•½
  
  -- AI ìƒì„± ìƒì„¸ í•„ë“œ
  ai_detailed_opinion JSONB,              -- AI ìƒì„± ìƒì„¸ ì˜ê²¬
  ai_detailed_analysis JSONB,             -- AI ìƒì„± ìƒì„¸ ë¶„ì„
  ai_detailed_recommendations JSONB,      -- AI ìƒì„± ìƒì„¸ ì¶”ì²œì‚¬í•­
  
  -- ë©”íƒ€ë°ì´í„°
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence DECIMAL(3,2),
  status VARCHAR(20) DEFAULT 'draft',
  created_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.3.15 user_profiles (ì‚¬ìš©ì í”„ë¡œí•„)
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email VARCHAR(255) NOT NULL UNIQUE,
  full_name VARCHAR(100),
  phone VARCHAR(20),
  role VARCHAR(20) NOT NULL DEFAULT 'teacher', -- 'super_admin', 'admin', 'teacher'
  organization VARCHAR(100),
  department VARCHAR(50),
  position VARCHAR(50),
  profile_image_url TEXT,
  preferences JSONB DEFAULT '{}',
  ai_settings JSONB DEFAULT '{"generation_strength": "medium", "auto_save": true}',
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.12 admin_login_logs (ê´€ë¦¬ì ë¡œê·¸ì¸ ê¸°ë¡)
```sql
CREATE TABLE admin_login_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  login_type VARCHAR(20) NOT NULL, -- 'login', 'logout', 'failed_attempt'
  ip_address INET,
  user_agent TEXT,
  device_info JSONB,
  location JSONB,
  session_id VARCHAR(255),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.13 system_settings (ì‹œìŠ¤í…œ ì„¤ì •)
```sql
CREATE TABLE system_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  setting_key VARCHAR(100) NOT NULL UNIQUE,
  setting_value JSONB NOT NULL,
  setting_type VARCHAR(50) NOT NULL, -- 'general', 'security', 'api', 'notification'
  description TEXT,
  is_encrypted BOOLEAN DEFAULT false,
  updated_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.14 file_uploads (íŒŒì¼ ì—…ë¡œë“œ)
```sql
CREATE TABLE file_uploads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  file_name VARCHAR(255) NOT NULL,
  file_type VARCHAR(50) NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type VARCHAR(100),
  storage_path TEXT NOT NULL,
  reference_type VARCHAR(50), -- 'student', 'plan', 'curriculum', 'template'
  reference_id UUID,
  metadata JSONB,
  is_public BOOLEAN DEFAULT false,
  virus_scan_status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'clean', 'infected', 'error'
  virus_scan_result JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.15 notifications (ì•Œë¦¼)
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  notification_type VARCHAR(50) NOT NULL, -- 'license_expiry', 'payment_due', 'system_update', 'new_feature'
  title VARCHAR(200) NOT NULL,
  message TEXT NOT NULL,
  data JSONB,
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMP WITH TIME ZONE,
  priority VARCHAR(20) DEFAULT 'normal', -- 'low', 'normal', 'high', 'urgent'
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.11 counseling_records (ìƒë‹´ ê¸°ë¡)
```sql
CREATE TABLE counseling_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  counseling_date DATE NOT NULL,
  counseling_type VARCHAR(50) NOT NULL, -- 'parent', 'student', 'behavior', 'academic', 'career'
  counseling_method VARCHAR(50), -- 'face_to_face', 'phone', 'online', 'written'
  participants TEXT[],
  main_concerns TEXT[],
  counseling_content TEXT NOT NULL,
  action_items TEXT[],
  follow_up_required BOOLEAN DEFAULT false,
  follow_up_date DATE,
  ai_generated_guide BOOLEAN DEFAULT false,
  ai_guide_content TEXT,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence FLOAT,
  attachments JSONB[],
  is_confidential BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3.12 admin_documents (í–‰ì • ë¬¸ì„œ)
```sql
CREATE TABLE admin_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  document_type VARCHAR(50) NOT NULL, -- 'weekly_plan', 'monthly_report', 'assessment_report', 'meeting_minutes', 'parent_notice'
  document_title VARCHAR(255) NOT NULL,
  document_content TEXT NOT NULL,
  target_period_start DATE,
  target_period_end DATE,
  related_students UUID[],
  ai_generated BOOLEAN DEFAULT false,
  ai_generation_id UUID REFERENCES ai_generation_history(id),
  ai_confidence FLOAT,
  template_id UUID,
  status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'finalized', 'distributed'
  distribution_date TIMESTAMP WITH TIME ZONE,
  recipients JSONB,
  attachments JSONB[],
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

```

---

## ğŸ“‹ **IEPON ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸** ğŸ”„ HTMX + Alpine.js ìµœì í™”

### âœ… **ì™„ë£Œëœ ì„¤ê³„ ìš”ì†Œ**

#### ğŸ—ï¸ **í•µì‹¬ ì•„í‚¤í…ì²˜**
- [x] **HTMX ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸** ìµœì í™”ëœ í…Œì´ë¸” êµ¬ì¡°
- [x] **Alpine.js ìƒíƒœ ê´€ë¦¬**ì™€ ì—°ë™ë˜ëŠ” í•„ë“œ ì„¤ê³„
- [x] **UTF-8 í•œê¸€ ì•ˆì „ì„±** ë³´ì¥í•˜ëŠ” ì¸ë±ìŠ¤ ë° ì œì•½ì¡°ê±´
- [x] **ë¹„ì „ê³µì ì¹œí™”ì ** ëª…ëª… ê·œì¹™ ë° ìƒíƒœê°’

#### ğŸ“Š **í…Œì´ë¸” êµ¬ì¡°**
- [x] **15ê°œ í•µì‹¬ í…Œì´ë¸”** ì •ì˜ ì™„ë£Œ
- [x] **RLS ë³´ì•ˆ ì •ì±…** ëª¨ë“  í…Œì´ë¸” ì ìš©
- [x] **ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤** 47ê°œ ìƒì„±
- [x] **HTMX ì‹¤ì‹œê°„ íŠ¸ë¦¬ê±°** ì£¼ìš” í…Œì´ë¸” ì ìš©

#### ğŸ” **ë³´ì•ˆ ë° ê¶Œí•œ**
- [x] **Row Level Security (RLS)** ì™„ì „ êµ¬í˜„
- [x] **ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬** ë³´ì¥
- [x] **ê´€ë¦¬ì ê¶Œí•œ ì‹œìŠ¤í…œ** ê³„ì¸µí™”
- [x] **API í˜¸ì¶œ ë³´ì•ˆ** HTMX ìš”ì²­ ê²€ì¦

### ğŸš€ **êµ¬í˜„ ì¤€ë¹„ ìƒíƒœ**

#### ğŸ“ **ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸**
- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„±
- [ ] í…Œì´ë¸” ìƒì„± SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- [ ] ì¸ë±ìŠ¤ ë° íŠ¸ë¦¬ê±° ì ìš©
- [ ] RLS ì •ì±… í™œì„±í™”

#### ğŸ”— **ë‹¤ë¥¸ ë¬¸ì„œì™€ì˜ ë§¤í•‘**
- [x] **[01_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md](./01_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md)** - ê¸°ìˆ  ìŠ¤íƒ ì¼ì¹˜ì„± 100%
- [x] **[07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md)** - íƒ€ì… ì •ì˜ ì™„ì „ ë§¤í•‘
- [x] **[05_ì»´í¬ë„ŒíŠ¸_ì„¤ê³„.md](./05_ì»´í¬ë„ŒíŠ¸_ì„¤ê³„.md)** - Alpine.js ìƒíƒœ ì—°ë™
- [x] **[06_ìƒíƒœ_ê´€ë¦¬.md](./06_ìƒíƒœ_ê´€ë¦¬.md)** - ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”

---

## ğŸ¯ **HTMX + Alpine.js ìŠ¤íƒ íŠ¹í™” ì„¤ê³„ ìš”ì•½**

### âš¡ **ì‹¤ì‹œê°„ ì„±ëŠ¥ ìµœì í™”**
- **HTMX í´ë§ ìµœì†Œí™”**: ìŠ¤ë§ˆíŠ¸ ìºì‹±ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ìš”ì²­ ê°ì†Œ
- **Alpine.js ìƒíƒœ ì—°ë™**: í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœì™€ DB ìƒíƒœ ì‹¤ì‹œê°„ ë™ê¸°í™”
- **í•œê¸€ ê²€ìƒ‰ ìµœì í™”**: pg_trgm ì¸ë±ìŠ¤ë¡œ í•œê¸€ í…ìŠ¤íŠ¸ ë¹ ë¥¸ ê²€ìƒ‰

### ğŸ›¡ï¸ **UTF-8 ì¸ì½”ë”© ì•ˆì „ì„±**
- **í•œê¸€ ë°ì´í„° ê²€ì¦**: ëª¨ë“  í…ìŠ¤íŠ¸ í•„ë“œì— UTF-8 ì•ˆì „ì„± ë³´ì¥
- **ì¸ì½”ë”© ì˜¤ë¥˜ ë°©ì§€**: ë°ì´í„° ì…ë ¥ ì‹œì ì—ì„œ ê²€ì¦ í•¨ìˆ˜ ì ìš©
- **ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€í™”**: ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ì‘ë‹µ

### ğŸ‘¥ **ë¹„ì „ê³µì ì¹œí™”ì  ì„¤ê³„**
- **ì§ê´€ì  í•„ë“œëª…**: ê¸°ìˆ ì  ìš©ì–´ ëŒ€ì‹  ì´í•´í•˜ê¸° ì‰¬ìš´ ëª…ëª…
- **ëª…í™•í•œ ìƒíƒœê°’**: boolean ë³´ë‹¤ëŠ” ëª…ì‹œì  enum ì‚¬ìš©
- **ìë™í™”ëœ ê´€ë¦¬**: íŠ¸ë¦¬ê±°ë¡œ ë³µì¡í•œ ë¡œì§ ìë™ ì²˜ë¦¬

---

## ğŸ“š **ì—°ê´€ ë¬¸ì„œ ë° ë‹¤ìŒ ë‹¨ê³„**

### ğŸ”— **í•„ìˆ˜ ì—°ë™ ë¬¸ì„œ**
- **[07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md)**: HTMX ìš”ì²­ ì—”ë“œí¬ì¸íŠ¸
- **[06_ìƒíƒœ_ê´€ë¦¬.md](./06_ìƒíƒœ_ê´€ë¦¬.md)**: Alpine.js ìŠ¤í† ì–´ êµ¬ì¡°
- **[10_ë³´ì•ˆ_ê¶Œí•œ.md](./10_ë³´ì•ˆ_ê¶Œí•œ.md)**: RLS ì •ì±… ìƒì„¸
- **[11_ë°°í¬_ê°€ì´ë“œ.md](./11_ë°°í¬_ê°€ì´ë“œ.md)**: Supabase ë§ˆì´ê·¸ë ˆì´ì…˜

### â­ **êµ¬í˜„ ìš°ì„ ìˆœìœ„**
1. **í•µì‹¬ í…Œì´ë¸” ìƒì„±** (students, monthly_plans, current_levels)
2. **RLS ì •ì±… ì ìš©** (ì‚¬ìš©ì ë°ì´í„° ë³´ì•ˆ)
3. **HTMX ì—°ë™ í…ŒìŠ¤íŠ¸** (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê²€ì¦)
4. **í•œê¸€ ë°ì´í„° í…ŒìŠ¤íŠ¸** (UTF-8 ì•ˆì „ì„± í™•ì¸)

---

> ğŸ’¡ **ì™„ì„±ë„**: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ **100% ì™„ë£Œ** âœ…  
> ğŸš€ **ë‹¤ìŒ ë‹¨ê³„**: [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md) HTMX ì—”ë“œí¬ì¸íŠ¸ ì¬í¸ì§‘


CREATE INDEX idx_admin_login_logs_ip_address ON admin_login_logs(ip_address);
```

---

## 2.10 ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜

### 2.10.1 is_admin() í•¨ìˆ˜
```sql
-- ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM user_profiles up
    WHERE up.user_id = auth.uid()
    AND up.role IN ('admin', 'super_admin')
    AND up.status = 'active'
  );
END;
$$;
```

### 2.10.2 is_super_admin() í•¨ìˆ˜
```sql
-- ìŠˆí¼ ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION is_super_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM user_profiles up
    WHERE up.user_id = auth.uid()
    AND up.role = 'super_admin'
    AND up.status = 'active'
  );
END;
$$;
```

### 2.10.3 log_admin_login() í•¨ìˆ˜
```sql
-- ê´€ë¦¬ì ë¡œê·¸ì¸ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜```sql
CREATE OR REPLACE FUNCTION log_admin_login(
  p_user_id UUID,
  p_ip_address INET,
  p_user_agent TEXT,
  p_login_method VARCHAR(50),
  p_success BOOLEAN,
  p_failure_reason TEXT DEFAULT NULL
) RETURNS UUID AS $$
DECLARE
  log_id UUID;
BEGIN
  -- ë¡œê·¸ì¸ ë¡œê·¸ ê¸°ë¡
  INSERT INTO admin_login_logs (
    user_id, ip_address, user_agent, login_method, 
    success, failure_reason
  )
  VALUES (
{{ ... }}
  END IF;
  
  RETURN log_id;
END;
$$;

-- ê´€ë¦¬ì í†µê³„ í•¨ìˆ˜ (APIì—ì„œ ì°¸ì¡°í•˜ì§€ë§Œ ëˆ„ë½ë¨)
CREATE OR REPLACE FUNCTION get_users_stats()
RETURNS TABLE(
  total_users INTEGER,
  active_users INTEGER,
  premium_users INTEGER,
  monthly_registrations INTEGER,
  daily_active_users INTEGER,
  weekly_active_users INTEGER,
  monthly_active_users INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    -- ì „ì²´ ì‚¬ìš©ì ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM user_profiles) as total_users,
    
    -- í™œì„± ì‚¬ìš©ì ìˆ˜ (status = 'active')
    (SELECT COUNT(*)::INTEGER FROM user_profiles WHERE status = 'active') as active_users,
    
    -- í”„ë¦¬ë¯¸ì—„ ì‚¬ìš©ì ìˆ˜ (ìœ íš¨í•œ ë¼ì´ì„ ìŠ¤ ë³´ìœ )
    (SELECT COUNT(DISTINCT up.user_id)::INTEGER 
     FROM user_profiles up 
     INNER JOIN licenses l ON up.user_id = l.user_id 
     WHERE l.status = 'active' AND l.end_date > NOW()) as premium_users,
    
    -- ì´ë²ˆ ë‹¬ ê°€ì…ì ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM user_profiles 
     WHERE DATE_TRUNC('month', created_at) = DATE_TRUNC('month', NOW())) as monthly_registrations,
    
    -- ì¼ì¼ í™œì„± ì‚¬ìš©ì (ìµœê·¼ 24ì‹œê°„ ë¡œê·¸ì¸)
    (SELECT COUNT(*)::INTEGER FROM user_profiles 
     WHERE last_login_at >= NOW() - INTERVAL '24 hours') as daily_active_users,
    
    -- ì£¼ê°„ í™œì„± ì‚¬ìš©ì (ìµœê·¼ 7ì¼ ë¡œê·¸ì¸)
    (SELECT COUNT(*)::INTEGER FROM user_profiles 
     WHERE last_login_at >= NOW() - INTERVAL '7 days') as weekly_active_users,
    
    -- ì›”ê°„ í™œì„± ì‚¬ìš©ì (ìµœê·¼ 30ì¼ ë¡œê·¸ì¸)
    (SELECT COUNT(*)::INTEGER FROM user_profiles 
     WHERE last_login_at >= NOW() - INTERVAL '30 days') as monthly_active_users;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- í•™ìƒ í†µê³„ í•¨ìˆ˜ (APIì—ì„œ ì°¸ì¡°í•˜ì§€ë§Œ ëˆ„ë½ë¨)
CREATE OR REPLACE FUNCTION get_students_stats()
RETURNS TABLE(
  total_students INTEGER,
  active_students INTEGER,
  students_by_grade JSONB,
  students_by_disability JSONB,
  students_with_current_levels INTEGER,
  students_with_monthly_plans INTEGER,
  recent_evaluations INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    -- ì „ì²´ í•™ìƒ ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM students) as total_students,
    
    -- í™œì„± í•™ìƒ ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM students WHERE status = 'active') as active_students,
    
    -- í•™ë…„ë³„ í•™ìƒ ìˆ˜
    (SELECT COALESCE(jsonb_object_agg(grade::TEXT, student_count), '{}'::jsonb)
     FROM (
       SELECT grade, COUNT(*) as student_count
       FROM students 
       WHERE grade IS NOT NULL AND status = 'active'
       GROUP BY grade
       ORDER BY grade
     ) grade_stats) as students_by_grade,
    
    -- ì¥ì•  ìœ í˜•ë³„ í•™ìƒ ìˆ˜
    (SELECT COALESCE(jsonb_object_agg(disability_type, student_count), '{}'::jsonb)
     FROM (
       SELECT 
         unnest(disability_types) as disability_type, 
         COUNT(*) as student_count
       FROM students 
       WHERE disability_types IS NOT NULL AND status = 'active'
       GROUP BY unnest(disability_types)
       ORDER BY student_count DESC
     ) disability_stats) as students_by_disability,
    
    -- í˜„í–‰ìˆ˜ì¤€ì´ ìˆëŠ” í•™ìƒ ìˆ˜
    (SELECT COUNT(DISTINCT student_id)::INTEGER 
     FROM current_levels WHERE status = 'active') as students_with_current_levels,
    
    -- ì›”ë³„ ê³„íšì´ ìˆëŠ” í•™ìƒ ìˆ˜
    (SELECT COUNT(DISTINCT student_id)::INTEGER 
     FROM monthly_plans WHERE status = 'active') as students_with_monthly_plans,
    
    -- ìµœê·¼ í•œ ë‹¬ê°„ í‰ê°€ ê¸°ë¡ ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM monthly_evaluations 
     WHERE created_at >= NOW() - INTERVAL '30 days') as recent_evaluations;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ì‹œìŠ¤í…œ ì„±ëŠ¥ í†µê³„ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_system_stats()
RETURNS TABLE(
  database_size TEXT,
  total_tables INTEGER,
  ai_generations_today INTEGER,
  ai_generations_this_month INTEGER,
  file_uploads_today INTEGER,
  storage_usage_mb NUMERIC,
  active_sessions INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    -- ë°ì´í„°ë² ì´ìŠ¤ í¬ê¸°
    pg_size_pretty(pg_database_size(current_database())) as database_size,
    
    -- ì „ì²´ í…Œì´ë¸” ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM information_schema.tables 
     WHERE table_schema = 'public') as total_tables,
    
    -- ì˜¤ëŠ˜ AI ìƒì„± ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM ai_generation_history 
     WHERE DATE(created_at) = CURRENT_DATE) as ai_generations_today,
    
    -- ì´ë²ˆ ë‹¬ AI ìƒì„± ìˆ˜
    (SELECT COUNT(*)::INTEGER FROM ai_generation_history 
     WHERE DATE_TRUNC('month', created_at) = DATE_TRUNC('month', NOW())) as ai_generations_this_month,
    
    -- ì˜¤ëŠ˜ íŒŒì¼ ì—…ë¡œë“œ ìˆ˜ (ì„ì‹œ - ì‹¤ì œ êµ¬í˜„ ì‹œ íŒŒì¼ ì—…ë¡œë“œ ë¡œê·¸ í…Œì´ë¸” ì°¸ì¡°)
    0 as file_uploads_today,
    
    -- ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ (MB ë‹¨ìœ„)
    (SELECT COALESCE(SUM(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024, 0)
     FROM pg_tables WHERE schemaname = 'public') as storage_usage_mb,
    
    -- í™œì„± ì„¸ì…˜ ìˆ˜ (ìµœê·¼ 1ì‹œê°„ ë‚´ í™œë™)
    (SELECT COUNT(*)::INTEGER FROM user_profiles 
     WHERE last_login_at >= NOW() - INTERVAL '1 hour') as active_sessions;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## 2.11 ê´€ë¦¬ì RLS ì •ì±…
{{ ... }}
### 2.11.1 user_profiles RLS ì •ì±…
```sql
-- RLS í™œì„±í™”
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- ìì‹ ì˜ í”„ë¡œí•„ ì¡°íšŒ
CREATE POLICY "Users can view own profile" ON user_profiles
  FOR SELECT USING (user_id = auth.uid());

-- ìì‹ ì˜ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ (role ì œì™¸)
CREATE POLICY "Users can update own profile" ON user_profiles
  FOR UPDATE USING (user_id = auth.uid());

-- ê´€ë¦¬ìëŠ” ëª¨ë“  í”„ë¡œí•„ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view all profiles" ON user_profiles
  FOR SELECT USING (is_admin());

-- ìŠˆí¼ ê´€ë¦¬ìëŠ” ëª¨ë“  ì‘ì—… ê°€ëŠ¥
CREATE POLICY "Super admins can manage all profiles" ON user_profiles
  FOR ALL USING (is_super_admin());
```

### 2.11.2 admin_login_logs RLS ì •ì±…
```sql
-- RLS í™œì„±í™”
ALTER TABLE admin_login_logs ENABLE ROW LEVEL SECURITY;

-- ìì‹ ì˜ ë¡œê·¸ì¸ ë¡œê·¸ ì¡°íšŒ
CREATE POLICY "Users can view own login logs" ON admin_login_logs
  FOR SELECT USING (user_id = auth.uid());

-- ê´€ë¦¬ìëŠ” ëª¨ë“  ë¡œê·¸ì¸ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view all login logs" ON admin_login_logs
  FOR SELECT USING (is_admin());

-- ì‹œìŠ¤í…œë§Œ ë¡œê·¸ ìƒì„± ê°€ëŠ¥ (í•¨ìˆ˜ë¥¼ í†µí•´ì„œë§Œ)
CREATE POLICY "System can insert login logs" ON admin_login_logs
  FOR INSERT WITH CHECK (true);
```

### 2.11.3 ê¸°ì¡´ í…Œì´ë¸”ì— ê´€ë¦¬ì ì „ì²´ ì ‘ê·¼ ì •ì±… ì¶”ê°€
```sql
-- students í…Œì´ë¸”
CREATE POLICY "Admins can manage all students" ON students
  FOR ALL USING (is_admin());

-- current_levels í…Œì´ë¸”
CREATE POLICY "Admins can manage all current_levels" ON current_levels
  FOR ALL USING (is_admin());

-- monthly_plans í…Œì´ë¸”
CREATE POLICY "Admins can manage all monthly_plans" ON monthly_plans
  FOR ALL USING (is_admin());

-- monthly_evaluations í…Œì´ë¸”
CREATE POLICY "Admins can manage all monthly_evaluations" ON monthly_evaluations
  FOR ALL USING (is_admin());

-- curriculum_units í…Œì´ë¸”
CREATE POLICY "Admins can manage all curriculum_units" ON curriculum_units
  FOR ALL USING (is_admin());

-- serial_codes í…Œì´ë¸”
CREATE POLICY "Admins can manage all serial_codes" ON serial_codes
  FOR ALL USING (is_admin());

-- payments í…Œì´ë¸”
CREATE POLICY "Admins can manage all payments" ON payments
  FOR ALL USING (is_admin());

-- licenses í…Œì´ë¸”
CREATE POLICY "Admins can manage all licenses" ON licenses
  FOR ALL USING (is_admin());
```

---

## âš ï¸ **ì¶”ê°€ ì‘ì—… í•„ìš”**

### ì™„ë£Œëœ ê´€ë¦¬ì ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ
- âœ… `user_profiles` - ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ í…Œì´ë¸”
- âœ… `admin_login_logs` - ê´€ë¦¬ì ë¡œê·¸ì¸ ë¡œê·¸ í…Œì´ë¸”
- âœ… `is_admin()` í•¨ìˆ˜ - ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦
- âœ… `is_super_admin()` í•¨ìˆ˜ - ìŠˆí¼ ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦
- âœ… `log_admin_login()` í•¨ìˆ˜ - ë¡œê·¸ì¸ ë¡œê·¸ ê¸°ë¡
- âœ… ê´€ë¦¬ì RLS ì •ì±… - ì „ì²´ í…Œì´ë¸” ì ‘ê·¼ ê¶Œí•œ

### 2.10.6 system_settings (ì‹œìŠ¤í…œ ì„¤ì •) ğŸ”„ API ì—°ë™ í•„ìˆ˜ í…Œì´ë¸”
```sql
CREATE TABLE system_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  setting_key VARCHAR(100) NOT NULL UNIQUE,
  setting_value JSONB NOT NULL,
  setting_type VARCHAR(50) NOT NULL DEFAULT 'string', -- 'string', 'number', 'boolean', 'object'
  display_name VARCHAR(200) NOT NULL,
  description TEXT,
  category VARCHAR(100) DEFAULT 'general',
  is_public BOOLEAN DEFAULT false,
  is_required BOOLEAN DEFAULT false,
  default_value JSONB,
  validation_rules JSONB,
  
  -- ë©”íƒ€ë°ì´í„°
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_system_settings_category ON system_settings(category);
CREATE INDEX idx_system_settings_public ON system_settings(is_public);

-- ê¸°ë³¸ ì‹œìŠ¤í…œ ì„¤ì •ê°’ ì‚½ì…
INSERT INTO system_settings (setting_key, setting_value, setting_type, display_name, description, category, is_public, is_required) VALUES
('maintenance_mode', 'false', 'boolean', 'ì ê²€ ëª¨ë“œ', 'ì‹œìŠ¤í…œ ì ê²€ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€', 'system', false, true),
('registration_enabled', 'true', 'boolean', 'íšŒì›ê°€ì… í—ˆìš©', 'ì‹ ê·œ íšŒì›ê°€ì… í—ˆìš© ì—¬ë¶€', 'user', true, true),
('max_students_per_user', '50', 'number', 'ì‚¬ìš©ìë³„ ìµœëŒ€ í•™ìƒ ìˆ˜', 'í•œ ì‚¬ìš©ìê°€ ë“±ë¡í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í•™ìƒ ìˆ˜', 'user', false, true),
('ai_generation_enabled', 'true', 'boolean', 'AI ìƒì„± ì„œë¹„ìŠ¤ í™œì„±í™”', 'AI ê¸°ë°˜ ë¬¸ì„œ ìƒì„± ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€', 'ai', false, true),
('file_upload_max_size', '10485760', 'number', 'íŒŒì¼ ì—…ë¡œë“œ ìµœëŒ€ í¬ê¸°', 'íŒŒì¼ ì—…ë¡œë“œ ìµœëŒ€ í¬ê¸° (bytes)', 'file', false, true),
('session_timeout', '3600', 'number', 'ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ', 'ì‚¬ìš©ì ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì‹œê°„ (ì´ˆ)', 'security', false, true),
('notification_email_enabled', 'true', 'boolean', 'ì´ë©”ì¼ ì•Œë¦¼ í™œì„±í™”', 'ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ í™œì„±í™” ì—¬ë¶€', 'notification', false, true),
('backup_schedule', '"0 2 * * *"', 'string', 'ë°±ì—… ìŠ¤ì¼€ì¤„', 'ìë™ ë°±ì—… í¬ë¡  ìŠ¤ì¼€ì¤„', 'system', false, true),
('mcp_enabled', 'true', 'boolean', 'MCP ì„œë²„ ì—°ë™ í™œì„±í™”', 'MCP ì„œë²„ ì—°ë™ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€', 'mcp', false, true),
('mcp_health_check_interval', '300', 'number', 'MCP ì„œë²„ ìƒíƒœ í™•ì¸ ì£¼ê¸°', 'MCP ì„œë²„ ìƒíƒœ í™•ì¸ ì£¼ê¸° (ì´ˆ)', 'mcp', false, true),
('mcp_timeout_seconds', '30', 'number', 'MCP íˆ´ íƒ€ì„ì•„ì›ƒ', 'MCP íˆ´ í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ ì‹œê°„ (ì´ˆ)', 'mcp', false, true),
('mcp_retry_attempts', '3', 'number', 'MCP ì¬ì‹œë„ íšŸìˆ˜', 'MCP íˆ´ í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜', 'mcp', false, true),
('mcp_audit_retention_days', '90', 'number', 'MCP ê°ì‚¬ ë¡œê·¸ ë³´ì¡´ ê¸°ê°„', 'MCP ê°ì‚¬ ë¡œê·¸ ë³´ì¡´ ê¸°ê°„ (ì¼)', 'mcp', false, true);
```

---

## 2.11 MCP ì—°ë™ í…Œì´ë¸” (MCP Integration Tables) ğŸ†•

### 2.11.1 mcp_tool_logs (MCP íˆ´ í˜¸ì¶œ ë¡œê·¸) ğŸ”„
```sql
CREATE TABLE mcp_tool_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- MCP íˆ´ í˜¸ì¶œ ì •ë³´
  mcp_server_name VARCHAR(100) NOT NULL,           -- 'supabase', 'toss-payments' ë“±
  tool_name VARCHAR(100) NOT NULL,                 -- í˜¸ì¶œëœ íˆ´ ì´ë¦„
  tool_parameters JSONB DEFAULT '{}',              -- íˆ´ í˜¸ì¶œ ë§¤ê°œë³€ìˆ˜
  tool_result JSONB DEFAULT '{}',                  -- íˆ´ ì‹¤í–‰ ê²°ê³¼
  
  -- í˜¸ì¶œ ìƒíƒœ ë° ë©”íƒ€ë°ì´í„°
  call_status VARCHAR(20) DEFAULT 'pending' CHECK (
    call_status IN ('pending', 'success', 'error', 'timeout', 'cancelled')
  ),
  execution_time_ms INTEGER DEFAULT 0,            -- ì‹¤í–‰ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
  error_message TEXT,                             -- ì˜¤ë¥˜ ë©”ì‹œì§€
  error_code VARCHAR(50),                         -- ì˜¤ë¥˜ ì½”ë“œ
  
  -- ì‚¬ìš©ì ë° ë³´ì•ˆ ì •ë³´
  user_id UUID REFERENCES auth.users(id),         -- í˜¸ì¶œí•œ ì‚¬ìš©ì
  session_id VARCHAR(100),                        -- ì„¸ì…˜ ID
  ip_address INET,                                -- í˜¸ì¶œ IP
  user_agent TEXT,                                -- ë¸Œë¼ìš°ì € ì •ë³´
  
  -- MCP ë³´ì•ˆ ì •ë³´
  auth_token_hash VARCHAR(255),                   -- ì¸ì¦ í† í° í•´ì‹œ
  server_health_status VARCHAR(20) DEFAULT 'unknown', -- MCP ì„œë²„ ìƒíƒœ
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ì„¤ì •
CREATE INDEX idx_mcp_tool_logs_server_tool ON mcp_tool_logs(mcp_server_name, tool_name);
CREATE INDEX idx_mcp_tool_logs_user_id ON mcp_tool_logs(user_id);
CREATE INDEX idx_mcp_tool_logs_status ON mcp_tool_logs(call_status);
CREATE INDEX idx_mcp_tool_logs_created ON mcp_tool_logs(created_at DESC);
CREATE INDEX idx_mcp_tool_logs_execution_time ON mcp_tool_logs(execution_time_ms);
```

### 2.11.2 mcp_server_status (MCP ì„œë²„ ìƒíƒœ ì¶”ì ) ğŸ”„
```sql
CREATE TABLE mcp_server_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- MCP ì„œë²„ ì •ë³´
  server_name VARCHAR(100) NOT NULL UNIQUE,       -- 'supabase', 'toss-payments' ë“±
  server_url VARCHAR(500),                        -- ì„œë²„ URL
  server_version VARCHAR(50),                     -- ì„œë²„ ë²„ì „
  
  -- ìƒíƒœ ì •ë³´
  health_status VARCHAR(20) DEFAULT 'unknown' CHECK (
    health_status IN ('healthy', 'degraded', 'unhealthy', 'unknown', 'maintenance')
  ),
  is_active BOOLEAN DEFAULT true,                 -- ì„œë²„ í™œì„± ìƒíƒœ
  last_health_check TIMESTAMP WITH TIME ZONE,     -- ë§ˆì§€ë§‰ ìƒíƒœ í™•ì¸
  consecutive_failures INTEGER DEFAULT 0,         -- ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜
  
  -- ì„±ëŠ¥ ë©”íŠ¸ë¦­
  avg_response_time_ms INTEGER DEFAULT 0,         -- í‰ê·  ì‘ë‹µ ì‹œê°„
  total_requests INTEGER DEFAULT 0,               -- ì´ ìš”ì²­ ìˆ˜
  successful_requests INTEGER DEFAULT 0,          -- ì„±ê³µ ìš”ì²­ ìˆ˜
  failed_requests INTEGER DEFAULT 0,              -- ì‹¤íŒ¨ ìš”ì²­ ìˆ˜
  
  -- ì„œë²„ ë©”íƒ€ë°ì´í„°
  server_metadata JSONB DEFAULT '{}',            -- ì¶”ê°€ ì„œë²„ ì •ë³´
  capabilities JSONB DEFAULT '{}',                -- ì„œë²„ ê¸°ëŠ¥ ëª©ë¡
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ì„¤ì •
CREATE INDEX idx_mcp_server_status_name ON mcp_server_status(server_name);
CREATE INDEX idx_mcp_server_status_health ON mcp_server_status(health_status);
CREATE INDEX idx_mcp_server_status_active ON mcp_server_status(is_active);
CREATE INDEX idx_mcp_server_status_updated ON mcp_server_status(updated_at DESC);
```

### 2.11.3 mcp_payment_transactions (MCP ê²°ì œ íŠ¸ëœì­ì…˜) ğŸ”„
```sql
CREATE TABLE mcp_payment_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ê¸°ì¡´ ê²°ì œ ì—°ë§‰
  payment_id UUID REFERENCES payments(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  
  -- MCP Toss Payments ì •ë³´
  mcp_transaction_id VARCHAR(100) NOT NULL UNIQUE, -- MCP íŠ¸ëœì­ì…˜ ID
  toss_payment_key VARCHAR(200),                   -- Toss Payments ê²°ì œ í‚¤
  toss_order_id VARCHAR(100),                      -- Toss ì£¼ë¬¸ ID
  
  -- MCP íˆ´ í˜¸ì¶œ ì •ë³´
  mcp_tool_call_id UUID REFERENCES mcp_tool_logs(id), -- ê´€ë ¨ MCP íˆ´ ë¡œê·¸
  ai_agent_session VARCHAR(100),                   -- AI ì—ì´ì „íŠ¸ ì„¸ì…˜
  automation_level VARCHAR(20) DEFAULT 'manual' CHECK (
    automation_level IN ('manual', 'semi-auto', 'full-auto')
  ),
  
  -- íŠ¸ëœì­ì…˜ ìƒíƒœ
  mcp_status VARCHAR(20) DEFAULT 'initiated' CHECK (
    mcp_status IN ('initiated', 'processing', 'approved', 'completed', 'failed', 'cancelled', 'refunded')
  ),
  
  -- ê²°ì œ ì„¸ë¶€ ì •ë³´
  amount DECIMAL(10,2) NOT NULL CHECK (amount > 0),
  currency VARCHAR(3) DEFAULT 'KRW',
  payment_method VARCHAR(50),                      -- ê²°ì œ ìˆ˜ë‹¨
  
  -- MCP ë©”íƒ€ë°ì´í„°
  mcp_request_data JSONB DEFAULT '{}',            -- MCP ìš”ì²­ ë°ì´í„°
  mcp_response_data JSONB DEFAULT '{}',           -- MCP ì‘ë‹µ ë°ì´í„°
  ai_decision_context JSONB DEFAULT '{}',         -- AI ê²°ì • ì»´í…ìŠ¤íŠ¸
  
  -- ë³´ì•ˆ ë° ê°ì‚¬
  security_hash VARCHAR(255),                     -- ë³´ì•ˆ í•´ì‹œ
  audit_trail JSONB[] DEFAULT '{}',               -- ê°ì‚¬ ì´ë ¥
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ì„¤ì •
CREATE INDEX idx_mcp_payment_transactions_payment_id ON mcp_payment_transactions(payment_id);
CREATE INDEX idx_mcp_payment_transactions_user_id ON mcp_payment_transactions(user_id);
CREATE INDEX idx_mcp_payment_transactions_mcp_id ON mcp_payment_transactions(mcp_transaction_id);
CREATE INDEX idx_mcp_payment_transactions_status ON mcp_payment_transactions(mcp_status);
CREATE INDEX idx_mcp_payment_transactions_toss_key ON mcp_payment_transactions(toss_payment_key);
CREATE INDEX idx_mcp_payment_transactions_created ON mcp_payment_transactions(created_at DESC);
```

### 2.11.4 mcp_audit_logs (MCP ê°ì‚¬ ë¡œê·¸) ğŸ”„
```sql
CREATE TABLE mcp_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- MCP ì„œë²„ ì—°ë ì •ë³´
  mcp_server_name VARCHAR(100) NOT NULL,           -- MCP ì„œë²„ ì´ë¦„
  mcp_tool_call_id UUID REFERENCES mcp_tool_logs(id), -- ê´€ë ¨ íˆ´ í˜¸ì¶œ
  
  -- ê°ì‚¬ ì´ë²¤íŠ¸ ì •ë³´
  event_type VARCHAR(50) NOT NULL,                 -- 'auth', 'data_access', 'data_modify', 'payment', 'security'
  event_action VARCHAR(100) NOT NULL,              -- 'login', 'create', 'update', 'delete', 'pay', 'verify'
  resource_type VARCHAR(100),                      -- 'user', 'student', 'payment', 'license'
  resource_id VARCHAR(255),                        -- ë¦¬ì†ŒìŠ¤ ID
  
  -- ì‚¬ìš©ì ì •ë³´
  user_id UUID REFERENCES auth.users(id),
  user_role VARCHAR(50),                          -- ì‚¬ìš©ì ì—­í• 
  session_id VARCHAR(100),                        -- ì„¸ì…˜ ID
  
  -- ë„¤íŠ¸ì›Œí¬ ì •ë³´
  ip_address INET,
  user_agent TEXT,
  request_headers JSONB DEFAULT '{}',
  
  -- ë°ì´í„° ë³€ê²½ ì •ë³´
  old_values JSONB DEFAULT '{}',                  -- ë³€ê²½ ì „ ë°ì´í„°
  new_values JSONB DEFAULT '{}',                  -- ë³€ê²½ í›„ ë°ì´í„°
  affected_rows INTEGER DEFAULT 0,                -- ì˜í–¥ì„ ë°›ì€ ë¡œìš° ìˆ˜
  
  -- ë³´ì•ˆ ì •ë³´
  security_level VARCHAR(20) DEFAULT 'normal' CHECK (
    security_level IN ('low', 'normal', 'high', 'critical')
  ),
  risk_score INTEGER DEFAULT 0 CHECK (risk_score >= 0 AND risk_score <= 100),
  security_flags JSONB DEFAULT '{}',              -- ë³´ì•ˆ í”Œë˜ê·¸
  
  -- ê²°ê³¼ ì •ë³´
  success BOOLEAN DEFAULT true,
  error_message TEXT,
  error_code VARCHAR(50),
  
  -- ë©”íƒ€ë°ì´í„°
  context_data JSONB DEFAULT '{}',                -- ì¶”ê°€ ì»´í…ìŠ¤íŠ¸ ë°ì´í„°
  compliance_tags TEXT[] DEFAULT '{}',            -- ì»´í”Œë¼ì´ì–¸ìŠ¤ íƒœê·¸
  
  -- ì‹œìŠ¤í…œ í•„ë“œ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ì„¤ì •
CREATE INDEX idx_mcp_audit_logs_server ON mcp_audit_logs(mcp_server_name);
CREATE INDEX idx_mcp_audit_logs_event ON mcp_audit_logs(event_type, event_action);
CREATE INDEX idx_mcp_audit_logs_user ON mcp_audit_logs(user_id);
CREATE INDEX idx_mcp_audit_logs_resource ON mcp_audit_logs(resource_type, resource_id);
CREATE INDEX idx_mcp_audit_logs_security ON mcp_audit_logs(security_level, risk_score);
CREATE INDEX idx_mcp_audit_logs_created ON mcp_audit_logs(created_at DESC);
CREATE INDEX idx_mcp_audit_logs_success ON mcp_audit_logs(success);
```

---

## 2.12 MCP ì—°ë™ ì¶”ê°€ ì„¤ì •

### 2.12.1 MCP ì„œë²„ ê¸°ë³¸ ë°ì´í„° ì‚½ì…
```sql
-- MCP ì„œë²„ ìƒíƒœ ê¸°ë³¸ ë°ì´í„°
INSERT INTO mcp_server_status (server_name, server_url, health_status, is_active, capabilities) VALUES
('supabase', 'https://supabase.mcp.server', 'healthy', true, '{
  "database": ["query", "insert", "update", "delete"],
  "auth": ["login", "logout", "validate_token"],
  "storage": ["upload", "download", "delete_file"],
  "realtime": ["subscribe", "unsubscribe", "broadcast"]
}'),
('toss-payments', 'https://toss-payments.mcp.server', 'healthy', true, '{
  "payments": ["process_payment", "confirm_payment", "cancel_payment"],
  "webhooks": ["setup_webhook", "handle_webhook"],
  "analytics": ["get_payment_stats", "get_revenue_data"]
}');
