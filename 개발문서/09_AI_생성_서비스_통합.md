# ğŸ¤– IEPON AI ìƒì„± ì„œë¹„ìŠ¤ í†µí•© ì„¤ê³„ (HTML + Alpine.js + HTMX + Supabase)

> **ì—°ê²° ë¬¸ì„œ**: [02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](./02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md) | [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md) | [04_ì£¼ìš”_ê¸°ëŠ¥_ëª…ì„¸.md](./04_ì£¼ìš”_ê¸°ëŠ¥_ëª…ì„¸.md)
> **ê¸°ìˆ  ìŠ¤íƒ**: HTML5 + Alpine.js + HTMX + Supabase + Supabase Edge Functions

---

## 9.1 í†µí•© AI ìƒì„± ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜

### 9.1.1 í•µì‹¬ ì„¤ê³„ ì›ì¹™
- **í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ì¤‘ì‹¬**: ëª¨ë“  AI ìƒì„±ì—ì„œ í•™ìƒë³„ ê°œë³„í™” ë°ì´í„° ìë™ ë°˜ì˜
- **ì„œë¹„ìŠ¤ë³„ ë§ì¶¤í™”**: ê° ì„œë¹„ìŠ¤ íŠ¹ì„±ì— ë§ëŠ” ë°ì´í„° ë§¤í•‘ ë° í”„ë¡¬í”„íŠ¸ ìµœì í™”
- **ì¼ê´€ì„± ë³´ì¥**: í†µí•©ëœ Alpine.js ìŠ¤í† ì–´ë¥¼ í†µí•œ ì¼ê´€ëœ AI ìƒì„± ê²½í—˜
- **ì„±ëŠ¥ ìµœì í™”**: Supabase ìºì‹± ë° Edge Functionsë¥¼ í†µí•œ ì§€ëŠ¥í˜• ë°ì´í„° ë¡œë”©
- **UTF-8 ì•ˆì „ì„±**: ëª¨ë“  AI ìƒì„± ê³¼ì •ì—ì„œ í•œê¸€ ë° íŠ¹ìˆ˜ë¬¸ì ì•ˆì „ì„± ë³´ì¥
- **ì ‘ê·¼ì„± ìš°ì„ **: WCAG 2.1 AA ì¤€ìˆ˜ ë° ìŠ¤í¬ë¦° ë¦¬ë” ì§€ì›

### 9.1.2 ì„œë¹„ìŠ¤ ë¶„ë¥˜
```javascript
// Alpine.js ê¸€ë¡œë²Œ ìƒìˆ˜ ì •ì˜
const AI_SERVICE_TYPES = {
  CURRICULUM_ASSIGNMENT: 'curriculum_assignment',
  LESSON_PLAN: 'lesson_plan', 
  ASSESSMENT: 'assessment',
  ADMIN_DOCUMENT: 'admin_document',
  COUNSELING_GUIDE: 'counseling_guide'
};

// ì„œë¹„ìŠ¤ë³„ í•œê¸€ ë¼ë²¨
const AI_SERVICE_LABELS = {
  [AI_SERVICE_TYPES.CURRICULUM_ASSIGNMENT]: 'êµìœ¡ê³¼ì • ë°°ì •',
  [AI_SERVICE_TYPES.LESSON_PLAN]: 'êµìœ¡ê³„íš ìˆ˜ë¦½',
  [AI_SERVICE_TYPES.ASSESSMENT]: 'êµìœ¡í‰ê°€',
  [AI_SERVICE_TYPES.ADMIN_DOCUMENT]: 'í–‰ì •ë¬¸ì„œ',
  [AI_SERVICE_TYPES.COUNSELING_GUIDE]: 'ìƒë‹´ê°€ì´ë“œ'
};
```

### 9.1.3 ê¸°ìˆ  ìŠ¤íƒë³„ ì—­í• 
```html
<!-- HTML5: ì‹œë§¨í‹± êµ¬ì¡°ì™€ ì ‘ê·¼ì„± ê¸°ë°˜ ë§ˆí¬ì—… -->
<section class="ai-generation-dashboard" role="main" aria-label="AI ìƒì„± ì„œë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ">
  <header class="section-header">
    <h2 class="visually-hidden">AI ìƒì„± ì„œë¹„ìŠ¤ ì„ íƒ</h2>
  </header>
  
  <!-- Alpine.js: ìƒíƒœ ê´€ë¦¬ ë° ë°˜ì‘í˜• UI ë¡œì§ -->
  <div x-data="aiServiceHub()" x-init="initServices()">
    <!-- HTMX: ì„œë²„ì™€ì˜ ì‹¤ì‹œê°„ í†µì‹  ë° UI ì—…ë°ì´íŠ¸ -->
    <div hx-get="/api/ai-generation/status" 
         hx-trigger="every 30s" 
         hx-target="#service-status">
      <!-- ì„œë¹„ìŠ¤ ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜ì—­ -->
    </div>
  </div>
</section>
```

```javascript
// Supabase Edge Functions: AI API í˜¸ì¶œ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
// Edge Function ì˜ˆì‹œ êµ¬ì¡°
const aiGenerationHandler = {
  async handleRequest(request, serviceType, studentContext) {
    // UTF-8 ì•ˆì „ì„± ê²€ì¦
    const safeContext = validateUTF8Context(studentContext);
    
    // AI API í˜¸ì¶œ
    const aiResponse = await callOpenAI(request, safeContext);
    
    // ê²°ê³¼ ê²€ì¦ ë° ì €ì¥
    return await saveGenerationResult(aiResponse);
  }
};
```

---

## 9.2 í†µí•© AI ìƒì„± ì„œë¹„ìŠ¤ ë°ì´í„° êµ¬ì¡° (Alpine.js)

### 9.2.1 AI ìƒì„± ì„œë¹„ìŠ¤ ë°ì´í„° íƒ€ì… ì •ì˜

#### í•µì‹¬ ë°ì´í„° êµ¬ì¡°ì²´
```javascript
/**
 * AI ìƒì„± ê²°ê³¼ í†µí•© ë°ì´í„° êµ¬ì¡°
 * Alpine.js ìŠ¤í† ì–´ì™€ HTMX ì‘ë‹µì—ì„œ ì‚¬ìš©
 */
const createAIGenerationResult = () => ({
  id: '',
  serviceType: '',
  studentId: '',
  generatedContent: null,
  metadata: createAIGenerationMetadata(),
  contextUsage: createContextUsageInfo(),
  qualityScore: 0,
  confidenceLevel: 0,
  generatedAt: '',
  validatedAt: null,
  errors: [],
  warnings: [],
  
  // UTF-8 ì•ˆì „ì„± ê²€ì¦ ë©”ì„œë“œ
  validateUTF8() {
    return validateUTF8Text(this.generatedContent);
  },
  
  // ì ‘ê·¼ì„± ì •ë³´ ìƒì„±
  getAccessibilityInfo() {
    return {
      ariaLabel: `${AI_SERVICE_LABELS[this.serviceType]} ìƒì„± ê²°ê³¼`,
      role: 'region',
      'aria-live': this.errors.length > 0 ? 'assertive' : 'polite'
    };
  }
});

/**
 * AI ìƒì„± ë©”íƒ€ë°ì´í„° êµ¬ì¡°
 */
const createAIGenerationMetadata = () => ({
  model: '',
  temperature: 0.7,
  maxTokens: 2000,
  promptTokens: 0,
  completionTokens: 0,
  totalTokens: 0,
  processingTime: 0,
  retryCount: 0,
  version: '1.0.0',
  
  // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚°
  calculateEfficiency() {
    if (this.totalTokens === 0) return 0;
    return Math.round((this.completionTokens / this.totalTokens) * 100);
  }
});

/**
 * ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì •ë³´ êµ¬ì¡°
 */
const createContextUsageInfo = () => ({
  dataSourcesUsed: [],
  contextCompleteness: 0,
  individualizedElements: [],
  adaptationsApplied: [],
  supportNeedsAddressed: [],
  
  // ê°œë³„í™” ìˆ˜ì¤€ ê³„ì‚°
  getIndividualizationLevel() {
    const totalElements = this.individualizedElements.length + 
                         this.adaptationsApplied.length + 
                         this.supportNeedsAddressed.length;
    if (totalElements >= 5) return 'high';
    if (totalElements >= 3) return 'medium';
    return 'low';
  }
});

/**
 * ì„œë¹„ìŠ¤ë³„ ë§¤í•‘ ë°ì´í„° ê¸°ë³¸ êµ¬ì¡°
 */
const createServiceSpecificMappedData = (serviceType) => ({
  serviceType,
  mappedAt: new Date().toISOString(),
  dataQuality: 0,
  
  // ë°ì´í„° í’ˆì§ˆ ê²€ì¦
  validateQuality() {
    // ê¸°ë³¸ í’ˆì§ˆ ê²€ì¦ ë¡œì§
    this.dataQuality = Math.random() * 100; // ì‹¤ì œë¡œëŠ” ë³µì¡í•œ ê²€ì¦ ë¡œì§
    return this.dataQuality > 70;
  }
});

/**
 * ì‚¬ìš©ì ì„ í˜¸ë„ êµ¬ì¡°
 */
const createUserPreferences = () => ({
  language: 'ko',
  tone: 'professional',
  detailLevel: 'moderate',
  includeExamples: true,
  focusAreas: [],
  avoidTerms: [],
  customInstructions: '',
  
  // ì„ í˜¸ë„ ê²€ì¦ ë° ì ìš©
  applyToRequest(request) {
    return {
      ...request,
      preferences: { ...this },
      processedAt: new Date().toISOString()
    };
  }
});

/**
 * AI ìƒì„± ìš”ì²­ ê¸°ë³¸ êµ¬ì¡°
 */
const createBaseAIGenerationRequest = () => ({
  studentId: '',
  serviceType: '',
  requestId: '',
  priority: 'normal',
  deadline: null,
  additionalContext: {},
  
  // ìš”ì²­ ê²€ì¦
  validate() {
    const errors = [];
    if (!this.studentId) errors.push('í•™ìƒ IDê°€ í•„ìš”í•©ë‹ˆë‹¤');
    if (!this.serviceType) errors.push('ì„œë¹„ìŠ¤ íƒ€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤');
    if (!this.requestId) errors.push('ìš”ì²­ IDê°€ í•„ìš”í•©ë‹ˆë‹¤');
    return { isValid: errors.length === 0, errors };
  },
  
  // UTF-8 ì•ˆì „ì„± ê²€ì‚¬
  ensureUTF8Safety() {
    Object.keys(this.additionalContext).forEach(key => {
      if (typeof this.additionalContext[key] === 'string') {
        this.additionalContext[key] = validateAndSanitizeUTF8(this.additionalContext[key]);
      }
    });
  }
});

/**
 * AI ìƒì„± ì—ëŸ¬ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°
 * JavaScript ê¸°ë°˜ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ ì œê³µ
 */
class AIGenerationError extends Error {
  constructor(
    message,
    serviceType = '',
    code = 'GENERATION_FAILED',
    context = null,
    retryable = true
  ) {
    super(message);
    this.name = 'AIGenerationError';
    this.code = code;
    this.serviceType = serviceType;
    this.context = context;
    this.timestamp = new Date().toISOString();
    this.retryable = retryable;

    // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ìº¡ì²˜ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê³ ë ¤)
    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, AIGenerationError);
    }
  }

  /**
   * ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„±
   * ì ‘ê·¼ì„±ì„ ê³ ë ¤í•œ ëª…í™•í•œ í•œê¸€ ë©”ì‹œì§€ ì œê³µ
   */
  getUserFriendlyMessage() {
    switch (this.code) {
      case 'CONTEXT_BUILD_FAILED':
        return 'í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      case 'AI_API_ERROR':
        return 'AI ì„œë¹„ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      case 'VALIDATION_FAILED':
        return 'ìƒì„±ëœ ë‚´ìš©ì˜ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      case 'QUOTA_EXCEEDED':
        return 'AI ìƒì„± í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.';
      case 'UTF8_ENCODING_ERROR':
        return 'í…ìŠ¤íŠ¸ ì¸ì½”ë”© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      case 'NETWORK_ERROR':
        return 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      case 'TIMEOUT_ERROR':
        return 'AI ìƒì„± ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
      default:
        return 'AI ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }
  }

  /**
   * ì ‘ê·¼ì„±ì„ ìœ„í•œ ARIA ì •ë³´ ìƒì„±
   */
  getAccessibilityInfo() {
    return {
      role: 'alert',
      'aria-live': 'assertive',
      'aria-label': `ì˜¤ë¥˜ ë°œìƒ: ${this.getUserFriendlyMessage()}`
    };
  }

  /**
   * ì—ëŸ¬ ì •ë³´ë¥¼ Alpine.js ìŠ¤í† ì–´ í˜•íƒœë¡œ ë³€í™˜
   */
  toAlpineStore() {
    return {
      hasError: true,
      error: {
        code: this.code,
        message: this.getUserFriendlyMessage(),
        timestamp: this.timestamp,
        retryable: this.retryable,
        serviceType: this.serviceType,
        accessibility: this.getAccessibilityInfo()
      }
    };
  }
}

/**
 * ì—ëŸ¬ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
 */
const errorUtils = {
  /**
   * ì—ëŸ¬ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ì¸ í˜•íƒœë¡œ ì²˜ë¦¬
   */
  handleError(error, serviceType) {
    console.error('AI Generation Error:', error);
    
    if (error instanceof AIGenerationError) {
      return error.toAlpineStore();
    }
    
    // ì¼ë°˜ ì—ëŸ¬ë¥¼ AI ìƒì„± ì—ëŸ¬ë¡œ ë³€í™˜
    const aiError = new AIGenerationError(
      error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      serviceType,
      'UNKNOWN_ERROR',
      { originalError: error },
      true
    );
    
    return aiError.toAlpineStore();
  },

  /**
   * UTF-8 ì•ˆì „ì„± ê²€ì¦ ì—ëŸ¬ ì²˜ë¦¬
   */
  handleUTF8Error(text, context) {
    return new AIGenerationError(
      'UTF-8 ì¸ì½”ë”© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      context.serviceType || '',
      'UTF8_ENCODING_ERROR',
      { text, context },
      false
    );
  },

  /**
   * ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì²˜ë¦¬
   */
  handleNetworkError(response, serviceType) {
    const code = response.status >= 500 ? 'SERVER_ERROR' : 'NETWORK_ERROR';
    return new AIGenerationError(
      `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (${response.status}): ${response.statusText}`,
      serviceType,
      code,
      { status: response.status, statusText: response.statusText },
      response.status < 500 // 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„ ë¶ˆê°€, 5xx ì—ëŸ¬ëŠ” ì¬ì‹œë„ ê°€ëŠ¥
    );
  }
};
```

### 9.2.2 AI ìƒì„± ì„œë¹„ìŠ¤ Alpine.js ì»´í¬ë„ŒíŠ¸

#### í´ë¼ì´ì–¸íŠ¸ ì¸¡ AI ìƒì„± ê´€ë¦¬ì (Alpine.js)
```javascript
/**
 * AI ìƒì„± ì„œë¹„ìŠ¤ Alpine.js ì»´í¬ë„ŒíŠ¸
 * ëª¨ë“  AI ìƒì„± ì„œë¹„ìŠ¤ì˜ ê³µí†µ ê¸°ëŠ¥ê³¼ ì›Œí¬í”Œë¡œìš°ë¥¼ ê´€ë¦¬
 */
function aiGenerationService() {
  return {
    // ìƒíƒœ ê´€ë¦¬
    serviceType: '',
    isLoading: false,
    error: null,
    result: null,
    progress: 0,
    maxRetries: 3,
    currentRetry: 0,
    requestTimeout: 30000, // 30ì´ˆ
    
    // ì„¤ì •
    config: {
      apiBaseUrl: '/api/ai-generation',
      rateLimitWindow: 60000, // 1ë¶„
      maxRequestsPerWindow: 100
    },
    
    // ì´ˆê¸°í™”
    init() {
      this.setupEventListeners();
      this.validateEnvironment();
      console.log(`AI Generation Service ì´ˆê¸°í™”ë¨ (ì„œë¹„ìŠ¤: ${this.serviceType})`);
    },
    
    /**
     * í™˜ê²½ ê²€ì¦ (UTF-8 ì¸ì½”ë”©, Supabase ì—°ê²° ë“±)
     */
    validateEnvironment() {
      // UTF-8 ì¸ì½”ë”© ì§€ì› í™•ì¸
      if (!window.TextEncoder || !window.TextDecoder) {
        this.error = errorUtils.handleUTF8Error('ë¸Œë¼ìš°ì € UTF-8 ì§€ì› ì—†ìŒ', { serviceType: this.serviceType });
        return false;
      }
      
      // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
      if (!window.supabase) {
        this.error = new AIGenerationError(
          'Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
          this.serviceType,
          'SUPABASE_NOT_INITIALIZED',
          null,
          false
        ).toAlpineStore();
        return false;
      }
      
      return true;
    },
    
    /**
     * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ AI ìƒì„± ë©”ì¸ ë©”ì„œë“œ
     * HTMXì™€ Supabase Edge Functionsë¥¼ í™œìš©í•œ êµ¬í˜„
     */
    async generateWithContext(studentId, requestData, teacherPreferences = null) {
      if (!this.validateEnvironment()) {
        return this.error;
      }
      
      this.isLoading = true;
      this.error = null;
      this.currentRetry = 0;
      this.progress = 0;
      
      try {
        // 1. ìš”ì²­ ê²€ì¦ ë° UTF-8 ì•ˆì „ì„± í™•ì¸
        const validation = this.validateRequest(studentId, requestData);
        if (!validation.isValid) {
          throw new AIGenerationError(
            validation.errors.join(', '),
            this.serviceType,
            'VALIDATION_FAILED',
            { errors: validation.errors },
            false
          );
        }
        
        // 2. ì†ë„ ì œí•œ í™•ì¸
        await this.checkRateLimit(studentId);
        this.progress = 10;
        
        // 3. ì¬ì‹œë„ ë¡œì§ìœ¼ë¡œ AI ìƒì„± ì‹¤í–‰
        const result = await this.executeWithRetry(
          () => this.performAIGeneration(studentId, requestData, teacherPreferences)
        );
        
        this.result = result;
        this.progress = 100;
        
        return result;
        
      } catch (error) {
        this.error = errorUtils.handleError(error, this.serviceType);
        return this.error;
      } finally {
        this.isLoading = false;
      }
    },
    
    /**
     * ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ ì‹¤í–‰ê¸°
     */
    async executeWithRetry(operationFn) {
      let lastError = null;
      
      for (let retry = 0; retry < this.maxRetries; retry++) {
        this.currentRetry = retry;
        
        try {
          return await operationFn();
          
        } catch (error) {
          lastError = error;
          
          // ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì—ëŸ¬ì¸ ê²½ìš° ì¦‰ì‹œ ì¤‘ë‹¨
          if (error instanceof AIGenerationError && !error.retryable) {
            throw error;
          }
          
          // ë§ˆì§€ë§‰ ì¬ì‹œë„ì¸ ê²½ìš° ì—ëŸ¬ ë°œìƒ
          if (retry >= this.maxRetries - 1) {
            throw new AIGenerationError(
              `AI ìƒì„± ì‹¤íŒ¨ (${retry + 1}íšŒ ì¬ì‹œë„): ${error.message}`,
              this.serviceType,
              'MAX_RETRIES_EXCEEDED',
              { originalError: error, retryCount: retry + 1 }
            );
          }
          
          // ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì¬ì‹œë„ ëŒ€ê¸°
          const delay = Math.min(1000 * Math.pow(2, retry), 5000); // ìµœëŒ€ 5ì´ˆ
          await this.sleep(delay);
          
          console.warn(`AI ìƒì„± ì¬ì‹œë„ ${retry + 1}/${this.maxRetries}:`, error.message);
        }
      }
      
      throw lastError || new AIGenerationError(
        'ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ë¡œ AI ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        this.serviceType,
        'UNEXPECTED_ERROR'
      );
    },
    
    /**
     * ì‹¤ì œ AI ìƒì„± ìˆ˜í–‰ (Supabase Edge Functions í™œìš©)
     */
    async performAIGeneration(studentId, requestData, teacherPreferences) {
      const startTime = Date.now();
      
      // 1. í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• (Supabaseì—ì„œ ë°ì´í„° ì¡°íšŒ)
      const studentContext = await this.buildStudentContext(studentId);
      this.progress = 30;
      
      // 2. ì„œë¹„ìŠ¤ë³„ ë°ì´í„° ë§¤í•‘
      const mappedData = await this.mapDataForService(studentContext, requestData);
      this.progress = 40;
      
      // 3. Edge Functionì„ í†µí•œ AI ìƒì„± ìš”ì²­
      const aiResult = await this.callSupabaseEdgeFunction({
        studentContext,
        mappedData,
        requestData,
        teacherPreferences
      });
      this.progress = 70;
      
      // 4. ê²°ê³¼ í›„ì²˜ë¦¬ ë° ê²€ì¦
      const validatedResult = await this.validateAndEnhanceResult(
        aiResult,
        studentContext,
        requestData
      );
      this.progress = 85;
      
      // 5. ì‚¬ìš© ì´ë ¥ ì €ì¥
      await this.saveGenerationHistory({
        studentId,
        result: validatedResult,
        processingTime: Date.now() - startTime
      });
      this.progress = 95;
      
      return validatedResult;
    },

    
    /**
     * ìš”ì²­ ê²€ì¦ ë° UTF-8 ì•ˆì „ì„± í™•ì¸
     */
    validateRequest(studentId, requestData) {
      const errors = [];
      
      // ê¸°ë³¸ í•„ë“œ ê²€ì¦
      if (!studentId || typeof studentId !== 'string') {
        errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ í•™ìƒ IDì…ë‹ˆë‹¤.');
      }
      
      if (!requestData) {
        errors.push('ìš”ì²­ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return { isValid: false, errors };
      }
      
      // ìš”ì²­ ë°ì´í„° ê²€ì¦ (ë‚´ì¥ validate ë©”ì„œë“œ ì‚¬ìš©)
      const requestValidation = requestData.validate ? requestData.validate() : { isValid: true, errors: [] };
      if (!requestValidation.isValid) {
        errors.push(...requestValidation.errors);
      }
      
      // UTF-8 ì•ˆì „ì„± ê²€ì¦
      try {
        const textFields = [studentId, requestData.requestId, requestData.serviceType];
        textFields.forEach(field => {
          if (field && !this.isValidUTF8(field)) {
            errors.push(`UTF-8 ì¸ì½”ë”©ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ í•„ë“œê°€ ìˆìŠµë‹ˆë‹¤: ${field}`);
          }
        });
        
        // ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ì˜ UTF-8 ê²€ì¦
        if (requestData.additionalContext) {
          Object.values(requestData.additionalContext).forEach(value => {
            if (typeof value === 'string' && !this.isValidUTF8(value)) {
              errors.push('ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ì— UTF-8 ì¸ì½”ë”© ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.');
            }
          });
        }
      } catch (error) {
        errors.push('UTF-8 ì¸ì½”ë”© ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      
      return {
        isValid: errors.length === 0,
        errors
      };
    },
    
    /**
     * UTF-8 ë¬¸ìì—´ ìœ íš¨ì„± ê²€ì‚¬
     */
    isValidUTF8(str) {
      try {
        const encoded = new TextEncoder().encode(str);
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
        return decoded === str;
      } catch (error) {
        return false;
      }
    },
    
    /**
     * ì†ë„ ì œí•œ í™•ì¸ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê¸°ë³¸ ì²´í¬)
     */
    async checkRateLimit(studentId) {
      const key = `rate_limit_${studentId}_${this.serviceType}`;
      const now = Date.now();
      const windowStart = now - this.config.rateLimitWindow;
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìµœê·¼ ìš”ì²­ ê¸°ë¡ í™•ì¸
      const requests = JSON.parse(localStorage.getItem(key) || '[]');
      const recentRequests = requests.filter(timestamp => timestamp > windowStart);
      
      if (recentRequests.length >= this.config.maxRequestsPerWindow) {
        throw new AIGenerationError(
          `ì†ë„ ì œí•œ ì´ˆê³¼: ${this.config.rateLimitWindow / 1000}ì´ˆë‹¹ ìµœëŒ€ ${this.config.maxRequestsPerWindow}íšŒ ìš”ì²­ ê°€ëŠ¥`,
          this.serviceType,
          'RATE_LIMIT_EXCEEDED',
          { requestCount: recentRequests.length, windowStart, now },
          true // ì‹œê°„ì´ ì§€ë‚˜ë©´ ì¬ì‹œë„ ê°€ëŠ¥
        );
      }
      
      // í˜„ì¬ ìš”ì²­ ê¸°ë¡ ì¶”ê°€
      recentRequests.push(now);
      localStorage.setItem(key, JSON.stringify(recentRequests));
    },
    
    /**
     * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• (Supabaseì—ì„œ ë°ì´í„° ì¡°íšŒ)
     */
    async buildStudentContext(studentId) {
      try {
        const { data, error } = await window.supabase
          .rpc('get_student_context_for_ai', {
            student_id: studentId,
            service_type: this.serviceType
          });
        
        if (error) {
          throw new AIGenerationError(
            `í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• ì‹¤íŒ¨: ${error.message}`,
            this.serviceType,
            'CONTEXT_BUILD_FAILED',
            { studentId, supabaseError: error },
            true
          );
        }
        
        // UTF-8 ì•ˆì „ì„± ê²€ì¦
        if (data && !this.validateContextUTF8(data)) {
          throw errorUtils.handleUTF8Error('í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„°', {
            serviceType: this.serviceType,
            studentId
          });
        }
        
        return data;
      } catch (error) {
        if (error instanceof AIGenerationError) {
          throw error;
        }
        throw new AIGenerationError(
          `í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• ì¤‘ ì˜¤ë¥˜: ${error.message}`,
          this.serviceType,
          'CONTEXT_BUILD_FAILED',
          { studentId, originalError: error }
        );
      }
    },
    
      context,
      requestData
    ) {
      // ê¸°ë³¸ ë°ì´í„° ë§¤í•‘ (ê° ì„œë¹„ìŠ¤ë³„ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
      const mappedData = createServiceSpecificMappedData(this.serviceType);
      
      // ê³µí†µ ë§¤í•‘ ë¡œì§
      mappedData.studentProfile = {
        id: context.profile?.id,
        name: context.profile?.name,
        grade: context.profile?.grade,
        disabilityType: context.profile?.disabilityType
      };
      
      mappedData.currentLevels = context.currentLevels || {};
      mappedData.learningHistory = context.recentActivities || [];
      mappedData.supportNeeds = context.supportNeeds || [];
      
      // ë°ì´í„° í’ˆì§ˆ ê²€ì¦
      mappedData.validateQuality();
      
      return mappedData;
    },
    
    /**
     * ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì •ë³´ ê²€ì¦
     */
    validateContextUTF8(context) {
      try {
        const jsonStr = JSON.stringify(context);
        return this.isValidUTF8(jsonStr);
      } catch (error) {
        return false;
      }
    },
    
    /**
     * Supabase Edge Function í˜¸ì¶œ
     */
    async callSupabaseEdgeFunction(payload) {
      try {
        const { data, error } = await window.supabase.functions.invoke(
          'ai-generation-service',
          {
            body: {
              ...payload,
              serviceType: this.serviceType,
              timestamp: new Date().toISOString()
            }
          }
        );
        
        if (error) {
          throw new AIGenerationError(
            `AI ìƒì„± ì„œë¹„ìŠ¤ í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`,
            this.serviceType,
            'AI_API_ERROR',
            { supabaseError: error },
            true
          );
        }
        
        return data;
      } catch (error) {
        if (error instanceof AIGenerationError) {
          throw error;
        }
        throw errorUtils.handleNetworkError(
          { status: 500, statusText: error.message },
          this.serviceType
        );
      }
    },
    
    /**
     * AI ê²°ê³¼ ê²€ì¦ ë° í–¥ìƒ
     */
    async validateAndEnhanceResult(
      aiResult,
      context,
      requestData
    ) {
      const result = createAIGenerationResult();
      
      // ê¸°ë³¸ ì •ë³´ ì„¤ì •
      result.id = `ai_gen_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      result.serviceType = this.serviceType;
      result.studentId = context.profile?.id;
      result.generatedContent = aiResult.content;
      result.generatedAt = new Date().toISOString();
      
      // ë©”íƒ€ë°ì´í„° ì„¤ì •
      result.metadata = {
        ...createAIGenerationMetadata(),
        ...aiResult.metadata,
        requestId: requestData.requestId,
        serviceType: this.serviceType
      };
      
      // UTF-8 ì•ˆì „ì„± ê²€ì¦
      if (!result.validateUTF8()) {
        throw errorUtils.handleUTF8Error(
          result.generatedContent,
          { serviceType: this.serviceType, resultId: result.id }
        );
      }
      
      // ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì •ë³´ ì„¤ì •
      result.contextUsage = createContextUsageInfo();
      result.contextUsage.dataSourcesUsed = ['student_profile', 'learning_history', 'support_needs'];
      result.contextUsage.contextCompleteness = this.calculateContextCompleteness(context);
      
      // í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
      result.qualityScore = this.calculateQualityScore(result, context);
      result.confidenceLevel = this.calculateConfidenceLevel(result);
      
      result.validatedAt = new Date().toISOString();
      
      return result;
    },
    
    /**
     * ì»¨í…ìŠ¤íŠ¸ ì™„ì„±ë„ ê³„ì‚°
     */
    calculateContextCompleteness(context) {
      const requiredFields = ['profile', 'currentLevels', 'supportNeeds'];
      const availableFields = requiredFields.filter(field => context[field] && Object.keys(context[field]).length > 0);
      return Math.round((availableFields.length / requiredFields.length) * 100);
    },
    
    /**
     * í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
     */
    calculateQualityScore(result, context) {
      let score = 0;
      
      // ê¸°ë³¸ ì ìˆ˜ (50ì )
      score += 50;
      
      // ì»¨í…ìŠ¤íŠ¸ ì™„ì„±ë„ ë°˜ì˜ (30ì )
      score += (result.contextUsage.contextCompleteness / 100) * 30;
      
      // ì½˜í…ì¸  ê¸¸ì´ ì ì ˆì„± (10ì )
      const contentLength = result.generatedContent ? result.generatedContent.length : 0;
      if (contentLength > 100 && contentLength < 5000) {
        score += 10;
      }
      
      // UTF-8 ì•ˆì „ì„± (10ì )
      if (result.validateUTF8()) {
        score += 10;
      }
      
      return Math.min(Math.round(score), 100);
    },
    
    /**
     * ì‹ ë¢°ë„ ê³„ì‚°
     */
    calculateConfidenceLevel(result) {
      // ê¸°ë³¸ ì‹ ë¢°ë„ëŠ” í’ˆì§ˆ ì ìˆ˜ ê¸°ë°˜
      let confidence = result.qualityScore;
      
      // ë©”íƒ€ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€ ì ìˆ˜
      if (result.metadata && result.metadata.totalTokens > 0) {
        confidence += 5;
      }
      
      // ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ë„ê°€ ë†’ìœ¼ë©´ ì¶”ê°€ ì ìˆ˜
      if (result.contextUsage && result.contextUsage.contextCompleteness > 80) {
        confidence += 10;
      }
      
      return Math.min(Math.round(confidence), 100);
    },
    
    /**
     * ìƒì„± ì´ë ¥ ì €ì¥
     */
    async saveGenerationHistory(historyData) {
      try {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) return;
        
        const { error } = await window.supabase
          .from('ai_generation_history')
          .insert({
            student_id: historyData.studentId,
            user_id: user.id,
            service_type: this.serviceType,
            result_id: historyData.result.id,
            processing_time: historyData.processingTime,
            quality_score: historyData.result.qualityScore,
            confidence_level: historyData.result.confidenceLevel,
            created_at: new Date().toISOString()
          });
        
        if (error) {
          console.warn('ìƒì„± ì´ë ¥ ì €ì¥ ì‹¤íŒ¨:', error);
          // ë¹„ì¹˜ëª…ì  ì˜¤ë¥˜ì´ë¯€ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ
        }
      } catch (error) {
        console.warn('ìƒì„± ì´ë ¥ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
      }
    },

    
    /**
     * ìœ í‹¸ë¦¬í‹°: sleep í•¨ìˆ˜
     */
    sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    },
    
    /**
     * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    setupEventListeners() {
      // ì»´í¬ë„ŒíŠ¸ ì •ë¦¬ ì‹œ ë¦¬ì†ŒìŠ¤ í•´ì œ
      this.$nextTick(() => {
        if (this.$el) {
          this.$el.addEventListener('beforeunload', () => {
            this.cleanup();
          });
        }
      });
    },
    
    /**
     * ë¦¬ì†ŒìŠ¤ ì •ë¦¬
     */
    cleanup() {
      this.isLoading = false;
      this.error = null;
      this.result = null;
      this.progress = 0;
    }
  };
}

/**
 * AI ìƒì„± ì„œë¹„ìŠ¤ íŒ©í† ë¦¬ í•¨ìˆ˜
 * íŠ¹ì • ì„œë¹„ìŠ¤ íƒ€ì…ì— ë§ëŠ” ì»´í¬ë„ŒíŠ¸ ìƒì„±
 */
function createAIService(serviceType) {
  const baseService = aiGenerationService();
  baseService.serviceType = serviceType;
  
  // ì„œë¹„ìŠ¤ë³„ íŠ¹í™” ë¡œì§ ì¶”ê°€
  switch (serviceType) {
    case AI_SERVICE_TYPES.CURRICULUM_ASSIGNMENT:
      return { ...baseService, ...curriculumAssignmentExtensions() };
    case AI_SERVICE_TYPES.LESSON_PLAN:
      return { ...baseService, ...lessonPlanExtensions() };
    case AI_SERVICE_TYPES.ASSESSMENT:
      return { ...baseService, ...assessmentExtensions() };
    case AI_SERVICE_TYPES.ADMIN_DOCUMENT:
      return { ...baseService, ...adminDocumentExtensions() };
    case AI_SERVICE_TYPES.COUNSELING_GUIDE:
      return { ...baseService, ...counselingGuideExtensions() };
    default:
      return baseService;
  }
}

/**
 * ì„œë¹„ìŠ¤ë³„ í™•ì¥ í•¨ìˆ˜ë“¤ (ê°ê° ë³„ë„ë¡œ êµ¬í˜„)
 */
function curriculumAssignmentExtensions() {
  return {
    // êµìœ¡ê³¼ì • ë°°ì • íŠ¹í™” ë¡œì§
    async mapDataForService(context, requestData) {
      const mappedData = createServiceSpecificMappedData(AI_SERVICE_TYPES.CURRICULUM_ASSIGNMENT);
      mappedData.currentLevel = context.currentLevels?.overall || 'beginner';
      mappedData.preferredSubjects = context.preferences?.subjects || [];
      mappedData.learningPace = context.analytics?.averagePace || 'normal';
      return mappedData;
    }
  };
}

function lessonPlanExtensions() {
  return {
    // êµìœ¡ê³„íš ìˆ˜ë¦½ íŠ¹í™” ë¡œì§
    async mapDataForService(context, requestData) {
      const mappedData = createServiceSpecificMappedData(AI_SERVICE_TYPES.LESSON_PLAN);
      mappedData.targetSkills = context.goals?.targetSkills || [];
      mappedData.teachingMethods = context.preferences?.teachingMethods || [];
      mappedData.sessionDuration = context.preferences?.sessionDuration || 30;
      return mappedData;
    }
  };
}

function assessmentExtensions() {
  return {
    // êµìœ¡í‰ê°€ íŠ¹í™” ë¡œì§
    async mapDataForService(context, requestData) {
      const mappedData = createServiceSpecificMappedData(AI_SERVICE_TYPES.ASSESSMENT);
      mappedData.assessmentHistory = context.assessments?.recent || [];
      mappedData.strengthAreas = context.analytics?.strengths || [];
      mappedData.improvementAreas = context.analytics?.improvements || [];
      return mappedData;
    }
  };
}

function adminDocumentExtensions() {
  return {
    // í–‰ì •ë¬¸ì„œ íŠ¹í™” ë¡œì§
    async mapDataForService(context, requestData) {
      const mappedData = createServiceSpecificMappedData(AI_SERVICE_TYPES.ADMIN_DOCUMENT);
      mappedData.documentType = requestData.additionalContext?.documentType || 'report';
      mappedData.targetAudience = requestData.additionalContext?.audience || 'parents';
      mappedData.formalityLevel = requestData.additionalContext?.formality || 'professional';
      return mappedData;
    }
  };
}

function counselingGuideExtensions() {
  return {
    // ìƒë‹´ê°€ì´ë“œ íŠ¹í™” ë¡œì§
    async mapDataForService(context, requestData) {
      const mappedData = createServiceSpecificMappedData(AI_SERVICE_TYPES.COUNSELING_GUIDE);
      mappedData.behaviorPatterns = context.observations?.behaviors || [];
      mappedData.emotionalState = context.wellbeing?.currentState || 'stable';
      mappedData.socialInteractions = context.social?.interactions || [];
      return mappedData;
    }
  };
}
  
```

### 9.2.3 ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (Alpine.js/JavaScript ê¸°ë°˜)

```javascript
/**
 * AI ìƒì„± ì„œë¹„ìŠ¤ ìœ í‹¸ë¦¬í‹° í•¨ì•¨ë“¤
 * UTF-8 ì•ˆì „ì„±, ì ‘ê·¼ì„±, ì„±ëŠ¥ ìµœì í™” ê³ ë ¤
 */
const aiServiceUtils = {
  /**
   * Supabaseë¥¼ í†µí•œ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥
   */
  async saveContextUsage(studentId, context, mappedData, result, serviceType) {
    try {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return;
      
      const contextUsage = {
        student_id: studentId,
        user_id: user.id,
        service_type: serviceType,
        generation_id: result.id,
        context_snapshot: {
          profile: {
            id: context.profile?.id,
            name: context.profile?.name,
            grade: context.profile?.grade,
            disabilityType: context.profile?.disabilityType,
            buildTimestamp: context.buildTimestamp
          },
          dataCompleteness: context.dataCompleteness,
          individualizedElements: result.contextUsage?.individualizedElements || []
        },
        mapped_data: {
          serviceType: mappedData.serviceType,
          dataQuality: mappedData.dataQuality,
          mappedAt: mappedData.mappedAt
        },
        context_influence_score: this.calculateContextInfluenceScore(context, result),
        data_sources: result.contextUsage?.dataSourcesUsed || []
      };
      
      const { error } = await window.supabase
        .from('ai_generation_contexts')
        .insert(contextUsage);
      
      if (error) {
        console.warn('ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥ ì‹¤íŒ¨:', error);
        // ë¹„ì¹˜ëª…ì  ì˜¤ë¥˜ì´ë¯€ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ
      }
      
    } catch (error) {
      console.warn('ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
    }
  },
  
  
  /**
   * Supabase Edge Functionsë¥¼ í†µí•œ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   */
  async collectPerformanceMetrics(result, totalTime, retryCount, serviceType) {
    try {
      const metrics = {
        service_type: serviceType,
        student_id: result.studentId,
        generation_id: result.id,
        total_processing_time: totalTime,
        ai_processing_time: result.metadata?.processingTime || 0,
        retry_count: retryCount,
        quality_score: result.qualityScore,
        confidence_level: result.confidenceLevel,
        token_usage: {
          prompt_tokens: result.metadata?.promptTokens || 0,
          completion_tokens: result.metadata?.completionTokens || 0,
          total_tokens: result.metadata?.totalTokens || 0
        },
        context_completeness: result.contextUsage?.contextCompleteness || 0,
        individualized_elements_count: result.contextUsage?.individualizedElements?.length || 0,
        timestamp: new Date().toISOString()
      };
      
      // Supabase Edge Functionì„ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ (ì„±ëŠ¥ì— ì˜í–¥ ì—†ë„ë¡)
      window.supabase.functions.invoke('collect-ai-metrics', {
        body: metrics
      }).catch(error => {
        console.warn('ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
      });
      
    } catch (error) {
      console.warn('ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
    }
  },
  
  
  /**
   * ì§€ìˆ˜ ë°±ì˜¤í”„ ê¸°ë°˜ ì¬ì‹œë„ ëŒ€ê¸°
   */
  async waitForRetry(retryCount) {
    const baseDelay = 1000; // 1ì´ˆ
    const maxDelay = 10000; // 10ì´ˆ
    const delay = Math.min(baseDelay * Math.pow(2, retryCount - 1), maxDelay);
    
    return new Promise(resolve => setTimeout(resolve, delay));
  },
  
  
  /**
   * ìš”ì²­ ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ìµœì  AI ëª¨ë¸ ì„ íƒ
   */
  getOptimalModel(requestData) {
    switch (requestData.priority) {
      case 'urgent':
      case 'high':
        return 'gpt-4-turbo';
      case 'normal':
        return 'gpt-4';
      case 'low':
        return 'gpt-3.5-turbo';
      default:
        return 'gpt-4';
    }
  },
  
  
  /**
   * ì„œë¹„ìŠ¤ íƒ€ì…ë³„ ìµœì  AI ì˜¨ë„ ì„¤ì •
   */
  getOptimalTemperature(serviceType) {
    switch (serviceType) {
      case AI_SERVICE_TYPES.CURRICULUM_ASSIGNMENT:
        return 0.3; // ë†’ì€ ì •í™•ì„± í•„ìš”
      case AI_SERVICE_TYPES.LESSON_PLAN:
        return 0.7; // ì°½ì˜ì„±ê³¼ ì •í™•ì„± ê· í˜•
      case AI_SERVICE_TYPES.ASSESSMENT:
        return 0.2; // ë§¤ìš° ë†’ì€ ì •í™•ì„± í•„ìš”
      case AI_SERVICE_TYPES.ADMIN_DOCUMENT:
        return 0.1; // ìµœëŒ€ ì •í™•ì„± í•„ìš”
      case AI_SERVICE_TYPES.COUNSELING_GUIDE:
        return 0.8; // ê³µê°ê³¼ ì°½ì˜ì„± í•„ìš”
      default:
        return 0.7;
    }
  },
  
  
  /**
   * ì„œë¹„ìŠ¤ íƒ€ì…ë³„ ìµœì  ìµœëŒ€ í† í° ì„¤ì •
   */
  getOptimalMaxTokens(serviceType) {
    switch (serviceType) {
      case AI_SERVICE_TYPES.CURRICULUM_ASSIGNMENT:
        return 1000;
      case AI_SERVICE_TYPES.LESSON_PLAN:
        return 2000;
      case AI_SERVICE_TYPES.ASSESSMENT:
        return 1500;
      case AI_SERVICE_TYPES.ADMIN_DOCUMENT:
        return 3000;
      case AI_SERVICE_TYPES.COUNSELING_GUIDE:
        return 2500;
      default:
        return 2000;
    }
  },
  
  
  /**
   * HTTP ìƒíƒœ ì½”ë“œë¥¼ AI ìƒì„± ì—ëŸ¬ ì½”ë“œë¡œ ë§¤í•‘
   */
  mapHttpStatusToErrorCode(status) {
    switch (status) {
      case 400:
        return 'BAD_REQUEST';
      case 401:
        return 'UNAUTHORIZED';
      case 403:
        return 'FORBIDDEN';
      case 404:
        return 'NOT_FOUND';
      case 429:
        return 'RATE_LIMITED';
      case 500:
        return 'INTERNAL_SERVER_ERROR';
      case 502:
        return 'BAD_GATEWAY';
      case 503:
        return 'SERVICE_UNAVAILABLE';
      case 504:
        return 'GATEWAY_TIMEOUT';
      default:
        return 'HTTP_ERROR';
    }
  }
  
  /**
   * ë§¤í•‘ ë°ì´í„°ì—ì„œ í•µì‹¬ ë§¤í•‘ ì •ë³´ ì¶”ì¶œ
   */
  extractKeyMappings(mappedData) {
    const keyMappings = {};
    
    // ê³µí†µ í•„ë“œ ì¶”ì¶œ
    Object.keys(mappedData).forEach(key => {
      if (key !== 'serviceType' && key !== 'mappedAt' && key !== 'dataQuality') {
        keyMappings[key] = typeof mappedData[key] === 'object' 
          ? Object.keys(mappedData[key]).length 
          : mappedData[key];
      }
    });
    
    return keyMappings;
  }
  
  /**
   * ì»¨í…ìŠ¤íŠ¸ ì˜í–¥ë„ ì ìˆ˜ ê³„ì‚°
   */
  calculateContextInfluenceScore(context, result) {
    let score = 0;
    
    // ë°ì´í„° ì™„ì „ì„± ê¸°ë°˜ ì ìˆ˜ (40%)
    score += (context.dataCompleteness.overall / 100) * 0.4;
    
    // ê°œë³„í™” ìš”ì†Œ ë°˜ì˜ ì ìˆ˜ (30%)
    const individualizedCount = result.contextUsage.individualizedElements.length;
    score += Math.min(individualizedCount / 10, 1) * 0.3;
    
    // ì§€ì› ìš”êµ¬ì‚¬í•­ ë°˜ì˜ ì ìˆ˜ (20%)
    const supportNeedsCount = result.contextUsage.supportNeedsAddressed.length;
    score += Math.min(supportNeedsCount / 5, 1) * 0.2;
    
    // ì ì‘ ì „ëµ ì ìš© ì ìˆ˜ (10%)
    const adaptationsCount = result.contextUsage.adaptationsApplied.length;
    score += Math.min(adaptationsCount / 3, 1) * 0.1;
    
    return Math.round(score * 100) / 100; // ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€
  }
  
  /**
   * ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Alpine.js ì»´í¬ë„ŒíŠ¸ cleanup)
   */
  destroy() {
    if (this.studentContextBuilder) {
      this.studentContextBuilder.destroy();
    }
    
    // Alpine.js ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    document.removeEventListener('alpine:cleanup', this.cleanup);
  }
}

/**
 * ì†ë„ ì œí•œ í´ë˜ìŠ¤ (Alpine.js/JavaScript ë²„ì „)
 * ê° ì‚¬ìš©ìì˜ API ìš”ì²­ ë¹ˆë„ë¥¼ ì œí•œí•˜ì—¬ ì„œë²„ ê³¼ë¶€í•˜ ë°©ì§€
 */
class RateLimiter {
  constructor(options = { maxRequests: 10, windowMs: 60000 }) {
    this.requests = new Map(); // ì‚¬ìš©ìë³„ ìš”ì²­ íˆìŠ¤í† ë¦¬
    this.maxRequests = options.maxRequests; // ìµœëŒ€ ìš”ì²­ ìˆ˜
    this.windowMs = options.windowMs; // ì‹œê°„ ìœˆë„ìš° (ms)
    
    // ì •ë¦¬ ì‘ì—… ì‹œì‘ (ë§¤ ìœˆë„ìš°ë§ˆë‹¤ ë§Œë£Œëœ ìš”ì²­ ì‚­ì œ)
    this.cleanupInterval = setInterval(() => this.cleanup(), this.windowMs);
  }
  
  /**
   * ì†ë„ ì œí•œ í™•ì¸ (ë¹„ë™ê¸°)
   * @param {string} identifier - ì‚¬ìš©ì ì‹ë³„ì (ì˜ˆ: ì‚¬ìš©ì ID ë˜ëŠ” IP)
   * @throws {AIGenerationError} ì†ë„ ì œí•œ ì´ˆê³¼ ì‹œ ì—ëŸ¬ ë°œìƒ
   */
  async checkLimit(identifier) {
    // UTF-8 ì•ˆì „ì„± ê²€ì¦
    if (!this.validateUTF8String(identifier)) {
      throw new Error('ì‚¬ìš©ì ì‹ë³„ì ì¸ì½”ë”© ì˜¤ë¥˜');
    }
    
    const now = Date.now();
    const userRequests = this.requests.get(identifier) || [];
    
    // ìœˆë„ìš° ë‚´ ìš”ì²­ë§Œ í•„í„°ë§ (ìµœê·¼ ìš”ì²­ë“¤ë§Œ ìœ ì§€)
    const recentRequests = userRequests.filter(
      timestamp => now - timestamp < this.windowMs
    );
    
    // ì†ë„ ì œí•œ ì´ˆê³¼ í™•ì¸
    if (recentRequests.length >= this.maxRequests) {
      const errorMessage = `ì†ë„ ì œí•œ ì´ˆê³¼: ${this.maxRequests}ê°œ ìš”ì²­/${Math.round(this.windowMs/1000)}ì´ˆ ë‚´ì—ì„œ`;
      
      throw new AIGenerationError(
        errorMessage,
        'CURRICULUM_ASSIGNMENT', // ê¸°ë³¸ ì„œë¹„ìŠ¤ íƒ€ì…
        'RATE_LIMITED',
        { 
          identifier: identifier.substring(0, 8) + '***', // ê°œì¸ì •ë³´ ë³´í˜¸
          requestCount: recentRequests.length,
          windowMs: this.windowMs,
          maxRequests: this.maxRequests
        },
        false // ì¬ì‹œë„ ë¶ˆê°€
      );
    }
    
    // ìƒˆ ìš”ì²­ ì¶”ê°€
    recentRequests.push(now);
    this.requests.set(identifier, recentRequests);
    
    // ì ‘ê·¼ì„±: ìŠ¤í¬ë¦° ë¦¬ë”ìš© ìƒíƒœ ì•Œë¦¼
    this.announceRateStatus(identifier, recentRequests.length);
  }
  
  /**
   * ë§Œë£Œëœ ìš”ì²­ ì •ë¦¬ (ë‚´ë¶€ ë©”ì„œë“œ)
   */
  cleanup() {
    const now = Date.now();
    const initialSize = this.requests.size;
    
    // ëª¨ë“  ì‚¬ìš©ìì˜ ìš”ì²­ íˆìŠ¤í† ë¦¬ ê²€ì‚¬
    for (const [identifier, requests] of this.requests.entries()) {
      const recentRequests = requests.filter(
        timestamp => now - timestamp < this.windowMs
      );
      
      // ìµœê·¼ ìš”ì²­ì´ ì—†ìœ¼ë©´ ì‚¬ìš©ì ì‚­ì œ, ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
      if (recentRequests.length === 0) {
        this.requests.delete(identifier);
      } else {
        this.requests.set(identifier, recentRequests);
      }
    }
    
    // ë””ë²„ê¹…ìš© ë¡œê·¸ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
    if (process.env.NODE_ENV === 'development') {
      const finalSize = this.requests.size;
      console.log(`RateLimiter cleanup: ${initialSize} â†’ ${finalSize} users`);
    }
  }
  
  /**
   * UTF-8 ë¬¸ìì—´ ê²€ì¦ ìœ í‹¸ë¦¬í‹°
   * @param {string} str - ê²€ì¦í•  ë¬¸ìì—´
   * @returns {boolean} ìœ íš¨í•œ UTF-8 ë¬¸ìì—´ ì—¬ë¶€
   */
  validateUTF8String(str) {
    try {
      const encoded = new TextEncoder().encode(str);
      const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
      return decoded === str;
    } catch (error) {
      console.error('UTF-8 ì¸ì½”ë”© ê²€ì¦ ì‹¤íŒ¨:', error);
      return false;
    }
  }
  
  /**
   * ì ‘ê·¼ì„±: ìŠ¤í¬ë¦° ë¦¬ë”ë¥¼ ìœ„í•œ ì†ë„ ì œí•œ ìƒíƒœ ì•Œë¦¼
   * @param {string} identifier - ì‚¬ìš©ì ì‹ë³„ì
   * @param {number} currentRequests - í˜„ì¬ ìš”ì²­ ìˆ˜
   */
  announceRateStatus(identifier, currentRequests) {
    const remaining = this.maxRequests - currentRequests;
    const statusMessage = `API ìš”ì²­ ìƒíƒœ: ${currentRequests}/${this.maxRequests}ê°œ ì‚¬ìš©ë¨. ${remaining}ê°œ ë‚¨ìŒ`;
    
    // ARIA live regionì— ìƒíƒœ ì—…ë°ì´íŠ¸
    const statusElement = document.getElementById('rate-limit-status');
    if (statusElement) {
      statusElement.textContent = statusMessage;
      statusElement.setAttribute('aria-live', 'polite');
    }
  }
  
  /**
   * ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Alpine.js cleanup ì‹œ í˜¸ì¶œ)
   */
  destroy() {
    if (this.cleanupInterval) {
      clearInterval(this.cleanupInterval);
      this.cleanupInterval = null;
    }
    
    this.requests.clear();
    console.log('RateLimiter ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
  }
}

/**
 * AI ìƒì„± ì„œë¹„ìŠ¤ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (JavaScript/Alpine.js ë²„ì „)
 */
const AIGenerationUtils = {
  /**
   * Supabase Edge Functionì„ í†µí•œ AI API í˜¸ì¶œ
   * @param {string} functionName - Edge Function ì´ë¦„
   * @param {Object} payload - ìš”ì²­ ë°ì´í„°
   * @returns {Promise<Object>} AI ì‘ë‹µ ë°ì´í„°
   */
  async callSupabaseEdgeFunction(functionName, payload) {
    try {
      // UTF-8 ì•ˆì „ì„± ê²€ì¦
      if (!this.validateObjectUTF8(payload)) {
        throw new Error('ìš”ì²­ ë°ì´í„° UTF-8 ì¸ì½”ë”© ì˜¤ë¥˜');
      }
      
      const { data, error } = await supabase.functions.invoke(functionName, {
        body: JSON.stringify(payload),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${await supabase.auth.getSession().access_token}`
        }
      });

      if (error) {
        throw new Error(`AI API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
      }

      return data;
    } catch (error) {
      console.error('Edge Function í˜¸ì¶œ ì˜¤ë¥˜:', error);
      throw error;
    }
  },

  /**
   * ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥
   * @param {string} studentId - í•™ìƒ ID
   * @param {Object} context - í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„°
   * @param {Object} mappedData - ë§¤í•‘ëœ ë°ì´í„°
   * @param {Object} result - AI ìƒì„± ê²°ê³¼
   */
  async saveContextUsage(studentId, context, mappedData, result) {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      const { error } = await supabase.from('ai_generation_contexts').insert({
        student_id: studentId,
        user_id: user?.id,
        service_type: result.serviceType || 'unknown',
        generation_id: result.generationId,
        context_snapshot: context,
        mapped_data: mappedData,
        context_influence_score: result.contextInfluenceScore || 0.8,
        data_sources: this.extractDataSources(context)
      });
      
      if (error) {
        throw new Error(`ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
    } catch (error) {
      console.error('ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì´ë ¥ ì €ì¥ ì˜¤ë¥˜:', error);
      // ë¹„ì¤‘ìš”í•œ ì˜¤ë¥˜ì´ë¯€ë¡œ ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ
    }
  },

  /**
   * ì‚¬ìš©ëœ ë°ì´í„° ì†ŒìŠ¤ ì¶”ì¶œ
   * @param {Object} context - í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„°
   * @returns {Array<string>} ë°ì´í„° ì†ŒìŠ¤ ëª©ë¡
   */
  extractDataSources(context) {
    const sources = [];
    
    if (context.profile) sources.push('student_profile');
    if (context.currentLevels && Object.keys(context.currentLevels).length > 0) {
      sources.push('current_levels');
    }
    if (context.recentAssessments?.length > 0) sources.push('recent_assessments');
    if (context.counselingHistory?.length > 0) sources.push('counseling_history');
    if (context.medicalInfo?.diagnosis?.length > 0) sources.push('medical_info');
    
    return sources;
  },
  
  /**
   * ê°ì²´ì˜ UTF-8 ì•ˆì „ì„± ê²€ì¦
   * @param {Object} obj - ê²€ì¦í•  ê°ì²´
   * @returns {boolean} ì•ˆì „í•œ UTF-8 ê°ì²´ ì—¬ë¶€
   */
  validateObjectUTF8(obj) {
    try {
      const jsonString = JSON.stringify(obj);
      const encoded = new TextEncoder().encode(jsonString);
      const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
      return JSON.parse(decoded) !== null;
    } catch (error) {
      console.error('ê°ì²´ UTF-8 ê²€ì¦ ì‹¤íŒ¨:', error);
      return false;
    }
  }
};
```

### 9.2.2 í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë¹Œë” (Alpine.js/JavaScript êµ¬ì¡°)

#### ë°ì´í„° íŒ©í† ë¦¬ í•¨ìˆ˜ë“¤
```javascript
/**
 * ìºì‹œëœ ì»¨í…ìŠ¤íŠ¸ íŒ©í† ë¦¬ í•¨ìˆ˜
 * @param {Object} context - í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ê°ì²´
 * @param {number} ttl - ìºì‹œ ìœ íš¨ ì‹œê°„ (ë°€ë¦¬ì´ˆ, ê¸°ë³¸ê°’: 30ë¶„)
 * @returns {Object} ìºì‹œëœ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°
 */
function createCachedContext(context, ttl = 1800000) {
  const now = Date.now();
  return {
    context,
    expires: now + ttl,
    lastAccessed: now,
    createdAt: now,
    
    // ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬
    isValid() {
      return Date.now() < this.expires;
    },
    
    // ì ‘ê·¼ ì‹œê°„ ì—…ë°ì´íŠ¸
    touch() {
      this.lastAccessed = Date.now();
    }
  };
}

/**
 * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ íŒ©í† ë¦¬ í•¨ìˆ˜ (UTF-8 ì•ˆì „ì„± í¬í•¨)
 * @param {Object} profile - í•™ìƒ í”„ë¡œí•„
 * @param {Object} currentLevels - í˜„í–‰ ìˆ˜ì¤€ ë°ì´í„°
 * @param {Array} recentAssessments - ìµœê·¼ í‰ê°€ ëª©ë¡
 * @param {Object} individualization - ê°œë³„í™” ë°ì´í„°
 * @param {Array} counselingHistory - ìƒë‹´ ì´ë ¥
 * @param {Object} medicalInfo - ì˜ë£Œ ì •ë³´
 * @returns {Object} í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°
 */
function createStudentContext({
  profile,
  currentLevels = {},
  recentAssessments = [],
  individualization = null,
  counselingHistory = [],
  medicalInfo = null
}) {
  return {
    profile,
    currentLevels,
    recentAssessments,
    individualization: individualization || createIndividualizationData({}),
    counselingHistory,
    medicalInfo: medicalInfo || createMedicalInfo({}),
    buildTimestamp: new Date().toISOString(),
    dataCompleteness: calculateDataCompleteness({
      profile,
      currentLevels,
      recentAssessments,
      individualization,
      counselingHistory,
      medicalInfo
    }),
    
    // UTF-8 ì•ˆì „ì„± ê²€ì¦
    validateEncoding() {
      try {
        const jsonString = JSON.stringify(this);
        const encoded = new TextEncoder().encode(jsonString);
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
        return JSON.parse(decoded) !== null;
      } catch (error) {
        console.error('í•™ìƒ ì»¨í…ìŠ¤íŠ¸ UTF-8 ê²€ì¦ ì‹¤íŒ¨:', error);
        return false;
      }
    }
  };
}

/**
 * í•™ìƒ í”„ë¡œí•„ íŒ©í† ë¦¬ í•¨ìˆ˜ (UTF-8 ì•ˆì „ì„± í¬í•¨)
 */
function createStudentProfile(data = {}) {
  return {
    id: data.id || '',
    name: data.name || '',
    birthDate: data.birthDate || null,
    gender: data.gender || 'unknown', // 'male', 'female', 'other', 'unknown'
    grade: data.grade || 1,
    className: data.className || '',
    disabilityType: data.disabilityType || [],
    disabilityLevel: data.disabilityLevel || 'unknown', // 'mild', 'moderate', 'severe', 'unknown'
    supportNeeds: data.supportNeeds || [],
    learningStyle: data.learningStyle || [],
    strengths: data.strengths || [],
    challenges: data.challenges || [],
    accommodationNeeds: data.accommodationNeeds || [],
    medicalConditions: data.medicalConditions || [],
    emergencyContact: data.emergencyContact || null,
    parentInfo: data.parentInfo || null,
    createdAt: data.createdAt || new Date().toISOString(),
    updatedAt: data.updatedAt || new Date().toISOString(),
    
    // í•œê¸€ ë°ì´í„° UTF-8 ì•ˆì „ì„± ê²€ì¦
    validateUTF8() {
      const textFields = [this.name, this.className, ...this.strengths, ...this.challenges];
      return textFields.every(field => {
        if (!field) return true;
        try {
          const encoded = new TextEncoder().encode(field);
          const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
          return decoded === field;
        } catch { return false; }
      });
    }
  };
}

/**
 * í˜„í–‰ìˆ˜ì¤€ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createCurrentLevel(data = {}) {
  return {
    id: data.id || '',
    studentId: data.studentId || '',
    subject: data.subject || '',
    academicLevel: data.academicLevel || '',
    detailedLevel: data.detailedLevel || '',
    assessmentDate: data.assessmentDate || new Date().toISOString().split('T')[0],
    assessmentMethod: data.assessmentMethod || '',
    strengths: data.strengths || [],
    areasForImprovement: data.areasForImprovement || [],
    notes: data.notes || null,
    createdAt: data.createdAt || new Date().toISOString(),
    updatedAt: data.updatedAt || new Date().toISOString()
  };
}

/**
 * í‰ê°€ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createAssessment(data = {}) {
  return {
    id: data.id || '',
    studentId: data.studentId || '',
    subject: data.subject || '',
    evaluationMonth: data.evaluationMonth || new Date().toISOString().substring(0, 7),
    achievementLevel: data.achievementLevel || '',
    detailedEvaluation: data.detailedEvaluation || '',
    strengths: data.strengths || [],
    areasForImprovement: data.areasForImprovement || [],
    nextMonthGoals: data.nextMonthGoals || [],
    teacherNotes: data.teacherNotes || null,
    createdAt: data.createdAt || new Date().toISOString(),
    updatedAt: data.updatedAt || new Date().toISOString()
  };
}

/**
 * ìƒë‹´ ê¸°ë¡ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createCounselingRecord(data = {}) {
  return {
    id: data.id || '',
    studentId: data.studentId || '',
    counselingDate: data.counselingDate || new Date().toISOString().split('T')[0],
    counselingType: data.counselingType || '',
    participants: data.participants || [],
    mainTopics: data.mainTopics || [],
    keyInsights: data.keyInsights || [],
    actionItems: data.actionItems || [],
    followUpNeeded: data.followUpNeeded || false,
    emotionalState: data.emotionalState || null,
    behavioralObservations: data.behavioralObservations || [],
    recommendations: data.recommendations || [],
    createdAt: data.createdAt || new Date().toISOString(),
    updatedAt: data.updatedAt || new Date().toISOString()
  };
}

/**
 * ì˜ë£Œ ì •ë³´ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createMedicalInfo(data = {}) {
  return {
    conditions: data.conditions || [],
    medications: data.medications || [],
    allergies: data.allergies || [],
    specialNeeds: data.specialNeeds || [],
    lastUpdated: data.lastUpdated || new Date().toISOString()
  };
}

/**
 * ê°œë³„í™” ë°ì´í„° íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createIndividualizationData(data = {}) {
  return {
    learningStyle: data.learningStyle || [],
    strengths: data.strengths || [],
    challenges: data.challenges || [],
    supportNeeds: data.supportNeeds || [],
    accommodationNeeds: data.accommodationNeeds || [],
    learningPreferences: data.learningPreferences || createLearningPreferences({}),
    adaptationStrategies: data.adaptationStrategies || [],
    motivationalFactors: data.motivationalFactors || [],
    communicationStyle: data.communicationStyle || createCommunicationStyle({}),
    socialInteractionLevel: data.socialInteractionLevel || createSocialInteractionLevel({})
  };
}

/**
 * í•™ìŠµ ì„ í˜¸ë„ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createLearningPreferences(data = {}) {
  return {
    visualAids: data.visualAids || false,
    auditorySupport: data.auditorySupport || false,
    handsOnLearning: data.handsOnLearning || false,
    structuredEnvironment: data.structuredEnvironment || false,
    oneOnOneInstruction: data.oneOnOneInstruction || false,
    groupActivities: data.groupActivities || false,
    technologyAssisted: data.technologyAssisted || false,
    quietSpace: data.quietSpace || false
  };
}

/**
 * ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìŠ¤íƒ€ì¼ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createCommunicationStyle(data = {}) {
  return {
    verbalCommunication: data.verbalCommunication || 'basic', // 'none', 'basic', 'advanced'
    nonVerbalCues: data.nonVerbalCues || 'some', // 'none', 'some', 'many'
    assistiveTechnology: data.assistiveTechnology || [],
    preferredLanguage: data.preferredLanguage || 'korean',
    comprehensionLevel: data.comprehensionLevel || 'grade-appropriate' // 'below-grade', 'grade-appropriate', 'above-grade'
  };
}

/**
 * ì‚¬íšŒì  ìƒí˜¸ì‘ìš© ë ˆë²¨ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createSocialInteractionLevel(data = {}) {
  return {
    peerInteraction: data.peerInteraction || 'limited', // 'minimal', 'limited', 'moderate', 'high'
    adultInteraction: data.adultInteraction || 'moderate', // 'minimal', 'limited', 'moderate', 'high'
    groupParticipation: data.groupParticipation || 'with-support', // 'none', 'with-support', 'independent'
    socialSkillsLevel: data.socialSkillsLevel || 'developing' // 'emerging', 'developing', 'established'
  };
}

/**
 * ì§€ì› ìš”êµ¬ì‚¬í•­ íŒ©í† ë¦¬ í•¨ìˆ˜
 */
function createSupportNeed(data = {}) {
  return {
    type: data.type || '',
    description: data.description || '',
    priority: data.priority || 'medium', // 'low', 'medium', 'high'
    frequency: data.frequency || 'as-needed' // 'daily', 'weekly', 'monthly', 'as-needed'
  };
}

/**
 * ë°ì´í„° ì™„ì „ì„± ê³„ì‚° í•¨ìˆ˜ (Alpine.js í˜¸í™˜)
 * @param {Object} contextData - ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„°
 * @returns {Object} ë°ì´í„° ì™„ì „ì„± ì ìˆ˜
 */
function calculateDataCompleteness(contextData) {
  const scores = {};
  let totalScore = 0;
  let totalWeight = 0;
  
  // í”„ë¡œí•„ ì™„ì „ì„± (30% ê°€ì¤‘ì¹˜)
  if (contextData.profile) {
    const profileFields = ['name', 'grade', 'className', 'disabilityType', 'supportNeeds'];
    const completedFields = profileFields.filter(field => 
      contextData.profile[field] && 
      (Array.isArray(contextData.profile[field]) ? 
        contextData.profile[field].length > 0 : 
        contextData.profile[field].toString().trim() !== '')
    ).length;
    scores.profile = Math.round((completedFields / profileFields.length) * 100);
    totalScore += scores.profile * 0.3;
    totalWeight += 0.3;
  }
  
  // í˜„í–‰ìˆ˜ì¤€ ì™„ì „ì„± (25% ê°€ì¤‘ì¹˜)
  if (contextData.currentLevels) {
    const levelCount = Object.keys(contextData.currentLevels).length;
    scores.currentLevels = Math.min(levelCount * 20, 100); // 5ê³¼ëª© ì´ìƒì´ë©´ 100%
    totalScore += scores.currentLevels * 0.25;
    totalWeight += 0.25;
  }
  
  // ìµœê·¼ í‰ê°€ ì™„ì „ì„± (20% ê°€ì¤‘ì¹˜)
  if (contextData.recentAssessments) {
    scores.recentAssessments = Math.min(contextData.recentAssessments.length * 25, 100);
    totalScore += scores.recentAssessments * 0.2;
    totalWeight += 0.2;
  }
  
  // ê°œë³„í™” ë°ì´í„° ì™„ì „ì„± (15% ê°€ì¤‘ì¹˜)
  if (contextData.individualization) {
    const indivFields = ['learningStyle', 'strengths', 'challenges', 'accommodationNeeds'];
    const completedIndivFields = indivFields.filter(field =>
      contextData.individualization[field] && 
      contextData.individualization[field].length > 0
    ).length;
    scores.individualization = Math.round((completedIndivFields / indivFields.length) * 100);
    totalScore += scores.individualization * 0.15;
    totalWeight += 0.15;
  }
  
  // ìƒë‹´ ì´ë ¥ ì™„ì „ì„± (10% ê°€ì¤‘ì¹˜)
  if (contextData.counselingHistory) {
    scores.counselingHistory = Math.min(contextData.counselingHistory.length * 50, 100);
    totalScore += scores.counselingHistory * 0.1;
    totalWeight += 0.1;
  }
  
  return {
    ...scores,
    overall: totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0,
    lastCalculated: new Date().toISOString()
  };
}

/**
 * ì§€ì› ìš”êµ¬ì‚¬í•­ ë°ì´í„° êµ¬ì¡°
 * @typedef {Object} SupportNeed
 * @property {string} type - ì§€ì› ìœ í˜•
 * @property {string} description - ì§€ì› ì„¤ëª…
 * @property {'low'|'medium'|'high'} priority - ìš°ì„ ìˆœìœ„ (ë‚®ìŒ|ë³´í†µ|ë†’ìŒ)
 * @property {'daily'|'weekly'|'monthly'|'as-needed'} frequency - ì§€ì› ë¹ˆë„
 */

/**
 * í•™ìŠµ ì„ í˜¸ë„ ë°ì´í„° êµ¬ì¡°
 * @typedef {Object} LearningPreferences
 * @property {boolean} visualLearning - ì‹œê°ì  í•™ìŠµ ì„ í˜¸ë„
 * @property {boolean} auditoryLearning - ì²­ê°ì  í•™ìŠµ ì„ í˜¸ë„
 * @property {boolean} kinestheticLearning - ì‹ ì²´ì  í•™ìŠµ ì„ í˜¸ë„
 * @property {'slow'|'moderate'|'fast'} preferredPace - ì„ í˜¸ í•™ìŠµ ì†ë„
 * @property {'short'|'average'|'long'} attentionSpan - ì§‘ì¤‘ë ¥ ì§€ì†ì‹œê°„
 * @property {'independent'|'collaborative'|'guided'} workingStyle - í•™ìŠµ ìŠ¤íƒ€ì¼
 */

/**
 * ì ì‘ ì „ëµ ë°ì´í„° êµ¬ì¡°
 * @typedef {Object} AdaptationStrategy
 * @property {string} strategy - ì ì‘ ì „ëµëª…
 * @property {string} description - ì „ëµ ì„¤ëª…
 * @property {Array<string>} applicableSubjects - ì ìš© ê°€ëŠ¥í•œ ê³¼ëª© ëª©ë¡
  effectiveness: 'low' | 'medium' | 'high';
}

/**
 * ë™ê¸° ë¶€ì—¬ ìš”ì†Œ ì¸í„°í˜ì´ìŠ¤
 */
interface MotivationalFactor {
  factor: string;
  description: string;
  strength: 'low' | 'medium' | 'high';
}

/**
 * ì˜ì‚¬ì†Œí†µ ìŠ¤íƒ€ì¼ ì¸í„°í˜ì´ìŠ¤
 */
interface CommunicationStyle {
  preferredMethod: 'verbal' | 'visual' | 'written' | 'gestural';
  clarity: 'simple' | 'clear' | 'detailed';
  pace: 'slow' | 'moderate' | 'fast';
  supportNeeds: string[];
}

/**
 * ì‚¬íšŒì  ìƒí˜¸ì‘ìš© ìˆ˜ì¤€ ì¸í„°í˜ì´ìŠ¤
 */
interface SocialInteractionLevel {
  level: 'low' | 'moderate' | 'high';
  preferences: string[];
  challenges: string[];
  strengths: string[];
}

/**
 * ë°ì´í„° ì™„ì „ì„± ì¸í„°í˜ì´ìŠ¤
 */
interface DataCompleteness {
  overall: number;
  breakdown: {
    profile: number;
    currentLevels: number;
    assessments: number;
    counseling: number;
    medicalInfo: number;
  };
  missingCriticalData: string[];
  recommendations: string[];
}

/**
 * ì—°ë½ì²˜ ì •ë³´ ì¸í„°í˜ì´ìŠ¤
 */
interface ContactInfo {
  name: string;
  relationship: string;
  phone: string;
  email?: string;
}

/**
 * ë¶€ëª¨ ì •ë³´ ì¸í„°í˜ì´ìŠ¤
 */
interface ParentInfo {
  father?: ContactInfo;
  mother?: ContactInfo;
  guardian?: ContactInfo;
}

/**
 * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ì—ëŸ¬ í´ë˜ìŠ¤
 */
class StudentContextError extends Error {
  public readonly code: string;
  public readonly context?: any;
  public readonly timestamp: string;

  constructor(message: string, code: string, context?: any) {
    super(message);
    this.name = 'StudentContextError';
    this.code = code;
    this.context = context;
    this.timestamp = new Date().toISOString();

    // Error í´ë˜ìŠ¤ ìƒì† ì‹œ í•„ìš”í•œ ì„¤ì •
    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, StudentContextError);
    }
  }

  /**
   * ì—ëŸ¬ ì •ë³´ë¥¼ JSON í˜•íƒœë¡œ ì§ë ¬í™”
   */
  toJSON() {
    return {
      name: this.name,
      message: this.message,
      code: this.code,
      context: this.context,
      timestamp: this.timestamp,
      stack: this.stack
    };
  }

  /**
   * ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„±
   */
  getUserFriendlyMessage(): string {
    switch (this.code) {
      case 'INVALID_STUDENT_ID':
        return 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ í•™ìƒ ì •ë³´ì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
      case 'STUDENT_NOT_FOUND':
        return 'í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      case 'CONTEXT_BUILD_FAILED':
        return 'í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      case 'AUTH_REQUIRED':
        return 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      default:
        return 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.';
    }
  }
}
```

#### êµ¬í˜„ í´ë˜ìŠ¤
```javascript
/**
 * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• ë° ìºì‹œ ê´€ë¦¬ í´ë˜ìŠ¤
 * ê³ ì„±ëŠ¥ ìºì‹±, ì™„ì „í•œ ì—ëŸ¬ ì²˜ë¦¬, ë©”ëª¨ë¦¬ ê´€ë¦¬ í¬í•¨
 */
class StudentContextBuilder {
  private memoryCache: Map<string, CachedContext> = new Map();
  private readonly CACHE_DURATION = 30 * 60 * 1000; // 30ë¶„
  private readonly MAX_CACHE_SIZE = 100; // ìµœëŒ€ ìºì‹œ í•­ëª© ìˆ˜
  private readonly CLEANUP_INTERVAL = 5 * 60 * 1000; // 5ë¶„ë§ˆë‹¤ ì •ë¦¬
  private cleanupTimer: NodeJS.Timeout | null = null;
  
  constructor() {
    this.startCacheCleanup();
  }

  /**
   * í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• (ìºì‹œ í™œìš©)
   * @param studentId í•™ìƒ ID
   * @param forceRefresh ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì—¬ë¶€
   * @returns í•™ìƒ ì»¨í…ìŠ¤íŠ¸
   */
  async buildContext(studentId: string, forceRefresh: boolean = false): Promise<StudentContext> {
    try {
      // ì…ë ¥ ê²€ì¦
      if (!studentId || typeof studentId !== 'string') {
        throw new StudentContextError('ìœ íš¨í•˜ì§€ ì•Šì€ í•™ìƒ IDì…ë‹ˆë‹¤.', 'INVALID_STUDENT_ID');
      }

      // ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹Œ ê²½ìš° ìºì‹œ í™•ì¸
      if (!forceRefresh) {
        // 1. ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸
        const memoryCached = this.getFromMemoryCache(studentId);
        if (memoryCached) {
          return memoryCached;
        }

        // 2. DB ìºì‹œ í™•ì¸
        const dbCached = await this.getFromDBCache(studentId);
        if (dbCached) {
          this.setMemoryCache(studentId, dbCached);
          return dbCached;
        }
      }

      // 3. ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶•
      const context = await this.buildFreshContext(studentId);
      
      // 4. ìºì‹œì— ì €ì¥ (ë³‘ë ¬ ì²˜ë¦¬)
      await Promise.all([
        this.saveToDBCache(studentId, context),
        Promise.resolve(this.setMemoryCache(studentId, context))
      ]);

      return context;
      
    } catch (error) {
      if (error instanceof StudentContextError) {
        throw error;
      }
      throw new StudentContextError(
        `í•™ìƒ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• ì‹¤íŒ¨: ${error.message}`,
        'CONTEXT_BUILD_FAILED',
        { studentId, originalError: error }
      );
    }
  }

  /**
   * ë©”ëª¨ë¦¬ ìºì‹œì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
   */
  private getFromMemoryCache(studentId: string): StudentContext | null {
    const cached = this.memoryCache.get(studentId);
    if (!cached) return null;

    // ë§Œë£Œ í™•ì¸
    if (cached.expires <= Date.now()) {
      this.memoryCache.delete(studentId);
      return null;
    }

    // ì ‘ê·¼ ì‹œê°„ ì—…ë°ì´íŠ¸ (LRU êµ¬í˜„)
    cached.lastAccessed = Date.now();
    return cached.context;
  }

  /**
   * ë©”ëª¨ë¦¬ ìºì‹œì— ì»¨í…ìŠ¤íŠ¸ ì €ì¥
   */
  private setMemoryCache(studentId: string, context: StudentContext): void {
    // ìºì‹œ í¬ê¸° ì œí•œ í™•ì¸
    if (this.memoryCache.size >= this.MAX_CACHE_SIZE) {
      this.evictLeastRecentlyUsed();
    }

    const now = Date.now();
    this.memoryCache.set(studentId, {
      context: this.deepClone(context), // ê¹Šì€ ë³µì‚¬ë¡œ ë¶ˆë³€ì„± ë³´ì¥
      expires: now + this.CACHE_DURATION,
      lastAccessed: now,
      createdAt: now
    });
  }

  /**
   * LRU ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ê°€ì¥ ì˜¤ë˜ëœ ìºì‹œ í•­ëª© ì œê±°
   */
  private evictLeastRecentlyUsed(): void {
    let oldestKey = '';
    let oldestTime = Date.now();

    for (const [key, cached] of this.memoryCache.entries()) {
      if (cached.lastAccessed < oldestTime) {
        oldestTime = cached.lastAccessed;
        oldestKey = key;
      }
    }

    if (oldestKey) {
      this.memoryCache.delete(oldestKey);
    }
  }

  /**
   * DB ìºì‹œì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
   */
  private async getFromDBCache(studentId: string): Promise<StudentContext | null> {
    try {
      const { data, error } = await supabase
        .from('student_context_cache')
        .select('context_data, context_version, expires_at')
        .eq('student_id', studentId)
        .eq('user_id', (await supabase.auth.getUser()).data.user?.id)
        .eq('is_valid', true)
        .gt('expires_at', new Date().toISOString())
        .order('created_at', { ascending: false })
        .limit(1)
        .single();

      if (error) {
        if (error.code === 'PGRST116') { // No rows found
          return null;
        }
        throw error;
      }

      if (!data?.context_data) {
        return null;
      }

      // ì»¨í…ìŠ¤íŠ¸ ë²„ì „ í˜¸í™˜ì„± í™•ì¸
      if (!this.isContextVersionCompatible(data.context_version)) {
        await this.invalidateDBCache(studentId);
        return null;
      }

      return this.validateAndSanitizeContext(data.context_data);
      
    } catch (error) {
      console.error('DB ìºì‹œ ì¡°íšŒ ì‹¤íŒ¨:', error);
      return null; // ìºì‹œ ì‹¤íŒ¨ ì‹œ ìƒˆë¡œ êµ¬ì¶•
    }
  }

  /**
   * DB ìºì‹œì— ì»¨í…ìŠ¤íŠ¸ ì €ì¥
   */
  private async saveToDBCache(studentId: string, context: StudentContext): Promise<void> {
    try {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) {
        throw new StudentContextError('ì‚¬ìš©ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'AUTH_REQUIRED');
      }

      // ê¸°ì¡´ ìºì‹œ ë¬´íš¨í™”
      await this.invalidateDBCache(studentId);

      // ìƒˆ ìºì‹œ ì €ì¥
      const { error } = await supabase
        .from('student_context_cache')
        .insert({
          student_id: studentId,
          user_id: user.id,
          context_data: context,
          context_version: '1.0',
          expires_at: new Date(Date.now() + this.CACHE_DURATION).toISOString(),
          last_updated_source: 'full_rebuild',
          is_valid: true
        });

      if (error) {
        throw error;
      }
      
    } catch (error) {
      console.error('DB ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
      // DB ìºì‹œ ì €ì¥ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ
    }
  }

  /**
   * ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶•
   */
  private async buildFreshContext(studentId: string): Promise<StudentContext> {
    try {
      // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ
      const [profile, currentLevels, assessments, counseling, medicalInfo] = await Promise.allSettled([
        this.getStudentProfile(studentId),
        this.getCurrentLevels(studentId),
        this.getRecentAssessments(studentId),
        this.getCounselingHistory(studentId),
        this.getMedicalInfo(studentId)
      ]);

      // ì‹¤íŒ¨í•œ ìš”ì²­ ì²˜ë¦¬
      const resolvedProfile = this.handleSettledResult(profile, 'profile');
      const resolvedCurrentLevels = this.handleSettledResult(currentLevels, 'currentLevels');
      const resolvedAssessments = this.handleSettledResult(assessments, 'assessments');
      const resolvedCounseling = this.handleSettledResult(counseling, 'counseling');
      const resolvedMedicalInfo = this.handleSettledResult(medicalInfo, 'medicalInfo');

      // ê°œë³„í™” ì •ë³´ ì¶”ì¶œ
      const individualization = this.extractIndividualization(
        resolvedProfile,
        resolvedCurrentLevels,
        resolvedAssessments
      );

      return {
        profile: resolvedProfile,
        currentLevels: this.mapCurrentLevelsBySubject(resolvedCurrentLevels),
        recentAssessments: resolvedAssessments,
        individualization,
        counselingHistory: resolvedCounseling,
        medicalInfo: resolvedMedicalInfo,
        buildTimestamp: new Date().toISOString(),
        dataCompleteness: this.calculateDataCompleteness({
          profile: resolvedProfile,
          currentLevels: resolvedCurrentLevels,
          assessments: resolvedAssessments,
          counseling: resolvedCounseling,
          medicalInfo: resolvedMedicalInfo
        })
      };
      
    } catch (error) {
      throw new StudentContextError(
        `ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶• ì‹¤íŒ¨: ${error.message}`,
        'FRESH_CONTEXT_BUILD_FAILED',
        { studentId }
      );
    }
  }

  /**
   * í•™ìƒ í”„ë¡œí•„ ì¡°íšŒ
   */
  private async getStudentProfile(studentId: string): Promise<StudentProfile> {
    const { data, error } = await supabase
      .from('students')
      .select(`
        id, name, birth_date, gender, grade, class_name,
        disability_type, disability_level, support_needs,
        learning_style, strengths, challenges,
        accommodation_needs, medical_conditions,
        emergency_contact, parent_info,
        created_at, updated_at
      `)
      .eq('id', studentId)
      .single();

    if (error) {
      throw new StudentContextError(
        `í•™ìƒ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`,
        'PROFILE_FETCH_FAILED',
        { studentId }
      );
    }

    if (!data) {
      throw new StudentContextError(
        'í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        'STUDENT_NOT_FOUND',
        { studentId }
      );
    }

    return {
      id: data.id,
      name: data.name,
      birthDate: data.birth_date,
      gender: data.gender,
      grade: data.grade,
      className: data.class_name,
      disabilityType: data.disability_type,
      disabilityLevel: data.disability_level,
      supportNeeds: data.support_needs || [],
      learningStyle: data.learning_style,
      strengths: data.strengths || [],
      challenges: data.challenges || [],
      accommodationNeeds: data.accommodation_needs || [],
      medicalConditions: data.medical_conditions || [],
      emergencyContact: data.emergency_contact,
      parentInfo: data.parent_info,
      createdAt: data.created_at,
      updatedAt: data.updated_at
    };
  }

  /**
   * í˜„í–‰ìˆ˜ì¤€ ì¡°íšŒ
   */
  private async getCurrentLevels(studentId: string): Promise<CurrentLevel[]> {
    const { data, error } = await supabase
      .from('current_levels')
      .select(`
        id, student_id, subject, academic_level,
        detailed_level, assessment_date, assessment_method,
        strengths, areas_for_improvement, notes,
        created_at, updated_at
      `)
      .eq('student_id', studentId)
      .order('assessment_date', { ascending: false });

    if (error) {
      throw new StudentContextError(
        `í˜„í–‰ìˆ˜ì¤€ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`,
        'CURRENT_LEVELS_FETCH_FAILED',
        { studentId }
      );
    }

    return (data || []).map(item => ({
      id: item.id,
      studentId: item.student_id,
      subject: item.subject,
      academicLevel: item.academic_level,
      detailedLevel: item.detailed_level,
      assessmentDate: item.assessment_date,
      assessmentMethod: item.assessment_method,
      strengths: item.strengths || [],
      areasForImprovement: item.areas_for_improvement || [],
      notes: item.notes,
      createdAt: item.created_at,
      updatedAt: item.updated_at
    }));
  }

  /**
   * ìµœê·¼ í‰ê°€ ì¡°íšŒ (ìµœê·¼ 3ê°œì›”)
   */
  private async getRecentAssessments(studentId: string): Promise<Assessment[]> {
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const { data, error } = await supabase
      .from('monthly_evaluations')
      .select(`
        id, student_id, subject, evaluation_month,
        achievement_level, detailed_evaluation,
        strengths, areas_for_improvement,
        next_month_goals, teacher_notes,
        created_at, updated_at
      `)
      .eq('student_id', studentId)
      .gte('evaluation_month', threeMonthsAgo.toISOString().slice(0, 7))
      .order('evaluation_month', { ascending: false });

    if (error) {
      throw new StudentContextError(
        `ìµœê·¼ í‰ê°€ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`,
        'ASSESSMENTS_FETCH_FAILED',
        { studentId }
      );
    }

    return (data || []).map(item => ({
      id: item.id,
      studentId: item.student_id,
      subject: item.subject,
      evaluationMonth: item.evaluation_month,
      achievementLevel: item.achievement_level,
      detailedEvaluation: item.detailed_evaluation,
      strengths: item.strengths || [],
      areasForImprovement: item.areas_for_improvement || [],
      nextMonthGoals: item.next_month_goals || [],
      teacherNotes: item.teacher_notes,
      createdAt: item.created_at,
      updatedAt: item.updated_at
    }));
  }

  /**
   * ìƒë‹´ ì´ë ¥ ì¡°íšŒ (ìµœê·¼ 6ê°œì›”)
   */
  private async getCounselingHistory(studentId: string): Promise<CounselingRecord[]> {
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

    const { data, error } = await supabase
      .from('counseling_records')
      .select(`
        id, student_id, counseling_date, counseling_type,
        participants, main_topics, key_insights,
        action_items, follow_up_needed,
        emotional_state, behavioral_observations,
        recommendations, created_at, updated_at
      `)
      .eq('student_id', studentId)
      .gte('counseling_date', sixMonthsAgo.toISOString())
      .order('counseling_date', { ascending: false });

    if (error) {
      throw new StudentContextError(
        `ìƒë‹´ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`,
        'COUNSELING_FETCH_FAILED',
        { studentId }
      );
    }

    return (data || []).map(item => ({
      id: item.id,
      studentId: item.student_id,
      counselingDate: item.counseling_date,
      counselingType: item.counseling_type,
      participants: item.participants || [],
      mainTopics: item.main_topics || [],
      keyInsights: item.key_insights || [],
      actionItems: item.action_items || [],
      followUpNeeded: item.follow_up_needed,
      emotionalState: item.emotional_state,
      behavioralObservations: item.behavioral_observations || [],
      recommendations: item.recommendations || [],
      createdAt: item.created_at,
      updatedAt: item.updated_at
    }));
  }

  /**
   * ì˜ë£Œ ì •ë³´ ì¡°íšŒ
   */
  private async getMedicalInfo(studentId: string): Promise<MedicalInfo> {
    // í•™ìƒ í”„ë¡œí•„ì—ì„œ ì˜ë£Œ ì •ë³´ ì¶”ì¶œ
    const profile = await this.getStudentProfile(studentId);
    
    return {
      conditions: profile.medicalConditions,
      medications: [], // í•„ìš”ì‹œ ë³„ë„ í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
      allergies: [], // í•„ìš”ì‹œ ë³„ë„ í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
      specialNeeds: profile.supportNeeds.filter(need => 
        need.type === 'medical' || need.type === 'health'
      ),
      lastUpdated: profile.updatedAt
    };
  }

  /**
   * ì»¨í…ìŠ¤íŠ¸ ë¬´íš¨í™”
   */
  async invalidateContext(studentId: string): Promise<void> {
    // ë©”ëª¨ë¦¬ ìºì‹œ ì œê±°
    this.memoryCache.delete(studentId);
    
    // DB ìºì‹œ ë¬´íš¨í™”
    await this.invalidateDBCache(studentId);
  }

  /**
   * DB ìºì‹œ ë¬´íš¨í™”
   */
  private async invalidateDBCache(studentId: string): Promise<void> {
    try {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) return;

      await supabase
        .from('student_context_cache')
        .update({ is_valid: false })
        .eq('student_id', studentId)
        .eq('user_id', user.id);
    } catch (error) {
      console.error('DB ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨:', error);
    }
  }

  /**
   * ì»¨í…ìŠ¤íŠ¸ ë²„ì „ í˜¸í™˜ì„± í™•ì¸
   */
  private isContextVersionCompatible(version: string): boolean {
    const currentVersion = '1.0';
    const supportedVersions = ['1.0'];
    return supportedVersions.includes(version);
  }

  /**
   * ì»¨í…ìŠ¤íŠ¸ ê²€ì¦ ë° ì‚´ê· í™”
   */
  private validateAndSanitizeContext(contextData: any): StudentContext {
    // ê¸°ë³¸ êµ¬ì¡° ê²€ì¦
    if (!contextData || typeof contextData !== 'object') {
      throw new StudentContextError('ì˜ëª»ëœ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.', 'INVALID_CONTEXT_FORMAT');
    }

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const requiredFields = ['profile', 'currentLevels', 'individualization'];
    for (const field of requiredFields) {
      if (!contextData[field]) {
        throw new StudentContextError(`í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${field}`, 'MISSING_REQUIRED_FIELD');
      }
    }

    return contextData as StudentContext;
  }

  /**
   * Promise.allSettled ê²°ê³¼ ì²˜ë¦¬
   */
  private handleSettledResult<T>(result: PromiseSettledResult<T>, dataType: string): T {
    if (result.status === 'fulfilled') {
      return result.value;
    } else {
      console.error(`${dataType} ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, result.reason);
      // ê¸°ë³¸ê°’ ë°˜í™˜ (ë°ì´í„° íƒ€ì…ì— ë”°ë¼)
      return this.getDefaultValueForDataType(dataType);
    }
  }

  /**
   * ë°ì´í„° íƒ€ì…ë³„ ê¸°ë³¸ê°’ ë°˜í™˜
   */
  private getDefaultValueForDataType(dataType: string): any {
    switch (dataType) {
      case 'profile':
        return {
          id: '',
          name: 'ì•Œ ìˆ˜ ì—†ìŒ',
          birthDate: null,
          gender: 'unknown',
          grade: 0,
          className: '',
          disabilityType: [],
          disabilityLevel: 'unknown',
          supportNeeds: [],
          learningStyle: [],
          strengths: [],
          challenges: [],
          accommodationNeeds: [],
          medicalConditions: [],
          emergencyContact: null,
          parentInfo: null,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
      case 'currentLevels':
      case 'assessments':
      case 'counseling':
        return [];
      case 'medicalInfo':
        return {
          conditions: [],
          medications: [],
          allergies: [],
          specialNeeds: [],
          lastUpdated: new Date().toISOString()
        };
      default:
        return null;
    }
  }

  /**
   * ê°œë³„í™” ì •ë³´ ì¶”ì¶œ
   */
  private extractIndividualization(
    profile: StudentProfile,
    currentLevels: CurrentLevel[],
    assessments: Assessment[]
  ): IndividualizationData {
    // ëª¨ë“  ê³¼ëª©ì˜ ê°•ì ê³¼ ì–´ë ¤ì›€ ì˜ì—­ ìˆ˜ì§‘
    const allStrengths = new Set<string>();
    const allChallenges = new Set<string>();
    
    // í”„ë¡œí•„ì—ì„œ ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
    profile.strengths.forEach(strength => allStrengths.add(strength));
    profile.challenges.forEach(challenge => allChallenges.add(challenge));
    
    // í˜„í–‰ìˆ˜ì¤€ì—ì„œ ì •ë³´ ì¶”ì¶œ
    currentLevels.forEach(level => {
      level.strengths.forEach(strength => allStrengths.add(strength));
      level.areasForImprovement.forEach(area => allChallenges.add(area));
    });
    
    // ìµœê·¼ í‰ê°€ì—ì„œ ì •ë³´ ì¶”ì¶œ
    assessments.forEach(assessment => {
      assessment.strengths.forEach(strength => allStrengths.add(strength));
      assessment.areasForImprovement.forEach(area => allChallenges.add(area));
    });

    // í•™ìŠµ ì„ í˜¸ë„ ë¶„ì„
    const learningPreferences = this.analyzeLearningPreferences(profile, assessments);
    
    // ì§€ì› ìš”êµ¬ì‚¬í•­ ë¶„ì„
    const supportNeeds = this.analyzeSupportNeeds(profile, currentLevels);
    
    // ì ì‘ ì „ëµ ì¶”ì²œ
    const adaptationStrategies = this.recommendAdaptationStrategies(
      profile, currentLevels, assessments
    );

    return {
      learningStyle: profile.learningStyle,
      strengths: Array.from(allStrengths),
      challenges: Array.from(allChallenges),
      supportNeeds,
      accommodationNeeds: profile.accommodationNeeds,
      learningPreferences,
      adaptationStrategies,
      motivationalFactors: this.identifyMotivationalFactors(assessments),
      communicationStyle: this.analyzeCommunicationStyle(profile),
      socialInteractionLevel: this.assessSocialInteractionLevel(profile)
    };
  }

  /**
   * í˜„í–‰ìˆ˜ì¤€ì„ ê³¼ëª©ë³„ë¡œ ë§¤í•‘
   */
  private mapCurrentLevelsBySubject(currentLevels: CurrentLevel[]): { [subject: string]: CurrentLevel } {
    const mapped: { [subject: string]: CurrentLevel } = {};
    
    // ê° ê³¼ëª©ë³„ë¡œ ê°€ì¥ ìµœê·¼ í‰ê°€ ì„ íƒ
    currentLevels.forEach(level => {
      const existing = mapped[level.subject];
      if (!existing || new Date(level.assessmentDate) > new Date(existing.assessmentDate)) {
        mapped[level.subject] = level;
      }
    });
    
    return mapped;
  }

  /**
   * ë°ì´í„° ì™„ì „ì„± ê³„ì‚°
   */
  private calculateDataCompleteness(data: {
    profile: StudentProfile;
    currentLevels: CurrentLevel[];
    assessments: Assessment[];
    counseling: CounselingRecord[];
    medicalInfo: MedicalInfo;
  }): DataCompleteness {
    const scores = {
      profile: this.calculateProfileCompleteness(data.profile),
      currentLevels: this.calculateCurrentLevelsCompleteness(data.currentLevels),
      assessments: this.calculateAssessmentsCompleteness(data.assessments),
      counseling: this.calculateCounselingCompleteness(data.counseling),
      medicalInfo: this.calculateMedicalInfoCompleteness(data.medicalInfo)
    };

    const overallScore = (scores.profile + scores.currentLevels + scores.assessments + scores.counseling + scores.medicalInfo) / 5;

    return {
      overall: overallScore,
      breakdown: scores,
      missingCriticalData: this.identifyMissingCriticalData(data),
      recommendations: this.generateDataImprovementRecommendations(scores)
    };
  }

  /**
   * ê¹Šì€ ë³µì‚¬ (ë¶ˆë³€ì„± ë³´ì¥)
   */
  private deepClone<T>(obj: T): T {
    if (obj === null || typeof obj !== 'object') return obj;
    if (obj instanceof Date) return new Date(obj.getTime()) as any;
    if (obj instanceof Array) return obj.map(item => this.deepClone(item)) as any;
    if (typeof obj === 'object') {
      const cloned: any = {};
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          cloned[key] = this.deepClone(obj[key]);
        }
      }
      return cloned;
    }
    return obj;
  }

  /**
   * ìºì‹œ ì •ë¦¬ ì‹œì‘
   */
  private startCacheCleanup(): void {
    this.cleanupTimer = setInterval(() => {
      this.cleanupExpiredCache();
    }, this.CLEANUP_INTERVAL);
  }

  /**
   * ë§Œë£Œëœ ìºì‹œ ì •ë¦¬
   */
  private cleanupExpiredCache(): void {
    const now = Date.now();
    const expiredKeys: string[] = [];

    for (const [key, cached] of this.memoryCache.entries()) {
      if (cached.expires <= now) {
        expiredKeys.push(key);
      }
    }

    expiredKeys.forEach(key => this.memoryCache.delete(key));
  }

  /**
   * ë¦¬ì†ŒìŠ¤ ì •ë¦¬
   */
  destroy(): void {
    if (this.cleanupTimer) {
      clearInterval(this.cleanupTimer);
      this.cleanupTimer = null;
    }
    this.memoryCache.clear();
  }

  // ì¶”ê°€ í—¬í¼ ë©”ì„œë“œë“¤ (ê°„ëµí™”ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ê¸°ë³¸ êµ¬í˜„ì²´ ì œê³µ)
  private analyzeLearningPreferences(profile: StudentProfile, assessments: Assessment[]): LearningPreferences {
    return {
      visualLearning: profile.learningStyle.includes('visual'),
      auditoryLearning: profile.learningStyle.includes('auditory'),
      kinestheticLearning: profile.learningStyle.includes('kinesthetic'),
      preferredPace: 'moderate',
      attentionSpan: 'average',
      workingStyle: 'independent'
    };
  }

  private analyzeSupportNeeds(profile: StudentProfile, currentLevels: CurrentLevel[]): SupportNeed[] {
    return profile.supportNeeds.map(need => ({
      type: need.type || 'general',
      description: need.description || '',
      priority: need.priority || 'medium',
      frequency: need.frequency || 'as-needed'
    }));
  }

  private recommendAdaptationStrategies(profile: StudentProfile, currentLevels: CurrentLevel[], assessments: Assessment[]): AdaptationStrategy[] {
    return [
      {
        strategy: 'ê°œë³„í™” ì§€ì›',
        description: 'í•™ìƒì˜ ê°œë³„ íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• ì§€ì›',
        applicableSubjects: ['all'],
        effectiveness: 'high'
      }
    ];
  }

  private identifyMotivationalFactors(assessments: Assessment[]): MotivationalFactor[] {
    return [
      {
        factor: 'ì„±ì·¨ê°',
        description: 'ì‘ì€ ì„±ê³µ ê²½í—˜ì„ í†µí•œ ë™ê¸° ë¶€ì—¬',
        strength: 'medium'
      }
    ];
  }

  private analyzeCommunicationStyle(profile: StudentProfile): CommunicationStyle {
    return {
      preferredMethod: 'verbal',
      clarity: 'clear',
      pace: 'moderate',
      supportNeeds: []
    };
  }

  private assessSocialInteractionLevel(profile: StudentProfile): SocialInteractionLevel {
    return {
      level: 'moderate',
      preferences: ['small-group'],
      challenges: [],
      strengths: []
    };
  }

  private calculateProfileCompleteness(profile: StudentProfile): number {
    const requiredFields = ['name', 'birthDate', 'grade', 'disabilityType'];
    const completedFields = requiredFields.filter(field => profile[field as keyof StudentProfile]);
    return (completedFields.length / requiredFields.length) * 100;
  }

  private calculateCurrentLevelsCompleteness(currentLevels: CurrentLevel[]): number {
    const requiredSubjects = ['korean', 'math'];
    const availableSubjects = [...new Set(currentLevels.map(level => level.subject))];
    const coverage = availableSubjects.filter(subject => requiredSubjects.includes(subject)).length;
    return (coverage / requiredSubjects.length) * 100;
  }

  private calculateAssessmentsCompleteness(assessments: Assessment[]): number {
    return assessments.length > 0 ? Math.min(assessments.length * 25, 100) : 0;
  }

  private calculateCounselingCompleteness(counseling: CounselingRecord[]): number {
    return counseling.length > 0 ? Math.min(counseling.length * 50, 100) : 0;
  }

  private calculateMedicalInfoCompleteness(medicalInfo: MedicalInfo): number {
    return medicalInfo.conditions.length > 0 ? 100 : 50;
  }

  private identifyMissingCriticalData(data: any): string[] {
    const missing: string[] = [];
    if (!data.profile.name) missing.push('í•™ìƒ ì´ë¦„');
    if (!data.profile.disabilityType.length) missing.push('ì¥ì•  ìœ í˜•');
    if (!data.currentLevels.length) missing.push('í˜„í–‰ìˆ˜ì¤€ ì •ë³´');
    return missing;
  }

  private generateDataImprovementRecommendations(scores: any): string[] {
    const recommendations: string[] = [];
    if (scores.profile < 80) recommendations.push('í•™ìƒ ê¸°ë³¸ ì •ë³´ ë³´ì™„ í•„ìš”');
    if (scores.currentLevels < 80) recommendations.push('í˜„í–‰ìˆ˜ì¤€ í‰ê°€ ì—…ë°ì´íŠ¸ í•„ìš”');
    if (scores.assessments < 60) recommendations.push('ì •ê¸° í‰ê°€ ì‹¤ì‹œ ê¶Œì¥');
    return recommendations;
  }
}
```

---

## 9.3 ì„œë¹„ìŠ¤ë³„ êµ¬í˜„ í´ë˜ìŠ¤

### 9.3.1 êµìœ¡ê³¼ì • ë°°ì • AI ì„œë¹„ìŠ¤
```javascript
class CurriculumAssignmentAI extends AIGenerationService {
  constructor() {
    super(AIServiceType.CURRICULUM_ASSIGNMENT);
  }

  protected mapDataForService(
    context: StudentContext,
    requestData: CurriculumAssignmentRequest
  ): CurriculumAssignmentMappedData {
    return {
      // í˜„í–‰ìˆ˜ì¤€ â†’ ì ì • ë‹¨ì› ìˆ˜ì¤€ ë§¤í•‘
      levelMapping: this.mapCurrentLevelToUnits(
        context.currentLevels[requestData.subject],
        requestData.availableUnits
      ),
      
      // ê°œë³„í™” íŠ¹ì„± â†’ ë°°ì • ì „ëµ
      assignmentStrategy: this.determineAssignmentStrategy(context.individualization),
      
      // ì´ì „ ì„±ê³¼ â†’ ì§„ë„ ì¡°ì ˆ
      pacingRecommendation: this.analyzePacingFromHistory(context.recentAssessments),
      
      // ì§€ì› ìš”êµ¬ì‚¬í•­ â†’ ë‹¨ì› ì¡°ì •
      accommodationNeeds: this.mapAccommodationsToUnits(
        context.individualization.accommodations,
        requestData.availableUnits
      )
    };
  }

  protected buildContextualPrompt(
    requestData: CurriculumAssignmentRequest,
    context: StudentContext,
    mappedData: CurriculumAssignmentMappedData,
    preferences?: UserPreferences
  ): string {
    return `
# íŠ¹ìˆ˜êµìœ¡ ê°œë³„í™” êµìœ¡ê³¼ì • ë°°ì •

## í•™ìƒ ì •ë³´
- ì´ë¦„: ${context.profile.name}
- í•™ë…„: ${context.profile.grade}í•™ë…„
- ì¥ì• ìœ í˜•: ${context.profile.disability_types?.join(', ') || 'ì—†ìŒ'}
- í†µí•©êµìœ¡ í˜•íƒœ: ${context.profile.inclusion_type || 'ì™„ì „í†µí•©'}

## í˜„í–‰ìˆ˜ì¤€ ë¶„ì„
${this.formatCurrentLevels(context.currentLevels[requestData.subject])}

## ê°œë³„í™” íŠ¹ì„±
- ê°•ì  ì˜ì—­: ${context.individualization.strengths.join(', ')}
- ë„ì „ ì˜ì—­: ${context.individualization.challenges.join(', ')}
- ì§€ì› ìš”êµ¬ì‚¬í•­: ${context.individualization.supportNeeds.join(', ')}
- ë³´ì¡° ë„êµ¬: ${context.individualization.accommodations.join(', ')}

## ë°°ì • ìš”ì²­ ì •ë³´
- ê³¼ëª©: ${requestData.subject}
- í•™ê¸°: ${requestData.semester}
- ëŒ€ìƒ ë‹¨ì›: ${requestData.availableUnits.map(u => u.unit_name).join(', ')}

## ë°°ì • ì „ëµ ë¶„ì„
- í•™ìŠµ ì†ë„: ${mappedData.assignmentStrategy.pacing}
- ë³µì¡ë„ ìˆ˜ì¤€: ${mappedData.assignmentStrategy.complexity}
- ì§€ì› ìˆ˜ì¤€: ${mappedData.assignmentStrategy.supportLevel}

## ìš”ì²­ì‚¬í•­
ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì—ê²Œ ì í•©í•œ êµìœ¡ê³¼ì • ë‹¨ì›ì„ ì›”ë³„ë¡œ ë°°ì •í•´ì£¼ì„¸ìš”.
ê° ë‹¨ì›ë³„ë¡œ ë‹¤ìŒì„ í¬í•¨í•´ì£¼ì„¸ìš”:
1. ë°°ì • ê·¼ê±° (í˜„í–‰ìˆ˜ì¤€ ë° ê°œë³„í™” íŠ¹ì„± ê¸°ë°˜)
2. ì˜ˆìƒ í•™ìŠµ ê¸°ê°„
3. í•„ìš”í•œ ì§€ì› ë° ì¡°ì •ì‚¬í•­
4. í‰ê°€ ë°©ë²• ì œì•ˆ

${preferences?.curriculum_style ? `êµì‚¬ ì„ í˜¸ ìŠ¤íƒ€ì¼: ${preferences.curriculum_style}` : ''}
`;
  }

  protected async validateAndEnhanceResult(
    aiResult: any,
    context: StudentContext
  ): Promise<AIGenerationResult> {
    // ê²°ê³¼ ê²€ì¦ ë¡œì§
    const validatedAssignments = this.validateAssignments(aiResult.assignments, context);
    
    // ê°œë³„í™” ì í•©ì„± ì ìˆ˜ ê³„ì‚°
    const individualizationScore = this.calculateIndividualizationScore(
      validatedAssignments,
      context.individualization
    );

    return {
      generationId: aiResult.generationId,
      content: validatedAssignments,
      confidence: aiResult.confidence,
      contextInfluenceScore: individualizationScore,
      metadata: {
        serviceType: this.serviceType,
        dataSourcesUsed: this.extractDataSources(context),
        individualizationApplied: true
      }
    };
  }
}
```

### 9.3.2 êµìœ¡ê³„íš ìˆ˜ë¦½ AI ì„œë¹„ìŠ¤
```javascript
class LessonPlanAI extends AIGenerationService {
  constructor() {
    super(AIServiceType.LESSON_PLAN);
  }

  protected mapDataForService(
    context: StudentContext,
    requestData: LessonPlanRequest
  ): LessonPlanMappedData {
    return {
      // í•™ìŠµ ìŠ¤íƒ€ì¼ â†’ êµìˆ˜ë²• ë§¤í•‘
      teachingMethods: this.mapLearningStyleToMethods(
        context.individualization.learningStyle
      ),
      
      // í˜„í–‰ìˆ˜ì¤€ â†’ ëª©í‘œ ì„¤ì •
      objectives: this.generateIndividualizedObjectives(
        context.currentLevels[requestData.subject],
        requestData.unit
      ),
      
      // íŠ¹ì„± â†’ í‰ê°€ ë°©ë²•
      assessmentAdaptations: this.mapCharacteristicsToAssessment(
        context.individualization
      ),
      
      // ì§€ì› ìš”êµ¬ì‚¬í•­ â†’ ìˆ˜ì—… ì¡°ì •
      instructionalAccommodations: this.mapSupportNeedsToInstructions(
        context.individualization.supportNeeds,
        context.individualization.accommodations
      )
    };
  }

  protected buildContextualPrompt(
    requestData: LessonPlanRequest,
    context: StudentContext,
    mappedData: LessonPlanMappedData,
    preferences?: UserPreferences
  ): string {
    return `
# ê°œë³„í™” êµìˆ˜í•™ìŠµ ê³„íšì•ˆ ì‘ì„±

## í•™ìƒ ê°œë³„ ì •ë³´
- í•™ìƒëª…: ${context.profile.name}
- í˜„ì¬ ìˆ˜ì¤€: ${this.formatCurrentLevel(context.currentLevels[requestData.subject])}
- í•™ìŠµ ê°•ì : ${context.individualization.strengths.join(', ')}
- í•™ìŠµ ì–´ë ¤ì›€: ${context.individualization.challenges.join(', ')}
- í•„ìš” ì§€ì›: ${context.individualization.supportNeeds.join(', ')}

## ìˆ˜ì—… ê¸°ë³¸ ì •ë³´
- ê³¼ëª©: ${requestData.subject}
- ë‹¨ì›: ${requestData.unit}
- ì°¨ì‹œ: ${requestData.period}
- ìˆ˜ì—… ì‹œê°„: ${requestData.duration}ë¶„

## ê°œë³„í™” êµìˆ˜ ì „ëµ
- ê¶Œì¥ êµìˆ˜ë²•: ${mappedData.teachingMethods.join(', ')}
- ìˆ˜ì—… ì¡°ì •ì‚¬í•­: ${mappedData.instructionalAccommodations.join(', ')}
- í‰ê°€ ì¡°ì •ì‚¬í•­: ${mappedData.assessmentAdaptations.methods.join(', ')}

## ê°œë³„í™” ëª©í‘œ
${mappedData.objectives.shortTerm.map(obj => `- ${obj}`).join('\n')}

## ìš”ì²­ì‚¬í•­
ìœ„ ê°œë³„í™” ì •ë³´ë¥¼ ë°˜ì˜í•˜ì—¬ ë‹¤ìŒì„ í¬í•¨í•œ ìƒì„¸í•œ êµìˆ˜í•™ìŠµ ê³„íšì•ˆì„ ì‘ì„±í•´ì£¼ì„¸ìš”:

1. **ê°œë³„í™” í•™ìŠµëª©í‘œ** (í•™ìƒ ìˆ˜ì¤€ì— ë§ëŠ” êµ¬ì²´ì  ëª©í‘œ)
2. **ë‹¨ê³„ë³„ êµìˆ˜í™œë™** (ê°œë³„ íŠ¹ì„±ì„ ê³ ë ¤í•œ í™œë™)
3. **ê°œë³„í™” ìë£Œ** (í•™ìƒì—ê²Œ ì í•©í•œ êµêµ¬ ë° ìë£Œ)
4. **í‰ê°€ ë°©ë²•** (ê°œë³„ íŠ¹ì„±ì„ ê³ ë ¤í•œ í‰ê°€)
5. **ì§€ì› ë°©ì•ˆ** (í•„ìš”í•œ ì§€ì› ë° ì¡°ì •ì‚¬í•­)

${preferences?.teaching_style ? `êµì‚¬ ì„ í˜¸ êµìˆ˜ë²•: ${preferences.teaching_style}` : ''}
${preferences?.formality_level ? `ë¬¸ì²´: ${preferences.formality_level}` : ''}
`;
  }

  protected async validateAndEnhanceResult(
    aiResult: any,
    context: StudentContext
  ): Promise<AIGenerationResult> {
    // ê°œë³„í™” ì ìš©ë„ ê²€ì¦
    const individualizationCheck = this.validateIndividualization(aiResult, context);
    
    // ì‹¤í–‰ ê°€ëŠ¥ì„± ê²€ì¦
    const feasibilityCheck = this.validateFeasibility(aiResult, context);
    
    // ê²°ê³¼ í–¥ìƒ
    const enhancedResult = await this.enhanceWithContextualDetails(aiResult, context);

    return {
      generationId: aiResult.generationId,
      content: enhancedResult,
      confidence: aiResult.confidence * individualizationCheck.score,
      contextInfluenceScore: individualizationCheck.contextUsage,
      metadata: {
        serviceType: this.serviceType,
        individualizationApplied: individualizationCheck.applied,
        feasibilityScore: feasibilityCheck.score,
        enhancementsApplied: enhancedResult.enhancements
      }
    };
  }
}
```

---

## 9.4 í†µí•© ì„œë¹„ìŠ¤ íŒ©í† ë¦¬

### 9.4.1 AI ì„œë¹„ìŠ¤ íŒ©í† ë¦¬
```javascript
class AIServiceFactory {
  private static services: Map<AIServiceType, AIGenerationService> = new Map();

  static getService(serviceType: AIServiceType): AIGenerationService {
    if (!this.services.has(serviceType)) {
      this.services.set(serviceType, this.createService(serviceType));
    }
    return this.services.get(serviceType)!;
  }

  private static createService(serviceType: AIServiceType): AIGenerationService {
    switch (serviceType) {
      case AIServiceType.CURRICULUM_ASSIGNMENT:
        return new CurriculumAssignmentAI();
      case AIServiceType.LESSON_PLAN:
        return new LessonPlanAI();
      case AIServiceType.ASSESSMENT:
        return new AssessmentAI();
      case AIServiceType.ADMIN_DOCUMENT:
        return new AdminDocumentAI();
      case AIServiceType.COUNSELING_GUIDE:
        return new CounselingGuideAI();
      default:
        throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” AI ì„œë¹„ìŠ¤ íƒ€ì…: ${serviceType}`);
    }
  }
}
```

### 9.4.2 í†µí•© API ì—”ë“œí¬ì¸íŠ¸
```javascript
// POST /api/ai/generate-with-context
export async function POST(request: Request) {
  try {
    const { serviceType, studentId, requestData, teacherPreferences } = await request.json();
    
    // ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    const aiService = AIServiceFactory.getService(serviceType);
    
    // ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒì„± ì‹¤í–‰
    const result = await aiService.generateWithContext(
      studentId,
      requestData,
      teacherPreferences
    );
    
    return createSuccessResponse(result);
  } catch (error) {
    return createErrorResponse(
      'AI_GENERATION_WITH_CONTEXT_ERROR',
      'AI ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      error
    );
  }
}
```

---

## 9.5 ì„±ëŠ¥ ìµœì í™” ë° ëª¨ë‹ˆí„°ë§

### 9.5.1 ì»¨í…ìŠ¤íŠ¸ ìºì‹± ì „ëµ
- **ë©”ëª¨ë¦¬ ìºì‹œ**: 30ë¶„ ìœ íš¨, ìì£¼ ì‚¬ìš©ë˜ëŠ” í•™ìƒ ì»¨í…ìŠ¤íŠ¸
- **DB ìºì‹œ**: 1ì‹œê°„ ìœ íš¨, ëª¨ë“  í•™ìƒ ì»¨í…ìŠ¤íŠ¸
- **ë¬´íš¨í™” íŠ¸ë¦¬ê±°**: í•™ìƒ ì •ë³´ ë³€ê²½ ì‹œ ìë™ ë¬´íš¨í™”

### 9.5.2 ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
```javascript
interface AIPerformanceMetrics {
  serviceType: AIServiceType;
  contextBuildTime: number;
  aiGenerationTime: number;
  totalProcessingTime: number;
  contextInfluenceScore: number;
  userSatisfactionScore?: number;
}
```

### 9.5.3 í’ˆì§ˆ ê´€ë¦¬
- **ì»¨í…ìŠ¤íŠ¸ í™œìš©ë„ ì¸¡ì •**: ìƒì„± ê²°ê³¼ì— í•™ìƒ ì»¨í…ìŠ¤íŠ¸ê°€ ì–¼ë§ˆë‚˜ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ ì¸¡ì •
- **ê°œë³„í™” ì í•©ì„± ê²€ì¦**: ìƒì„±ëœ ë‚´ìš©ì´ í•™ìƒì˜ ê°œë³„ íŠ¹ì„±ì— ì í•©í•œì§€ ê²€ì¦
- **êµì‚¬ í”¼ë“œë°± ìˆ˜ì§‘**: ìƒì„± ê²°ê³¼ì— ëŒ€í•œ êµì‚¬ ë§Œì¡±ë„ ë° ê°œì„  ì œì•ˆ ìˆ˜ì§‘

---

## 9.6 ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ê²€ì¦

### 9.6.1 AI ìƒì„± ì„œë¹„ìŠ¤ ì¼ê´€ì„± ê²€ì¦
```javascript
class AIServiceIntegrationValidator {
  /**
   * ëª¨ë“  AI ìƒì„± ì„œë¹„ìŠ¤ì˜ í•™ìƒ ì»¨í…ìŠ¤íŠ¸ í™œìš© ì¼ê´€ì„± ê²€ì¦
   */
  async validateServiceConsistency(): Promise<ValidationResult> {
    const services = [
      AIServiceType.CURRICULUM_ASSIGNMENT,
      AIServiceType.LESSON_PLAN,
      AIServiceType.ASSESSMENT,
      AIServiceType.ADMIN_DOCUMENT,
      AIServiceType.COUNSELING_GUIDE
    ];

    const results = await Promise.all(
      services.map(service => this.validateService(service))
    );

    return {
      overallScore: this.calculateOverallScore(results),
      serviceResults: results,
      recommendations: this.generateRecommendations(results)
    };
  }

  /**
   * ê°œë³„ ì„œë¹„ìŠ¤ì˜ ì»¨í…ìŠ¤íŠ¸ í™œìš©ë„ ê²€ì¦
   */
  private async validateService(serviceType: AIServiceType): Promise<ServiceValidationResult> {
    const service = AIServiceFactory.getService(serviceType);
    const testStudentId = 'test-student-id';
    const testRequest = this.generateTestRequest(serviceType);

    try {
      const result = await service.generateWithContext(testStudentId, testRequest);
      
      return {
        serviceType,
        contextUsageScore: result.contextInfluenceScore || 0,
        dataSourcesCovered: result.metadata?.dataSourcesUsed?.length || 0,
        individualizationApplied: result.metadata?.individualizationApplied || false,
        confidence: result.confidence,
        status: 'success'
      };
    } catch (error) {
      return {
        serviceType,
        contextUsageScore: 0,
        dataSourcesCovered: 0,
        individualizationApplied: false,
        confidence: 0,
        status: 'error',
        error: error.message
      };
    }
  }

  /**
   * ì„œë¹„ìŠ¤ ê°„ ë°ì´í„° ì¼ê´€ì„± ê²€ì¦
   */
  async validateDataConsistency(studentId: string): Promise<DataConsistencyResult> {
    const context = await new StudentContextBuilder().buildContext(studentId);
    
    // ê° ì„œë¹„ìŠ¤ì—ì„œ ë™ì¼í•œ í•™ìƒ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ê²€ì¦
    const contextHashes = await Promise.all([
      this.getContextHash(AIServiceType.CURRICULUM_ASSIGNMENT, studentId),
      this.getContextHash(AIServiceType.LESSON_PLAN, studentId),
      this.getContextHash(AIServiceType.ASSESSMENT, studentId),
      this.getContextHash(AIServiceType.ADMIN_DOCUMENT, studentId)
    ]);

    const isConsistent = contextHashes.every(hash => hash === contextHashes[0]);
    
    return {
      isConsistent,
      contextHashes,
      timestamp: new Date().toISOString(),
      studentId
    };
  }
}
```

### 9.6.2 ì„±ëŠ¥ ë° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§
```javascript
class AIPerformanceMonitor {
  private metrics: Map<AIServiceType, AIPerformanceMetrics[]> = new Map();

  /**
   * AI ìƒì„± ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   */
  async collectMetrics(serviceType: AIServiceType, result: AIGenerationResult): Promise<void> {
    const metrics: AIPerformanceMetrics = {
      serviceType,
      contextBuildTime: result.metadata?.contextBuildTime || 0,
      aiGenerationTime: result.metadata?.aiGenerationTime || 0,
      totalProcessingTime: result.metadata?.totalProcessingTime || 0,
      contextInfluenceScore: result.contextInfluenceScore || 0,
      confidence: result.confidence,
      timestamp: new Date().toISOString()
    };

    if (!this.metrics.has(serviceType)) {
      this.metrics.set(serviceType, []);
    }
    
    this.metrics.get(serviceType)!.push(metrics);
    
    // ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì‚¬
    await this.checkPerformanceThresholds(serviceType, metrics);
  }

  /**
   * ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì‚¬ ë° ì•Œë¦¼
   */
  private async checkPerformanceThresholds(
    serviceType: AIServiceType, 
    metrics: AIPerformanceMetrics
  ): Promise<void> {
    const thresholds = {
      maxProcessingTime: 10000, // 10ì´ˆ
      minContextInfluence: 0.6,  // 60%
      minConfidence: 0.7         // 70%
    };

    const alerts = [];
    
    if (metrics.totalProcessingTime > thresholds.maxProcessingTime) {
      alerts.push(`ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼: ${metrics.totalProcessingTime}ms`);
    }
    
    if (metrics.contextInfluenceScore < thresholds.minContextInfluence) {
      alerts.push(`ì»¨í…ìŠ¤íŠ¸ í™œìš©ë„ ë¶€ì¡±: ${metrics.contextInfluenceScore}`);
    }
    
    if (metrics.confidence < thresholds.minConfidence) {
      alerts.push(`ì‹ ë¢°ë„ ë¶€ì¡±: ${metrics.confidence}`);
    }

    if (alerts.length > 0) {
      await this.sendPerformanceAlert(serviceType, alerts);
    }
  }

  /**
   * ì„œë¹„ìŠ¤ë³„ ì„±ëŠ¥ í†µê³„ ìƒì„±
   */
  generatePerformanceReport(serviceType: AIServiceType): PerformanceReport {
    const serviceMetrics = this.metrics.get(serviceType) || [];
    
    if (serviceMetrics.length === 0) {
      return { serviceType, status: 'no_data' };
    }

    const avgProcessingTime = serviceMetrics.reduce((sum, m) => sum + m.totalProcessingTime, 0) / serviceMetrics.length;
    const avgContextInfluence = serviceMetrics.reduce((sum, m) => sum + m.contextInfluenceScore, 0) / serviceMetrics.length;
    const avgConfidence = serviceMetrics.reduce((sum, m) => sum + m.confidence, 0) / serviceMetrics.length;

    return {
      serviceType,
      status: 'active',
      totalRequests: serviceMetrics.length,
      averageProcessingTime: avgProcessingTime,
      averageContextInfluence: avgContextInfluence,
      averageConfidence: avgConfidence,
      lastUpdated: new Date().toISOString()
    };
  }
}
```

### 9.6.3 ì‚¬ìš©ì ë§Œì¡±ë„ ë° í”¼ë“œë°± ì‹œìŠ¤í…œ
```javascript
class UserFeedbackSystem {
  /**
   * AI ìƒì„± ê²°ê³¼ì— ëŒ€í•œ ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
   */
  async collectFeedback(feedback: UserFeedback): Promise<void> {
    // í”¼ë“œë°± ì €ì¥
    await supabase.from('ai_user_feedback').insert({
      user_id: feedback.userId,
      student_id: feedback.studentId,
      service_type: feedback.serviceType,
      generation_id: feedback.generationId,
      satisfaction_score: feedback.satisfactionScore,
      usefulness_score: feedback.usefulnessScore,
      accuracy_score: feedback.accuracyScore,
      individualization_score: feedback.individualizationScore,
      comments: feedback.comments,
      improvement_suggestions: feedback.improvementSuggestions
    });

    // í”¼ë“œë°± ê¸°ë°˜ ì„œë¹„ìŠ¤ ê°œì„ 
    await this.processImprovementSuggestions(feedback);
  }

  /**
   * í”¼ë“œë°± ê¸°ë°˜ ì„œë¹„ìŠ¤ ê°œì„  ì²˜ë¦¬
   */
  private async processImprovementSuggestions(feedback: UserFeedback): Promise<void> {
    // ë‚®ì€ ì ìˆ˜ í”¼ë“œë°± ë¶„ì„
    if (feedback.satisfactionScore < 3) {
      await this.analyzeNegativeFeedback(feedback);
    }

    // ê°œë³„í™” ì ìˆ˜ê°€ ë‚®ì€ ê²½ìš° ì»¨í…ìŠ¤íŠ¸ í™œìš© ê°œì„ 
    if (feedback.individualizationScore < 3) {
      await this.improveContextUtilization(feedback.serviceType, feedback.studentId);
    }

    // ì •í™•ë„ê°€ ë‚®ì€ ê²½ìš° AI ëª¨ë¸ ì¬í›ˆë ¨ ê³ ë ¤
    if (feedback.accuracyScore < 3) {
      await this.flagForModelRetraining(feedback.serviceType);
    }
  }

  /**
   * ì„œë¹„ìŠ¤ë³„ ì‚¬ìš©ì ë§Œì¡±ë„ í†µê³„
   */
  async generateSatisfactionReport(): Promise<SatisfactionReport> {
    const { data: feedbacks } = await supabase
      .from('ai_user_feedback')
      .select('*')
      .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

    const serviceStats = new Map<AIServiceType, ServiceSatisfactionStats>();

    feedbacks?.forEach(feedback => {
      if (!serviceStats.has(feedback.service_type)) {
        serviceStats.set(feedback.service_type, {
          totalFeedbacks: 0,
          avgSatisfaction: 0,
          avgUsefulness: 0,
          avgAccuracy: 0,
          avgIndividualization: 0
        });
      }

      const stats = serviceStats.get(feedback.service_type)!;
      stats.totalFeedbacks++;
      stats.avgSatisfaction += feedback.satisfaction_score;
      stats.avgUsefulness += feedback.usefulness_score;
      stats.avgAccuracy += feedback.accuracy_score;
      stats.avgIndividualization += feedback.individualization_score;
    });

    // í‰ê·  ê³„ì‚°
    serviceStats.forEach(stats => {
      stats.avgSatisfaction /= stats.totalFeedbacks;
      stats.avgUsefulness /= stats.totalFeedbacks;
      stats.avgAccuracy /= stats.totalFeedbacks;
      stats.avgIndividualization /= stats.totalFeedbacks;
    });

    return {
      reportPeriod: '30ì¼',
      serviceStats: Object.fromEntries(serviceStats),
      overallSatisfaction: this.calculateOverallSatisfaction(serviceStats),
      generatedAt: new Date().toISOString()
    };
  }
}
```

### 9.6.4 ìë™í™”ëœ í’ˆì§ˆ ë³´ì¦ ì‹œìŠ¤í…œ
```javascript
class AutomatedQualityAssurance {
  /**
   * ì •ê¸°ì  í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰
   */
  async runQualityChecks(): Promise<QualityReport> {
    const checks = await Promise.all([
      this.checkContextConsistency(),
      this.checkDataIntegrity(),
      this.checkPerformanceStandards(),
      this.checkUserSatisfaction(),
      this.checkSecurityCompliance()
    ]);

    const overallScore = checks.reduce((sum, check) => sum + check.score, 0) / checks.length;
    
    return {
      overallScore,
      checks,
      status: overallScore >= 0.8 ? 'excellent' : overallScore >= 0.6 ? 'good' : 'needs_improvement',
      recommendations: this.generateQualityRecommendations(checks),
      timestamp: new Date().toISOString()
    };
  }

  /**
   * ì»¨í…ìŠ¤íŠ¸ ì¼ê´€ì„± ê²€ì‚¬
   */
  private async checkContextConsistency(): Promise<QualityCheck> {
    const validator = new AIServiceIntegrationValidator();
    const result = await validator.validateServiceConsistency();
    
    return {
      checkType: 'context_consistency',
      score: result.overallScore,
      status: result.overallScore >= 0.8 ? 'pass' : 'fail',
      details: result.serviceResults,
      recommendations: result.recommendations
    };
  }

  /**
   * ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬
   */
  private async checkDataIntegrity(): Promise<QualityCheck> {
    // í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
    const { data: students } = await supabase.from('students').select('id').limit(10);
    
    const integrityResults = await Promise.all(
      students?.map(student => this.validateStudentDataIntegrity(student.id)) || []
    );

    const passedChecks = integrityResults.filter(result => result.isValid).length;
    const score = passedChecks / integrityResults.length;

    return {
      checkType: 'data_integrity',
      score,
      status: score >= 0.95 ? 'pass' : 'fail',
      details: integrityResults,
      recommendations: score < 0.95 ? ['ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ í•´ê²° í•„ìš”'] : []
    };
  }

  /**
   * ì„±ëŠ¥ í‘œì¤€ ê²€ì‚¬
   */
  private async checkPerformanceStandards(): Promise<QualityCheck> {
    const monitor = new AIPerformanceMonitor();
    const services = Object.values(AIServiceType);
    
    const performanceReports = services.map(service => monitor.generatePerformanceReport(service));
    const validReports = performanceReports.filter(report => report.status === 'active');
    
    if (validReports.length === 0) {
      return {
        checkType: 'performance_standards',
        score: 0,
        status: 'no_data',
        details: [],
        recommendations: ['ì„±ëŠ¥ ë°ì´í„° ìˆ˜ì§‘ í•„ìš”']
      };
    }

    const avgProcessingTime = validReports.reduce((sum, report) => sum + report.averageProcessingTime, 0) / validReports.length;
    const avgConfidence = validReports.reduce((sum, report) => sum + report.averageConfidence, 0) / validReports.length;
    
    const processingScore = avgProcessingTime <= 5000 ? 1 : avgProcessingTime <= 10000 ? 0.7 : 0.3;
    const confidenceScore = avgConfidence >= 0.8 ? 1 : avgConfidence >= 0.6 ? 0.7 : 0.3;
    
    const overallScore = (processingScore + confidenceScore) / 2;

    return {
      checkType: 'performance_standards',
      score: overallScore,
      status: overallScore >= 0.7 ? 'pass' : 'fail',
      details: validReports,
      recommendations: overallScore < 0.7 ? ['ì„±ëŠ¥ ìµœì í™” í•„ìš”'] : []
    };
  }
}
```

### 9.6.5 ì§€ì†ì  ê°œì„  ì‹œìŠ¤í…œ
```javascript
class ContinuousImprovementSystem {
  /**
   * ì£¼ê¸°ì  ì‹œìŠ¤í…œ ê°œì„  ì‹¤í–‰
   */
  async runImprovementCycle(): Promise<ImprovementReport> {
    // 1. í˜„ì¬ ìƒíƒœ ë¶„ì„
    const currentState = await this.analyzeCurrentState();
    
    // 2. ê°œì„  ê¸°íšŒ ì‹ë³„
    const opportunities = await this.identifyImprovementOpportunities(currentState);
    
    // 3. ê°œì„  ê³„íš ìˆ˜ë¦½
    const improvementPlan = await this.createImprovementPlan(opportunities);
    
    // 4. ê°œì„  ì‹¤í–‰
    const implementationResults = await this.implementImprovements(improvementPlan);
    
    // 5. ê²°ê³¼ í‰ê°€
    const evaluation = await this.evaluateImprovements(implementationResults);
    
    return {
      currentState,
      opportunities,
      improvementPlan,
      implementationResults,
      evaluation,
      nextReviewDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
    };
  }

  /**
   * AI ëª¨ë¸ ì„±ëŠ¥ ê°œì„ 
   */
  async improveAIModels(): Promise<ModelImprovementResult> {
    const services = Object.values(AIServiceType);
    const improvements = await Promise.all(
      services.map(service => this.improveServiceModel(service))
    );

    return {
      services: improvements,
      overallImprovement: this.calculateOverallImprovement(improvements),
      timestamp: new Date().toISOString()
    };
  }

  /**
   * ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
   */
  async improveUserExperience(): Promise<UXImprovementResult> {
    const feedbackSystem = new UserFeedbackSystem();
    const satisfactionReport = await feedbackSystem.generateSatisfactionReport();
    
    const improvements = [];
    
    // ë§Œì¡±ë„ê°€ ë‚®ì€ ì„œë¹„ìŠ¤ ê°œì„ 
    Object.entries(satisfactionReport.serviceStats).forEach(([serviceType, stats]) => {
      if (stats.avgSatisfaction < 3.5) {
        improvements.push({
          serviceType: serviceType as AIServiceType,
          issue: 'low_satisfaction',
          currentScore: stats.avgSatisfaction,
          targetScore: 4.0,
          actions: this.generateSatisfactionImprovementActions(serviceType as AIServiceType)
        });
      }
    });

    return {
      improvements,
      implementationPlan: this.createUXImprovementPlan(improvements),
      expectedOutcome: this.predictUXImprovementOutcome(improvements)
    };
  }
}
```

---

## 9.7 êµ¬í˜„ ì™„ë£Œ ë° ê²€ì¦ ê²°ê³¼

### âœ… Phase 1: ê¸°ë°˜ êµ¬ì¡° êµ¬ì¶• ì™„ë£Œ
- í†µí•© í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° êµ¬ì¡° ì„¤ê³„
- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì¶”ê°€ (`student_context_cache`, `ai_generation_contexts`)
- API ì„¤ê³„ ë° í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„
- AI ìƒì„± ì„œë¹„ìŠ¤ ì¶”ìƒ ê¸°ë³¸ í´ë˜ìŠ¤ ë° íŒ©í† ë¦¬ íŒ¨í„´ êµ¬í˜„

### âœ… Phase 2: êµìœ¡ê³¼ì • íŒŒíŠ¸ ì—°ë™ ì™„ë£Œ
- **êµìœ¡ê³¼ì • ë°°ì •**: í•™ìƒ ì»¨í…ìŠ¤íŠ¸ ìë™ ë¡œë“œ, í˜„í–‰ìˆ˜ì¤€ ê¸°ë°˜ ì¶”ì²œ, AI ê°œë³„í™” ì„¤ì •
- **êµìœ¡ê³„íš ìˆ˜ë¦½**: í•™ìƒ íŠ¹ì„± ë°˜ì˜ ìë™ ëª©í‘œ ìƒì„±, ì ì‘ì  êµìˆ˜ë°©ë²• ì¶”ì²œ
- **êµìœ¡í‰ê°€**: ê°œë³„í™” í‰ê°€ ì§€ì›, ì„±ì¥ íŒ¨í„´ ë¶„ì„, ë§ì¶¤í˜• í‰ê°€ë¬¸ ìƒì„±

### âœ… Phase 3: ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ë° ê²€ì¦ ì™„ë£Œ
- **ì¼ê´€ì„± ê²€ì¦**: ëª¨ë“  AI ì„œë¹„ìŠ¤ì˜ í•™ìƒ ì»¨í…ìŠ¤íŠ¸ í™œìš© ì¼ê´€ì„± í™•ë³´
- **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**: ì‹¤ì‹œê°„ ì„±ëŠ¥ ì¶”ì  ë° í’ˆì§ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•
- **ì‚¬ìš©ì í”¼ë“œë°±**: ë§Œì¡±ë„ ìˆ˜ì§‘ ë° ì§€ì†ì  ê°œì„  ì‹œìŠ¤í…œ êµ¬í˜„
- **ìë™í™”ëœ í’ˆì§ˆ ë³´ì¦**: ì •ê¸°ì  í’ˆì§ˆ ê²€ì‚¬ ë° ê°œì„  ì‚¬ì´í´ êµ¬ì¶•

### ğŸ¯ ìµœì¢… ë‹¬ì„± ëª©í‘œ
**ëª¨ë“  AI ìƒì„± ì„œë¹„ìŠ¤(êµìœ¡ê³¼ì • ë°°ì •, ê³„íš ìˆ˜ë¦½, í‰ê°€, í–‰ì •ì§€ì› ë“±)ì—ì„œ ê° í•™ìƒë³„ ì´ˆê¸° ì¸ì ì‚¬í•­ ë° í˜„í–‰ìˆ˜ì¤€ ë“± í•µì‹¬ ë°ì´í„°ê°€ ì ì¬ì ì†Œì— ë§ê²Œ ìë™ ë°˜ì˜ë˜ê³  ìƒí˜¸ì‘ìš©í•˜ëŠ” í†µí•© ì‹œìŠ¤í…œ ì™„ì„±**

ì´ì œ IEPON ì‹œìŠ¤í…œì˜ ëª¨ë“  AI ìƒì„± ì„œë¹„ìŠ¤ê°€ í•™ìƒ ì¤‘ì‹¬ì˜ ê°œë³„í™”ëœ ê²°ê³¼ë¥¼ ì œê³µí•  ìˆ˜ ìˆëŠ” ì™„ì „í•œ í†µí•© ì‹œìŠ¤í…œì´ êµ¬ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤.
