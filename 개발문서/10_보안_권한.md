# ğŸ” IEPON MCP ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

> **ì—°ê²° ë¬¸ì„œ**: [02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](./02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md) | [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md) | [11_ë°°í¬_ê°€ì´ë“œ.md](./11_ë°°í¬_ê°€ì´ë“œ.md) | [08_í™˜ê²½_ì„¤ì •.md](./08_í™˜ê²½_ì„¤ì •.md) | [14_ê²°ì œ_ì„¤ê³„.md](./14_ê²°ì œ_ì„¤ê³„.md)
> **MCP ë³´ì•ˆ ì•ˆë‚´**: MCP ì„œë²„ ê°„ í†µì‹  ë° ë°ì´í„° êµí™˜ ì‹œ ì—”ë“œíˆ¬ì—”ë“œ ì•”í˜¸í™”, ì¸ì¦ í† í° ê²€ì¦, MCP í”„ë¡œí† ì½œ ë³´ì•ˆ ì •ì±…ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.
> **ê³µí†µ ENUM ì•ˆë‚´**: ë³¸ ë¬¸ì„œ ì „ë°˜ì—ì„œ ì‚¬ìš©ë˜ëŠ” `status` í•„ë“œëŠ” [02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](./02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)ì— ì •ì˜ëœ ê³µí†µ ENUM (`'active'`, `'expired'`, `'pending'`, `'cancelled'`, `'error'`) ê°’ì„ ì°¸ì¡°í•©ë‹ˆë‹¤. ë³´ì•ˆ ì •ì±… ë‹¨ê³„ êµ¬ë¶„ì—ëŠ” `policy_status`, `token_state` ë“± ë³„ë„ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.

---

## 10.1 MCP ê¸°ë°˜ ë³´ì•ˆ ì•„í‚¤í…ì²˜

### 10.1.1 MCP ë‹¤ì¸µ ë³´ì•ˆ êµ¬ì¡°
- **MCP ì„œë²„ ì¸ì¦**: Windsurf MCP ì„¤ì • ê¸°ë°˜ ì„œë²„ ì¸ì¦
- **ì¸ì¦ ê³„ì¸µ**: Supabase MCP Auth (JWT ê¸°ë°˜)
- **ê²°ì œ ë³´ì•ˆ**: Toss Payments MCP ì„œë²„ ë³´ì•ˆ ì •ì±…
- **ê¶Œí•œ ê³„ì¸µ**: MCP ê¸°ë°˜ Row Level Security (RLS)
- **ë°ì´í„° ê³„ì¸µ**: MCP ì„œë²„ ê°„ ì—”ë“œíˆ¬ì—”ë“œ ì•”í˜¸í™”
- **ë„¤íŠ¸ì›Œí¬ ê³„ì¸µ**: MCP í”„ë¡œí† ì½œ ë³´ì•ˆ + HTTPS, CSP, CORS
- **ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ**: MCP íˆ´ ê²€ì¦, ì…ë ¥ ê²€ì¦, ì„¸ì…˜ ê´€ë¦¬

### 10.1.2 MCP ë³´ì•ˆ ì›ì¹™
- **MCP ì„œë²„ ê²©ë¦¬**: ê° MCP ì„œë²„ ê°„ ë…ë¦½ì  ë³´ì•ˆ ê²½ê³„ ìœ ì§€
- **ìµœì†Œ ê¶Œí•œ ì›ì¹™**: MCP íˆ´ í˜¸ì¶œ ì‹œ í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬
- **ì‹¬ì¸µ ë°©ì–´**: MCP í”„ë¡œí† ì½œ + ë‹¤ì¤‘ ë³´ì•ˆ ê³„ì¸µ êµ¬ì„±
- **ì—”ë“œíˆ¬ì—”ë“œ ì•”í˜¸í™”**: MCP ì„œë²„ ê°„ ëª¨ë“  ë°ì´í„° êµí™˜ ì•”í˜¸í™”
- **ë°ì´í„° ë³´í˜¸**: ê°œì¸ì •ë³´ MCP ì„œë²„ ë‚´ ì•”í˜¸í™” ì €ì¥
- **ê°ì‚¬ ì¶”ì **: ëª¨ë“  MCP íˆ´ í˜¸ì¶œ ë° ë°ì´í„° ì ‘ê·¼ ì´ë ¥ ê¸°ë¡
- **MCP íˆ´ ê²€ì¦**: ëª¨ë“  MCP íˆ´ í˜¸ì¶œ ì‹œ ì¸ì¦ ë° ê¶Œí•œ ê²€ì¦

---

## 10.2 ì‚¬ìš©ì ì¸ì¦ ë° ê¶Œí•œ

### 10.2.1 ì‚¬ìš©ì ì—­í•  ì •ì˜
```sql
-- ì‚¬ìš©ì ì—­í•  ENUM ì •ì˜
CREATE TYPE user_role AS ENUM ('teacher', 'super_admin');

-- ì‚¬ìš©ì ë©”íƒ€ë°ì´í„° êµ¬ì¡°
-- auth.users.raw_user_meta_data:
-- {
--   "role": "teacher" | "super_admin",
--   "name": "ì‚¬ìš©ì ì´ë¦„",
--   "school": "ì†Œì† í•™êµ",
--   "approved": true | false
-- }
```

### 10.2.2 ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤
| ê¸°ëŠ¥ | ì¼ë°˜ êµì‚¬ | ê´€ë¦¬ì |
|------|-----------|--------|
| ìì‹ ì˜ í•™ìƒ ë°ì´í„° ì¡°íšŒ/ìˆ˜ì • | âœ… | âœ… |
| ëª¨ë“  í•™ìƒ ë°ì´í„° ì¡°íšŒ/ìˆ˜ì • | âŒ | âœ… |
| ì‚¬ìš©ì ê³„ì • ê´€ë¦¬ | âŒ | âœ… |
| ì‹œìŠ¤í…œ ì„¤ì • ê´€ë¦¬ | âŒ | âœ… |
| ê²°ì œ ë‚´ì—­ ì¡°íšŒ | ë³¸ì¸ë§Œ | ì „ì²´ |
| í€´ë§í¬ ê´€ë¦¬ | âŒ | âœ… |
| ì‹œìŠ¤í…œ ë¡œê·¸ ì¡°íšŒ | âŒ | âœ… |
| **êµìœ¡ê³¼ì • ì¡°íšŒ** | âœ… | âœ… |
| **êµìœ¡ê³¼ì • ì—…ë¡œë“œ** | âŒ | âœ… |
| **êµìœ¡ê³¼ì • ìˆ˜ì •/ì‚­ì œ** | âŒ | âœ… |
| **êµìœ¡ê³¼ì • Excel ì—…ë¡œë“œ** | âŒ | âœ… |

---

## 10.3 Row Level Security (RLS) ì •ì±…

### 10.3.1 í•™ìƒ ë°ì´í„° ë³´ì•ˆ ì •ì±…
```sql
-- í•™ìƒ í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "teachers_own_students" ON students
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_students" ON students
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- í˜„í–‰ìˆ˜ì¤€ í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "teachers_own_current_levels" ON current_levels
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_current_levels" ON current_levels
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- ì›”ë³„ êµìœ¡ê³„íš RLS ì •ì±…
CREATE POLICY "teachers_own_monthly_plans" ON monthly_plans
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_monthly_plans" ON monthly_plans
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- êµìœ¡ê³¼ì • ë‹¨ì› RLS ì •ì±…
CREATE POLICY "teachers_read_curriculum_units" ON curriculum_units
FOR SELECT USING (true); -- ëª¨ë“  êµì‚¬ê°€ êµìœ¡ê³¼ì • ì¡°íšŒ ê°€ëŠ¥

CREATE POLICY "super_admins_manage_curriculum_units" ON curriculum_units
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- êµìœ¡ê³¼ì • ì—…ë¡œë“œ ë¡œê·¸ RLS ì •ì±… (ê´€ë¦¬ìë§Œ ì ‘ê·¼)
CREATE POLICY "super_admins_curriculum_logs" ON curriculum_upload_logs
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- ì›”ë³„ êµìœ¡í‰ê°€ RLS ì •ì±…
CREATE POLICY "teachers_own_monthly_evaluations" ON monthly_evaluations
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_monthly_evaluations" ON monthly_evaluations
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);
```

### 10.3.2 ê²°ì œ ë° ë¼ì´ì„ ìŠ¤ ë³´ì•ˆ ì •ì±…
```sql
-- ê²°ì œ ë‚´ì—­ RLS ì •ì±…
CREATE POLICY "users_own_payments" ON payments
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_payments" ON payments
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- ë¼ì´ì„ ìŠ¤ RLS ì •ì±…
CREATE POLICY "users_own_licenses" ON licenses
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "super_admins_all_licenses" ON licenses
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);

-- ì‹œë¦¬ì–¼ ì½”ë“œ RLS ì •ì±… (ê´€ë¦¬ìë§Œ ì ‘ê·¼)
CREATE POLICY "super_admins_only_serial_codes" ON serial_codes
FOR ALL USING (
    EXISTS (
        SELECT 1 FROM auth.users 
        WHERE id = auth.uid() 
        AND raw_user_meta_data->>'role' = 'super_admin'
    )
);
```

---

## 10.4 ë°ì´í„° ì•”í˜¸í™”

### 10.4.1 ì•”í˜¸í™” í•¨ìˆ˜
```sql
-- ì•”í˜¸í™” í•¨ìˆ˜ (AES-256-GCM ì‚¬ìš©)
CREATE OR REPLACE FUNCTION encrypt_data(data TEXT, key TEXT, iv TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(
        encrypt(
            data::bytea,
            key::bytea,
            'aes-gcm'
        ),
        'base64'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ë³µí˜¸í™” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION decrypt_data(encrypted_data TEXT, key TEXT, iv TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN convert_from(
        decrypt(
            decode(encrypted_data, 'base64'),
            key::bytea,
            'aes-gcm'
        ),
        'UTF8'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 10.4.2 ë¯¼ê° ë°ì´í„° ì•”í˜¸í™”
```sql
-- ë¯¼ê° ì •ë³´ ì•”í˜¸í™” íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data()
RETURNS TRIGGER AS $$
BEGIN
    -- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì „í™”ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ ì•”í˜¸í™”
    IF NEW.phone IS NOT NULL THEN
        NEW.phone = encrypt_data(
            NEW.phone,
            current_setting('app.encryption_key'),
            current_setting('app.encryption_iv')
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- í•™ìƒ í…Œì´ë¸”ì— ì•”í˜¸í™” íŠ¸ë¦¬ê±° ì ìš©
CREATE TRIGGER encrypt_student_data
    BEFORE INSERT OR UPDATE ON students
    FOR EACH ROW
    EXECUTE FUNCTION encrypt_sensitive_data();
```

---

## 10.5 ì ‘ê·¼ ì œì–´ ë° ê°ì‚¬

### 10.5.1 ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
```sql
-- ì ‘ê·¼ ë¡œê·¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION log_access(
    table_name TEXT,
    record_id UUID,
    action TEXT,
    user_id UUID DEFAULT auth.uid()
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO access_logs (
        table_name,
        record_id,
        action,
        user_id,
        timestamp,
        ip_address,
        user_agent
    ) VALUES (
        table_name,
        record_id,
        action,
        user_id,
        NOW(),
        current_setting('request.headers', true)::json->>'x-forwarded-for',
        current_setting('request.headers', true)::json->>'user-agent'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ìë™ ë¡œê·¸ ê¸°ë¡ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION auto_log_access()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        PERFORM log_access(TG_TABLE_NAME, NEW.id, 'INSERT');
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        PERFORM log_access(TG_TABLE_NAME, NEW.id, 'UPDATE');
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        PERFORM log_access(TG_TABLE_NAME, OLD.id, 'DELETE');
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

### 10.5.2 ê°ì‚¬ ë¡œê·¸ í…Œì´ë¸”
```sql
-- ì ‘ê·¼ ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE access_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    table_name TEXT NOT NULL,
    record_id UUID NOT NULL,
    action TEXT NOT NULL,
    user_id UUID NOT NULL REFERENCES auth.users(id),
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ip_address INET,
    user_agent TEXT,
    changes JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì‹œìŠ¤í…œ ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE system_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    level TEXT NOT NULL, -- 'info', 'warn', 'error', 'debug'
    message TEXT NOT NULL,
    context JSONB,
    user_id UUID REFERENCES auth.users(id),
    ip_address INET,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 10.6 API ë³´ì•ˆ

### 10.6.1 MCP ê¸°ë°˜ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ (Alpine.js/JavaScript êµ¬ì¡°)
```javascript
// utils/auth.js - MCP ì—°ë™ Alpine.js í˜¸í™˜ ì¸ì¦ ìœ í‹¸ë¦¬í‹°
/**
 * MCP ê¸°ë°˜ ì¸ì¦ ê´€ë¦¬ Alpine.js ì»´í¬ë„ŒíŠ¸
 * Supabase MCP Authì™€ í†µí•©í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬
 * MCP íˆ´ í˜¸ì¶œ ì‹œ ìë™ ì¸ì¦ í† í° ê²€ì¦ ë° ê¶Œí•œ í™•ì¸
 */
function authManager() {
  return {
    user: null,
    isAuthenticated: false,
    userRole: 'teacher',
    loading: false,
    mcpServerStatus: {
      supabase: false,
      payments: false
    },
    
    /**
     * MCP ê¸°ë°˜ ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° MCP ì„œë²„ ì—°ê²° ê²€ì¦
     */
    async init() {
      this.loading = true;
      try {
        // MCP ì„œë²„ ìƒíƒœ í™•ì¸
        await this.checkMcpServerStatus();
        
        // Supabase MCPë¥¼ í†µí•œ ì„¸ì…˜ í™•ì¸
        const session = await this.getMcpSession();
        
        if (!session) {
          this.handleAuthError();
          return;
        }
        
        this.user = session.user;
        this.isAuthenticated = true;
        this.userRole = session.user.user_metadata?.role || 'teacher';
        
        // UTF-8 ì‚¬ìš©ì ë°ì´í„° ê²€ì¦
        this.validateUserDataUTF8();
        
        // MCP ì¸ì¦ í† í° ê²€ì¦
        await this.validateMcpAuthToken();
        
      } catch (error) {
        console.error('MCP ì¸ì¦ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        this.handleAuthError();
      } finally {
        this.loading = false;
      }
    },
    
    /**
     * MCP ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
     */
    async checkMcpServerStatus() {
      try {
        // Supabase MCP ì„œë²„ ìƒíƒœ í™•ì¸
        if (typeof window.mcp !== 'undefined') {
          this.mcpServerStatus.supabase = await window.mcp.checkServerHealth('supabase');
          this.mcpServerStatus.payments = await window.mcp.checkServerHealth('toss-payments');
        }
      } catch (error) {
        console.error('MCP ì„œë²„ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
      }
    },
    
    /**
     * MCPë¥¼ í†µí•œ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
     */
    async getMcpSession() {
      try {
        if (!this.mcpServerStatus.supabase) {
          throw new Error('Supabase MCP ì„œë²„ ì—°ê²° ë¶ˆê°€');
        }
        
        const result = await window.mcp.callTool('supabase', 'get_session', {});
        return result.data;
      } catch (error) {
        console.error('MCP ì„¸ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        return null;
      }
    },
    
    /**
     * MCP ì¸ì¦ í† í° ê²€ì¦
     */
    async validateMcpAuthToken() {
      try {
        const result = await window.mcp.callTool('supabase', 'validate_auth_token', {
          user_id: this.user.id,
          role: this.userRole
        });
        
        if (!result.success) {
          throw new Error('MCP ì¸ì¦ í† í° ê²€ì¦ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('MCP ì¸ì¦ í† í° ê²€ì¦ ì˜¤ë¥˜:', error);
        this.handleAuthError();
      }
    },
    
    /**
     * API ìš”ì²­ì„ ìœ„í•œ ì¸ì¦ í—¤ë” ìƒì„±
     * @returns {Object} ì¸ì¦ í—¤ë” ê°ì²´
     */
    async getAuthHeaders() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error || !session) {
          throw new Error('ì¸ì¦ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }
        
        return {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
          'x-user-role': this.userRole
        };
      } catch (error) {
        console.error('ì¸ì¦ í—¤ë” ìƒì„± ì‹¤íŒ¨:', error);
        this.handleAuthError();
        throw error;
      }
    },
    
    /**
     * ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
     * @param {string} requiredRole - í•„ìš”í•œ ê¶Œí•œ ë ˆë²¨
     * @returns {boolean} ê¶Œí•œ ë³´ìœ  ì—¬ë¶€
     */
    hasPermission(requiredRole = 'teacher') {
      if (!this.isAuthenticated) {
        return false;
      }
      
      // ê¶Œí•œ ë ˆë²¨ ë§¤í•‘ (ë†’ì€ ìˆ«ìê°€ ë” ë†’ì€ ê¶Œí•œ)
      const roleHierarchy = {
        'teacher': 1,
        'super_admin': 2
      };
      
      const userLevel = roleHierarchy[this.userRole] || 0;
      const requiredLevel = roleHierarchy[requiredRole] || 0;
      
      return userLevel >= requiredLevel;
    },
    
    /**
     * ì¸ì¦ ì˜¤ë¥˜ ì²˜ë¦¬
     */
    handleAuthError() {
      this.user = null;
      this.isAuthenticated = false;
      this.userRole = 'teacher';
      
      // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (HTMX ë°©ì‹)
      if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', '/login', {
          target: 'body',
          swap: 'outerHTML'
        });
      } else {
        window.location.href = '/login';
      }
    },
    
    /**
     * ì ‘ê·¼ì„±: ì¸ì¦ ìƒíƒœ ì•Œë¦¼
     * @param {string} message - ì•Œë¦¼ ë©”ì‹œì§€
     */
    announceAuthStatus(message) {
      const statusElement = document.getElementById('auth-status-announcement');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.setAttribute('aria-live', 'polite');
      }
    },
    
    /**
     * UTF-8 ì•ˆì „ì„±ì„ ê³ ë ¤í•œ ì‚¬ìš©ì ë°ì´í„° ê²€ì¦
     * @param {Object} userData - ì‚¬ìš©ì ë°ì´í„°
     * @returns {boolean} ì•ˆì „í•œ ë°ì´í„° ì—¬ë¶€
     */
    validateUserDataUTF8(userData) {
      try {
        const jsonString = JSON.stringify(userData);
        const encoded = new TextEncoder().encode(jsonString);
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
        return JSON.parse(decoded) !== null;
      } catch (error) {
        console.error('ì‚¬ìš©ì ë°ì´í„° UTF-8 ê²€ì¦ ì‹¤íŒ¨:', error);
        return false;
      }
    }
  };
}
```

### 10.6.2 ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
```javascript
// lib/permissions.js - Alpine.js í˜¸í™˜ ê¶Œí•œ ê´€ë¦¬

/**
 * ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
 * Alpine.js ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 * @param {string} userRole - ì‚¬ìš©ì ì—­í•  ('teacher' | 'super_admin')
 * @param {string} resource - ë¦¬ì†ŒìŠ¤ ì´ë¦„
 * @param {string} action - ìˆ˜í–‰í•  ì•¡ì…˜ ('read' | 'create' | 'update' | 'delete')
 * @returns {boolean} ê¶Œí•œ ì—¬ë¶€
 */
function checkPermission(userRole, resource, action) {
  if (!userRole || !resource || !action) {
    return false;
  }
  
  const permissions = {
    teacher: {
      students: ['read', 'create', 'update', 'delete'], // ë³¸ì¸ í•™ìƒë§Œ
      current_levels: ['read', 'create', 'update'],
      monthly_plans: ['read', 'create', 'update'],
      monthly_evaluations: ['read', 'create', 'update'],
      payments: ['read'], // ë³¸ì¸ ê²°ì œë§Œ
      licenses: ['read'], // ë³¸ì¸ ë¼ì´ì„ ìŠ¤ë§Œ
    },
    super_admin: {
      students: ['read', 'create', 'update', 'delete'], // ëª¨ë“  í•™ìƒ
      current_levels: ['read', 'create', 'update', 'delete'],
      monthly_plans: ['read', 'create', 'update', 'delete'],
      monthly_evaluations: ['read', 'create', 'update', 'delete'],
      payments: ['read', 'create', 'update'], // ëª¨ë“  ê²°ì œ
      licenses: ['read', 'create', 'update', 'delete'], // ëª¨ë“  ë¼ì´ì„ ìŠ¤
      serial_codes: ['read', 'create', 'update', 'delete'],
      users: ['read', 'create', 'update', 'delete'],
      system_logs: ['read'],
      tool_links: ['read', 'create', 'update', 'delete'],
    },
  };

  return permissions[userRole]?.[resource]?.includes(action) || false;
}

/**
 * Alpine.js í˜¸í™˜ ê¶Œí•œ ê²€ì¦ í—¬í¼ í•¨ìˆ˜
 * ê¶Œí•œì´ ì—†ì„ ê²½ìš° ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ëŠ” ëŒ€ì‹  ì‚¬ìš©ì ì¹œí™”ì  ì²˜ë¦¬
 * @param {string} userRole - ì‚¬ìš©ì ì—­í• 
 * @param {string} resource - ë¦¬ì†ŒìŠ¤ ì´ë¦„
 * @param {string} action - ìˆ˜í–‰í•  ì•¡ì…˜
 * @param {Function} callback - ê¶Œí•œì´ ìˆì„ ë•Œ ì‹¤í–‰í•  ì½œë°± í•¨ìˆ˜
 * @param {Function} errorCallback - ê¶Œí•œì´ ì—†ì„ ë•Œ ì‹¤í–‰í•  ì½œë°± í•¨ìˆ˜
 */
function requirePermission(userRole, resource, action, callback, errorCallback) {
  if (checkPermission(userRole, resource, action)) {
    if (typeof callback === 'function') {
      return callback();
    }
    return true;
  } else {
    const errorMessage = 'í•´ë‹¹ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    
    if (typeof errorCallback === 'function') {
      return errorCallback(errorMessage);
    }
    
    // Alpine.js ì»´í¬ë„ŒíŠ¸ì—ì„œ í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
    if (typeof Alpine !== 'undefined') {
      Alpine.store('toast').show(errorMessage, 'error');
    }
    
    return false;
  }
}
```

---

## 10.7 ì…ë ¥ ê²€ì¦ ë° ë³´ì•ˆ

### 10.7.1 ì…ë ¥ ê²€ì¦ ìŠ¤í‚¤ë§ˆ
```javascript
// lib/validation.js - Alpine.js í˜¸í™˜ ì…ë ¥ ê²€ì¦

/**
 * í•™ìƒ ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
 * Alpine.js í¼ì—ì„œ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 * @param {Object} studentData - ê²€ì¦í•  í•™ìƒ ë°ì´í„°
 * @returns {Object} { isValid: boolean, errors: Object }
 */
function validateStudent(studentData) {
  const errors = {};
  
  // ì´ë¦„ ê²€ì¦
  if (!studentData.name || studentData.name.trim() === '') {
    errors.name = 'ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤';
  } else if (studentData.name.length < 2) {
    errors.name = 'ì´ë¦„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤';
  } else if (studentData.name.length > 100) {
    errors.name = 'ì´ë¦„ì€ 100ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
  } else if (!/^[ê°€-í£a-zA-Z\s]+$/.test(studentData.name)) {
    errors.name = 'ì´ë¦„ì€ í•œê¸€, ì˜ë¬¸, ê³µë°±ë§Œ í—ˆìš©ë©ë‹ˆë‹¤';
  }
  
  // ìƒë…„ì›”ì¼ ê²€ì¦
  if (!studentData.birth_date) {
    errors.birth_date = 'ìƒë…„ì›”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤';
  } else {
    const birthDate = new Date(studentData.birth_date);
    const today = new Date();
    const minDate = new Date('1900-01-01');
    
    if (birthDate > today) {
      errors.birth_date = 'ìƒë…„ì›”ì¼ì€ í˜„ì¬ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤';
    } else if (birthDate < minDate) {
      errors.birth_date = 'ìƒë…„ì›”ì¼ì´ ë„ˆë¬´ ì´ì „ì…ë‹ˆë‹¤';
    }
  }
  
  // í•™êµëª… ê²€ì¦ (ì„ íƒì‚¬í•­)
  if (studentData.school_name) {
    if (studentData.school_name.length > 200) {
      errors.school_name = 'í•™êµëª…ì€ 200ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    } else if (!/^[ê°€-í£a-zA-Z0-9\s\-()]+$/.test(studentData.school_name)) {
      errors.school_name = 'í•™êµëª…ì— íŠ¹ìˆ˜ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    }
  }
  
  // í•™ë…„ ê²€ì¦ (ì„ íƒì‚¬í•­)
  if (studentData.grade !== undefined && studentData.grade !== null) {
    const grade = Number(studentData.grade);
    if (isNaN(grade) || grade < 1 || grade > 12) {
      errors.grade = 'í•™ë…„ì€ 1~12 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤';
    }
  }
  
  // ì¥ì• ìœ í˜• ê²€ì¦
  if (studentData.disability_types && Array.isArray(studentData.disability_types)) {
    const validTypes = [
      'ì§€ì ì¥ì• ', 'ìíì„±ì¥ì• ', 'ì •ì„œí–‰ë™ì¥ì• ', 'ì˜ì‚¬ì†Œí†µì¥ì• ',
      'í•™ìŠµì¥ì• ', 'ê±´ê°•ì¥ì• ', 'ë°œë‹¬ì§€ì²´', 'ê¸°íƒ€'
    ];
    
    const invalidTypes = studentData.disability_types.filter(
      type => !validTypes.includes(type)
    );
    
    if (invalidTypes.length > 0) {
      errors.disability_types = `ìœ íš¨í•˜ì§€ ì•Šì€ ì¥ì• ìœ í˜•: ${invalidTypes.join(', ')}`;
    }
  }
  
  return {
    isValid: Object.keys(errors).length === 0,
    errors
  };
}

/**
 * XSS ë°©ì§€ í•¨ìˆ˜ - Alpine.jsì—ì„œ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 * @param {string} input - ìƒˆë‹ˆíƒ€ì´ì§•í•  ì…ë ¥ ë¬¸ìì—´
 * @returns {string} ìƒˆë‹ˆíƒ€ì´ì§•ëœ ë¬¸ìì—´
 */
function sanitizeInput(input) {
  if (!input) return '';
  return input
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

/**
 * SQL ì¸ì ì…˜ ë°©ì§€ í•¨ìˆ˜ (SupabaseëŠ” ìë™ìœ¼ë¡œ ë°©ì§€í•˜ì§€ë§Œ ì¶”ê°€ ê²€ì¦)
 * Alpine.js í¼ ê²€ì¦ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
 * @param {string} input - ê²€ì¦í•  ì…ë ¥ ë¬¸ìì—´
 * @returns {boolean} ì•ˆì „í•œ ì…ë ¥ì¸ì§€ ì—¬ë¶€
 */
function validateSqlInput(input) {
  if (!input) return true;
  
  const sqlKeywords = [
    'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'DROP', 'CREATE',
    'ALTER', 'EXEC', 'UNION', 'SCRIPT', 'JAVASCRIPT'
  ];
  
  const upperInput = input.toUpperCase();
  return !sqlKeywords.some(keyword => upperInput.includes(keyword));
}
```

### 10.7.2 íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ
```javascript
// lib/fileUpload.js
const ALLOWED_MIME_TYPES = [
  'application/pdf',
  'image/jpeg',
  'image/png',
  'image/gif',
  'application/vnd.hancom.hwp',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'video/mp4'
];

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

/**
 * íŒŒì¼ ë³´ì•ˆ ì„¤ì • ê°ì²´
 * Alpine.js ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 */
const fileSecurityConfig = {
  maxFileSize: MAX_FILE_SIZE,
  allowedTypes: ALLOWED_MIME_TYPES,
  allowedExtensions: ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.hwp', '.docx', '.mp4'],
  scanForVirus: true,
  quarantinePath: '/quarantine'
};

/**
 * íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ ê²€ì¦ í•¨ìˆ˜
 * Alpine.js íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @param {File} file - ê²€ì¦í•  íŒŒì¼ ê°ì²´
 * @returns {Promise<Object>} ê²€ì¦ ê²°ê³¼ { isValid: boolean, error?: string }
 */
async function validateFileUpload(file) {
  // íŒŒì¼ í¬ê¸° ê²€ì¦
  if (file.size > fileSecurityConfig.maxFileSize) {
    return {
      isValid: false,
      error: `íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${fileSecurityConfig.maxFileSize / (1024 * 1024)}MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
    };
  }

  // íŒŒì¼ íƒ€ì… ê²€ì¦
  if (!fileSecurityConfig.allowedTypes.includes(file.type)) {
    return {
      isValid: false,
      error: 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'
    };
  }

  // íŒŒì¼ í™•ì¥ì ê²€ì¦
  const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();
  if (!fileSecurityConfig.allowedExtensions.includes(fileExtension)) {
    return {
      isValid: false,
      error: 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í™•ì¥ìì…ë‹ˆë‹¤.'
    };
  }

  // íŒŒì¼ ë‚´ìš© ê²€ì¦ (ë§¤ì§ ë„˜ë²„ í™•ì¸)
  const isValidContent = await validateFileContent(file);
  if (!isValidContent) {
    return {
      isValid: false,
      error: 'íŒŒì¼ ë‚´ìš©ì´ í™•ì¥ìì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
    };
  }

  return { isValid: true };
}

// íŒŒì¼ ë‚´ìš© ê²€ì¦ (ë§¤ì§ ë„˜ë²„)
async function validateFileContent(file) {
  const buffer = await file.arrayBuffer();
  const bytes = new Uint8Array(buffer.slice(0, 4));
  
  // ì£¼ìš” íŒŒì¼ íƒ€ì…ì˜ ë§¤ì§ ë„˜ë²„ ê²€ì¦
  const magicNumbers = {
    'image/jpeg': [0xFF, 0xD8, 0xFF],
    'image/png': [0x89, 0x50, 0x4E, 0x47],
    'application/pdf': [0x25, 0x50, 0x44, 0x46]
  };

  const expectedMagic = magicNumbers[file.type as keyof typeof magicNumbers];
  if (expectedMagic) {
    return expectedMagic.every((byte, index) => bytes[index] === byte);
  }

  return true; // ë§¤ì§ ë„˜ë²„ê°€ ì •ì˜ë˜ì§€ ì•Šì€ íƒ€ì…ì€ í†µê³¼
}

/**
 * íŒŒì¼ ì´ë¦„ ìƒˆë‹ˆíƒ€ì´ì§• í•¨ìˆ˜
 * Alpine.js íŒŒì¼ ì—…ë¡œë“œì—ì„œ ì‚¬ìš©
 * @param {string} fileName - ìƒˆë‹ˆíƒ€ì´ì§•í•  íŒŒì¼ëª…
 * @returns {string} ì•ˆì „í•œ íŒŒì¼ëª…
 */
function sanitizeFileName(fileName) {
  if (!fileName) return 'unknown_file';
  
  // ìœ„í—˜í•œ ë¬¸ì ì œê±° ë° UTF-8 ì•ˆì „ì„± ë³´ì¥
  return fileName
    .replace(/[^a-zA-Z0-9._ê°€-í£-]/g, '_') // í•œê¸€ í—ˆìš©
    .replace(/_{2,}/g, '_')
    .substring(0, 100); // ìµœëŒ€ 100ìë¡œ ì œí•œ
}
```

---

## 10.8 ì„¸ì…˜ ë° í† í° ê´€ë¦¬

### 10.8.1 JWT í† í° ì„¤ì • (Alpine.js/JavaScript êµ¬ì¡°)
```javascript
// lib/jwt.js - Alpine.js í˜¸í™˜ JWT ê´€ë¦¬
/**
 * JWT í† í° ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°
 * Supabase Authì™€ í†µí•©í•˜ì—¬ í† í° ìƒì„±, ê²€ì¦, ê°±ì‹  ì²˜ë¦¬
 */

/**
 * í† í° í˜ì´ë¡œë“œ íŒ©í† ë¦¬ í•¨ìˆ˜
 * @param {Object} data - í† í°ì— í¬í•¨í•  ë°ì´í„°
 * @returns {Object} í† í° í˜ì´ë¡œë“œ êµ¬ì¡°
 */
function createTokenPayload(data = {}) {
  return {
    userId: data.userId || '',
    role: data.role || 'teacher',
    exp: data.exp || Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60), // 7ì¼
    iat: Math.floor(Date.now() / 1000),
    iss: 'iepon-system',
    aud: 'iepon-users'
  };
}

/**
 * JWT í† í° ìƒì„± (Supabase ê¸°ë°˜)
 * Alpine.js ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
 * @param {Object} payload - í† í° í˜ì´ë¡œë“œ
 * @returns {Promise<string>} ìƒì„±ëœ JWT í† í°
 */
async function generateCustomToken(payload) {
  try {
    // Supabase Edge Functionì„ í†µí•œ ì»¤ìŠ¤í…€ í† í° ìƒì„±
    const { data, error } = await supabase.functions.invoke('generate-custom-token', {
      body: JSON.stringify(createTokenPayload(payload))
    });

    if (error) {
      throw new Error(`í† í° ìƒì„± ì‹¤íŒ¨: ${error.message}`);
    }

    return data.token;
  } catch (error) {
    console.error('JWT í† í° ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * JWT í† í° ê²€ì¦
 * Alpine.js ì¸ì¦ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @param {string} token - ê²€ì¦í•  í† í°
 * @returns {Promise<Object|null>} í† í° í˜ì´ë¡œë“œ ë˜ëŠ” null
 */
async function verifyCustomToken(token) {
  try {
    if (!token) return null;

    // Supabaseë¥¼ í†µí•œ í† í° ê²€ì¦
    const { data: { user }, error } = await supabase.auth.getUser(token);
    
    if (error || !user) {
      console.error('í† í° ê²€ì¦ ì‹¤íŒ¨:', error?.message);
      return null;
    }

    return {
      userId: user.id,
      role: user.user_metadata?.role || 'teacher',
      email: user.email,
      exp: user.exp,
      iat: user.iat
    };
  } catch (error) {
    console.error('í† í° ê²€ì¦ ì˜¤ë¥˜:', error);
    return null;
  }
}

/**
 * í† í° ê°±ì‹  (Alpine.js ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©)
 * @param {string} oldToken - ê¸°ì¡´ í† í°
 * @returns {Promise<string|null>} ìƒˆë¡œìš´ í† í° ë˜ëŠ” null
 */
async function refreshCustomToken(oldToken) {
  try {
    const payload = await verifyCustomToken(oldToken);
    if (!payload) return null;

    // í† í° ë§Œë£Œ 30ë¶„ ì „ì—ë§Œ ê°±ì‹  í—ˆìš©
    const thirtyMinutes = 30 * 60;
    if (payload.exp - Math.floor(Date.now() / 1000) > thirtyMinutes) {
      return oldToken; // ì•„ì§ ê°±ì‹ í•  í•„ìš” ì—†ìŒ
    }

    // ìƒˆ í† í° ìƒì„±
    return await generateCustomToken({
      userId: payload.userId,
      role: payload.role
    });
  } catch (error) {
    console.error('í† í° ê°±ì‹  ì˜¤ë¥˜:', error);
    return null;
  }
}

/**
 * Alpine.js í† í° ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸
 */
function tokenManager() {
  return {
    token: null,
    isValid: false,
    expiresAt: null,
    
    /**
     * í† í° ì´ˆê¸°í™”
     */
    async init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        this.token = session.access_token;
        this.expiresAt = new Date(session.expires_at * 1000);
        this.isValid = true;
        
        // ìë™ ê°±ì‹  ì„¤ì •
        this.scheduleRefresh();
      }
    },
    
    /**
     * í† í° ìë™ ê°±ì‹  ìŠ¤ì¼€ì¤„ë§
     */
    scheduleRefresh() {
      if (!this.expiresAt) return;
      
      const refreshTime = this.expiresAt.getTime() - Date.now() - (5 * 60 * 1000); // 5ë¶„ ì „
      
      if (refreshTime > 0) {
        setTimeout(async () => {
          await this.refreshToken();
        }, refreshTime);
      }
    },
    
    /**
     * í† í° ê°±ì‹ 
     */
    async refreshToken() {
      try {
        const { data, error } = await supabase.auth.refreshSession();
        
        if (error || !data.session) {
          this.handleTokenError();
          return;
        }
        
        this.token = data.session.access_token;
        this.expiresAt = new Date(data.session.expires_at * 1000);
        this.isValid = true;
        
        // ë‹¤ìŒ ê°±ì‹  ìŠ¤ì¼€ì¤„ë§
        this.scheduleRefresh();
        
        // HTMX í—¤ë” ì—…ë°ì´íŠ¸
        this.updateHTMXHeaders();
      } catch (error) {
        console.error('í† í° ê°±ì‹  ì‹¤íŒ¨:', error);
        this.handleTokenError();
      }
    },
    
    /**
     * HTMX ìš”ì²­ í—¤ë” ì—…ë°ì´íŠ¸
     */
    updateHTMXHeaders() {
      if (typeof htmx !== 'undefined' && this.token) {
        htmx.config.defaultHeaders = {
          ...htmx.config.defaultHeaders,
          'Authorization': `Bearer ${this.token}`
        };
      }
    },
    
    /**
     * í† í° ì˜¤ë¥˜ ì²˜ë¦¬
     */
    handleTokenError() {
      this.token = null;
      this.isValid = false;
      this.expiresAt = null;
      
      // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', '/login', { target: 'body', swap: 'outerHTML' });
      } else {
        window.location.href = '/login';
      }
    }
  };
}
```

### 10.8.2 ì„¸ì…˜ ë³´ì•ˆ ì„¤ì •
```javascript
// lib/session.js - Alpine.js í˜¸í™˜ ì„¸ì…˜ ê´€ë¦¬

/**
 * ë³´ì•ˆ ì„¸ì…˜ ì„¤ì • (ë¸Œë¼ìš°ì € í™˜ê²½)
 * Supabase Authì™€ í†µí•©í•˜ì—¬ ì„¸ì…˜ ë³´ì•ˆì„± ê°•í™”
 */
const secureSessionConfig = {
  // localStorage ëŒ€ì‹  sessionStorage ì‚¬ìš©ìœ¼ë¡œ ë³´ì•ˆ ê°•í™”
  storage: 'session', // 'session' | 'local'
  maxAge: 7 * 24 * 60 * 60, // 7ì¼ (ì´ˆ ë‹¨ìœ„)
  refreshMargin: 5 * 60, // 5ë¶„ ì „ ìë™ ê°±ì‹ 
  domain: window.location.hostname.includes('iepon.site') ? '.iepon.site' : undefined,
  // HTTPS í™˜ê²½ì—ì„œë§Œ ë³´ì•ˆ ì¿ í‚¤ ì‚¬ìš©
  secure: window.location.protocol === 'https:'
};

/**
 * ì„¸ì…˜ ë¬´íš¨í™” í•¨ìˆ˜ (ë¸Œë¼ìš°ì € í™˜ê²½)
 * Alpine.js ë¡œê·¸ì•„ì›ƒ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 */
function invalidateSession() {
  try {
    // Supabase ì„¸ì…˜ ì¢…ë£Œ
    supabase.auth.signOut();
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    if (secureSessionConfig.storage === 'local') {
      localStorage.removeItem('supabase.auth.token');
    } else {
      sessionStorage.removeItem('supabase.auth.token');
    }
    
    // HTMX í—¤ë” ì •ë¦¬
    if (typeof htmx !== 'undefined') {
      delete htmx.config.defaultHeaders['Authorization'];
    }
    
    return true;
  } catch (error) {
    console.error('ì„¸ì…˜ ë¬´íš¨í™” ì‹¤íŒ¨:', error);
    return false;
  }
}

/**
 * ì„¸ì…˜ ê°±ì‹  í•¨ìˆ˜ (ë¸Œë¼ìš°ì € í™˜ê²½)
 * Alpine.js í† í° ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @param {string} token - ìƒˆë¡œìš´ í† í°
 */
function refreshSession(token) {
  try {
    if (!token) {
      throw new Error('í† í°ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    }
    
    // ìƒˆë¡œìš´ í† í° ì €ì¥
    if (secureSessionConfig.storage === 'local') {
      localStorage.setItem('supabase.auth.token', token);
    } else {
      sessionStorage.setItem('supabase.auth.token', token);
    }
    
    // HTMX í—¤ë” ì—…ë°ì´íŠ¸
    if (typeof htmx !== 'undefined') {
      htmx.config.defaultHeaders = {
        ...htmx.config.defaultHeaders,
        'Authorization': `Bearer ${token}`
      };
    }
    
    return true;
  } catch (error) {
    console.error('ì„¸ì…˜ ê°±ì‹  ì‹¤íŒ¨:', error);
    return false;
  }
}



### 10.9.1 ê´€ë¦¬ì ê³„ì • ìë™ ìƒì„± ë° ê´€ë¦¬
```javascript
// lib/admin/setup.js - Alpine.js í˜¸í™˜ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬

/**
 * ê´€ë¦¬ì ê³„ì • ì„¤ì • íƒ€ì… ì •ì˜
 * @typedef {Object} AdminConfig
 * @property {string} email - ê´€ë¦¬ì ì´ë©”ì¼
 * @property {string} password - ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
 * @property {string} role - ê´€ë¦¬ì ì—­í• 
 * @property {string} displayName - í‘œì‹œ ì´ë¦„
 */

/**
 * í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê´€ë¦¬ì ì„¤ì • ë¡œë“œ
 * Alpine.js í™˜ê²½ì—ì„œ ì‚¬ìš© (ë¸Œë¼ìš°ì € ê¸°ë°˜)
 * @returns {AdminConfig} ê´€ë¦¬ì ì„¤ì • ê°ì²´
 */
function getAdminConfig() {
  // ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” window.ENV ê°ì²´ ì‚¬ìš©
  const env = window.ENV || {};
  
  const requiredEnvVars = {
    email: env.ADMIN_EMAIL,
    password: env.ADMIN_PASSWORD,
    role: env.ADMIN_ROLE || 'super_admin',
    displayName: env.ADMIN_DISPLAY_NAME || 'System Administrator'
  };

  // í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ë° UTF-8 ì•ˆì „ì„± í™•ì¸
  if (!requiredEnvVars.email || !requiredEnvVars.password) {
    const errorMessage = 'ê´€ë¦¬ì ê³„ì • í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ADMIN_EMAILê³¼ ADMIN_PASSWORDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
    console.error(errorMessage);
    throw new Error(errorMessage);
  }
  
  // UTF-8 ì¸ì½”ë”© ê²€ì¦
  const textFields = [requiredEnvVars.email, requiredEnvVars.displayName];
  const isUTF8Safe = textFields.every(field => {
    try {
      const encoded = new TextEncoder().encode(field);
      const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
      return decoded === field;
    } catch {
      return false;
    }
  });
  
  if (!isUTF8Safe) {
    throw new Error('ê´€ë¦¬ì ì„¤ì •ì— UTF-8 ì¸ì½”ë”© ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
  }

  return requiredEnvVars;
}

/**
 * ê´€ë¦¬ì ê³„ì • ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
 * Alpine.js ê´€ë¦¬ì ì„¤ì • ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 */
async function ensureAdminAccount() {
  try {
    const adminConfig = getAdminConfig();
    
    // ê¸°ì¡´ ê´€ë¦¬ì ê³„ì • í™•ì¸
    const { data: existingUser, error: fetchError } = await supabaseAdmin.auth.admin.getUserByEmail(adminConfig.email);
    
    if (fetchError && fetchError.message !== 'User not found') {
      throw fetchError;
    }

    if (existingUser?.user) {
      // ê¸°ì¡´ ê³„ì •ì´ ìˆìœ¼ë©´ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
      await updateAdminAccount(existingUser.user.id, adminConfig);
      logger.info(`ê´€ë¦¬ì ê³„ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${adminConfig.email}`);
    } else {
      // ìƒˆ ê´€ë¦¬ì ê³„ì • ìƒì„±
      await createAdminAccount(adminConfig);
      logger.info(`ê´€ë¦¬ì ê³„ì • ìƒì„± ì™„ë£Œ: ${adminConfig.email}`);
    }
  } catch (error) {
    logger.error('ê´€ë¦¬ì ê³„ì • ì„¤ì • ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ìƒˆ ê´€ë¦¬ì ê³„ì • ìƒì„±
async function createAdminAccount(config) {
  const { data, error } = await supabaseAdmin.auth.admin.createUser({
    email: config.email,
    password: config.password,
    email_confirm: true,
    user_metadata: {
      role: config.role,
      display_name: config.displayName,
      is_admin: true,
      created_by: 'system',
      created_at: new Date().toISOString()
    }
  });

  if (error) {
    throw new Error(`ê´€ë¦¬ì ê³„ì • ìƒì„± ì‹¤íŒ¨: ${error.message}`);
  }

  // ê´€ë¦¬ì í”„ë¡œí•„ ì •ë³´ ì¶”ê°€ ì €ì¥
  if (data.user) {
    await supabaseAdmin
      .from('user_profiles')
      .upsert({
        user_id: data.user.id,
        email: config.email,
        display_name: config.displayName,
        role: config.role,
        is_admin: true,
        status: 'active'
      });
  }
}

// ê¸°ì¡´ ê´€ë¦¬ì ê³„ì • ì—…ë°ì´íŠ¸
async function updateAdminAccount(userId, config) {
  // ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
  const { error: passwordError } = await supabaseAdmin.auth.admin.updateUserById(userId, {
    password: config.password
  });

  if (passwordError) {
    throw new Error(`ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${passwordError.message}`);
  }

  // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
  const { error: metadataError } = await supabaseAdmin.auth.admin.updateUserById(userId, {
    user_metadata: {
      role: config.role,
      display_name: config.displayName,
      is_admin: true,
      updated_at: new Date().toISOString()
    }
  });

  if (metadataError) {
    throw new Error(`ê´€ë¦¬ì ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${metadataError.message}`);
  }

  // í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
  await supabaseAdmin
    .from('user_profiles')
    .upsert({
      user_id: userId,
      email: config.email,
      display_name: config.displayName,
      role: config.role,
      is_admin: true,
      status: 'active'
    });
}
```

### 10.9.2 ê´€ë¦¬ì ê³„ì • ë³´ì•ˆ ê²€ì¦ (Alpine.js/JavaScript êµ¬ì¡°)
```javascript
// lib/admin/security.js - Alpine.js í˜¸í™˜ ê´€ë¦¬ì ë³´ì•ˆ ê²€ì¦
/**
 * ê´€ë¦¬ì ê³„ì • ë³´ì•ˆ ê²€ì¦ ë° ë¡œê¹… ìœ í‹¸ë¦¬í‹°
 * Supabaseì™€ í†µí•©í•˜ì—¬ ì•ˆì „í•œ ê´€ë¦¬ì ë³´ì•ˆ ê´€ë¦¬
 */

/**
 * ê´€ë¦¬ì ë³´ì•ˆ ê²€ì¦
 * @returns {Promise<boolean>} ë³´ì•ˆ ê²€ì¦ í†µê³¼ ì—¬ë¶€
 */
/**
 * ê´€ë¦¬ì ë³´ì•ˆ ê²€ì¦ í•¨ìˆ˜
 * Alpine.js ê´€ë¦¬ì ì„¤ì • ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @returns {Promise<boolean>} ë³´ì•ˆ ê²€ì¦ í†µê³¼ ì—¬ë¶€
 */
async function validateAdminSecurity() {
  try {
    const adminConfig = getAdminConfig();
    
    // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦
    if (!isStrongPassword(adminConfig.password)) {
      console.error('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return false;
    }

    // Supabaseë¥¼ í†µí•œ ê´€ë¦¬ì ê³„ì • í™œì„± ìƒíƒœ í™•ì¸
    const { data: adminUser, error } = await supabase.rpc('get_user_by_email', {
      user_email: adminConfig.email
    });
    
    if (error || !adminUser || adminUser.length === 0) {
      console.error('ê´€ë¦¬ì ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return false;
    }

    const user = adminUser[0];
    if (!user.approved || user.banned_until) {
      console.error('ê´€ë¦¬ì ê³„ì •ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
      return false;
    }

    return true;
  } catch (error) {
    console.error('ê´€ë¦¬ì ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨:', error);
    return false;
  }
}

/**
 * ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
 * @param {string} password - ê²€ì¦í•  ë¹„ë°€ë²ˆí˜¸
 * @returns {boolean} ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì¶©ì¡± ì—¬ë¶€
 */
function isStrongPassword(password) {
  if (!password || typeof password !== 'string') {
    return false;
  }
  
  // UTF-8 ì•ˆì „ì„± ê²€ì¦
  try {
    const encoded = new TextEncoder().encode(password);
    const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
    if (decoded !== password) return false;
  } catch {
    return false;
  }
  
  // ìµœì†Œ 8ì, ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨
  const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  return strongPasswordRegex.test(password);
}

/**
 * ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œë„ ë¡œê¹… í•¨ìˆ˜
 * Alpine.js ë¡œê·¸ì¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @param {string} email - ê´€ë¦¬ì ì´ë©”ì¼
 * @param {boolean} success - ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€
 * @param {string} ip - IP ì£¼ì†Œ
 */
async function logAdminLogin(email, success, ip) {
  try {
    const logData = {
      admin_email: email,
      login_success: success,
      ip_address: ip || 'unknown',
      timestamp: new Date().toISOString(),
      user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : 'Server',
      session_id: crypto.randomUUID()
    };

    // Supabaseë¥¼ í†µí•œ ë¡œê·¸ ì €ì¥
    const { error } = await supabase.from('admin_login_logs').insert(logData);
    
    if (error) {
      console.error('ê´€ë¦¬ì ë¡œê·¸ì¸ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
    }
    
    if (success) {
      console.log(`ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ: ${email}`);
    } else {
      console.warn(`ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨: ${email}`);
      
      // ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ë³´ì•ˆ ì¡°ì¹˜
      await handleFailedAdminLogin(email, ip);
    }
  } catch (error) {
    console.error('ê´€ë¦¬ì ë¡œê·¸ì¸ ë¡œê¹… ì˜¤ë¥˜:', error);
  }
}

/**
 * ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
 * @param {string} email - ê´€ë¦¬ì ì´ë©”ì¼
 * @param {string} ip - IP ì£¼ì†Œ
 */
async function handleFailedAdminLogin(email, ip) {
  try {
    // ìµœê·¼ ì‹¤íŒ¨ íšŸìˆ˜ í™•ì¸
    const { data: recentFailures, error } = await supabase
      .from('admin_login_logs')
      .select('*')
      .eq('admin_email', email)
      .eq('login_success', false)
      .gte('timestamp', new Date(Date.now() - 15 * 60 * 1000).toISOString()) // 15ë¶„ ë‚´
      .order('timestamp', { ascending: false });

    if (error) {
      console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      return;
    }

    const failureCount = recentFailures?.length || 0;
    
    // 5íšŒ ì´ìƒ ì‹¤íŒ¨ ì‹œ ê³„ì • ì„ì‹œ ì ê¸ˆ
    if (failureCount >= 5) {
      await temporaryLockAccount(email);
    }
  } catch (error) {
    console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
  }
}

/**
 * ê³„ì • ì„ì‹œ ì ê¸ˆ
 * @param {string} email - ê´€ë¦¬ì ì´ë©”ì¼
 */
async function temporaryLockAccount(email) {
  try {
    const lockUntil = new Date(Date.now() + 30 * 60 * 1000); // 30ë¶„ ì ê¸ˆ
    
    const { error } = await supabase
      .from('user_profiles')
      .update({ 
        banned_until: lockUntil.toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('email', email);

    if (error) {
      console.error('ê³„ì • ì ê¸ˆ ì‹¤íŒ¨:', error);
    } else {
      console.warn(`ê´€ë¦¬ì ê³„ì • ì„ì‹œ ì ê¸ˆ: ${email} (30ë¶„)`);
    }
  } catch (error) {
    console.error('ê³„ì • ì ê¸ˆ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
  }

## 10.10 íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ

### 10.10.1 íŒŒì¼ ë³´ì•ˆ ì„¤ì •
```javascript
/**
 * íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ ì„¤ì •
 * Alpine.js íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 */
const fileSecurityConfig = {
  maxFileSize: 10 * 1024 * 1024, // 10MB
  allowedTypes: [
    'image/jpeg', 'image/png', 'image/gif',
    'application/pdf', 'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ],
  allowedExtensions: ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.doc', '.docx'],
  scanForVirus: true,
  quarantinePath: '/quarantine'
};

/**
 * íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ ê²€ì¦ í•¨ìˆ˜
 * Alpine.js íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * @param {File} file - ì—…ë¡œë“œí•  íŒŒì¼ ê°ì²´
 * @returns {Promise<{isValid: boolean, error?: string}>} ê²€ì¦ ê²°ê³¼
 */
async function validateFileUpload(file) {
  // íŒŒì¼ í¬ê¸° ê²€ì¦
  if (file.size > fileSecurityConfig.maxFileSize) {
    return {
      isValid: false,
      error: `íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${fileSecurityConfig.maxFileSize / (1024 * 1024)}MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
    };
  }

  // íŒŒì¼ íƒ€ì… ê²€ì¦
  if (!fileSecurityConfig.allowedTypes.includes(file.type)) {
    return {
      isValid: false,
      error: 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'
    };
  }

  // íŒŒì¼ í™•ì¥ì ê²€ì¦
  const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();
  if (!fileSecurityConfig.allowedExtensions.includes(fileExtension)) {
    return {
      isValid: false,
      error: 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í™•ì¥ìì…ë‹ˆë‹¤.'
    };
  }

  // íŒŒì¼ ë‚´ìš© ê²€ì¦ (ë§¤ì§ ë„˜ë²„ í™•ì¸)
  const isValidContent = await validateFileContent(file);
  if (!isValidContent) {
    return {
      isValid: false,
      error: 'íŒŒì¼ ë‚´ìš©ì´ í™•ì¥ìì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
    };
  }

  return { isValid: true };
}

// íŒŒì¼ ë‚´ìš© ê²€ì¦ (ë§¤ì§ ë„˜ë²„)
async function validateFileContent(file) {
  const buffer = await file.arrayBuffer();
  const bytes = new Uint8Array(buffer.slice(0, 4));
  
  // ì£¼ìš” íŒŒì¼ íƒ€ì…ì˜ ë§¤ì§ ë„˜ë²„ ê²€ì¦
  const magicNumbers = {
    'image/jpeg': [0xFF, 0xD8, 0xFF],
    'image/png': [0x89, 0x50, 0x4E, 0x47],
    'application/pdf': [0x25, 0x50, 0x44, 0x46]
  };

  const expectedMagic = magicNumbers[file.type as keyof typeof magicNumbers];
  if (expectedMagic) {
    return expectedMagic.every((byte, index) => bytes[index] === byte);
  }

  return true; // ë§¤ì§ ë„˜ë²„ê°€ ì •ì˜ë˜ì§€ ì•Šì€ íƒ€ì…ì€ í†µê³¼
}

/**
 * íŒŒì¼ ì´ë¦„ ìƒˆë‹ˆíƒ€ì´ì§• í•¨ìˆ˜
 * Alpine.js íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * UTF-8 ì•ˆì „ì„±ì„ ê³ ë ¤í•œ í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬
 * @param {string} fileName - ì›ë³¸ íŒŒì¼ëª…
 * @returns {string} ì•ˆì „í•œ íŒŒì¼ëª…
 */
function sanitizeFileName(fileName) {
  try {
    // UTF-8 ì¸ì½”ë”© ê²€ì¦
    if (!validateUTF8(fileName)) {
      console.warn('íŒŒì¼ëª… UTF-8 ì¸ì½”ë”© ì˜¤ë¥˜, ê¸°ë³¸ê°’ ì‚¬ìš©');
      return 'file_' + Date.now();
    }

    // í•œê¸€ ë° ì•ˆì „í•œ ë¬¸ì í—ˆìš©
    return fileName
      .replace(/[^a-zA-Z0-9._\-ê°€-í£\s]/g, '_')
      .replace(/_{2,}/g, '_')
      .replace(/^[._\-]+|[._\-]+$/g, '') // ì‹œì‘/ë íŠ¹ìˆ˜ë¬¸ì ì œê±°
      .substring(0, 100); // ìµœëŒ€ 100ìë¡œ ì œí•œ
  } catch (error) {
    console.error('íŒŒì¼ëª… ìƒˆë‹ˆíƒ€ì´ì§• ì˜¤ë¥˜:', error);
    return 'file_' + Date.now();
  }
### 10.11.2 ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ (Alpine.js/JavaScript êµ¬ì¡°)
```javascript
// components/admin/SecurityDashboard.js - Alpine.js í˜¸í™˜ ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ
/**
 * ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ Alpine.js ì»´í¬ë„ŒíŠ¸
 * ì‹¤ì‹œê°„ ë³´ì•ˆ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬ ê¸°ëŠ¥
 */
function securityDashboard() {
  return {
    securityEvents: [],
    stats: {
      totalEvents: 0,
      criticalAlerts: 0,
      todayEvents: 0,
      activeThreats: 0
    },
    loading: false,
    error: null,
    filters: {
      severity: 'all',
      dateRange: '24h',
      eventType: 'all'
    },
    
    /**
     * ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
     */
    async init() {
      await this.loadSecurityData();
      this.startRealTimeUpdates();
      
      // ì ‘ê·¼ì„±: ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
      this.announceStatus('ë³´ì•ˆ ëŒ€ì‹œë³´ë“œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    },
    
    /**
     * ë³´ì•ˆ ë°ì´í„° ë¡œë“œ
     */
    async loadSecurityData() {
      this.loading = true;
      this.error = null;
      
      try {
        // ë³´ì•ˆ ì´ë²¤íŠ¸ ì¡°íšŒ
        await this.loadSecurityEvents();
        
        // í†µê³„ ë°ì´í„° ì¡°íšŒ
        await this.loadSecurityStats();
        
      } catch (error) {
        this.error = `ë³´ì•ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        console.error('ë³´ì•ˆ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
      } finally {
        this.loading = false;
      }
    },
    
    /**
     * ë³´ì•ˆ ì´ë²¤íŠ¸ ëª©ë¡ ì¡°íšŒ
     */
    async loadSecurityEvents() {
      const { data, error } = await supabase
        .from('security_events')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(100);

      if (error) {
        throw error;
      }

      this.securityEvents = data || [];
    },
    
    /**
     * ë³´ì•ˆ í†µê³„ ì¡°íšŒ
     */
    async loadSecurityStats() {
      const today = new Date().toISOString().split('T')[0];
      
      // ì˜¤ëŠ˜ì˜ ì´ë²¤íŠ¸ ì¡°íšŒ
      const { data: todayEvents, error: todayError } = await supabase
        .from('security_events')
        .select('*')
        .gte('timestamp', today + 'T00:00:00.000Z');

      if (todayError) {
        throw todayError;
      }

      // ì „ì²´ í†µê³„ ì¡°íšŒ
      const { data: allEvents, error: allError } = await supabase
        .from('security_events')
        .select('severity');

      if (allError) {
        throw allError;
      }

      this.stats = {
        totalEvents: allEvents?.length || 0,
        criticalAlerts: allEvents?.filter(e => e.severity === 'critical').length || 0,
        todayEvents: todayEvents?.length || 0,
        activeThreats: todayEvents?.filter(e => 
          e.severity === 'high' || e.severity === 'critical'
        ).length || 0
      };
    },
    
    /**
     * ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
     */
    startRealTimeUpdates() {
      // Supabase ì‹¤ì‹œê°„ êµ¬ë…
      const subscription = supabase
        .channel('security_events')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'security_events'
        }, (payload) => {
          this.handleNewSecurityEvent(payload.new);
        })
        .subscribe();

      // ì»´í¬ë„ŒíŠ¸ ì •ë¦¬ ì‹œ êµ¬ë… í•´ì œ
      this.$cleanup = () => {
        subscription.unsubscribe();
      };
    },
    
    /**
     * ìƒˆ ë³´ì•ˆ ì´ë²¤íŠ¸ ì²˜ë¦¬
     */
    handleNewSecurityEvent(newEvent) {
      // ì´ë²¤íŠ¸ ëª©ë¡ì— ì¶”ê°€
      this.securityEvents.unshift(newEvent);
      
      // ìµœëŒ€ 100ê°œ ìœ ì§€
      if (this.securityEvents.length > 100) {
        this.securityEvents = this.securityEvents.slice(0, 100);
      }
      
      // í†µê³„ ì—…ë°ì´íŠ¸
      this.updateStatsRealtime(newEvent);
      
      // ì‹¬ê°í•œ ì´ë²¤íŠ¸ëŠ” ì•Œë¦¼
      if (newEvent.severity === 'critical' || newEvent.severity === 'high') {
        this.showCriticalAlert(newEvent);
      }
      
      // ì ‘ê·¼ì„±: ìƒˆ ì´ë²¤íŠ¸ ì•Œë¦¼
      this.announceNewEvent(newEvent);
    },
    
    /**
     * ì‹¤ì‹œê°„ í†µê³„ ì—…ë°ì´íŠ¸
     */
    updateStatsRealtime(event) {
      this.stats.totalEvents++;
      
      const today = new Date().toISOString().split('T')[0];
      const eventDate = new Date(event.timestamp).toISOString().split('T')[0];
      
      if (eventDate === today) {
        this.stats.todayEvents++;
        
        if (event.severity === 'critical') {
          this.stats.criticalAlerts++;
          this.stats.activeThreats++;
        } else if (event.severity === 'high') {
          this.stats.activeThreats++;
        }
      }
    },
    
    /**
     * ì‹¬ê°í•œ ë³´ì•ˆ ì•Œë¦¼ í‘œì‹œ
     */
    showCriticalAlert(event) {
      // HTMXë¥¼ í†µí•œ ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ
      if (typeof htmx !== 'undefined') {
        htmx.ajax('POST', '/admin/security/alert', {
          values: {
            event_type: event.event_type,
            severity: event.severity,
            details: JSON.stringify(event.details)
          },
          target: '#security-alert-modal',
          swap: 'innerHTML'
        });
      }
    },
    
    /**
     * í•„í„° ì ìš©
     */
    applyFilters() {
      let filteredEvents = [...this.securityEvents];
      
      // ì‹¬ê°ë„ í•„í„°
      if (this.filters.severity !== 'all') {
        filteredEvents = filteredEvents.filter(e => e.severity === this.filters.severity);
      }
      
      // ë‚ ì§œ ë²”ìœ„ í•„í„°
      const now = new Date();
      let startDate;
      
      switch (this.filters.dateRange) {
        case '1h':
          startDate = new Date(now.getTime() - 60 * 60 * 1000);
          break;
        case '24h':
          startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
          break;
        case '7d':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          break;
        default:
          startDate = null;
      }
      
      if (startDate) {
        filteredEvents = filteredEvents.filter(e => 
          new Date(e.timestamp) >= startDate
        );
      }
      
      return filteredEvents;
    },
    
    /**
     * ì´ë²¤íŠ¸ ìƒì„¸ ë³´ê¸°
     */
    viewEventDetails(eventId) {
      if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', `/admin/security/events/${eventId}`, {
          target: '#event-details-modal',
          swap: 'innerHTML'
        });
      }
    },
    
    /**
     * ë³´ì•ˆ ì´ë²¤íŠ¸ ë‚´ë³´ë‚´ê¸°
     */
    async exportSecurityEvents() {
      try {
        const events = this.applyFilters();
        const csvContent = this.convertToCSV(events);
        
        // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `security_events_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        this.announceStatus('ë³´ì•ˆ ì´ë²¤íŠ¸ê°€ CSV íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
      } catch (error) {
        this.error = `ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`;
        console.error('ë³´ì•ˆ ì´ë²¤íŠ¸ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
      }
    },
    
    /**
     * CSV ë³€í™˜
     */
    convertToCSV(events) {
      const headers = ['ì‹œê°„', 'ìœ í˜•', 'ì‹¬ê°ë„', 'ì‚¬ìš©ìID', 'IPì£¼ì†Œ', 'ìƒì„¸ë‚´ìš©'];
      const rows = events.map(event => [
        new Date(event.timestamp).toLocaleString('ko-KR'),
        event.event_type,
        event.severity,
        event.user_id || 'N/A',
        event.ip_address,
        JSON.stringify(event.details)
      ]);
      
      return [headers, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
    },
    
    /**
     * ì ‘ê·¼ì„±: ìƒíƒœ ì•Œë¦¼
     */
    announceStatus(message) {
      const statusElement = document.getElementById('security-status-announcement');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.setAttribute('aria-live', 'polite');
      }
    },
    
    /**
     * ì ‘ê·¼ì„±: ìƒˆ ì´ë²¤íŠ¸ ì•Œë¦¼
     */
    announceNewEvent(event) {
      const message = `ìƒˆë¡œìš´ ${event.severity} ë³´ì•ˆ ì´ë²¤íŠ¸: ${event.event_type}`;
      this.announceStatus(message);
    },
    
    /**
     * ì»´í¬ë„ŒíŠ¸ ì •ë¦¬
     */
    destroy() {
      if (this.$cleanup) {
        this.$cleanup();
    }
  };
}
```

---

## 10.13 ì—°ê²° ë¬¸ì„œ ë° ì°¸ì¡°

### 10.13.1 í•µì‹¬ ì—°ê²° ë¬¸ì„œ
- **[02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](./02_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)**: RLS ì •ì±…, ì•”í˜¸í™” í•¨ìˆ˜, ë³´ì•ˆ í…Œì´ë¸” êµ¬ì¡°
- **[07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md)**: API ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´, HTMX ë³´ì•ˆ í†µì‹ 
- **[08_í™˜ê²½_ì„¤ì •.md](./08_í™˜ê²½_ì„¤ì •.md)**: ë³´ì•ˆ ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜ ë° Supabase ì„¤ì •
- **[11_ë°°í¬_ê°€ì´ë“œ.md](./11_ë°°í¬_ê°€ì´ë“œ.md)**: í”„ë¡œë•ì…˜ ë³´ì•ˆ ì„¤ì • ë° SSL êµ¬ì„±
- **[12_ê°œë°œ_ê°€ì´ë“œ.md](./12_ê°œë°œ_ê°€ì´ë“œ.md)**: ê´€ë¦¬ì ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ë³´ì•ˆ ê°œë°œ ê°€ì´ë“œë¼ì¸

### 10.13.2 ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ğŸ“‹ ì¸ì¦ ë° ê¶Œí•œ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] Supabase Auth ê¸°ë°˜ ì‚¬ìš©ì ì¸ì¦ êµ¬í˜„
- [x] Alpine.js ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ ê¶Œí•œ ê´€ë¦¬
- [x] RLS(Row Level Security) ì •ì±… ì ìš©
- [x] JWT í† í° ìë™ ê°±ì‹  ë©”ì»¤ë‹ˆì¦˜
- [x] ì„¸ì…˜ ë³´ì•ˆ ë° ë§Œë£Œ ì²˜ë¦¬
- [x] ê´€ë¦¬ì ê³„ì • ë³´ì•ˆ ê²€ì¦

#### ğŸ“‹ ë°ì´í„° ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] ì…ë ¥ ë°ì´í„° ê²€ì¦ ë° ìƒˆë‹ˆíƒ€ì´ì§•
- [x] XSS ë° SQL ì¸ì ì…˜ ë°©ì§€
- [x] íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ ê²€ì¦
- [x] UTF-8 ì¸ì½”ë”© ì•ˆì „ì„± í™•ë³´
- [x] ê°œì¸ì •ë³´ ì•”í˜¸í™” ì €ì¥
- [x] ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§

#### ğŸ“‹ ì ‘ê·¼ì„± ë° ì‚¬ìš©ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] ARIA ì†ì„±ì„ í†µí•œ ìŠ¤í¬ë¦° ë¦¬ë” ì§€ì›
- [x] í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›
- [x] í•œê¸€ ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€
- [x] ì‹¤ì‹œê°„ ìƒíƒœ ì•Œë¦¼ (aria-live)
- [x] ë°˜ì‘í˜• ë””ìì¸ ì ìš©
- [x] ë¡œë”© ìƒíƒœ ë° ì§„í–‰ í‘œì‹œ

### 10.13.3 ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì‚¬ìš©ë²•

1. **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**: Alpine.js ì»´í¬ë„ŒíŠ¸ê°€ ìë™ìœ¼ë¡œ ë³´ì•ˆ ì´ë²¤íŠ¸ë¥¼ ì‹¤ì‹œê°„ ì¶”ì 
2. **í•„í„°ë§**: ì‹¬ê°ë„, ë‚ ì§œ ë²”ìœ„, ì´ë²¤íŠ¸ ìœ í˜•ë³„ í•„í„°ë§ ê°€ëŠ¥
3. **ì•Œë¦¼ ì‹œìŠ¤í…œ**: ìœ„í—˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì¦‰ì‹œ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
4. **ë°ì´í„° ë‚´ë³´ë‚´ê¸°**: CSV í˜•íƒœë¡œ ë³´ì•ˆ ì´ë²¤íŠ¸ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì§€ì›
5. **ì ‘ê·¼ì„±**: ìŠ¤í¬ë¦° ë¦¬ë” ë° í‚¤ë³´ë“œ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì™„ì „í•œ ì ‘ê·¼ì„± ì§€ì›

### 10.13.4 ë³´ì•ˆ ì—…ë°ì´íŠ¸ ë° ìœ ì§€ë³´ìˆ˜

- **ì •ê¸° ë³´ì•ˆ ì ê²€**: ì›” 1íšŒ ë³´ì•ˆ ì„¤ì • ë° ì •ì±… ê²€í† 
- **ì·¨ì•½ì  ìŠ¤ìº”**: Supabase ë³´ì•ˆ ì—…ë°ì´íŠ¸ ìë™ ì ìš©
- **ë¡œê·¸ ë¶„ì„**: ì£¼ê°„ ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê·¸ ë¶„ì„ ë° ë¦¬í¬íŠ¸
- **ë°±ì—… ë° ë³µêµ¬**: ì¼ì¼ ë°ì´í„° ë°±ì—… ë° ë³µêµ¬ í…ŒìŠ¤íŠ¸
- **ì‚¬ìš©ì êµìœ¡**: ë¶„ê¸°ë³„ ë³´ì•ˆ ì¸ì‹ êµìœ¡ ì‹¤ì‹œ

---

## 10.14 ë§ˆë¬´ë¦¬

ì´ ë¬¸ì„œëŠ” **IEPON í”„ë¡œì íŠ¸**ì˜ ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬ë¥¼ ìœ„í•œ ì™„ì „í•œ Alpine.js/JavaScript ê¸°ë°˜ êµ¬í˜„ ê°€ì´ë“œì…ë‹ˆë‹¤. 

**ì£¼ìš” íŠ¹ì§•:**
- âœ… **TypeScript â†’ Alpine.js/JavaScript ì™„ì „ ë³€í™˜**
- âœ… **Supabase í†µí•© ë³´ì•ˆ ì•„í‚¤í…ì²˜**
- âœ… **UTF-8 ì•ˆì „ì„± ë° í•œê¸€ ì§€ì›**
- âœ… **ì ‘ê·¼ì„±(WCAG 2.1 AA) ì¤€ìˆ˜**
- âœ… **ì‹¤ì‹œê°„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§**
- âœ… **ë¹„ì „ê³µì ì¹œí™”ì  ì½”ë“œ êµ¬ì¡°**

ëª¨ë“  ë³´ì•ˆ ê¸°ëŠ¥ì€ **HTML + Alpine.js + HTMX + Supabase** ìŠ¤íƒìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, ë³µì¡í•œ ë¹Œë“œ ë„êµ¬ ì—†ì´ë„ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
```

## 10.9 ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ì™€ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ TypeScript ì½”ë“œë¥¼ Alpine.js/JavaScriptë¡œ ë³€í™˜
```javascript
// lib/admin/setup.js - Alpine.js í˜¸í™˜ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬
/**
 * ê´€ë¦¬ì ê³„ì • ì„¤ì • ë° ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°
 * Supabase Admin APIì™€ í†µí•©í•˜ì—¬ ì•ˆì „í•œ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬
 */

/**
 * ê´€ë¦¬ì ì„¤ì • íŒ©í† ë¦¬ í•¨ìˆ˜
 * @param {Object} config - ê´€ë¦¬ì ì„¤ì • ë°ì´í„°
 * @returns {Object} ê´€ë¦¬ì ì„¤ì • êµ¬ì¡°
 */
function createAdminConfig(config = {}) {
  return {
    email: config.email || process.env.ADMIN_EMAIL,
    password: config.password || process.env.ADMIN_PASSWORD,
    role: config.role || process.env.ADMIN_ROLE || 'super_admin',
    displayName: config.displayName || process.env.ADMIN_DISPLAY_NAME || 'System Administrator',
    
    // UTF-8 ì•ˆì „ì„± ê²€ì¦
    validateUTF8() {
      const textFields = [this.email, this.displayName];
      return textFields.every(field => {
        if (!field) return true;
        try {
          const encoded = new TextEncoder().encode(field);
          const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
          return decoded === field;
        } catch { return false; }
      });
    }
  };
}

// Note: getAdminConfig í•¨ìˆ˜ëŠ” ì´ë¯¸ ìœ„ì—ì„œ Alpine.js í˜¸í™˜ ë²„ì „ìœ¼ë¡œ ì •ì˜ë¨

// Note: ensureAdminAccount í•¨ìˆ˜ëŠ” ì´ë¯¸ ìœ„ì—ì„œ Alpine.js í˜¸í™˜ ë²„ì „ìœ¼ë¡œ ì •ì˜ë¨

/**
 * ìƒˆ ê´€ë¦¬ì ê³„ì • ìƒì„±
 * @param {Object} config - ê´€ë¦¬ì ì„¤ì •
 */
async function createAdminAccount(config) {
  try {
    // Supabase Edge Functionì„ í†µí•œ ê´€ë¦¬ì ê³„ì • ìƒì„±
    const { data, error } = await supabase.functions.invoke('create-admin-user', {
      body: JSON.stringify({
        email: config.email,
        password: config.password,
        user_metadata: {
          role: config.role,
          name: config.displayName,
          approved: true,
          created_by: 'system',
          created_at: new Date().toISOString()
        }
      })
    });

    if (error) {
      throw new Error(`ê´€ë¦¬ì ê³„ì • ìƒì„± ì‹¤íŒ¨: ${error.message}`);
    }

    // ê´€ë¦¬ì í”„ë¡œí•„ ì •ë³´ ì¶”ê°€ ì €ì¥
    const { error: profileError } = await supabase.from('user_profiles').insert({
      user_id: data.user.id,
      email: config.email,
      name: config.displayName,
      role: config.role,
      is_admin: true,
      approved: true
    });

    if (profileError) {
      console.error('ê´€ë¦¬ì í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', profileError);
    }

    return data.user;
  } catch (error) {
    console.error('ê´€ë¦¬ì ê³„ì • ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * ê¸°ì¡´ ê´€ë¦¬ì ê³„ì • ì—…ë°ì´íŠ¸
 * @param {string} userId - ì‚¬ìš©ì ID
 * @param {Object} config - ê´€ë¦¬ì ì„¤ì •
 */
async function updateAdminAccount(userId, config) {
  try {
    // ì‚¬ìš©ì ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
    const { error: updateError } = await supabase.functions.invoke('update-admin-user', {
      body: JSON.stringify({
        user_id: userId,
        user_metadata: {
          role: config.role,
          name: config.displayName,
          approved: true,
          updated_at: new Date().toISOString()
        }
      })
    });

    if (updateError) {
      throw new Error(`ê´€ë¦¬ì ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateError.message}`);
    }

    // í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
    const { error: profileError } = await supabase
      .from('user_profiles')
      .update({
        name: config.displayName,
        role: config.role,
        is_admin: true,
        approved: true,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', userId);

    if (profileError) {
      console.error('ê´€ë¦¬ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', profileError);
    }

  } catch (error) {
    console.error('ê´€ë¦¬ì ê³„ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * Alpine.js ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸
 */
function adminAccountManager() {
  return {
    adminUsers: [],
    loading: false,
    error: null,
    
    /**
     * ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
     */
    async init() {
      await this.loadAdminUsers();
    },
    
    /**
     * ê´€ë¦¬ì ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
     */
    async loadAdminUsers() {
      this.loading = true;
      this.error = null;
      
      try {
        const { data, error } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('is_admin', true)
          .order('created_at', { ascending: false });

        if (error) {
          throw error;
        }

        this.adminUsers = data || [];
      } catch (error) {
        this.error = `ê´€ë¦¬ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        console.error('ê´€ë¦¬ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
      } finally {
        this.loading = false;
      }
    },
    
    /**
     * ê´€ë¦¬ì ê³„ì • ìƒíƒœ í† ê¸€
     */
    async toggleAdminStatus(userId, currentStatus) {
      try {
        const { error } = await supabase
          .from('user_profiles')
          .update({ 
            approved: !currentStatus,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', userId);

        if (error) {
          throw error;
        }

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await this.loadAdminUsers();
        
        // ì ‘ê·¼ì„±: ìƒíƒœ ë³€ê²½ ì•Œë¦¼
        this.announceStatusChange(!currentStatus ? 'ìŠ¹ì¸ë¨' : 'ë¹„í™œì„±í™”ë¨');
        
      } catch (error) {
        this.error = `ê´€ë¦¬ì ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`;
        console.error('ê´€ë¦¬ì ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
      }
    },
    
    /**
     * ì ‘ê·¼ì„±: ìƒíƒœ ë³€ê²½ ì•Œë¦¼
     */
    announceStatusChange(status) {
      const statusElement = document.getElementById('admin-status-announcement');
      if (statusElement) {
        statusElement.textContent = `ê´€ë¦¬ì ê³„ì •ì´ ${status}ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        statusElement.setAttribute('aria-live', 'polite');
      }
    }
  };
}
