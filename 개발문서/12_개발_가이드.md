# 🛠️ IEPON 개발 가이드

> **연결 문서**: [08_환경_설정.md](./08_환경_설정.md) | [11_배포_가이드.md](./11_배포_가이드.md) | [README.md](./README.md)

> **🌟 HTML + Alpine.js + HTMX + Supabase 개발 가이드**: 이 문서는 비전공자도 쉽게 따라할 수 있는 단순화된 HTML 기반 개발 방법을 제공합니다. 복잡한 빌드 도구나 프레임워크 없이 직관적인 개발이 가능합니다.

---

## 12.1 단순화된 개발 환경 설정 (HTML + Alpine.js + HTMX)

### 12.1.1 최소한의 필수 도구 설치
```bash
# 🌐 브라우저만 있으면 개발 가능! (추가 도구는 선택사항)

# 1. 기본 도구 (선택사항)
# Git 설정 (버전 관리용)
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 2. 로컬 개발 서버 (선택사항)
# Python 간단 서버 (Python 3 기본 설치되어 있음)
python3 -m http.server 8000

# 또는 Node.js 서버 (선택사항)
npx http-server -p 8000

# 또는 PHP 서버 (선택사항)
php -S localhost:8000

# 3. Supabase CLI (백엔드 관리용, 선택사항)
npm install -g supabase
```

### 12.1.2 프로젝트 초기 설정 (단순화된 방식)
```bash
# 📁 프로젝트 디렉토리 생성
mkdir iepon-html-project
cd iepon-html-project

# 기본 폴더 구조 생성
mkdir -p public/{css,js,images,dashboard,students,curriculum,reports}

# 기본 HTML 파일 생성
touch public/index.html
touch public/dashboard/index.html
touch public/students/index.html
touch public/curriculum/index.html
touch public/reports/index.html

# CSS 및 JS 파일 생성
touch public/css/main.css
touch public/css/components.css
touch public/js/app.js
touch public/js/supabase.js

# 환경 설정 파일 (선택사항)
touch .env
touch netlify.toml
touch README.md

echo "🎉 HTML + Alpine.js + HTMX 프로젝트 초기 설정 완료!"
echo "🚀 브라우저에서 public/index.html을 열어 개발을 시작하세요."
```

### 12.1.3 기본 HTML 템플릿 생성
```html
<!-- public/index.html - 기본 템플릿 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IEPON - AI 기반 맞춤형 교육 플랫폼</title>
  
  <!-- CSS 파일 -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  
  <!-- Alpine.js CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- HTMX CDN -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- 메인 애플리케이션 -->
  <div id="app" x-data="appData()">
    <header class="header">
      <h1>IEPON 시스템</h1>
      <nav>
        <a href="/dashboard/">대시보드</a>
        <a href="/students/">학생 관리</a>
        <a href="/curriculum/">교육과정</a>
        <a href="/reports/">보고서</a>
      </nav>
    </header>
    
    <main class="main-content">
      <h2>환영합니다!</h2>
      <p>HTML + Alpine.js + HTMX + Supabase 기반 IEPON 시스템</p>
      
      <!-- Alpine.js 컴포넌트 예시 -->
      <div x-data="{ message: '안녕하세요!' }">
        <p x-text="message"></p>
        <button @click="message = '버튼이 클릭되었습니다!'">Click Me</button>
      </div>
    </main>
  </div>
  
  <!-- JavaScript 파일 -->
  <script src="/js/supabase.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
```

---

## 12.2 단순화된 코딩 표준 및 컨벤션 (HTML + Alpine.js + HTMX)

### 12.2.1 파일 및 폴더 구조 (정적 HTML 기반)
```
public/                     # 🌐 웹 루트 디렉토리 (브라우저에서 직접 접근)
├── index.html             # 메인 랜딩 페이지
├── auth/                  # 인증 관련 페이지
│   ├── login.html        # 로그인 페이지
│   ├── register.html     # 회원가입 페이지
│   └── forgot-password.html # 비밀번호 찾기
├── dashboard/             # 대시보드 페이지
│   ├── index.html        # 메인 대시보드
│   ├── analytics.html    # 분석 페이지
│   └── settings.html     # 설정 페이지
├── students/              # 학생 관리 페이지
│   ├── index.html        # 학생 목록
│   ├── add.html          # 학생 추가
│   ├── edit.html         # 학생 편집
│   └── profile.html      # 학생 프로필
├── curriculum/            # 교육과정 페이지
│   ├── index.html        # 교육과정 목록
│   ├── create.html       # 교육과정 생성
│   └── manage.html       # 교육과정 관리
├── reports/               # 보고서 페이지
│   ├── index.html        # 보고서 목록
│   ├── generate.html     # 보고서 생성
│   └── view.html         # 보고서 보기
├── admin/                 # 관리자 페이지
│   ├── index.html        # 관리자 대시보드
│   ├── users.html        # 사용자 관리
│   └── system.html       # 시스템 설정
├── css/                   # 스타일시트 파일
│   ├── main.css          # 메인 스타일
│   ├── components.css    # 컴포넌트 스타일
│   ├── dashboard.css     # 대시보드 전용 스타일
│   └── responsive.css    # 반응형 스타일
├── js/                    # JavaScript 파일
│   ├── app.js            # 메인 애플리케이션 로직
│   ├── supabase.js       # Supabase 클라이언트 설정
│   ├── auth.js           # 인증 관련 함수
│   ├── students.js       # 학생 관리 로직
│   ├── curriculum.js     # 교육과정 로직
│   ├── reports.js        # 보고서 로직
│   ├── utils.js          # 공통 유틸리티
│   └── validation.js     # 유효성 검사 함수
├── images/                # 이미지 파일
│   ├── logo.png          # 로고
│   ├── icons/            # 아이콘 파일들
│   └── avatars/          # 사용자 아바타
├── components/            # 재사용 가능한 HTML 컴포넌트 (템플릿)
│   ├── header.html       # 공통 헤더
│   ├── footer.html       # 공통 푸터
│   ├── sidebar.html      # 사이드바
│   └── modals.html       # 모달 컴포넌트들
└── data/                  # 정적 데이터 파일 (선택사항)
    ├── sample-students.json # 샘플 학생 데이터
    └── config.json       # 설정 파일
```

### 12.2.2 명명 규칙 (HTML + Alpine.js + JavaScript)
```javascript
// 🏷️ Alpine.js 컴포넌트: camelCase
function studentFormData() { ... }
function dashboardData() { ... }

// 🔧 JavaScript 함수: camelCase
const fetchStudentData = async () => { ... };
const validateForm = (formData) => { ... };

// 📦 변수: camelCase
const studentList = [];
const currentUser = null;

// 🔒 상수: UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 10 * 1024 * 1024;
const API_BASE_URL = 'https://your-project.supabase.co';

// 🎯 Alpine.js 데이터 속성: kebab-case
// x-data="studentForm"
// x-model="student.name"
// @click="handleSubmit"

// 📄 파일명: kebab-case
// student-form.html
// education-plan.html
// user-profile.js

// 🎨 CSS 클래스: kebab-case
// .student-card
// .form-container
// .btn-primary

// 🆔 HTML ID: kebab-case
// id="student-form"
// id="dashboard-container"
```

### 12.2.3 HTML + Alpine.js 코드 스타일 가이드
```html
<!-- ✅ 좋은 예시: 학생 카드 컴포넌트 -->
<div class="student-card" 
     x-data="{
       student: {},
       isLoading: false,
       isEditing: false
     }"
     x-init="loadStudentData()">
  
  <!-- 학생 정보 표시 -->
  <div class="student-info">
    <h3 class="student-name" x-text="student.name">학생 이름</h3>
    <p class="student-school" x-text="student.school_name">학교명</p>
    <p class="student-grade" x-text="`${student.grade}학년`">학년</p>
  </div>
  
  <!-- 액션 버튼들 -->
  <div class="student-actions">
    <button class="btn btn-edit" 
            @click="startEdit()" 
            :disabled="isLoading"
            x-show="!isEditing">
      <span x-show="!isLoading">편집</span>
      <span x-show="isLoading">로딩중...</span>
    </button>
    
    <button class="btn btn-save" 
            @click="saveStudent()" 
            :disabled="isLoading"
            x-show="isEditing">
      저장
    </button>
    
    <button class="btn btn-delete" 
            @click="deleteStudent()" 
            :disabled="isLoading"
            x-confirm="정말 삭제하시겠습니까?">
      삭제
    </button>
  </div>
  
  <!-- 편집 폼 (조건부 표시) -->
  <form class="edit-form" 
        x-show="isEditing" 
        @submit.prevent="saveStudent()">
    <input type="text" 
           x-model="student.name" 
           placeholder="학생 이름"
           required>
    <input type="text" 
           x-model="student.school_name" 
           placeholder="학교명"
           required>
    <select x-model="student.grade">
      <option value="1">1학년</option>
      <option value="2">2학년</option>
      <option value="3">3학년</option>
    </select>
  </form>
</div>

<script>
// ✅ 좋은 예시: Alpine.js 컴포넌트 함수
function studentCardData() {
  return {
    student: {},
    isLoading: false,
    isEditing: false,
    
    // 🔄 학생 데이터 로드
    async loadStudentData() {
      this.isLoading = true;
      try {
        const { data, error } = await supabase
          .from('students')
          .select('*')
          .eq('id', this.studentId)
          .single();
          
        if (error) throw error;
        this.student = data;
      } catch (error) {
        console.error('학생 데이터 로드 실패:', error);
        alert('학생 정보를 불러올 수 없습니다.');
      } finally {
        this.isLoading = false;
      }
    },
    
    // ✏️ 편집 모드 시작
    startEdit() {
      this.isEditing = true;
    },
    
    // 💾 학생 정보 저장
    async saveStudent() {
      if (!this.validateStudent()) return;
      
      this.isLoading = true;
      try {
        const { error } = await supabase
          .from('students')
          .update(this.student)
          .eq('id', this.student.id);
          
        if (error) throw error;
        
        this.isEditing = false;
        alert('학생 정보가 저장되었습니다.');
      } catch (error) {
        console.error('저장 실패:', error);
        alert('저장에 실패했습니다.');
      } finally {
        this.isLoading = false;
      }
    },
    
    // 🗑️ 학생 삭제
    async deleteStudent() {
      this.isLoading = true;
      try {
        const { error } = await supabase
          .from('students')
          .delete()
          .eq('id', this.student.id);
          
        if (error) throw error;
        
        // HTMX로 UI 업데이트 트리거
        htmx.trigger(document.body, 'student-deleted', { 
          detail: { studentId: this.student.id } 
        });
      } catch (error) {
        console.error('삭제 실패:', error);
        alert('삭제에 실패했습니다.');
      } finally {
        this.isLoading = false;
      }
    },
    
    // ✅ 유효성 검사
    validateStudent() {
      if (!this.student.name?.trim()) {
        alert('학생 이름을 입력해주세요.');
        return false;
      }
      if (!this.student.school_name?.trim()) {
        alert('학교명을 입력해주세요.');
        return false;
      }
      return true;
    }
  };
}
</script>
```

### 12.2.3 코드 스타일 가이드 (Alpine.js + HTML 패턴)
```html
<!-- ✅ 좋은 예시: Alpine.js 학생 카드 컴포넌트 -->
<div class="student-card p-4 border rounded-lg" 
     x-data="studentCardData(student)"
     x-init="init()">
  
  <!-- 학생 정보 표시 -->
  <h3 class="text-lg font-semibold" x-text="student.name"></h3>
  <p class="text-gray-600" x-text="student.school_name"></p>
  
  <!-- 버튼 영역 -->
  <div class="mt-4 flex gap-2">
    <button class="btn btn-primary" 
            @click="handleEdit()" 
            :disabled="isLoading"
            :class="{ 'opacity-50 cursor-not-allowed': isLoading }">
      <span x-show="!isLoading">수정</span>
      <span x-show="isLoading" class="flex items-center">
        <svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        처리중...
      </span>
    </button>
    
    <button class="btn btn-outline" 
            @click="handleDelete()"
            x-confirm="정말 삭제하시겠습니까?">
      삭제
    </button>
  </div>
  
  <!-- 에러 메시지 표시 -->
  <div x-show="error" 
       x-transition
       class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
    <span x-text="error"></span>
  </div>
</div>

<script>
// ✅ 좋은 예시: Alpine.js 컴포넌트 함수
function studentCardData(studentData = {}) {
  return {
    // 데이터 상태
    student: studentData,
    isLoading: false,
    error: null,
    
    // 초기화 함수
    init() {
      // UTF-8 인코딩 검증
      this.validateUTF8();
    },
    
    // 학생 편집 처리
    async handleEdit() {
      this.isLoading = true;
      this.error = null;
      
      try {
        // HTMX 요청으로 서버와 통신
        const response = await fetch(`/api/students/${this.student.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(this.student)
        });
        
        if (!response.ok) {
          throw new Error('수정에 실패했습니다.');
        }
        
        const result = await response.json();
        
        // 성공 시 페이지 새로고침 또는 이벤트 발생
        this.$dispatch('student-updated', { 
          student: result,
          message: '학생 정보가 성공적으로 수정되었습니다.' 
        });
        
      } catch (error) {
        console.error('편집 실패:', error);
        this.error = error.message || '편집 중 오류가 발생했습니다.';
      } finally {
        this.isLoading = false;
      }
    },
    
    // 학생 삭제 처리
    async handleDelete() {
      this.isLoading = true;
      this.error = null;
      
      try {
        const response = await fetch(`/api/students/${this.student.id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('삭제에 실패했습니다.');
        }
        
        // 성공 시 이벤트 발생
        this.$dispatch('student-deleted', { 
          studentId: this.student.id,
          message: '학생 정보가 삭제되었습니다.' 
        });
        
      } catch (error) {
        console.error('삭제 실패:', error);
        this.error = error.message || '삭제 중 오류가 발생했습니다.';
      } finally {
        this.isLoading = false;
      }
    },
    
    // UTF-8 인코딩 검증
    validateUTF8() {
      if (this.student.name && !this.isValidUTF8(this.student.name)) {
        console.warn('학생 이름 UTF-8 인코딩 문제 감지');
        this.error = '학생 이름에 인코딩 문제가 있습니다.';
      }
    },
    
    // UTF-8 유효성 검사 유틸리티
    isValidUTF8(str) {
      try {
        const encoded = new TextEncoder().encode(str);
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
        return decoded === str;
      } catch (error) {
        return false;
      }
    }
  };
}
</script>
```

---

## 12.3 단순화된 개발 워크플로우 (HTML + Alpine.js + HTMX)

### 12.3.1 Git 브랜치 전략 (단순화된 버전)
```bash
# 🌳 브랜치 구조 (단순화된 버전)
main                    # 프로덕션 배포용 (HTML 파일들)
├── develop            # 개발 통합 브랜치
├── feature/student-page    # 학생 관리 페이지
├── feature/dashboard-ui    # 대시보드 UI
└── bugfix/form-validation  # 폼 유효성 검사 버그

# 🚀 기능 개발 워크플로우
git checkout develop
git pull origin develop
git checkout -b feature/new-student-form

# HTML/CSS/JS 파일 수정 후
git add public/students/add.html public/css/components.css
git commit -m "feat(students): 학생 추가 폼 및 유효성 검사 추가"
git push origin feature/new-student-form
```

### 12.3.2 커밋 메시지 컨벤션 (HTML 기반)
```bash
# 예시
feat(auth): 로그인 HTML 페이지 및 Alpine.js 로직 추가
fix(students): 학생 목록 HTMX 로딩 오류 수정
style(dashboard): 대시보드 반응형 CSS 개선
refactor(forms): 공통 폼 컴포넌트 Alpine.js로 리팩토링
```

---

## 12.4 브라우저 기반 테스트 가이드 (HTML + Alpine.js + HTMX)

### 12.4.1 브라우저 기반 테스트 구조 (HTML + Alpine.js)
```html
<!-- tests/student-form.test.html - 브라우저 기반 테스트 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>StudentForm 테스트</title>
  
  <!-- Alpine.js CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- 테스트 스타일 -->
  <style>
    .test-container { max-width: 600px; margin: 20px auto; padding: 20px; }
    .test-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
    .test-result { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .test-pass { background: #d4edda; color: #155724; }
    .test-fail { background: #f8d7da; color: #721c24; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary { background: #007bff; color: white; }
    .error { color: #dc3545; font-size: 12px; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>학생 등록 폼 테스트</h1>
    
    <!-- 테스트 1: 폼 필드 렌더링 테스트 -->
    <div class="test-section" x-data="testFormRendering()">
      <h3>Test 1: 폼 필드 렌더링 검증</h3>
      
      <!-- 학생 등록 폼 -->
      <form x-data="studentFormData()" @submit.prevent="handleSubmit()">
        <div>
          <label for="student-name">학생 이름</label>
          <input id="student-name" 
                 type="text" 
                 x-model="formData.name" 
                 required>
        </div>
        
        <div>
          <label for="birth-date">생년월일</label>
          <input id="birth-date" 
                 type="date" 
                 x-model="formData.birth_date" 
                 required>
        </div>
        
        <div>
          <label for="school-name">학교명</label>
          <input id="school-name" 
                 type="text" 
                 x-model="formData.school_name" 
                 required>
        </div>
        
        <button type="submit" class="btn btn-primary">저장</button>
      </form>
      
      <!-- 테스트 결과 -->
      <div class="test-result" 
           :class="testResult.pass ? 'test-pass' : 'test-fail'" 
           x-text="testResult.message"></div>
      
      <button class="btn" @click="runTest()">테스트 실행</button>
    </div>
    
    <!-- 테스트 2: 필수 필드 유효성 검사 -->
    <div class="test-section" x-data="testValidation()">
      <h3>Test 2: 필수 필드 유효성 검사</h3>
      
      <form x-data="studentFormData()" @submit.prevent="handleSubmit()">
        <div>
          <label for="test2-name">학생 이름</label>
          <input id="test2-name" 
                 type="text" 
                 x-model="formData.name">
          <div class="error" x-show="errors.name" x-text="errors.name"></div>
        </div>
        
        <div>
          <label for="test2-birth">생년월일</label>
          <input id="test2-birth" 
                 type="date" 
                 x-model="formData.birth_date">
          <div class="error" x-show="errors.birth_date" x-text="errors.birth_date"></div>
        </div>
        
        <button type="submit" class="btn btn-primary">저장</button>
      </form>
      
      <div class="test-result" 
           :class="testResult.pass ? 'test-pass' : 'test-fail'" 
           x-text="testResult.message"></div>
           
      <button class="btn" @click="runValidationTest()">유효성 검사 테스트</button>
    </div>
    
    <!-- 테스트 3: 데이터 제출 테스트 -->
    <div class="test-section" x-data="testSubmission()">
      <h3>Test 3: 올바른 데이터 제출 테스트</h3>
      
      <form x-data="studentFormData()" @submit.prevent="handleSubmit()" x-ref="testForm">
        <div>
          <input type="text" 
                 x-model="formData.name" 
                 placeholder="학생 이름">
        </div>
        <div>
          <input type="date" 
                 x-model="formData.birth_date">
        </div>
        <button type="submit">저장</button>
      </form>
      
      <div class="test-result" 
           :class="testResult.pass ? 'test-pass' : 'test-fail'" 
           x-text="testResult.message"></div>
           
      <button class="btn" @click="runSubmissionTest()">제출 테스트</button>
    </div>
  </div>
  
  <script>
    // 학생 폼 데이터 컴포넌트
    function studentFormData() {
      return {
        formData: {
          name: '',
          birth_date: '',
          school_name: ''
        },
        errors: {},
        
        validateForm() {
          this.errors = {};
          
          if (!this.formData.name?.trim()) {
            this.errors.name = '이름은 필수입니다';
          }
          
          if (!this.formData.birth_date) {
            this.errors.birth_date = '생년월일은 필수입니다';
          }
          
          return Object.keys(this.errors).length === 0;
        },
        
        handleSubmit() {
          if (this.validateForm()) {
            // 성공 시 이벤트 발생
            this.$dispatch('form-submitted', this.formData);
            console.log('제출 데이터:', this.formData);
          }
        }
      };
    }
    
    // 테스트 1: 폼 렌더링
    function testFormRendering() {
      return {
        testResult: { pass: false, message: '테스트 대기중...' },
        
        runTest() {
          try {
            // DOM 요소 확인
            const nameField = document.querySelector('#student-name');
            const birthField = document.querySelector('#birth-date');
            const schoolField = document.querySelector('#school-name');
            
            if (nameField && birthField && schoolField) {
              this.testResult = {
                pass: true,
                message: '✅ PASS: 모든 필드가 올바르게 렌더링되었습니다.'
              };
            } else {
              this.testResult = {
                pass: false,
                message: '❌ FAIL: 일부 필드가 누락되었습니다.'
              };
            }
          } catch (error) {
            this.testResult = {
              pass: false,
              message: '❌ ERROR: ' + error.message
            };
          }
        }
      };
    }
    
    // 테스트 2: 유효성 검사
    function testValidation() {
      return {
        testResult: { pass: false, message: '테스트 대기중...' },
        
        runValidationTest() {
          try {
            // 빈 폼 제출 시도
            const nameInput = document.querySelector('#test2-name');
            const submitBtn = nameInput.closest('form').querySelector('button[type="submit"]');
            
            // 빈 값으로 설정
            nameInput.value = '';
            nameInput.dispatchEvent(new Event('input'));
            
            // 제출 버튼 클릭
            submitBtn.click();
            
            // 에러 메시지 확인
            setTimeout(() => {
              const errorMsg = document.querySelector('.error[x-show="errors.name"]');
              if (errorMsg && errorMsg.textContent.includes('이름은 필수입니다')) {
                this.testResult = {
                  pass: true,
                  message: '✅ PASS: 필수 필드 유효성 검사 성공'
                };
              } else {
                this.testResult = {
                  pass: false,
                  message: '❌ FAIL: 유효성 검사가 작동하지 않음'
                };
              }
            }, 100);
            
          } catch (error) {
            this.testResult = {
              pass: false,
              message: '❌ ERROR: ' + error.message
            };
          }
        }
      };
    }
    
    // 테스트 3: 데이터 제출
    function testSubmission() {
      return {
        testResult: { pass: false, message: '테스트 대기중...' },
        submittedData: null,
        
        runSubmissionTest() {
          // 이벤트 리스너 등록
          document.addEventListener('form-submitted', (event) => {
            this.submittedData = event.detail;
          });
          
          try {
            const form = this.$refs.testForm || document.querySelector('form');
            const nameInput = form.querySelector('input[type="text"]');
            const dateInput = form.querySelector('input[type="date"]');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // 테스트 데이터 입력
            nameInput.value = '홍길동';
            dateInput.value = '2010-01-01';
            
            // 이벤트 발생시키기
            nameInput.dispatchEvent(new Event('input'));
            dateInput.dispatchEvent(new Event('input'));
            
            // 폼 제출
            submitBtn.click();
            
            // 결과 확인
            setTimeout(() => {
              if (this.submittedData && 
                  this.submittedData.name === '홍길동' && 
                  this.submittedData.birth_date === '2010-01-01') {
                this.testResult = {
                  pass: true,
                  message: '✅ PASS: 올바른 데이터로 제출 성공'
                };
              } else {
                this.testResult = {
                  pass: false,
                  message: '❌ FAIL: 제출 데이터가 일치하지 않음'
                };
              }
            }, 100);
            
          } catch (error) {
            this.testResult = {
              pass: false,
              message: '❌ ERROR: ' + error.message
            };
          }
        }
      };
    }
  </script>
</body>
</html>
```

### 12.4.2 브라우저 테스트 실행 방법
```bash
# 1. 테스트 파일을 브라우저에서 열기
open tests/student-form.test.html

# 2. 또는 로컬 서버로 실행
python3 -m http.server 8000
# 브라우저에서 http://localhost:8000/tests/student-form.test.html 접속

# 3. 단순한 JavaScript 자동 테스트 (Playwright 선택사항)
npm install playwright

# 4. Alpine.js 전용 테스트 유틸리티 (cypress 선택사항)
npm install cypress --save-dev
npx cypress open
```

---

## 11.5 HTMX + Edge Functions 개발 가이드

### 11.5.1 Edge Functions 구조
```javascript
// supabase/functions/students/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // CORS 처리
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      {
        global: {
          headers: { Authorization: req.headers.get('Authorization')! },
        },
      }
    );

    const { data: { user } } = await supabaseClient.auth.getUser();
    
    if (!user) {
      return new Response(
        JSON.stringify({ error: '로그인이 필요합니다' }),
        { 
          status: 401,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    if (req.method === 'GET') {
      return await handleGetStudents(supabaseClient, user.id);
    } else if (req.method === 'POST') {
      const body = await req.json();
      return await handleCreateStudent(supabaseClient, user.id, body);
    }

    return new Response(
      JSON.stringify({ error: '지원하지 않는 요청 방식입니다' }),
      { 
        status: 405,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({ 
        success: false, 
        error: error.message || '서버 오류가 발생했습니다'
      }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
});

// 학생 목록 조회
async function handleGetStudents(supabase, userId) {
  const { data, error } = await supabase
    .from('students')
    .select('*')
    .eq('user_id', userId)
    .order('name');

  if (error) {
    throw new Error(`학생 목록 조회 실패: ${error.message}`);
  }

  return new Response(
    JSON.stringify({
      success: true,
      data
    }),
    {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  );
}

// 학생 생성
async function handleCreateStudent(supabase, userId, body) {
  // UTF-8 인코딩 검증
  if (body.name && !isValidUTF8(body.name)) {
    throw new Error('이름에 유효하지 않은 문자가 포함되어 있습니다');
  }

  // 기본 유효성 검사
  if (!body.name || body.name.trim().length === 0) {
    throw new Error('학생 이름은 필수입니다');
  }
  
  if (!body.grade || !['elementary', 'middle', 'high'].includes(body.grade)) {
    throw new Error('유효한 학년을 선택해주세요');
  }

  const { data, error } = await supabase
    .from('students')
    .insert([{
      name: body.name.trim(),
      grade: body.grade,
      birth_date: body.birth_date,
      user_id: userId
    }])
    .select()
    .single();

  if (error) {
    throw new Error(`학생 등록 실패: ${error.message}`);
  }

  return new Response(
    JSON.stringify({
      success: true,
      data
    }),
    {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  );
}

// UTF-8 인코딩 검증 함수
function isValidUTF8(str) {
  try {
    return str === decodeURIComponent(encodeURIComponent(str));
  } catch {
    return false;
  }
}
```

### 11.5.2 HTMX 프론트엔드 연동
```html
<!-- students.html - 학생 관리 페이지 -->
<div x-data="studentsManager()" class="students-container">
  <!-- 학생 목록 -->
  <div 
    hx-get="/functions/v1/students"
    hx-headers='{"Authorization": "Bearer " + Alpine.store("auth").token}'
    hx-target="#students-list"
    hx-trigger="load, students-updated from:body"
    hx-indicator="#loading"
  >
    <div id="loading" class="htmx-indicator">로딩 중...</div>
    <div id="students-list">
      <!-- 학생 목록이 여기에 렌더링됩니다 -->
    </div>
  </div>

  <!-- 학생 등록 폼 -->
  <form 
    hx-post="/functions/v1/students"
    hx-headers='{"Authorization": "Bearer " + Alpine.store("auth").token}'
    hx-target="#form-result"
    hx-on::after-request="handleStudentFormResponse"
    @submit.prevent
  >
    <input 
      type="text" 
      name="name" 
      placeholder="학생 이름"
      required
      maxlength="100"
      x-model="formData.name"
    >
    
    <select name="grade" required x-model="formData.grade">
      <option value="">학년 선택</option>
      <option value="elementary">초등학생</option>
      <option value="middle">중학생</option>
      <option value="high">고등학생</option>
    </select>
    
    <input 
      type="date" 
      name="birth_date"
      x-model="formData.birth_date"
    >
    
    <button type="submit" class="btn-primary">
      학생 등록
    </button>
  </form>
  
  <div id="form-result"></div>
</div>

<script>
function studentsManager() {
  return {
    formData: {
      name: '',
      grade: '',
      birth_date: ''
    },
    
    handleStudentFormResponse(event) {
      const response = JSON.parse(event.detail.xhr.responseText);
      
      if (response.success) {
        // 성공 시 폼 초기화 및 목록 새로고침
        this.formData = {
          name: '',
          grade: '',
          birth_date: ''
        };
        
        // 학생 목록 새로고침 이벤트 발생
        document.body.dispatchEvent(new CustomEvent('students-updated'));
        
        // 성공 메시지 표시
        Alpine.store('toast').show('학생이 성공적으로 등록되었습니다', 'success');
      } else {
        // 에러 메시지 표시
        Alpine.store('toast').show(response.error || '등록 중 오류가 발생했습니다', 'error');
      }
    }
  };
}
</script>
```

### 11.5.3 에러 처리 패턴
```javascript
// js/error-handler.js - 클라이언트 에러 처리
class APIErrorHandler {
  static handle(error, context = '') {
    console.error(`API Error ${context}:`, error);
    
    // 한글 에러 메시지 매핑
    const errorMessages = {
      'AUTHENTICATION_ERROR': '로그인이 필요합니다',
      'AUTHORIZATION_ERROR': '접근 권한이 없습니다',
      'VALIDATION_ERROR': '입력 정보를 확인해주세요',
      'NOT_FOUND': '요청하신 정보를 찾을 수 없습니다',
      'INTERNAL_ERROR': '서버 오류가 발생했습니다'
    };
    
    let message = error.message || '알 수 없는 오류가 발생했습니다';
    
    // 에러 코드가 있는 경우 한글 메시지로 변환
    if (error.code && errorMessages[error.code]) {
      message = errorMessages[error.code];
    }
    
    // UTF-8 인코딩 오류 체크
    if (!this.isValidUTF8(message)) {
      message = '텍스트 인코딩 오류가 발생했습니다';
    }
    
    // Toast 메시지로 사용자에게 표시
    Alpine.store('toast').show(message, 'error');
    
    return {
      success: false,
      error: message
    };
  }
  
  static isValidUTF8(str) {
    try {
      return str === decodeURIComponent(encodeURIComponent(str));
    } catch {
      return false;
    }
  }
  
  // HTMX 응답 에러 처리
  static handleHTMXError(event) {
    const xhr = event.detail.xhr;
    let errorMessage = '요청 처리 중 오류가 발생했습니다';
    
    try {
      const response = JSON.parse(xhr.responseText);
      errorMessage = response.error || response.message || errorMessage;
    } catch {
      // JSON 파싱 실패시 기본 메시지 사용
    }
    
    this.handle({ message: errorMessage }, `HTTP ${xhr.status}`);
  }
}

// 전역 HTMX 에러 핸들러 설정
document.addEventListener('htmx:responseError', (event) => {
  APIErrorHandler.handleHTMXError(event);
});

document.addEventListener('htmx:sendError', (event) => {
  APIErrorHandler.handle({ 
    message: '네트워크 연결을 확인해주세요' 
  }, 'Network Error');
});
```

### 11.5.4 Edge Functions 배포
```bash
# Edge Functions 배포 명령어
supabase functions deploy students
supabase functions deploy curriculum
supabase functions deploy ai-services

# 함수 로그 확인
supabase functions logs students

# 환경 변수 설정
supabase secrets set OPENAI_API_KEY=your_openai_key
supabase secrets set TOSS_PAYMENTS_SECRET_KEY=your_toss_key
};
```

---

## 11.6 데이터베이스 마이그레이션

### 11.6.1 마이그레이션 파일 생성
```sql
-- supabase/migrations/20240101000000_create_students_table.sql
CREATE TABLE students (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  name VARCHAR(100) NOT NULL,
  birth_date DATE NOT NULL,
  school_name VARCHAR(200),
  grade INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS 정책 추가
ALTER TABLE students ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own students" ON students
FOR ALL USING (user_id = auth.uid());

-- 인덱스 추가
CREATE INDEX idx_students_user_id ON students(user_id);
CREATE INDEX idx_students_name ON students(name);
```

### 11.6.2 마이그레이션 실행
```bash
# 새 마이그레이션 생성
supabase migration new create_students_table

# 로컬 데이터베이스에 마이그레이션 적용
supabase db push

# 원격 데이터베이스에 마이그레이션 적용
supabase db push --project-ref your-project-ref

# 마이그레이션 상태 확인
supabase migration list

# 데이터베이스 리셋 (개발 환경에서만)
supabase db reset
```

---

## 11.7 성능 최적화

### 11.7.1 Alpine.js 성능 최적화
```html
<!-- 학생 목록 컴포넌트 - x-for 최적화 -->
<div x-data="studentListManager()" class="student-list-container">
  <!-- 커스텀 로딩 인디케이터 -->
  <div x-show="loading" class="loading-indicator">
    <div class="spinner"></div>
    <span>학생 목록 로딩 중...</span>
  </div>

  <!-- 검색 및 필터 -->
  <div class="search-filters mb-4">
    <input 
      type="text" 
      x-model="searchQuery" 
      @input.debounce.300ms="filterStudents"
      placeholder="학생 이름으로 검색..."
      class="form-input"
    >
    <select x-model="gradeFilter" @change="filterStudents">
      <option value="">모든 학년</option>
      <option value="elementary">초등학생</option>
      <option value="middle">중학생</option>
      <option value="high">고등학생</option>
    </select>
  </div>

  <!-- 가상화된 리스트 (성능 최적화) -->
  <div class="virtual-list" x-show="!loading">
    <template x-for="(student, index) in paginatedStudents" :key="student.id">
      <div 
        class="student-card"
        x-data="{ editing: false }"
        :class="{ 'highlight': student.id === selectedStudentId }"
      >
        <div class="student-info">
          <h3 x-text="student.name" class="student-name"></h3>
          <p class="student-details">
            <span x-text="getGradeName(student.grade)"></span>
            <span x-show="student.school_name" x-text="' - ' + student.school_name"></span>
          </p>
        </div>
        
        <div class="student-actions">
          <button 
            @click="editStudent(student)"
            class="btn-edit"
            :disabled="editing"
          >
            편집
          </button>
          <button 
            @click="confirmDelete(student)"
            class="btn-delete"
            :disabled="editing"
          >
            삭제
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- 페이지네이션 -->
  <div class="pagination" x-show="totalPages > 1">
    <button 
      @click="prevPage"
      :disabled="currentPage === 1"
      class="btn-pagination"
    >
      이전
    </button>
    <span class="page-info">
      <span x-text="currentPage"></span> / <span x-text="totalPages"></span>
    </span>
    <button 
      @click="nextPage"
      :disabled="currentPage === totalPages"
      class="btn-pagination"
    >
      다음
    </button>
  </div>
</div>

<script>
function studentListManager() {
  return {
    // 데이터 상태
    students: [],
    filteredStudents: [],
    paginatedStudents: [],
    loading: false,
    selectedStudentId: null,
    
    // 검색 및 필터
    searchQuery: '',
    gradeFilter: '',
    
    // 페이지네이션
    currentPage: 1,
    itemsPerPage: 10,
    totalPages: 1,
    
    init() {
      this.loadStudents();
      // 실시간 업데이트 리스너
      this.$watch('students', () => this.filterStudents());
    },
    
    async loadStudents() {
      this.loading = true;
      try {
        // HTMX 대신 직접 Supabase 호출로 성능 최적화
        const response = await fetch('/functions/v1/students', {
          headers: {
            'Authorization': `Bearer ${Alpine.store('auth').token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        if (result.success) {
          this.students = result.data;
        }
      } catch (error) {
        Alpine.store('toast').show('학생 목록 로드 실패', 'error');
      } finally {
        this.loading = false;
      }
    },
    
    // 디바운싱된 검색 (성능 최적화)
    filterStudents() {
      let filtered = this.students;
      
      if (this.searchQuery) {
        const query = this.searchQuery.toLowerCase();
        filtered = filtered.filter(student => 
          student.name.toLowerCase().includes(query) ||
          (student.school_name && student.school_name.toLowerCase().includes(query))
        );
      }
      
      if (this.gradeFilter) {
        filtered = filtered.filter(student => student.grade === this.gradeFilter);
      }
      
      this.filteredStudents = filtered;
      this.totalPages = Math.ceil(filtered.length / this.itemsPerPage);
      this.updatePagination();
    },
    
    updatePagination() {
      const start = (this.currentPage - 1) * this.itemsPerPage;
      const end = start + this.itemsPerPage;
      this.paginatedStudents = this.filteredStudents.slice(start, end);
    },
    
    prevPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.updatePagination();
      }
    },
    
    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++;
        this.updatePagination();
      }
    },
    
    // 사용자 액션 (메모이제이션 효과)
    editStudent(student) {
      this.selectedStudentId = student.id;
      Alpine.store('modal').openStudentEdit(student);
    },
    
    confirmDelete(student) {
      Alpine.store('modal').confirm(
        '학생 삭제',
        `“${student.name}” 학생을 삭제하시겠습니까?`,
        () => this.deleteStudent(student.id)
      );
    },
    
    async deleteStudent(studentId) {
      try {
        const response = await fetch(`/functions/v1/students/${studentId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${Alpine.store('auth').token}`
          }
        });
        
        if (response.ok) {
          this.students = this.students.filter(s => s.id !== studentId);
          Alpine.store('toast').show('학생이 삭제되었습니다', 'success');
        }
      } catch (error) {
        Alpine.store('toast').show('삭제 중 오류가 발생했습니다', 'error');
      }
    },
    
    getGradeName(grade) {
      const gradeNames = {
        'elementary': '초등학생',
        'middle': '중학생',
        'high': '고등학생'
      };
      return gradeNames[grade] || grade;
    }
  };
}
</script>
```

### 11.7.2 데이터베이스 쿼리 최적화
```typescript
// 필요한 필드만 선택
const { data } = await supabase
  .from('students')
  .select('id, name, school_name, grade')
  .eq('user_id', userId);

// 페이지네이션
const { data } = await supabase
  .from('students')
  .select('*')
  .range(0, 9) // 0-9번째 레코드
  .order('name');

// 조인 최적화
const { data } = await supabase
  .from('students')
  .select(`
    id,
    name,
    current_levels (
      semester,
      lang_summary
    )
  `)
  .eq('user_id', userId);
```

---

## 11.8 디버깅 및 로깅

### 11.8.1 브라우저 개발자 도구 디버깅
```html
<!-- 디버깅 콘솔 컴포넌트 -->
<div x-data="debugConsole()" x-show="isDevelopment" class="debug-console">
  <div class="debug-header">
    <h3>🔍 디버깅 콘솔</h3>
    <button @click="toggleConsole" class="toggle-btn">
      <span x-text="isVisible ? '숨기기' : '보이기'"></span>
    </button>
  </div>
  
  <div x-show="isVisible" class="debug-content">
    <!-- 로그 리스트 -->
    <div class="log-container">
      <div class="log-header">
        <span>로그 기록</span>
        <button @click="clearLogs" class="clear-btn">지우기</button>
      </div>
      <div class="log-list">
        <template x-for="(log, index) in logs" :key="index">
          <div class="log-entry" :class="'log-' + log.type">
            <span class="log-time" x-text="log.timestamp"></span>
            <span class="log-message" x-text="log.message"></span>
            <details x-show="log.data">
              <summary>데이터 보기</summary>
              <pre x-text="JSON.stringify(log.data, null, 2)"></pre>
            </details>
          </div>
        </template>
      </div>
    </div>
    
    <!-- Alpine.js 상태 모니터링 -->
    <div class="state-monitor">
      <h4>Alpine.js 상태 모니터링</h4>
      <div class="state-item">
        <strong>인증:</strong>
        <span x-text="JSON.stringify(Alpine.store('auth').$data, null, 2)"></span>
      </div>
      <div class="state-item">
        <strong>학생 데이터:</strong>
        <span x-text="JSON.stringify(Alpine.store('students').$data, null, 2)"></span>
      </div>
    </div>
  </div>
</div>

<!-- 학생 폼 컴포넌트 (디버깅 기능 포함) -->
<div x-data="studentFormDebug()" class="student-form-debug">
  <form @submit.prevent="submitForm">
    <input 
      type="text" 
      x-model="formData.name" 
      @input="logFormChange('name', $event.target.value)"
      placeholder="학생 이름"
      required
    >
    <select 
      x-model="formData.grade" 
      @change="logFormChange('grade', $event.target.value)"
      required
    >
      <option value="">학년 선택</option>
      <option value="elementary">초등학생</option>
      <option value="middle">중학생</option>
      <option value="high">고등학생</option>
    </select>
    <button type="submit">등록</button>
  </form>
  
  <!-- 실시간 폼 데이터 모니터링 -->
  <div x-show="isDevelopment" class="form-debug-info">
    <h4>폼 데이터 상태:</h4>
    <pre x-text="JSON.stringify(formData, null, 2)"></pre>
  </div>
</div>

<script>
// 디버깅 콘솔 관리
function debugConsole() {
  return {
    isDevelopment: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
    isVisible: false,
    logs: [],
    
    init() {
      // 전역 디버깅 함수 등록
      window.debugLog = this.log.bind(this);
      
      // Alpine.js 오류 캡처
      window.addEventListener('alpine:init', () => {
        Alpine.store('debug', {
          log: this.log.bind(this),
          error: (message, data) => this.log(message, data, 'error'),
          warn: (message, data) => this.log(message, data, 'warn'),
          info: (message, data) => this.log(message, data, 'info')
        });
      });
    },
    
    toggleConsole() {
      this.isVisible = !this.isVisible;
    },
    
    log(message, data = null, type = 'info') {
      if (!this.isDevelopment) return;
      
      const timestamp = new Date().toLocaleTimeString();
      this.logs.unshift({
        timestamp,
        message,
        data,
        type
      });
      
      // 로그 제한 (100개)
      if (this.logs.length > 100) {
        this.logs = this.logs.slice(0, 100);
      }
      
      // 브라우저 콘솔에도 출력
      console.log(`[IEPON ${type.toUpperCase()}] ${message}`, data);
    },
    
    clearLogs() {
      this.logs = [];
    }
  };
}

// 학생 폼 디버깅
function studentFormDebug() {
  return {
    formData: {
      name: '',
      grade: '',
      birth_date: ''
    },
    isDevelopment: window.location.hostname === 'localhost',
    
    init() {
      // 폼 데이터 변화 모니터링
      this.$watch('formData', (newValue, oldValue) => {
        if (this.isDevelopment) {
          window.debugLog('폼 데이터 변경', {
            before: oldValue,
            after: newValue
          });
        }
      }, { deep: true });
    },
    
    logFormChange(field, value) {
      if (this.isDevelopment) {
        window.debugLog(`폼 필드 변경: ${field}`, {
          field,
          value,
          formData: { ...this.formData }
        });
      }
    },
    
    async submitForm() {
      window.debugLog('폼 제출 시도', this.formData);
      
      try {
        const response = await fetch('/functions/v1/students', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${Alpine.store('auth').token}`
          },
          body: JSON.stringify(this.formData)
        });
        
        const result = await response.json();
        window.debugLog('폼 제출 응답', result);
        
        if (result.success) {
          this.formData = { name: '', grade: '', birth_date: '' };
          Alpine.store('toast').show('학생이 등록되었습니다', 'success');
        } else {
          Alpine.store('toast').show(result.error, 'error');
        }
      } catch (error) {
        window.debugLog('폼 제출 오류', error, 'error');
        Alpine.store('toast').show('등록 중 오류가 발생했습니다', 'error');
      }
    }
  };
}
</script>
```

### 11.8.2 에러 로깅
```typescript
// lib/logger.ts
export const logError = (error: Error, context?: any) => {
  const errorInfo = {
    message: error.message,
    stack: error.stack,
    context,
    timestamp: new Date().toISOString(),
    url: window.location.href,
    userAgent: navigator.userAgent
  };

  // 개발 환경에서는 콘솔에 출력
  if (process.env.NODE_ENV === 'development') {
    console.error('Error logged:', errorInfo);
  }

  // 프로덕션 환경에서는 외부 서비스로 전송
  if (process.env.NODE_ENV === 'production') {
    // Sentry, LogRocket 등으로 전송
    window.Sentry?.captureException(error, { extra: context });
  }
};

// 사용 예시
try {
  await saveStudent(studentData);
} catch (error) {
  logError(error, { studentData, userId });
  throw error;
}

export async function generateEvaluationReport(evaluationData: EvaluationData): Promise<string> {
  // 평가 보고서 자동 생성 구현
}
```

### 11.10.2 AI 기능 컴포넌트
```html
<!-- AI 교육목표 생성 컴포넌트 -->
<div x-data="aiGoalGenerator()" class="ai-goal-generator bg-blue-50 p-4 rounded-lg">
  <div class="header mb-4">
    <h3 class="text-lg font-semibold mb-2">🤖 AI 교육목표 생성</h3>
    <p class="text-sm text-gray-600">
      학생의 정보를 바탕으로 AI가 개별화된 교육목표를 제안합니다.
    </p>
  </div>

  <!-- 학생 정보 입력 -->
  <div class="student-info mb-4">
    <input 
      type="hidden" 
      x-model="studentInfo.id" 
      name="student_id"
    >
    <div class="info-display p-3 bg-white rounded border">
      <div class="student-name">
        <strong>학생:</strong> 
        <span x-text="studentInfo.name || '학생을 선택해주세요'"></span>
      </div>
      <div class="student-grade" x-show="studentInfo.grade">
        <strong>학년:</strong> 
        <span x-text="getGradeName(studentInfo.grade)"></span>
      </div>
      <div class="student-level" x-show="studentInfo.current_level">
        <strong>현재 수준:</strong> 
        <span x-text="studentInfo.current_level"></span>
      </div>
    </div>
  </div>

  <!-- AI 목표 생성 버튼 -->
  <div class="generation-controls mb-4">
    <button
      @click="generateGoal"
      :disabled="isGenerating || !studentInfo.id"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
    >
      <span x-show="!isGenerating">AI 목표 생성</span>
      <span x-show="isGenerating" class="flex items-center">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
        생성 중...
      </span>
    </button>
    
    <button
      x-show="!isGenerating && generatedGoal"
      @click="regenerateGoal"
      class="ml-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
    >
      다시 생성
    </button>
  </div>

  <!-- 에러 메시지 -->
  <div 
    x-show="error" 
    x-transition
    class="error-message mt-2 p-3 bg-red-100 text-red-700 text-sm rounded border-l-4 border-red-500"
  >
    <div class="flex items-center">
      <span class="mr-2">⚠️</span>
      <span x-text="error"></span>
    </div>
    <button @click="error = null" class="mt-1 text-xs underline">닫기</button>
  </div>

  <!-- 생성된 목표 결과 -->
  <div 
    x-show="generatedGoal" 
    x-transition
    class="generated-goal mt-4 p-4 bg-green-50 border border-green-200 rounded"
  >
    <div class="goal-header flex justify-between items-center mb-3">
      <h4 class="font-semibold text-green-800">✨ AI 생성 교육목표</h4>
      <div class="actions">
        <button
          @click="copyGoal"
          class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"
        >
          복사
        </button>
        <button
          @click="saveGoal"
          class="ml-1 text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700"
        >
          저장
        </button>
      </div>
    </div>
    <div class="goal-content text-sm text-gray-700 whitespace-pre-line" x-text="generatedGoal"></div>
  </div>
</div>

<script>
function aiGoalGenerator() {
  return {
    // 학생 정보 데이터
    studentInfo: {
      id: '',
      name: '',
      grade: '',
      current_level: '',
      birth_date: ''
    },
    
    // 상태 관리
    isGenerating: false,
    generatedGoal: '',
    error: null,
    
    init() {
      // 전역 이벤트 리스너 (학생 선택 시)
      document.addEventListener('student-selected', (event) => {
        this.studentInfo = event.detail;
        this.error = null;
      });
    },
    
    async generateGoal() {
      if (!this.studentInfo.id) {
        this.error = '학생을 먼저 선택해주세요';
        return;
      }
      
      this.isGenerating = true;
      this.error = null;
      
      try {
        // UTF-8 인코딩 검증
        if (!this.isValidUTF8(this.studentInfo.name)) {
          throw new Error('학생 이름에 인코딩 문제가 있습니다');
        }
        
        const response = await fetch('/functions/v1/ai-services/generate-goal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${Alpine.store('auth').token}`
          },
          body: JSON.stringify({
            student_id: this.studentInfo.id,
            student_info: this.studentInfo
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          this.generatedGoal = result.data.goal;
          
          // 생성 완료 이벤트 발생
          document.dispatchEvent(new CustomEvent('ai-goal-generated', {
            detail: {
              studentId: this.studentInfo.id,
              goal: this.generatedGoal
            }
          }));
          
          Alpine.store('toast').show('AI 교육목표가 생성되었습니다', 'success');
        } else {
          throw new Error(result.error || 'AI 목표 생성에 실패했습니다');
        }
      } catch (error) {
        this.error = error.message || 'AI 목표 생성 중 오류가 발생했습니다';
        Alpine.store('toast').show(this.error, 'error');
      } finally {
        this.isGenerating = false;
      }
    },
    
    async regenerateGoal() {
      this.generatedGoal = '';
      await this.generateGoal();
    },
    
    async copyGoal() {
      try {
        await navigator.clipboard.writeText(this.generatedGoal);
        Alpine.store('toast').show('목표가 클립보드에 복사되었습니다', 'info');
      } catch (error) {
        Alpine.store('toast').show('복사에 실패했습니다', 'error');
      }
    },
    
    async saveGoal() {
      if (!this.generatedGoal) return;
      
      try {
        const response = await fetch('/functions/v1/education-plans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${Alpine.store('auth').token}`
          },
          body: JSON.stringify({
            student_id: this.studentInfo.id,
            goals: this.generatedGoal,
            type: 'ai_generated',
            status: 'draft'
          })
        });
        
        if (response.ok) {
          Alpine.store('toast').show('교육목표가 저장되었습니다', 'success');
        }
      } catch (error) {
        Alpine.store('toast').show('목표 저장에 실패했습니다', 'error');
      }
    },
    
    getGradeName(grade) {
      const gradeNames = {
        'elementary': '초등학생',
        'middle': '중학생',
        'high': '고등학생'
      };
      return gradeNames[grade] || grade;
    },
    
    isValidUTF8(str) {
      try {
        return str === decodeURIComponent(encodeURIComponent(str));
      } catch {
        return false;
      }
    }
  };
}
</script>
```
```

---

## 11.11 파일 업로드 시스템 개발 가이드

### 11.11.1 보안 파일 업로드 구현
```html
<!-- 보안 파일 업로드 컴포넌트 -->
<div x-data="secureFileUpload()" class="secure-file-upload">
  <!-- 드래그 앤 드롭 영역 -->
  <div 
    x-ref="dropzone"
    @drop.prevent="handleDrop($event)"
    @dragover.prevent="dragActive = true"
    @dragleave.prevent="dragActive = false"
    @click="$refs.fileInput.click()"
    class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors"
    :class="{
      'border-blue-500 bg-blue-50': dragActive,
      'border-gray-300 hover:border-gray-400': !dragActive
    }"
  >
    <!-- 숨겨진 파일 입력 -->
    <input 
      x-ref="fileInput"
      type="file" 
      @change="handleFileSelect($event)" 
      :accept="allowedTypes.join(',')"
      class="hidden"
      multiple="false"
    >
    
    <!-- 업로드 상태 표시 -->
    <div x-show="uploading" class="text-blue-600">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
      <span>업로드 중...</span>
    </div>
    
    <!-- 기본 상태 표시 -->
    <div x-show="!uploading">
      <div class="text-gray-600 mb-2">
        <span x-show="dragActive">파일을 여기에 놓으세요</span>
        <span x-show="!dragActive">파일을 드래그하거나 클릭하여 업로드</span>
      </div>
      <div class="text-sm text-gray-500">
        최대 <span x-text="Math.round(maxSize / 1024 / 1024)"></span>MB, 
        <span x-text="allowedTypes.join(', ')"></span>
      </div>
    </div>
    
    <!-- 에러 메시지 -->
    <div x-show="error" x-transition class="mt-2 p-2 bg-red-100 text-red-600 text-sm rounded">
      <span x-text="error"></span>
      <button @click="error = null" class="ml-2 underline">닫기</button>
    </div>
  </div>
  
  <!-- 업로드 진행률 -->
  <div x-show="uploading" class="mt-4">
    <div class="bg-gray-200 rounded-full h-2">
      <div 
        class="bg-blue-600 h-2 rounded-full transition-all duration-300"
        :style="`width: ${uploadProgress}%`"
      ></div>
    </div>
    <div class="text-xs text-gray-500 mt-1 text-center">
      <span x-text="uploadProgress"></span>% 완료
    </div>
  </div>
</div>

<script>
function secureFileUpload(options = {}) {
  return {
    // 설정 옵션
    allowedTypes: options.allowedTypes || ['image/jpeg', 'image/png', 'application/pdf'],
    maxSize: options.maxSize || 10 * 1024 * 1024, // 10MB
    linkTable: options.linkTable || null,
    linkId: options.linkId || null,
    
    // 상태 관리
    uploading: false,
    error: null,
    dragActive: false,
    uploadProgress: 0,
    
    init() {
      // 전역 파일 업로드 이벤트 리스너
      document.addEventListener('file-upload-complete', (event) => {
        console.log('파일 업로드 완료:', event.detail);
      });
    },
    
    handleDrop(event) {
      this.dragActive = false;
      const files = Array.from(event.dataTransfer.files);
      if (files.length > 0) {
        this.processFile(files[0]);
      }
    },
    
    handleFileSelect(event) {
      const files = Array.from(event.target.files);
      if (files.length > 0) {
        this.processFile(files[0]);
      }
    },
    
    async processFile(file) {
      // 파일 크기 검증
      if (file.size > this.maxSize) {
        this.error = `파일 크기는 ${Math.round(this.maxSize / 1024 / 1024)}MB를 초과할 수 없습니다.`;
        return;
      }
      
      // 파일 타입 검증
      if (!this.allowedTypes.includes(file.type)) {
        this.error = '허용되지 않는 파일 형식입니다.';
        return;
      }
      
      // UTF-8 파일명 검증
      if (!this.isValidUTF8(file.name)) {
        this.error = '파일명에 인코딩 문제가 있습니다. 파일명을 영문으로 변경해주세요.';
        return;
      }
      
      await this.uploadFile(file);
    },
    
    async uploadFile(file) {
      this.uploading = true;
      this.error = null;
      this.uploadProgress = 0;
      
      try {
        // FormData 생성
        const formData = new FormData();
        formData.append('file', file);
        if (this.linkTable) formData.append('link_table', this.linkTable);
        if (this.linkId) formData.append('link_id', this.linkId);
        
        // XMLHttpRequest를 사용한 업로드 진행률 추적
        const uploadResult = await this.uploadWithProgress(formData);
        
        // 업로드 완료 이벤트 발생
        document.dispatchEvent(new CustomEvent('file-upload-complete', {
          detail: {
            fileInfo: uploadResult,
            linkTable: this.linkTable,
            linkId: this.linkId
          }
        }));
        
        Alpine.store('toast').show('파일이 성공적으로 업로드되었습니다', 'success');
        
        // 파일 입력 초기화
        this.$refs.fileInput.value = '';
        
      } catch (error) {
        this.error = error.message || '파일 업로드에 실패했습니다';
        Alpine.store('toast').show(this.error, 'error');
      } finally {
        this.uploading = false;
        this.uploadProgress = 0;
      }
    },
    
    uploadWithProgress(formData) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        
        // 업로드 진행률 추적
        xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
            this.uploadProgress = Math.round((event.loaded / event.total) * 100);
          }
        });
        
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.success) {
                resolve(response.data);
              } else {
                reject(new Error(response.error || '업로드 실패'));
              }
            } catch (error) {
              reject(new Error('서버 응답 파싱 실패'));
            }
          } else {
            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
          }
        };
        
        xhr.onerror = () => {
          reject(new Error('네트워크 오류가 발생했습니다'));
        };
        
        xhr.open('POST', '/functions/v1/file-upload');
        xhr.setRequestHeader('Authorization', `Bearer ${Alpine.store('auth').token}`);
        xhr.send(formData);
      });
    },
    
    isValidUTF8(str) {
      try {
        return str === decodeURIComponent(encodeURIComponent(str));
      } catch {
        return false;
      }
    }
  };
}
</script>
```
```

---

## 11.12 실시간 기능 개발 가이드

### 11.12.1 Alpine.js + Supabase Realtime 활용
```html
<!-- 실시간 데이터 관리 컴포넌트 -->
<div x-data="realtimeDataManager()" class="realtime-data-container">
  <!-- 로딩 상태 -->
  <div x-show="loading" class="loading-state">
    <div class="animate-pulse flex space-x-4">
      <div class="rounded-full bg-gray-300 h-12 w-12"></div>
      <div class="flex-1 space-y-2 py-1">
        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
        <div class="h-4 bg-gray-300 rounded w-1/2"></div>
      </div>
    </div>
  </div>
  
  <!-- 에러 상태 -->
  <div x-show="error" x-transition class="error-state p-4 bg-red-100 border border-red-400 rounded">
    <div class="flex items-center">
      <span class="text-red-500 mr-2">⚠️</span>
      <span class="text-red-700" x-text="error"></span>
    </div>
    <button @click="retryLoad()" class="mt-2 text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
      다시 시도
    </button>
  </div>
  
  <!-- 실시간 데이터 리스트 -->
  <div x-show="!loading && !error" class="data-list">
    <!-- 연결 상태 표시 -->
    <div class="connection-status mb-4 flex items-center text-sm">
      <div class="flex items-center">
        <div 
          class="w-2 h-2 rounded-full mr-2"
          :class="connected ? 'bg-green-500' : 'bg-red-500'"
        ></div>
        <span x-text="connected ? '실시간 연결됨' : '연결 끊어짐'"></span>
      </div>
      <button 
        x-show="!connected" 
        @click="reconnect()" 
        class="ml-4 text-blue-600 hover:text-blue-800"
      >
        재연결
      </button>
    </div>
    
    <!-- 데이터 아이템들 -->
    <div class="space-y-2">
      <template x-for="(item, index) in data" :key="item.id || index">
        <div 
          class="data-item p-3 border rounded transition-all"
          :class="{
            'bg-green-50 border-green-200': item._isNew,
            'bg-yellow-50 border-yellow-200': item._isUpdated,
            'bg-gray-50 border-gray-200': !item._isNew && !item._isUpdated
          }"
        >
          <!-- 아이템 내용은 사용자가 커스텀화 -->
          <div class="item-content">
            <span x-text="item.name || item.title || 'No Name'"></span>
            <span x-show="item.created_at" class="text-xs text-gray-500 ml-2">
              <span x-text="formatDate(item.created_at)"></span>
            </span>
          </div>
          
          <!-- 실시간 업데이트 표시 -->
          <div x-show="item._isNew" class="text-xs text-green-600 mt-1">
            ✨ 새로 추가됨
          </div>
          <div x-show="item._isUpdated" class="text-xs text-yellow-600 mt-1">
            🔄 업데이트됨
          </div>
        </div>
      </template>
      
      <!-- 비어있을 때 -->
      <div x-show="data.length === 0" class="text-center py-8 text-gray-500">
        데이터가 없습니다
      </div>
    </div>
  </div>
</div>

<script>
function realtimeDataManager(options = {}) {
  return {
    // 설정
    table: options.table || 'students',
    filter: options.filter || null,
    
    // 상태
    data: [],
    loading: true,
    error: null,
    connected: false,
    channel: null,
    
    init() {
      this.loadInitialData();
      this.setupRealtimeSubscription();
      
      // 전역 이벤트 리스너
      document.addEventListener('realtime-data-update', (event) => {
        this.handleExternalUpdate(event.detail);
      });
    },
    
    async loadInitialData() {
      this.loading = true;
      this.error = null;
      
      try {
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        let query = supabase.from(this.table).select('*');
        
        // 필터 적용
        if (this.filter) {
          const [column, operator, value] = this.filter.split('=');
          if (operator === 'eq') {
            query = query.eq(column, value);
          } else if (operator === 'neq') {
            query = query.neq(column, value);
          } else if (operator === 'gt') {
            query = query.gt(column, value);
          } else if (operator === 'lt') {
            query = query.lt(column, value);
          }
        }
        
        // 인증된 사용자 데이터만 로드
        if (Alpine.store('auth').token) {
          query = query.order('created_at', { ascending: false });
        }
        
        const { data, error } = await query;
        
        if (error) {
          throw new Error(`데이터 로드 실패: ${error.message}`);
        }
        
        // UTF-8 인코딩 검증
        const validData = (data || []).filter(item => {
          if (item.name && !this.isValidUTF8(item.name)) {
            console.warn('인코딩 문제가 있는 데이터 발견:', item);
            return false;
          }
          return true;
        });
        
        this.data = validData;
        
      } catch (error) {
        this.error = error.message || '데이터 로드 중 오류가 발생했습니다';
        console.error('Realtime data load error:', error);
      } finally {
        this.loading = false;
      }
    },
    
    async setupRealtimeSubscription() {
      try {
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        this.channel = supabase
          .channel(`realtime_${this.table}_${Date.now()}`)
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: this.table,
              filter: this.filter
            },
            (payload) => {
              this.handleRealtimeUpdate(payload);
            }
          )
          .on('system', {}, (payload) => {
            // 연결 상태 변경 처리
            if (payload.event === 'connected') {
              this.connected = true;
              console.log('실시간 연결 성공');
            } else if (payload.event === 'disconnected') {
              this.connected = false;
              console.log('실시간 연결 끊어짐');
            }
          })
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              this.connected = true;
            } else if (status === 'CHANNEL_ERROR') {
              this.connected = false;
              console.error('실시간 구독 오류');
            }
          });
          
      } catch (error) {
        console.error('실시간 구독 설정 실패:', error);
      }
    },
    
    handleRealtimeUpdate(payload) {
      const { eventType, new: newRecord, old: oldRecord } = payload;
      
      // UTF-8 인코딩 검증
      if (newRecord && newRecord.name && !this.isValidUTF8(newRecord.name)) {
        console.warn('인코딩 문제가 있는 실시간 데이터:', newRecord);
        return;
      }
      
      switch (eventType) {
        case 'INSERT':
          // 새 데이터 표시
          newRecord._isNew = true;
          this.data.unshift(newRecord);
          
          // 3초 후 표시 제거
          setTimeout(() => {
            const index = this.data.findIndex(item => item.id === newRecord.id);
            if (index !== -1) {
              this.data[index]._isNew = false;
            }
          }, 3000);
          
          // 알림 표시
          Alpine.store('toast').show(`새로운 ${this.table} 항목이 추가되었습니다`, 'info');
          break;
          
        case 'UPDATE':
          const updateIndex = this.data.findIndex(item => item.id === newRecord.id);
          if (updateIndex !== -1) {
            newRecord._isUpdated = true;
            this.data[updateIndex] = newRecord;
            
            // 3초 후 표시 제거
            setTimeout(() => {
              const currentIndex = this.data.findIndex(item => item.id === newRecord.id);
              if (currentIndex !== -1) {
                this.data[currentIndex]._isUpdated = false;
              }
            }, 3000);
          }
          break;
          
        case 'DELETE':
          this.data = this.data.filter(item => item.id !== oldRecord.id);
          Alpine.store('toast').show(`${this.table} 항목이 삭제되었습니다`, 'info');
          break;
      }
      
      // 전역 이벤트 발생
      document.dispatchEvent(new CustomEvent('data-updated', {
        detail: {
          table: this.table,
          eventType,
          data: newRecord || oldRecord
        }
      }));
    },
    
    async retryLoad() {
      await this.loadInitialData();
    },
    
    async reconnect() {
      if (this.channel) {
        await this.channel.unsubscribe();
      }
      this.setupRealtimeSubscription();
    },
    
    formatDate(dateString) {
      return new Date(dateString).toLocaleString('ko-KR');
    },
    
    handleExternalUpdate(detail) {
      // 외부에서 발생한 데이터 업데이트 처리
      if (detail.table === this.table) {
        this.loadInitialData();
      }
    },
    
    isValidUTF8(str) {
      try {
        return str === decodeURIComponent(encodeURIComponent(str));
      } catch {
        return false;
      }
    },
    
    destroy() {
      if (this.channel) {
        this.channel.unsubscribe();
      }
    }
  };
}
</script>
```
```

### 11.12.2 Alpine.js 기반 실시간 알림 시스템
```html
<!-- 실시간 알림 관리 컴포넌트 -->
<div x-data="realtimeNotifications()" class="realtime-notifications">
  <!-- 브라우저 알림 권한 요청 -->
  <div 
    x-show="showPermissionRequest" 
    x-transition
    class="permission-request fixed top-4 right-4 z-50 bg-blue-100 border border-blue-400 rounded-lg p-4 max-w-sm"
  >
    <div class="flex items-center mb-2">
      <span class="text-blue-500 mr-2">🔔</span>
      <h4 class="font-semibold text-blue-800">브라우저 알림 허용</h4>
    </div>
    <p class="text-sm text-blue-700 mb-3">
      중요한 알림을 놓치지 않도록 브라우저 알림을 허용해주세요.
    </p>
    <div class="flex space-x-2">
      <button 
        @click="requestNotificationPermission" 
        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
      >
        허용
      </button>
      <button 
        @click="showPermissionRequest = false" 
        class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400"
      >
        다음에
      </button>
    </div>
  </div>

  <!-- 알림 리스트 (사용자가 볼 수 있는 UI) -->
  <div 
    x-show="showNotificationList" 
    x-transition
    class="notification-list fixed top-16 right-4 z-50 bg-white border border-gray-300 rounded-lg shadow-lg max-w-sm max-h-96 overflow-y-auto"
  >
    <div class="notification-header p-3 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h4 class="font-semibold text-gray-800">알림</h4>
        <div class="flex items-center space-x-2">
          <button 
            x-show="notifications.length > 0"
            @click="markAllAsRead"
            class="text-xs text-blue-600 hover:text-blue-800"
          >
            모두 읽음
          </button>
          <button 
            @click="showNotificationList = false"
            class="text-gray-500 hover:text-gray-700"
          >
            ×
          </button>
        </div>
      </div>
    </div>
    
    <div class="notification-items">
      <template x-for="(notification, index) in notifications" :key="notification.id">
        <div 
          class="notification-item p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50"
          :class="{ 'bg-blue-50': !notification.read }"
          @click="markAsRead(notification.id)"
        >
          <div class="flex items-start">
            <div class="notification-icon mr-3 mt-1">
              <span x-text="getNotificationIcon(notification.type)"></span>
            </div>
            <div class="notification-content flex-1">
              <p class="text-sm text-gray-800" x-text="notification.message"></p>
              <p class="text-xs text-gray-500 mt-1" x-text="formatTime(notification.created_at)"></p>
            </div>
            <div x-show="!notification.read" class="notification-badge">
              <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
            </div>
          </div>
        </div>
      </template>
      
      <div x-show="notifications.length === 0" class="p-6 text-center text-gray-500">
        <div class="mb-2">🔔</div>
        <p class="text-sm">새로운 알림이 없습니다</p>
      </div>
    </div>
  </div>
  
  <!-- 알림 버튼 (헤더에 표시되는 버튼) -->
  <button 
    @click="toggleNotificationList" 
    class="notification-trigger relative p-2 text-gray-600 hover:text-gray-800 transition-colors"
    :class="{ 'text-blue-600': unreadCount > 0 }"
  >
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M15 17h5l-3.5-3.5a7.5 7.5 0 01-1.5-4.5V9a6 6 0 00-12 0v1.5c0 1.5-.5 3-1.5 4.5L5 17h5m5 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
    </svg>
    <span 
      x-show="unreadCount > 0" 
      x-text="unreadCount" 
      class="notification-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
    ></span>
  </button>
</div>

<script>
function realtimeNotifications() {
  return {
    // 상태 관리
    notifications: [],
    unreadCount: 0,
    showNotificationList: false,
    showPermissionRequest: false,
    notificationChannel: null,
    
    // 설정
    maxNotifications: 50,
    
    init() {
      this.checkNotificationPermission();
      this.loadNotifications();
      this.setupRealtimeNotifications();
      
      // 전역 알림 이벤트 리스너
      document.addEventListener('show-notification', (event) => {
        this.addNotification(event.detail);
      });
    },
    
    checkNotificationPermission() {
      if ('Notification' in window) {
        if (Notification.permission === 'default') {
          // 5초 후에 권한 요청 표시
          setTimeout(() => {
            this.showPermissionRequest = true;
          }, 5000);
        }
      }
    },
    
    async requestNotificationPermission() {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          Alpine.store('toast').show('브라우저 알림이 활성되었습니다', 'success');
        }
        this.showPermissionRequest = false;
      }
    },
    
    async loadNotifications() {
      try {
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        const { data, error } = await supabase
          .from('notifications')
          .select('*')
          .eq('user_id', Alpine.store('auth').user?.id)
          .order('created_at', { ascending: false })
          .limit(this.maxNotifications);
          
        if (error) {
          console.error('알림 로드 실패:', error);
          return;
        }
        
        // UTF-8 인코딩 검증
        const validNotifications = (data || []).filter(notification => {
          if (notification.message && !this.isValidUTF8(notification.message)) {
            console.warn('인코딩 문제가 있는 알림:', notification);
            return false;
          }
          return true;
        });
        
        this.notifications = validNotifications;
        this.updateUnreadCount();
        
      } catch (error) {
        console.error('알림 로드 오류:', error);
      }
    },
    
    async setupRealtimeNotifications() {
      if (!Alpine.store('auth').user?.id) return;
      
      try {
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        this.notificationChannel = supabase
          .channel('realtime_notifications')
          .on('postgres_changes', 
            {
              event: 'INSERT',
              schema: 'public',
              table: 'notifications',
              filter: `user_id=eq.${Alpine.store('auth').user.id}`
            },
            (payload) => {
              this.handleNewNotification(payload.new);
            }
          )
          .subscribe();
          
      } catch (error) {
        console.error('실시간 알림 설정 실패:', error);
      }
    },
    
    handleNewNotification(notification) {
      // UTF-8 인코딩 검증
      if (!this.isValidUTF8(notification.message)) {
        console.warn('인코딩 문제가 있는 실시간 알림:', notification);
        return;
      }
      
      // 리스트에 추가
      this.notifications.unshift(notification);
      
      // 제한 초과 시 가장 오래된 알림 제거
      if (this.notifications.length > this.maxNotifications) {
        this.notifications = this.notifications.slice(0, this.maxNotifications);
      }
      
      this.updateUnreadCount();
      
      // Toast 알림 표시
      Alpine.store('toast').show(notification.message, notification.type || 'info', {
        icon: this.getNotificationIcon(notification.type),
        duration: 5000
      });
      
      // 브라우저 알림 (권한이 있는 경우)
      if (Notification.permission === 'granted') {
        new Notification(notification.title || 'IEPON 알림', {
          body: notification.message,
          icon: '/favicon.ico',
          badge: '/favicon.ico',
          tag: notification.id
        });
      }
    },
    
    addNotification(notificationData) {
      // 수동으로 알림 추가 (전역 이벤트로부터)
      const notification = {
        id: Date.now().toString(),
        message: notificationData.message,
        type: notificationData.type || 'info',
        created_at: new Date().toISOString(),
        read: false
      };
      
      this.handleNewNotification(notification);
    },
    
    async markAsRead(notificationId) {
      try {
        const notification = this.notifications.find(n => n.id === notificationId);
        if (!notification || notification.read) return;
        
        // 로컬 상태 업데이트
        notification.read = true;
        this.updateUnreadCount();
        
        // 서버에 업데이트
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        await supabase
          .from('notifications')
          .update({ read: true })
          .eq('id', notificationId);
          
      } catch (error) {
        console.error('알림 읽음 처리 실패:', error);
      }
    },
    
    async markAllAsRead() {
      try {
        // 로컬 상태 업데이트
        this.notifications.forEach(notification => {
          notification.read = true;
        });
        this.updateUnreadCount();
        
        // 서버에 업데이트
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(
          window.SUPABASE_URL || '',
          window.SUPABASE_ANON_KEY || ''
        );
        
        await supabase
          .from('notifications')
          .update({ read: true })
          .eq('user_id', Alpine.store('auth').user?.id)
          .eq('read', false);
          
      } catch (error) {
        console.error('알림 모두 읽음 처리 실패:', error);
      }
    },
    
    toggleNotificationList() {
      this.showNotificationList = !this.showNotificationList;
    },
    
    updateUnreadCount() {
      this.unreadCount = this.notifications.filter(n => !n.read).length;
    },
    
    getNotificationIcon(type) {
      const icons = {
        'success': '✅',
        'warning': '⚠️',
        'error': '❌',
        'info': 'ℹ️'
      };
      return icons[type] || 'ℹ️';
    },
    
    formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffInMinutes < 1) return '방금 전';
      if (diffInMinutes < 60) return `${diffInMinutes}분 전`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}시간 전`;
      return date.toLocaleDateString('ko-KR');
    },
    
    isValidUTF8(str) {
      try {
        return str === decodeURIComponent(encodeURIComponent(str));
      } catch {
        return false;
      }
    },
    
    destroy() {
      if (this.notificationChannel) {
        this.notificationChannel.unsubscribe();
      }
    }
  };
}
</script>
```
```

---

## 📋 **체크리스트**

### 개발 환경 설정 (HTML + Alpine.js + HTMX)
- [ ] 정적 파일 호스팅 환경 준비
- [ ] Alpine.js/HTMX CDN 링크 설정
- [ ] 환경 변수 설정 (window.ENV)
- [ ] Supabase 클라이언트 초기화
- [ ] 관리자 계정 자동 생성
- [ ] 결제 시스템 구축 (Toss Payments 위젯)
- [ ] AI 기능 통합 (Edge Functions)
- [ ] 파일 업로드 시스템 구축 (Supabase Storage)
- [ ] 실시간 기능 구축 (HTMX + Supabase Realtime)

### 코드 품질 (JavaScript + HTML)
- [ ] JSDoc 주석 작성 (TypeScript 대신)
- [ ] ESLint/Prettier 설정 (JavaScript 전용)
- [ ] HTML 유효성 검사 (html-validate)
- [ ] 접근성 검사 (WAVE, axe-core)
- [ ] 코드 리뷰 완료

### 성능 및 보안
- [ ] 성능 최적화 적용
- [ ] 보안 검증 완료
- [ ] 에러 처리 구현
- [ ] 로깅 시스템 구성

### 배포 준비
- [ ] 빌드 테스트 통과
- [ ] 환경별 설정 확인
- [ ] 데이터베이스 마이그레이션
- [ ] 배포 스크립트 준비

---

## 11.9 관리자 시스템 개발 가이드

### 11.9.1 관리자 계정 초기화
```bash
# 1. 초기 관리자 계정 설정
# Supabase 대시보드에서 직접 관리자 계정 생성 (권장 방법)
# 또는 아래 SQL 쿼리를 Supabase SQL Editor에서 실행

# 2. 수동 설정
psql -h localhost -d iepon -U postgres
```

```sql
-- 초기 super_admin 계정 생성
INSERT INTO auth.users (
  id,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  raw_user_meta_data
) VALUES (
  gen_random_uuid(),
  'admin@iepon.site',
  crypt('IeponAdmin2024!', gen_salt('bf')),
  now(),
  now(),
  now(),
  '{"role": "super_admin"}'
);

-- user_profiles 테이블에 프로필 생성
INSERT INTO user_profiles (
  id,
  email,
  full_name,
  role,
  is_active,
  organization,
  department
) SELECT 
  id,
  email,
  '시스템 관리자',
  'super_admin',
  true,
  'IEPON',
    </div>

    <!-- 에러 메시지 -->
    <div 
      x-show="error" 
      x-transition
      class="error-message mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded"
    >
      <div class="flex justify-between items-center">
        <span x-text="error"></span>
        <button 
          @click="clearError"
          class="ml-2 text-red-500 hover:text-red-700 font-bold"
        >
          ×
        </button>
      </div>
    </div>

    <!-- 로딩 상태 -->
    <div x-show="loading" class="loading-overlay fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
      <div class="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-600">데이터를 불러오는 중...</p>
      </div>
    </div>

    <!-- 통계 카드 섹션 -->
    <div class="statistics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- 활성 사용자 수 -->
      <div class="stat-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-blue-100 text-blue-600 p-3 rounded-lg">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="stat-value text-2xl font-bold text-gray-800" x-text="statistics.activeUsers || 0"></p>
            <p class="stat-label text-sm text-gray-600">활성 사용자</p>
          </div>
        </div>
      </div>

      <!-- 총 학생 수 -->
      <div class="stat-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-green-100 text-green-600 p-3 rounded-lg">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="stat-value text-2xl font-bold text-gray-800" x-text="statistics.totalStudents || 0"></p>
            <p class="stat-label text-sm text-gray-600">등록 학생 수</p>
          </div>
        </div>
      </div>

      <!-- 총 결제 금액 -->
      <div class="stat-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-yellow-100 text-yellow-600 p-3 rounded-lg">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="stat-value text-2xl font-bold text-gray-800" x-text="formatCurrency(statistics.totalPayments || 0)"></p>
            <p class="stat-label text-sm text-gray-600">총 결제 금액</p>
          </div>
        </div>
      </div>

      <!-- 활성 라이선스 -->
      <div class="stat-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-purple-100 text-purple-600 p-3 rounded-lg">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="stat-value text-2xl font-bold text-gray-800" x-text="statistics.activeLicenses || 0"></p>
            <p class="stat-label text-sm text-gray-600">활성 라이선스</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 관리 메뉴 섹션 -->
    <div class="management-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <!-- 사용자 관리 -->
      <div class="management-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center mb-4">
          <div class="icon bg-blue-100 text-blue-600 p-3 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
            </svg>
          </div>
          <h3 class="ml-3 text-lg font-semibold text-gray-800">사용자 관리</h3>
        </div>
        <p class="text-gray-600 mb-4">사용자 계정, 권한, 프로필을 관리합니다.</p>
        <button 
          @click="navigateTo('/admin/users')"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors"
        >
          관리하기
        </button>
      </div>

      <!-- 학생 관리 -->
      <div class="management-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center mb-4">
          <div class="icon bg-green-100 text-green-600 p-3 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
          <h3 class="ml-3 text-lg font-semibold text-gray-800">학생 관리</h3>
        </div>
        <p class="text-gray-600 mb-4">학생 정보, 교육과정 배정을 관리합니다.</p>
        <button 
          @click="navigateTo('/admin/students')"
          class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition-colors"
        >
          관리하기
        </button>
      </div>

      <!-- 시스템 설정 -->
      <div class="management-card bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center mb-4">
          <div class="icon bg-gray-100 text-gray-600 p-3 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.27 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.27-1.45-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <h3 class="ml-3 text-lg font-semibold text-gray-800">시스템 설정</h3>
        </div>
        <p class="text-gray-600 mb-4">시스템 환경 설정, 보안 설정을 관리합니다.</p>
        <button 
          @click="navigateTo('/admin/settings')"
          class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 transition-colors"
        >
          설정하기
        </button>
      </div>
    </div>

    <!-- 최근 활동 로그 -->
    <div class="activity-log bg-white rounded-lg shadow-md p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">최근 활동</h3>
      <div x-show="activityLogs.length === 0" class="text-center text-gray-500 py-8">
        활동 기록이 없습니다.
      </div>
      <div x-show="activityLogs.length > 0" class="space-y-3">
        <template x-for="(log, index) in activityLogs.slice(0, 10)" :key="log.id">
          <div class="activity-item flex items-center p-3 bg-gray-50 rounded">
            <div class="activity-icon mr-3">
              <span x-text="getActivityIcon(log.action)"></span>
            </div>
            <div class="activity-content flex-1">
              <p class="text-sm text-gray-800" x-text="log.description"></p>
              <p class="text-xs text-gray-500" x-text="formatDateTime(log.created_at)"></p>
            </div>
            <div class="activity-user">
              <span class="text-xs text-gray-600" x-text="log.user_name || '시스템'"></span>
            </div>
          </div>
        </template>
      </div>
      <button 
        @click="navigateTo('/admin/activity-logs')"
        class="mt-4 w-full text-center text-blue-600 hover:text-blue-800 text-sm"
      >
        전체 활동 로그 보기
      </button>
    </div>
  </div>

  <script>
  function adminDashboard() {
    return {
      // 상태 관리
      statistics: {
        activeUsers: 0,
        totalStudents: 0,
        totalPayments: 0,
        activeLicenses: 0
      },
      activityLogs: [],
      loading: false,
      error: '',
      lastUpdated: '',
      
      async init() {
        await this.checkAdminPermission();
        await this.loadDashboardData();
        this.setupAutoRefresh();
      },
      
      async checkAdminPermission() {
        try {
          const user = Alpine.store('auth').user;
          if (!user) {
            window.location.href = '/auth/login.html';
            return;
          }
          
          const profile = await Alpine.store('auth').getProfile();
          if (!profile || !['admin', 'super_admin'].includes(profile.role) || !profile.is_active) {
            window.location.href = '/dashboard.html';
            return;
          }
        } catch (error) {
          console.error('권한 확인 실패:', error);
          this.error = '권한 확인 중 오류가 발생했습니다.';
        }
      },
      
      async loadDashboardData() {
        this.loading = true;
        try {
          await Promise.all([
            this.loadStatistics(),
            this.loadActivityLogs()
          ]);
          this.lastUpdated = this.formatDateTime(new Date().toISOString());
        } catch (error) {
          console.error('대시보드 데이터 로드 실패:', error);
          this.error = '대시보드 데이터를 불러오는데 실패했습니다.';
        } finally {
          this.loading = false;
        }
      },
      
      async loadStatistics() {
        try {
          const response = await fetch('/functions/v1/admin/statistics', {
            headers: {
              'Authorization': `Bearer ${Alpine.store('auth').token}`,
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          if (result.success) {
            this.statistics = result.data;
          }
        } catch (error) {
          console.error('통계 데이터 로드 실패:', error);
        }
      },
      
      async loadActivityLogs() {
        try {
          const response = await fetch('/functions/v1/admin/activity-logs?limit=10', {
            headers: {
              'Authorization': `Bearer ${Alpine.store('auth').token}`,
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          if (result.success) {
            // UTF-8 인코딩 검증
            this.activityLogs = (result.data || []).filter(log => {
              if (log.description && !this.isValidUTF8(log.description)) {
                console.warn('인코딩 문제가 있는 활동 로그:', log);
                return false;
              }
              return true;
            });
          }
        } catch (error) {
          console.error('활동 로그 로드 실패:', error);
        }
      },
      
      setupAutoRefresh() {
        // 5분마다 자동 갱신
        setInterval(() => {
          this.loadStatistics();
        }, 5 * 60 * 1000);
      },
      
      async refreshAll() {
        await this.loadDashboardData();
        Alpine.store('toast').show('대시보드가 새로고침되었습니다', 'success');
      },
      
      clearError() {
        this.error = '';
      },
      
      navigateTo(path) {
        window.location.href = path;
      },
      
      formatCurrency(amount) {
        return new Intl.NumberFormat('ko-KR', {
          style: 'currency',
          currency: 'KRW'
        }).format(amount);
      },
      
      formatDateTime(dateString) {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }).format(date);
      },
      
      getActivityIcon(action) {
        const icons = {
          'login': '🔑',
          'logout': '🚪',
          'create': '➕',
          'update': '✏️',
          'delete': '🗑️',
          'payment': '💳',
          'system': '⚙️'
        };
        return icons[action] || '📝';
      },
      
      isValidUTF8(str) {
        try {
          return str === decodeURIComponent(encodeURIComponent(str));
        } catch {
          return false;
        }
      }
    };
import { NextApiRequest, NextApiResponse } from 'next';
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs';
import { adminAuthMiddleware } from '@/middleware/adminAuth';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  // 권한 검사
  const authResult = await adminAuthMiddleware(req);
  if (authResult.error) {
    return res.status(authResult.status).json({ error: authResult.error });
  }

  const supabase = createServerSupabaseClient({ req, res });

  switch (req.method) {
    case 'GET':
      return handleGetUsers(req, res, supabase);
    case 'POST':
      return handleCreateUser(req, res, supabase);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
}

async function handleGetUsers(req: NextApiRequest, res: NextApiResponse, supabase: any) {
  try {
    const { 
      page = 1, 
      limit = 20, 
      search = '', 
      role = 'all',
      status = 'all' 
    } = req.query;

    let query = supabase
      .from('user_profiles')
      .select('*', { count: 'exact' })
      .order('created_at', { ascending: false });

    // 검색 필터
    if (search) {
      query = query.or(`full_name.ilike.%${search}%,email.ilike.%${search}%`);
    }

    // 역할 필터
    if (role !== 'all') {
      query = query.eq('role', role);
    }

    // 상태 필터
    if (status !== 'all') {
      query = query.eq('is_active', status === 'active');
    }

    // 페이지네이션
    const offset = (Number(page) - 1) * Number(limit);
    query = query.range(offset, offset + Number(limit) - 1);

    const { data, count, error } = await query;

    if (error) throw error;

    return res.status(200).json({
      success: true,
      data,
      pagination: {
        page: Number(page),
        limit: Number(limit),
        total: count,
        totalPages: Math.ceil((count || 0) / Number(limit))
      }
    });
  } catch (error: any) {
    return res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
}
```

### 11.9.4 시스템 설정 관리
```typescript
// pages/api/admin/system-settings/[key].ts
import { NextApiRequest, NextApiResponse } from 'next';
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const { key } = req.query;
  const supabase = createServerSupabaseClient({ req, res });

  // super_admin 권한 필요
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    return res.status(401).json({ error: '인증이 필요합니다' });
  }

  const { data: profile } = await supabase
    .from('user_profiles')
    .select('role')
    .eq('id', session.user.id)
    .single();

  if (profile?.role !== 'super_admin') {
    return res.status(403).json({ error: '권한이 없습니다' });
  }

  switch (req.method) {
    case 'GET':
      return handleGetSetting(key as string, supabase, res);
    case 'PATCH':
      return handleUpdateSetting(key as string, req.body, supabase, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
}

async function handleUpdateSetting(
  key: string,
  body: any,
  supabase: any,
  res: NextApiResponse
) {
  try {
    const { value } = body;
    
    const { data, error } = await supabase
      .from('system_settings')
      .update({ 
        setting_value: value,
        updated_at: new Date().toISOString()
      })
      .eq('setting_key', key)
      .select()
      .single();

    if (error) throw error;

    // 설정 변경 로그 기록
    await supabase.from('admin_activity_logs').insert({
      action: 'system_setting_updated',
      details: { setting_key: key, new_value: value },
      created_at: new Date().toISOString()
    });

    return res.status(200).json({ success: true, data });
  } catch (error: any) {
    return res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
}
```

### 11.9.5 알림 시스템 개발
```typescript
// lib/notifications/manager.ts
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs';

export class NotificationManager {
  private supabase: any;

  constructor(supabase: any) {
    this.supabase = supabase;
  }

  // 전체 사용자에게 알림 발송
  async sendToAll(notification: {
    title: string;
    message: string;
    type: 'info' | 'warning' | 'error' | 'success';
  }) {
    try {
      const { data: users } = await this.supabase
        .from('user_profiles')
        .select('id')
        .eq('is_active', true);

      const notifications = users.map((user: any) => ({
        user_id: user.id,
        title: notification.title,
        message: notification.message,
        type: notification.type,
        is_read: false,
        created_at: new Date().toISOString()
      }));

      const { error } = await this.supabase
        .from('notifications')
        .insert(notifications);

      if (error) throw error;

      return { success: true, count: notifications.length };
    } catch (error) {
      console.error('알림 발송 오류:', error);
      return { success: false, error };
    }
  }

  // 특정 사용자에게 알림 발송
  async sendToUser(
    userId: string,
    notification: {
      title: string;
      message: string;
      type: 'info' | 'warning' | 'error' | 'success';
    }
  ) {
    try {
      const { error } = await this.supabase
        .from('notifications')
        .insert({
          user_id: userId,
          title: notification.title,
          message: notification.message,
          type: notification.type,
          is_read: false,
          created_at: new Date().toISOString()
        });

      if (error) throw error;
      return { success: true };
    } catch (error) {
      console.error('알림 발송 오류:', error);
      return { success: false, error };
    }
  }
}

// 사용 예시
export async function sendMaintenanceNotification() {
  const supabase = createServerSupabaseClient({});
  const notificationManager = new NotificationManager(supabase);
  
  await notificationManager.sendToAll({
    title: '시스템 점검 알림',
    message: '오늘 밤 2시부터 4시까지 시스템 점검이 예정되어 있습니다.',
    type: 'warning'
  });
}
```

### 11.9.6 관리자 개발 체크리스트

#### 백엔드 개발
- [ ] 관리자 계정 초기화 스크립트
- [ ] 관리자 권한 미들웨어
- [ ] 사용자 관리 API 구현
- [ ] 시스템 설정 API 구현
- [ ] 알림 시스템 API 구현
- [ ] 로그인 기록 API 구현
- [ ] 통계 데이터 API 구현

#### 프론트엔드 개발
- [ ] 관리자 대시보드 페이지
- [ ] 사용자 관리 페이지
- [ ] 시스템 설정 페이지
- [ ] 알림 센터 컴포넌트
- [ ] 로그인 기록 뷰어
- [ ] Zustand 스토어 연동
- [ ] 리얼타임 업데이트 처리

#### 보안 및 테스트
- [ ] 권한 별 접계 제한 테스트
- [ ] API 엔드포인트 보안 테스트
- [ ] 로그인 기록 및 모니터링 테스트
- [ ] 알림 시스템 테스트
- [ ] 성능 테스트 (대용량 데이터)

#### 배포 및 운영
- [ ] 관리자 환경 변수 설정
- [ ] 보안 설정 적용
- [ ] 모니터링 대시보드 설정
- [ ] 백업 및 복구 방침
- [ ] 운영 매뉴얼 작성

---

## 🔗 **관련 문서**

- **[08_환경_설정.md](./08_환경_설정.md)**: 개발 환경 상세 설정
- **[11_배포_가이드.md](./11_배포_가이드.md)**: 배포 프로세스
- **[10_보안_권한.md](./10_보안_권한.md)**: 보안 개발 가이드라인
- **[README.md](./README.md)**: 프로젝트 전체 가이드

---

## 🆘 **문제 해결 가이드**

### 자주 발생하는 문제들

#### 1. Supabase 연결 오류
```bash
# 해결 방법
supabase status
supabase start
# 환경 변수 확인
```

#### 2. 빌드 오류
```bash
# 캐시 삭제 후 재빌드
rm -rf .next
pnpm clean
pnpm install
pnpm build
```

#### 3. 타입 오류
```bash
# 타입 정의 재생성
supabase gen types typescript --project-id your-project > src/types/database.ts
```

#### 4. 권한 오류
```sql
-- RLS 정책 확인
SELECT * FROM pg_policies WHERE tablename = 'students';
-- 사용자 역할 확인
SELECT auth.jwt() ->> 'role' as user_role;
```

---

## 11.10 교육과정 시스템 구현 가이드

### 11.10.1 교육과정 테이블 생성
```sql
-- curriculum_units 테이블 생성
CREATE TABLE curriculum_units (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subject VARCHAR(20) NOT NULL CHECK (subject IN ('국어', '수학')),
  grade_level VARCHAR(10) NOT NULL CHECK (grade_level IN ('1학년', '2학년', '3학년', '4학년', '5학년', '6학년')),
  semester VARCHAR(10) NOT NULL CHECK (semester IN ('1학기', '2학기')),
  unit_number INTEGER NOT NULL,
  unit_name VARCHAR(200) NOT NULL,
  learning_objectives TEXT[] NOT NULL,
  achievement_standards TEXT[],
  learning_contents TEXT[] NOT NULL,
  key_concepts TEXT[],
  assessment_plan TEXT,
  evaluation_methods TEXT[],
  evaluation_criteria TEXT[],
  version VARCHAR(20) DEFAULT '1.0',
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(subject, grade_level, semester, unit_number)
);
```

### 11.10.2 API 라우트 구현
```typescript
// pages/api/curriculum-units/index.ts
import { NextApiRequest, NextApiResponse } from 'next';
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs';
import { getCurriculumUnits, createCurriculumUnit } from '@/lib/curriculum';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const supabase = createServerSupabaseClient({ req, res });
  
  try {
    if (req.method === 'GET') {
      const { subject, grade_level, semester, is_active } = req.query;
      const result = await getCurriculumUnits(supabase, {
        subject: subject as string,
        grade_level: grade_level as string,
        semester: semester as string,
        is_active: is_active === 'true'
      });
      
      if (result.success) {
        res.status(200).json(result);
      } else {
        res.status(400).json(result);
      }
    }
    
    else if (req.method === 'POST') {
      // 관리자 권한 확인
      const { data: user } = await supabase.auth.getUser();
      if (!user?.user || user.user.user_metadata?.role !== 'super_admin') {
        return res.status(403).json({ error: '관리자 권한이 필요합니다.' });
      }
      
      const result = await createCurriculumUnit(supabase, req.body);
      
      if (result.success) {
        res.status(201).json(result);
      } else {
        res.status(400).json(result);
      }
    }
    
    else {
      res.setHeader('Allow', ['GET', 'POST']);
      res.status(405).end(`Method ${req.method} Not Allowed`);
    }
  } catch (error) {
    res.status(500).json({ error: '서버 오류가 발생했습니다.' });
  }
}
```

### 11.10.3 Excel 업로드 처리
```typescript
// pages/api/curriculum-units/upload.ts
import { NextApiRequest, NextApiResponse } from 'next';
import multer from 'multer';
import xlsx from 'xlsx';
import { validateCurriculumData } from '@/lib/curriculum-validation';

const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: parseInt(process.env.CURRICULUM_UPLOAD_MAX_SIZE || '10485760') // 10MB
  },
  fileFilter: (req, file, cb) => {
    if (file.mimetype === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
      cb(null, true);
    } else {
      cb(new Error('Excel 파일(.xlsx)만 업로드 가능합니다.'));
    }
  }
});

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'POST 메소드만 허용됩니다.' });
  }

  try {
    // 파일 업로드 처리
    upload.single('file')(req as any, res as any, async (err) => {
      if (err) {
        return res.status(400).json({ error: err.message });
      }

      const file = (req as any).file;
      if (!file) {
        return res.status(400).json({ error: '파일이 업로드되지 않았습니다.' });
      }

      // Excel 파일 파싱
      const workbook = xlsx.read(file.buffer, { type: 'buffer' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = xlsx.utils.sheet_to_json(worksheet, { header: 1 });

      // 데이터 검증 및 변환
      const validationResult = await validateCurriculumData(jsonData);
      
      if (!validationResult.success) {
        return res.status(400).json({
          error: '데이터 검증 실패',
          details: validationResult.errors
        });
      }

      // 데이터베이스에 저장
      const uploadResult = await processCurriculumUpload(validationResult.data);
      
      res.status(200).json({
        success: true,
        data: uploadResult
      });
    });
  } catch (error) {
    res.status(500).json({ error: '파일 처리 중 오류가 발생했습니다.' });
  }
}

export const config = {
  api: {
    bodyParser: false,
  },
};
```

### 11.10.4 Alpine.js 기반 교육과정 관리
```html
<!-- admin/curriculum.html -->
<div x-data="curriculumManagement()" x-init="init()" class="curriculum-container p-8">
  <!-- 헤더 -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">교육과정 관리</h1>
    <div class="flex space-x-3">
      <button @click="showUpload = true" class="btn-primary">📄 Excel 업로드</button>
      <button @click="openUnitEditor(null)" class="btn-secondary">➕ 단원 추가</button>
    </div>
  </div>

  <!-- 검색 -->
  <div class="search-section mb-6">
    <input 
      type="text" 
      x-model="searchQuery"
      @input.debounce.500ms="searchUnits"
      placeholder="단원명으로 검색..."
      class="w-full px-4 py-2 border rounded-md"
    >
  </div>

  <!-- 단원 리스트 -->
  <div class="units-list bg-white rounded-lg shadow-sm border">
    <template x-for="unit in filteredUnits" :key="unit.id">
      <div class="unit-item border-b p-4 hover:bg-gray-50" @click="openUnitEditor(unit)">
        <h4 class="font-semibold" x-text="unit.name"></h4>
        <div class="flex space-x-2 mt-2">
          <span class="badge" x-text="unit.grade"></span>
          <span class="badge" x-text="unit.subject"></span>
        </div>
        <div class="flex justify-end space-x-2 mt-3">
          <button @click.stop="openUnitEditor(unit)" class="btn-edit">편집</button>
          <button @click.stop="confirmDelete(unit)" class="btn-delete">삭제</button>
        </div>
      </div>
    </template>
  </div>

  <!-- Excel 업로드 모달 -->
  <div x-show="showUpload" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-semibold mb-4">Excel 파일 업로드</h3>
      <input type="file" accept=".xlsx,.xls" @change="handleFileUpload($event.target.files[0])" class="mb-4">
      <div class="flex justify-end space-x-2">
        <button @click="showUpload = false" class="btn-cancel">취소</button>
      </div>
    </div>
  </div>

  <!-- 단원 편집 모달 -->
  <div x-show="editingUnit" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
      <h3 class="text-lg font-semibold mb-4" x-text="editingUnit?.id ? '단원 수정' : '새 단원 추가'"></h3>
      <form @submit.prevent="saveUnit">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <input type="text" x-model="unitForm.name" placeholder="단원명" required class="input">
          <select x-model="unitForm.grade" required class="input">
            <option value="">학년 선택</option>
            <option value="elementary">초등학교</option>
            <option value="middle">중학교</option>
            <option value="high">고등학교</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" @click="editingUnit = null" class="btn-cancel">취소</button>
          <button type="submit" class="btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function curriculumManagement() {
  return {
    units: [],
    filteredUnits: [],
    loading: false,
    error: '',
    searchQuery: '',
    showUpload: false,
    editingUnit: null,
    unitForm: { name: '', grade: '', subject: '' },
    
    init() {
      this.loadUnits();
    },
    
    async loadUnits() {
      this.loading = true;
      try {
        const response = await fetch('/functions/v1/curriculum', {
          headers: { 'Authorization': `Bearer ${Alpine.store('auth').token}` }
        });
        const result = await response.json();
        if (result.success) {
          this.units = result.data;
          this.filteredUnits = this.units;
        }
      } catch (error) {
        this.error = '교육과정 로드 실패';
      } finally {
        this.loading = false;
      }
    },
    
    searchUnits() {
      this.filteredUnits = this.units.filter(unit => 
        unit.name.toLowerCase().includes(this.searchQuery.toLowerCase())
      );
    },
    
    openUnitEditor(unit) {
      this.editingUnit = unit || {};
      this.unitForm = unit ? { ...unit } : { name: '', grade: '', subject: '' };
    },
    
    async saveUnit() {
      try {
        const url = this.editingUnit.id ? 
          `/functions/v1/curriculum/${this.editingUnit.id}` : 
          '/functions/v1/curriculum';
        const method = this.editingUnit.id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${Alpine.store('auth').token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.unitForm)
        });
        
        if (response.ok) {
          Alpine.store('toast').show('단원이 저장되었습니다', 'success');
          this.editingUnit = null;
          this.loadUnits();
        }
      } catch (error) {
        Alpine.store('toast').show('저장에 실패했습니다', 'error');
      }
    },
    
    async handleFileUpload(file) {
      if (!file) return;
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/functions/v1/curriculum/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${Alpine.store('auth').token}` },
          body: formData
        });
        
        if (response.ok) {
          Alpine.store('toast').show('업로드가 완료되었습니다', 'success');
          this.showUpload = false;
          this.loadUnits();
        }
      } catch (error) {
        Alpine.store('toast').show('업로드에 실패했습니다', 'error');
      }
    }
  };
}
    </div>
  );
}
```

### 11.10.5 데이터 검증 로직
```javascript
// public/js/curriculum-validation.js

/**
 * @typedef {Object} CurriculumValidationResult
 * @property {boolean} success - 검증 성공 여부
 * @property {Array} data - 검증된 교육과정 단원 데이터 배열 (성공 시)
 * @property {Array} errors - 검증 오류 목록 (실패 시)
 */

/**
 * @typedef {Object} ValidationError  
 * @property {number} row - 오류가 발생한 행 번호
 * @property {string} field - 오류가 발생한 필드명
 * @property {string} message - 오류 메시지
 */

/**
 * 교육과정 Excel 데이터 검증 함수
 * @param {Array<Array>} rawData - Excel에서 읽어온 원시 데이터 배열
 * @returns {Promise<CurriculumValidationResult>} 검증 결과
 */
export async function validateCurriculumData(rawData) {
  // UTF-8 인코딩 안전성 검증
  const validateUTF8 = (text) => {
    try {
      const encoded = new TextEncoder().encode(text);
      const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
      return decoded === text;
    } catch (error) {
      return false;
    }
  };
  
  const errors = [];
  const validatedData = [];
  
  // 헤더 확인 (첫 번째 행)
  const expectedHeaders = ['교과', '학년', '학기', '단원번호', '단원명', '교육목표(성취기준)', '교육내용', '평가계획'];
  const headers = rawData[0] || [];
  
  // 헤더 UTF-8 안전성 검증
  for (let i = 0; i < headers.length; i++) {
    if (typeof headers[i] === 'string' && !validateUTF8(headers[i])) {
      errors.push({
        row: 1,
        field: `header_${i}`,
        message: `헤더 ${i + 1}번째 열의 UTF-8 인코딩이 올바르지 않습니다.`
      });
    }
  }
  
  if (!expectedHeaders.every((header, index) => headers[index] === header)) {
    errors.push({
      row: 1,
      field: 'headers',
      message: '헤더가 올바르지 않습니다. 템플릿을 다운로드하여 확인하세요.'
    });
    return { success: false, errors };
  }
  
  // 데이터 행 검증 (두 번째 행부터)
  for (let i = 1; i < rawData.length; i++) {
    const row = rawData[i] as string[];
    const rowNum = i + 1;
    
    // 필수 필드 검증
    const [subject, gradeLevel, semester, unitNumber, unitName, objectives, contents, assessment] = row;
    
    if (!subject || !['국어', '수학'].includes(subject)) {
      errors.push({ row: rowNum, field: '교과', message: '국어 또는 수학만 입력 가능합니다.' });
    }
    
    if (!gradeLevel || !['1학년', '2학년', '3학년', '4학년', '5학년', '6학년'].includes(gradeLevel)) {
      errors.push({ row: rowNum, field: '학년', message: '1학년~6학년만 입력 가능합니다.' });
    }
    
    if (!semester || !['1학기', '2학기'].includes(semester)) {
      errors.push({ row: rowNum, field: '학기', message: '1학기 또는 2학기만 입력 가능합니다.' });
    }
    
    if (!unitNumber || isNaN(parseInt(unitNumber))) {
      errors.push({ row: rowNum, field: '단원번호', message: '단원번호는 숫자여야 합니다.' });
    }
    
    if (!unitName || unitName.length < 2 || unitName.length > 200) {
      errors.push({ row: rowNum, field: '단원명', message: '단원명은 2~200자여야 합니다.' });
    }
    
    if (!objectives) {
      errors.push({ row: rowNum, field: '교육목표', message: '교육목표는 필수입니다.' });
    }
    
    if (!contents) {
      errors.push({ row: rowNum, field: '교육내용', message: '교육내용은 필수입니다.' });
    }
    
    // 오류가 없으면 데이터 추가
    if (errors.filter(e => e.row === rowNum).length === 0) {
      validatedData.push({
        subject: subject as '국어' | '수학',
        grade_level: gradeLevel as string,
        semester: semester as '1학기' | '2학기',
        unit_number: parseInt(unitNumber),
        unit_name: unitName,
        learning_objectives: objectives.split('\n').filter(obj => obj.trim()),
        learning_contents: contents.split('\n').filter(content => content.trim()),
        assessment_plan: assessment || ''
      });
    }
  }
  
  if (errors.length > 0) {
    return { success: false, errors };
  }
  
  return { success: true, data: validatedData };
}
```

### 11.10.6 개발 체크리스트

#### 백엔드 개발
- [ ] curriculum_units 테이블 생성 및 인덱스 설정
- [ ] RLS 정책 설정
- [ ] API 라우트 구현 (CRUD)
- [ ] Excel 업로드 처리 로직
- [ ] 데이터 검증 로직
- [ ] 에러 핸들링

#### 프론트엔드 개발
- [ ] 교육과정 관리 페이지 구현
- [ ] CurriculumList 컴포넌트 구현
- [ ] CurriculumUpload 컴포넌트 구현
- [ ] CurriculumUnitEditor 컴포넌트 구현
- [ ] Zustand 스토어 연동
- [ ] 로딩 상태 및 에러 처리

#### 테스트
- [ ] 단위 테스트 작성
- [ ] API 엔드포인트 테스트
- [ ] 컴포넌트 테스트
- [ ] Excel 업로드 테스트
- [ ] 권한 테스트
SELECT raw_user_meta_data FROM auth.users WHERE email = 'user@example.com';
```

---

## 11.8 AI 프롬프트 템플릿 및 품질 관리

### 11.8.1 개별화교육 계획 생성 프롬프트
```typescript
// 개별화교육 계획 생성 프롬프트 템플릿
export const EDUCATION_PLAN_PROMPT = `
당신은 특수교육 전문가입니다. 다음 정보를 바탕으로 개별화교육 계획을 작성해주세요.

**학생 정보:**
- 이름: {{studentName}}
- 나이: {{studentAge}}
- 장애 유형: {{disabilityType}}
- 학년: {{grade}}

**현행수준:**
{{currentLevels}}

**교육과정 정보:**
- 과목: {{subject}}
- 단원: {{unit}}
- 성취기준: {{standards}}
- 교육내용: {{content}}

**교사 선호도:**
- 교육철학: {{philosophy}}
- 선호 교수법: {{methods}}
- 문체: {{formality}}

다음 형식으로 작성해주세요:

1. **교육목표** (구체적이고 측정 가능한 목표)
2. **교수방법** (다양한 교수전략 3-5개)
3. **평가계획** (평가 방법 및 기준)
4. **개별화 전략** (학생 특성에 맞는 전략)

전문적이고 실용적인 내용으로 작성해주세요.
`;

// 학교장 의견서 생성 프롬프트
export const SCHOOL_OPINION_PROMPT = `
당신은 특수교육 전문가이자 학교장입니다. 다음 정보를 바탕으로 {{opinionType}} 의견서를 작성해주세요.

**학생 정보:**
{{studentInfo}}

**현행수준 평가:**
{{currentLevels}}

**교육계획 및 성과:**
{{educationPlans}}

**의견서 유형:** {{opinionType}}

다음 구성으로 작성해주세요:

1. **학생 현황 요약**
2. **교육적 요구 분석**
3. **지원 방안 및 배치 의견**
4. **기대 효과 및 성과**
5. **결론 및 추천 사항**

공식적이고 전문적인 어조로 작성해주세요.
`;

// 상담 가이드 생성 프롬프트
export const COUNSELING_GUIDE_PROMPT = `
당신은 특수교육 상담 전문가입니다. 다음 정보를 바탕으로 {{counselingType}} 상담 가이드를 작성해주세요.

**학생 정보:**
{{studentInfo}}

**현재 상황:**
{{currentSituation}}

**주요 관심사항:**
{{focusAreas}}

**상담 유형:** {{counselingType}}

다음 구성으로 작성해주세요:

1. **상담 목표 및 방향**
2. **주요 상담 포인트** (5-7개)
3. **구체적 상담 전략** (3-5개)
4. **예상 질문 및 대응 방안**
5. **후속 조치 및 지원 방안**

실용적이고 공감대를 형성할 수 있는 내용으로 작성해주세요.
`;
```

### 11.8.2 AI 응답 후처리 및 품질 검증
```typescript
// AI 응답 후처리 함수
export async function processAIResponse(
  response: string,
  type: 'education_plan' | 'opinion' | 'counseling' | 'admin_doc',
  context: any
): Promise<{
  processed: string;
  confidence: number;
  warnings: string[];
  suggestions: string[];
}> {
  const warnings: string[] = [];
  const suggestions: string[] = [];
  
  // 1. 기본 품질 검증
  const qualityScore = await validateContentQuality(response);
  
  // 2. 전문성 검증
  const professionalScore = await validateProfessionalContent(response, type);
  
  // 3. 적절성 검증
  const appropriatenessScore = await validateEducationalAppropriateness(response, context);
  
  // 4. 전체 신뢰도 계산
  const confidence = (qualityScore + professionalScore + appropriatenessScore) / 3;
  
  // 5. 경고 및 제안 사항 생성
  if (confidence < 0.8) {
    warnings.push('생성된 내용의 신뢰도가 낮습니다. 검토 후 사용하세요.');
  }
  
  if (qualityScore < 0.7) {
    suggestions.push('내용을 더 구체적이고 체계적으로 수정해보세요.');
  }
  
  return {
    processed: response,
    confidence,
    warnings,
    suggestions
  };
}

// 내용 품질 검증
async function validateContentQuality(content: string): Promise<number> {
  let score = 1.0;
  
  // 길이 검증
  if (content.length < 200) score -= 0.2;
  if (content.length > 5000) score -= 0.1;
  
  // 구조 검증
  const hasStructure = /\d+\.|\*\*|###/.test(content);
  if (!hasStructure) score -= 0.2;
  
  // 전문 용어 검증
  const specialEducationTerms = ['개별화', '특수교육', '성취기준', '평가'];
  const hasTerms = specialEducationTerms.some(term => content.includes(term));
  if (!hasTerms) score -= 0.1;
  
  return Math.max(0, score);
}

// 전문성 검증
async function validateProfessionalContent(
  content: string, 
  type: string
): Promise<number> {
  let score = 1.0;
  
  const requiredElements = {
    education_plan: ['교육목표', '교수방법', '평가'],
    opinion: ['현황', '의견', '추천'],
    counseling: ['상담', '전략', '방안'],
    admin_doc: ['요약', '분석', '결론']
  };
  
  const required = requiredElements[type as keyof typeof requiredElements] || [];
  const missingElements = required.filter(element => !content.includes(element));
  
  score -= missingElements.length * 0.2;
  
  return Math.max(0, score);
}

// 교육적 적절성 검증
async function validateEducationalAppropriateness(
  content: string,
  context: any
): Promise<number> {
  let score = 1.0;
  
  // 나이 적절성 검증
  if (context.studentAge) {
    const age = parseInt(context.studentAge);
    if (age < 7 && content.includes('고등학교')) score -= 0.3;
    if (age > 15 && content.includes('유치원')) score -= 0.3;
  }
  
  // 장애 유형 적절성 검증
  if (context.disabilityType) {
    const inappropriate = [
      { disability: '지적장애', avoid: ['고등수학', '추상적 사고'] },
      { disability: '자폐성장애', avoid: ['대집단 활동', '소음 환경'] }
    ];
    
    inappropriate.forEach(item => {
      if (context.disabilityType.includes(item.disability)) {
        item.avoid.forEach(term => {
          if (content.includes(term)) score -= 0.2;
        });
      }
    });
  }
  
  return Math.max(0, score);
}
```

### 11.8.3 AI 오류 처리 및 재시도 로직
```typescript
// AI API 오류 처리
export async function handleAIError(
  error: any,
  requestData: any,
  retryCount: number = 0
): Promise<any> {
  const maxRetries = parseInt(process.env.AI_RETRY_COUNT || '3');
  
  // 재시도 횟수 초과 시 백업 모델 사용
  if (retryCount >= maxRetries) {
    console.log('백업 모델로 전환:', process.env.AI_BACKUP_MODEL);
    return await callBackupModel(requestData);
  }
  
  // 오류 유형별 처리
  if (error.code === 'rate_limit_exceeded') {
    // 속도 제한 시 대기 후 재시도
    await new Promise(resolve => setTimeout(resolve, 2000 * (retryCount + 1)));
    return await retryAIRequest(requestData, retryCount + 1);
  }
  
  if (error.code === 'context_length_exceeded') {
    // 컨텍스트 길이 초과 시 내용 요약
    const summarizedData = await summarizeRequestData(requestData);
    return await retryAIRequest(summarizedData, retryCount + 1);
  }
  
  // 기타 오류 시 재시도
  return await retryAIRequest(requestData, retryCount + 1);
}

// 백업 모델 호출
async function callBackupModel(requestData: any): Promise<any> {
  try {
    const response = await openai.chat.completions.create({
      model: process.env.AI_BACKUP_MODEL || 'gpt-3.5-turbo',
      messages: requestData.messages,
      max_tokens: 1500, // 백업 모델은 더 짧게
      temperature: 0.5
    });
    
    return {
      content: response.choices[0].message.content,
      confidence: 0.6, // 백업 모델은 낮은 신뢰도
      isBackupModel: true
    };
  } catch (backupError) {
    throw new Error('백업 모델도 실패했습니다.');
  }
}
```
