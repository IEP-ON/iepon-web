# 🗺️ IEPON 데이터 흐름 맵 (HTML + Alpine.js + HTMX + Supabase)

> **연결 문서**: [02_데이터베이스_설계.md](./02_데이터베이스_설계.md) | [05_컴포넌트_설계.md](./05_컴포넌트_설계.md) | [06_상태_관리.md](./06_상태_관리.md) | [07_API_설계.md](./07_API_설계.md)

> **🌟 새로운 아키텍처**: 이 문서는 HTML + Alpine.js + HTMX + Supabase 스택 기반의 단순화된 데이터 흐름을 설명합니다. 복잡한 상태 관리 라이브러리 없이 브라우저 네이티브 기능과 Alpine.js의 반응형 데이터를 활용한 직관적인 데이터 흐름을 제공합니다.

---

## 13.1 단순화된 ER 다이어그램 (Supabase PostgreSQL)

```mermaid
erDiagram
  users ||--o{ students : "1:N (RLS 정책 적용)"
  students ||--o{ current_levels : "1:N"
  students ||--o{ curriculum_units : "1:N"
  students ||--o{ monthly_plans : "1:N"
  students ||--o{ monthly_evaluations : "1:N"
  curriculum_units ||--o{ monthly_plans : "1:N"
  curriculum_units ||--o{ monthly_evaluations : "1:N"
  attachments ||--|| students : "file_of (Supabase Storage)"
  
  %% 새로운 아키텍처 특징
  users {
    string id "Supabase Auth UUID"
    string email "UTF-8 안전"
    string role "teacher|admin"
  }
  
  students {
    string user_id "RLS 정책 기준"
    string name "한글 이름 UTF-8"
    string school_name "한글 학교명"
  }
```

*공통 `status` ENUM*은 모든 테이블의 `status` 컬럼에서 참조하며, Supabase RLS(Row Level Security) 정책으로 데이터 접근을 제어합니다.

---

## 13.2 HTML + Alpine.js + HTMX 데이터 흐름 패턴

### 13.2.1 학생 목록 조회 (Alpine.js + HTMX 패턴)

```mermaid
sequenceDiagram
  participant HTML as students/index.html
  participant Alpine as Alpine.js Store
  participant HTMX as HTMX 요청
  participant Supabase as Supabase Client
  participant DB as students 테이블 (RLS)
  participant Error as 에러 처리

  HTML->>Alpine: x-init="loadStudents()" [페이지 로드]
  Alpine->>Alpine: isLoading = true
  Alpine->>Supabase: supabase.from('students').select('*')
  Supabase->>DB: SELECT * FROM students WHERE user_id = auth.user().id
  
  alt 성공적인 응답
    DB-->>Supabase: rows (UTF-8 인코딩 자동 검증)
    Supabase-->>Alpine: data (한글 데이터 안전성 확인)
    Alpine->>Alpine: students = data, isLoading = false
    Alpine-->>HTML: DOM 자동 업데이트 (x-for="student in students")
    Note over HTML: 접근성: aria-live="polite"로 스크린 리더에 업데이트 알림
    Note over HTML: HTMX: hx-trigger="load" 완료 이벤트 발생
  else 네트워크 오류
    Supabase-->>Error: 연결 실패
    Error-->>Alpine: 에러 상태 설정
    Alpine->>Alpine: errorMessage = "네트워크 연결을 확인해주세요"
    Alpine-->>HTML: 에러 메시지 표시 (x-show="errorMessage")
    Note over HTML: 접근성: role="alert"로 즉시 알림
    Note over HTML: HTMX: hx-retries="3" 자동 재시도
  else 권한 오류 (RLS 정책)
    DB-->>Supabase: RLS 정책 위반 (403)
    Supabase-->>Alpine: 권한 에러
    Alpine->>Alpine: errorMessage = "접근 권한이 없습니다"
    Alpine-->>HTML: 에러 메시지 + 로그인 버튼 표시
    Note over HTML: 접근성: 포커스를 에러 메시지로 이동
  end
```

### 13.2.2 교육과정 업로드 (Alpine.js + HTMX + Supabase Storage)

```mermaid
sequenceDiagram
  participant HTML as curriculum/upload.html
  participant Alpine as Alpine.js Component
  participant HTMX as HTMX Form Submit
  participant Supabase as Supabase Edge Function
  participant Storage as Supabase Storage
  participant DB as curriculum_units 테이블
  participant Validator as 클라이언트 검증

  HTML->>Alpine: 파일 선택 (x-on:change="handleFileSelect")
  Alpine->>Validator: 파일 형식 검증 (JavaScript)
  
  alt 올바른 파일 형식 (xlsx)
    Validator-->>Alpine: 검증 통과
    Alpine->>Alpine: isUploading = true, progress = 0
    HTML->>HTMX: hx-post="/upload-curriculum" (multipart/form-data)
    Note over HTML: 접근성: aria-describedby로 업로드 진행상황 안내
    
    HTMX->>Supabase: POST Edge Function (파일 + 메타데이터)
    Supabase->>Storage: 파일 임시 저장 (UTF-8 BOM 처리)
    Supabase->>Supabase: Excel 파싱 & UTF-8 인코딩 검증
    Note over Supabase: 한글 교육과정명 인코딩 안전성 확인
    
    alt 데이터 유효성 검증 성공
      Supabase->>DB: INSERT INTO curriculum_units (한글 데이터 안전 저장)
      DB-->>Supabase: inserted rows
      Supabase-->>HTMX: { success: true, count, message: "교육과정이 성공적으로 업로드되었습니다" }
      HTMX-->>Alpine: 응답 데이터 수신
      Alpine->>Alpine: isUploading = false, successMessage = response.message
      Alpine-->>HTML: DOM 업데이트 (x-show="successMessage")
      Note over HTML: 접근성: 성공 메시지를 스크린 리더에 즉시 전달
      Note over HTML: HTMX: hx-trigger="upload:success" 커스텀 이벤트 발생
    else 데이터 유효성 오류
      Supabase-->>HTMX: { success: false, errors: ["한글 오류 메시지 목록"] }
      HTMX-->>Alpine: 에러 응답
      Alpine->>Alpine: isUploading = false, errors = response.errors
      Alpine-->>HTML: 에러 목록 표시 (x-for="error in errors")
      Note over HTML: 접근성: 에러 목록을 순차적으로 읽기 가능하게 구성
    end
  else 잘못된 파일 형식
    Validator-->>Alpine: 클라이언트 검증 실패
    Alpine->>Alpine: errorMessage = "Excel 파일(.xlsx)만 업로드 가능합니다"
    Alpine-->>HTML: 즉시 에러 메시지 표시
    Note over HTML: 접근성: 파일 형식 오류 시 올바른 형식 안내
    Note over HTML: 서버 요청 없이 클라이언트에서 즉시 처리
  end
```

### 12.2.3 월간 계획 생성

```mermaid
sequenceDiagram
  participant UI as monthly-plan-form.html
  participant Store as Alpine.js $store.plans
  participant Edge as Edge Function createMonthlyPlan
  participant DB as monthly_plans 테이블

  UI->>Edge: hx-post="/api/monthly-plans"
  Edge->>DB: INSERT (student_id, curriculum_unit_id, semester, ...)
  DB-->>Edge: row
  Edge-->>Store: Alpine.js store 업데이트
  Store->>UI: HTMX 응답으로 UI 새로고침
```

---

## 12.3 Alpine.js Store ↔ HTMX 엔드포인트 ↔ Component 매핑

| 기능 영역 | HTMX 엔드포인트 | Alpine.js Store | HTML 컴포넌트 | 접근성 고려사항 |
|----------|----------------|-----------------|---------------|----------------|
| 학생 관리 | `hx-get="/api/students"` | `$store.students` | student-list.html, student-detail.html | 학생 목록 aria-label, 검색 결과 개수 안내 |
| 교육과정 | `hx-post="/api/curriculum"` / `hx-get="/api/curriculum-units"` | `$store.curriculum` | curriculum-upload.html, curriculum-list.html | 파일 업로드 진행률 aria-live, 에러 시 포커스 이동 |
| 월간계획 | `hx-get="/api/monthly-plans"` | `$store.plans` | monthly-plan-form.html, monthly-plan-table.html | 폼 유효성 검사 결과 즉시 알림, 저장 완료 상태 표시 |
| 월간평가 | `hx-get="/api/monthly-evaluations"` | `$store.evaluations` | monthly-evaluation-form.html | 평가 점수 변경 시 스크린 리더 안내, 고대비 색상 적용 |

> **데이터 흐름 규칙**
> - HTMX 엔드포인트는 `/api/[domain]` 패턴을 따르며, Alpine.js Store는 `$store.[domain]`로 통일
> - 모든 한글 데이터는 UTF-8 인코딩 검증 후 저장 및 조회
> - 에러 메시지는 사용자 친화적인 한글로 표시

---

## 12.4 실시간 데이터 동기화 패턴

1. **로그인 시** Supabase Auth → Alpine.js 사용자 정보 Store 초기화
   - 접근성: 로그인 완료 시 "안녕하세요, [사용자명]님" 스크린 리더 안내
   - UTF-8 안전성: 사용자명 한글 처리 시 인코딩 검증
   - 에러 처리: 토큰 만료 시 자동 갱신 또는 재로그인 유도

2. **각 페이지 진입 시** HTML 컴포넌트 → Alpine.js Store → HTMX로 데이터 fetch
   - 접근성: 데이터 로딩 중 aria-live="polite"로 상태 안내
   - UTF-8 안전성: 한글 데이터 수신 시 인코딩 무결성 자동 검증
   - 에러 처리: 네트워크 오류 시 "연결 상태를 확인해주세요" 한글 메시지 표시

3. **Mutate 계열** (업로드, 생성, 수정) Edge Function 성공 시 `queryClient.invalidateQueries()` 로 캐시 동기화
{{ ... }}
   - 에러 처리: 서버 오류 시 롤백 메커니즘 및 사용자 안내
   - 타입 안전성: 뮤테이션 데이터 타입 검증 및 스키마 일치성 확인

4. **실시간 변경** (Realtime) 발생 시 Supabase `on()` 리스너가 Store 상태 직접 업데이트
   - 접근성: 실시간 변경 사항을 "새로운 정보가 업데이트되었습니다" 알림으로 전달
   - 에러 처리: 실시간 연결 끊김 시 재연결 시도 및 상태 표시
   - 성능: 불필요한 리렌더링 방지를 위한 debounce 및 메모이제이션 적용

### 추가 고려사항
- **오프라인 모드**: 네트워크 연결 없을 때 로컬 캐시 데이터 활용
- **데이터 무결성**: 동시 편집 시 충돌 해결 및 마지막 수정자 우선 정책
- **성능 모니터링**: 데이터 로딩 시간 측정 및 3초 이상 시 진행률 표시

---

## 12.5 관리자 기능 흐름

### 12.5.1 학생 승인 및 권한 부여

```mermaid
sequenceDiagram
  participant AdminUI as AdminDashboard 컴포넌트
  participant AdminStore as useAdminStore
  participant Edge as Edge Function approveStudent
  participant DB as students 테이블
  participant Policy as RLS Policy

  AdminUI->>AdminStore: approveStudent(studentId)
  AdminStore->>Edge: POST /admin/students/{id}/approve
  Edge->>Policy: 검사 (is_admin)
  Policy-->>Edge: OK
  Edge->>DB: UPDATE students SET status='active', role='student' WHERE id=?
  DB-->>Edge: row
  Edge-->>AdminStore: success
  AdminStore-->>AdminUI: 상태 갱신
```

### 12.5.2 관리자 알림 발송

```mermaid
sequenceDiagram
  participant Monitor as Sentry Monitor
  participant Edge as Edge Function notifyAdmin
  participant Email as Mail API

  Monitor-->>Edge: Error/Webhook
  Edge->>Email: POST /send {to: admin@iepon.site, template: error}
  Email-->>Edge: 202 Accepted
```

---

## 13.6 AI 컨텍스트 생성 및 응답 흐름 (Alpine.js + Supabase Edge Functions)

```mermaid
sequenceDiagram
  participant HTML as ai-assistant.html
  participant Alpine as Alpine.js Component
  participant HTMX as HTMX Request
  participant Edge as Supabase Edge Function
  participant Cache as Supabase Cache (Redis)
  participant DB as 데이터베이스 (RLS)
  participant OpenAI as OpenAI API
  participant Error as 에러 처리

  HTML->>Alpine: 질문 입력 (@submit="askAI()")
  Alpine->>Alpine: isLoading = true, response = ''
  Note over HTML: 접근성: AI 응답 생성 중 aria-live="polite" 상태 안내
  
  Alpine->>HTMX: hx-post="/ai-assistant" (질문 + studentId)
  HTMX->>Edge: POST Edge Function (buildStudentContext)
  Edge->>Cache: GET context:{studentId}
  
  alt 캐시 Hit
    Cache-->>Edge: context JSON (UTF-8 검증)
    Note over Edge: 한글 컨텍스트 데이터 무결성 확인
  else 캐시 Miss
    Edge->>DB: SELECT * FROM students WHERE id=? (RLS 적용)
    Edge->>DB: SELECT * FROM current_levels WHERE student_id=?
    
    alt 데이터 조회 성공
      DB-->>Edge: rows (한글 데이터 포함)
      Edge->>Edge: UTF-8 인코딩 검증 및 컨텍스트 구성
      Edge->>Cache: SETEX context:{studentId} (5분 TTL)
    else 데이터 조회 실패 (RLS 정책)
      DB-->>Error: 권한 없음 또는 조회 실패
      Error-->>Edge: 기본 컨텍스트 생성
      Note over Edge: 최소한의 안전한 컨텍스트 구성
    end
  end
  
  Edge->>OpenAI: prompt + studentContext (한글 질문)
  
  alt AI 응답 성공
    OpenAI-->>Edge: 답변 + 신뢰도(score)
    Note over Edge: 신뢰도 점수가 80% 이상일 때만 답변 반환
    Edge-->>HTMX: { success: true, answer: "한글 답변", confidence: score }
    HTMX-->>Alpine: 응답 데이터 수신
    Alpine->>Alpine: isLoading = false, response = answer
    Alpine-->>HTML: DOM 업데이트 (x-text="response")
    Note over HTML: 접근성: 답변 생성 완료를 스크린 리더에 알림
  else AI 응답 실패
    OpenAI-->>Error: API 오류 (타임아웃, 할당량 초과 등)
    Error-->>Edge: 백업 응답 생성
    Edge-->>HTMX: { success: false, error: "AI 서비스 오류", fallback: true }
    HTMX-->>Alpine: 에러 응답
    Alpine->>Alpine: isLoading = false, errorMessage = "죄송합니다. 현재 AI 서비스에 문제가 있습니다. 잠시 후 다시 시도해주세요."
    Alpine-->>HTML: 에러 메시지 표시 (x-show="errorMessage")
    Note over HTML: 접근성: 에러 상황을 명확히 안내
  else 신뢰도 낮음
    OpenAI-->>Edge: 답변 + 신뢰도(score < 80%)
    Edge-->>HTMX: { success: true, answer: "답변", confidence: score, warning: true }
    HTMX-->>Alpine: 낮은 신뢰도 응답
    Alpine->>Alpine: isLoading = false, response = answer, showWarning = true
    Alpine-->>HTML: 답변 + 경고 메시지 표시
    Note over HTML: "생성된 답변의 신뢰도가 낮습니다. 전문가에게 문의하시기 바랍니다."
    Note over HTML: 접근성: 신뢰도 경고를 우선적으로 전달
  end
```

> **AI 응답 실패 시 백업 플랜**: Supabase Edge Function에서 Cache fallback → DB 재조회 후 로컬 요약 알고리즘 실행.

---

## 13.7 HTML + Alpine.js + HTMX + Supabase 스택 검토 항목

### 🔒 보안 및 권한 관리 (Supabase RLS 기반)
- **RLS 정책 일관성**: [10_보안_권한.md]의 RLS 정책과 Edge Function 내부 권한 검증 일치성 확인
- **멀티테넌트 확장**: `user_id` 기반 RLS 정책을 모든 테이블에 일관성 있게 적용
- **교육 데이터 보호**: Supabase 암호화 저장 + 접근 로그 자동 관리 (audit 테이블)
- **클라이언트 보안**: Alpine.js에서 민감한 데이터 노출 방지 (API 키, 토큰 등)

### ♿ 접근성 및 사용성 (WCAG 2.1 AA 준수)
- **스크린 리더 호환성**: 모든 Alpine.js 데이터 바인딩에서 aria-live, role 속성 적용
- **키보드 네비게이션**: HTMX 로딩 중 포커스 관리 및 Alpine.js x-trap 활용
- **고대비 모드**: CSS 변수 기반 색상 시스템으로 4.5:1 이상 대비율 확보
- **에러 메시지 접근성**: Alpine.js x-show와 role="alert" 조합으로 즉시 알림
- **진행률 표시**: HTMX hx-indicator와 Alpine.js 진행률 바 연동

### 🌐 UTF-8 인코딩 안전성 (한글 데이터 처리)
- **클라이언트 검증**: Alpine.js에서 한글 입력 시 UTF-8 인코딩 검증 함수 적용
- **파일 업로드**: Supabase Storage 업로드 시 UTF-8 BOM 자동 처리
- **Edge Function**: 한글 데이터 처리 시 인코딩 무결성 자동 검증
- **데이터베이스**: PostgreSQL UTF-8 설정 및 한글 텍스트 저장 전 검증
- **HTMX 응답**: 서버 응답 헤더에 charset=utf-8 명시적 설정

### ⚡ 성능 및 확장성 (정적 HTML 기반)
- **브라우저 캐싱**: HTML/CSS/JS 파일 브라우저 캐시 최적화 (Cache-Control 헤더)
- **Supabase 캐싱**: Edge Function 응답 캐싱 및 Redis TTL 최적화
- **Alpine.js 성능**: 대용량 데이터 렌더링 시 x-for 가상화 적용
- **HTMX 최적화**: hx-boost 활용한 페이지 전환 성능 개선
- **이미지 최적화**: Supabase Storage 이미지 변환 API 활용

### 🛠️ 에러 처리 및 복구 (브라우저 네이티브)
- **네트워크 오류**: HTMX hx-retries와 Alpine.js 에러 상태 관리 연동
- **AI 서비스 장애**: Edge Function 백업 응답 + 클라이언트 fallback 메시지
- **데이터 동기화**: Alpine.js store 기반 낙관적 업데이트 + 실패 시 롤백
- **오프라인 지원**: Service Worker 기반 기본 캐싱 (선택사항)
- **에러 로깅**: Supabase Edge Function 에러 자동 로깅 시스템

### 🧪 테스트 및 모니터링 (브라우저 기반)
- **브라우저 테스트**: 개발자 도구 콘솔 기반 Alpine.js 컴포넌트 테스트
- **HTMX 테스트**: 네트워크 탭에서 요청/응답 검증
- **접근성 테스트**: axe-core 브라우저 확장 프로그램 활용
- **성능 모니터링**: Lighthouse 점수 기반 성능 측정
- **Supabase 모니터링**: 내장 대시보드 활용한 DB/Edge Function 모니터링

### 🔄 데이터 흐름 최적화
- **실시간 업데이트**: Supabase Realtime + Alpine.js 반응형 데이터 연동
- **배치 처리**: 대용량 데이터 처리 시 HTMX 청크 업로드 패턴
- **캐시 무효화**: Alpine.js store 기반 스마트 캐시 무효화 전략
- **상태 동기화**: 여러 탭 간 Alpine.js 상태 동기화 (BroadcastChannel API)

---

> **📋 참고**: 이 문서는 HTML + Alpine.js + HTMX + Supabase 스택 기반 개발자 온보딩용 **Single Source of Truth** 데이터 흐름 맵입니다. 변경 시 연결된 모든 문서([02_데이터베이스_설계.md](./02_데이터베이스_설계.md), [05_컴포넌트_설계.md](./05_컴포넌트_설계.md), [06_상태_관리.md](./06_상태_관리.md), [07_API_설계.md](./07_API_설계.md))를 함께 업데이트해야 일관성이 유지됩니다.
