# ğŸ’³ IEPON ê²°ì œ Â· ì´ìš©ê¶Œ ì„¤ê³„ (Toss Payments MCP)

> **HTML + Alpine.js + HTMX + Supabase + í† ìŠ¤í˜ì´ë¨¼ì¸  MCP ì„œë²„ ê¸°ë°˜ AI ì—ì´ì „íŠ¸ ê²°ì œ ì‹œìŠ¤í…œ**

> **ì—°ê²° ë¬¸ì„œ**: [05_ì»´í¬ë„ŒíŠ¸_ì„¤ê³„.md](./05_ì»´í¬ë„ŒíŠ¸_ì„¤ê³„.md) | [06_ìƒíƒœ_ê´€ë¦¬.md](./06_ìƒíƒœ_ê´€ë¦¬.md) | [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md) | [08_í™˜ê²½_ì„¤ì •.md](./08_í™˜ê²½_ì„¤ì •.md) | [10_ë³´ì•ˆ_ê¶Œí•œ.md](./10_ë³´ì•ˆ_ê¶Œí•œ.md)

---

## 14.1 ë‹¨ìˆœí™”ëœ ê²°ì œ ì‹œë‚˜ë¦¬ì˜¤

### ğŸ¯ MCP ê¸°ë°˜ AI ì—ì´ì „íŠ¸ ê²°ì œ í”Œë¡œìš°
1. **ê²°ì œ í˜ì´ì§€ ì ‘ê·¼**: ì‚¬ìš©ìê°€ `payment.html` í˜ì´ì§€ì—ì„œ í”„ë¦¬ë¯¸ì—„ í”Œëœì„ í™•ì¸í•©ë‹ˆë‹¤.
2. **MCP ì„œë²„ ì´ˆê¸°í™”**: í† ìŠ¤í˜ì´ë¨¼ì¸  MCP ì„œë²„ê°€ ìë™ìœ¼ë¡œ ë¡œë“œë˜ë©° AI ì—ì´ì „íŠ¸ê°€ ê²°ì œ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
3. **ê²°ì œ ìš”ì²­**: ì‚¬ìš©ìê°€ "ê²°ì œí•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ AI ì—ì´ì „íŠ¸ê°€ MCP `createPayment` íˆ´ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
4. **ê²°ì œì°½ í‘œì‹œ**: MCP ì„œë²„ë¥¼ í†µí•´ í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œì°½ì´ í‘œì‹œë˜ë©° AI ì—ì´ì „íŠ¸ê°€ ê²°ì œ ì§„í–‰ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
5. **ê²°ì œ ì™„ë£Œ ì²˜ë¦¬**: ê²°ì œ ì™„ë£Œ ì‹œ MCP `confirmPayment` íˆ´ì´ ìë™ í˜¸ì¶œë˜ì–´ `payment-success.html`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë©ë‹ˆë‹¤.
6. **êµ¬ë… í™œì„±í™”**: AI ì—ì´ì „íŠ¸ê°€ MCP `updateSubscription` íˆ´ì„ í†µí•´ Supabase êµ¬ë…ì„ ìë™ í™œì„±í™”í•©ë‹ˆë‹¤.
7. **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**: MCP ì„œë²„ê°€ êµ¬ë… ìƒíƒœ ë³€ê²½ì„ ê°ì§€í•˜ì—¬ Alpine.js ìŠ¤í† ì–´ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜í•©ë‹ˆë‹¤.

### ğŸ”„ MCP ê¸°ë°˜ ì‹¤ì‹œê°„ ìƒíƒœ ë™ê¸°í™”
- **ê²°ì œ ì§„í–‰ ìƒíƒœ**: MCP ì„œë²„ê°€ ê²°ì œ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ì í•˜ì—¬ `hx-indicator`ì— ë°˜ì˜
- **ì—ëŸ¬ ì²˜ë¦¬**: MCP `handlePaymentError` íˆ´ì´ ì—ëŸ¬ë¥¼ ê°ì§€í•˜ì—¬ í•œê¸€ ì—ëŸ¬ ë©”ì‹œì§€ ìë™ í‘œì‹œ
- **ì„±ê³µ ì²˜ë¦¬**: MCP `onPaymentSuccess` ì´ë²¤íŠ¸ê°€ êµ¬ë… ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ê°±ì‹ í•˜ì—¬ UIì— ë°˜ì˜
- **AI ëª¨ë‹ˆí„°ë§**: AI ì—ì´ì „íŠ¸ê°€ ê²°ì œ ì „ ê³¼ì •ì„ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì´ìƒ ìƒí™© ìë™ ê°ì§€ ë° ëŒ€ì‘

---

## 14.2 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (MCP ê¸°ë°˜ ì‹¤ì‹œê°„ ìµœì í™”)

### ğŸ“Š êµ¬ë… ê´€ë¦¬ í…Œì´ë¸” (`subscriptions`)

| í•„ë“œëª… | ë°ì´í„° íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… | MCP ì—°ë™ |
|--------|-------------|----------|------|---------|
| `id` | `uuid` | PRIMARY KEY | êµ¬ë… ê³ ìœ  ì‹ë³„ì | MCP íˆ´ ì°¸ì¡° í‚¤ |
| `user_id` | `uuid` | FK â†’ `auth.users.id` | êµ¬ë… ì‚¬ìš©ì | AI ì—ì´ì „íŠ¸ ì‚¬ìš©ì ì‹ë³„ |
| `plan_type` | `varchar(20)` | DEFAULT 'premium' | êµ¬ë… í”Œëœ íƒ€ì… | MCP í”Œëœ ê´€ë¦¬ íˆ´ ì—°ë™ |
| `subscription_status` | `subscription_status_enum` | DEFAULT 'pending' | êµ¬ë… ìƒíƒœ | MCP ìƒíƒœ ì—…ë°ì´íŠ¸ íˆ´ |
| `payment_started_at` | `timestamptz` | NOT NULL | ê²°ì œ ì‹œì‘ ì‹œê° | MCP createPayment í˜¸ì¶œ ì‹œì  |
| `payment_completed_at` | `timestamptz` | NULL | ê²°ì œ ì™„ë£Œ ì‹œê° | MCP confirmPayment ì™„ë£Œ ì‹œì  |
| `subscription_expires_at` | `timestamptz` | NOT NULL | êµ¬ë… ë§Œë£Œ ì˜ˆì •ì¼ | MCP ë§Œë£Œ ì•Œë¦¼ íˆ´ íŠ¸ë¦¬ê±° |
| `toss_payment_key` | `varchar(200)` | UNIQUE, ì•”í˜¸í™” | Toss ê²°ì œ ê³ ìœ í‚¤ | MCP ê²°ì œ ê²€ì¦ íˆ´ íŒŒë¼ë¯¸í„° |
| `mcp_transaction_id` | `varchar(100)` | UNIQUE | MCP ê±°ë˜ ì¶”ì  ID | AI ì—ì´ì „íŠ¸ íŠ¸ëœì­ì…˜ ì¶”ì  |
| `payment_amount` | `numeric(10,2)` | CHECK > 0 | ê²°ì œ ê¸ˆì•¡ (ì›) | MCP ê¸ˆì•¡ ê²€ì¦ íˆ´ |
| `korean_display_name` | `varchar(100)` | UTF-8 ì•ˆì „ | í•œê¸€ í”Œëœëª… | MCP UI í‘œì‹œ íˆ´ |
| `mcp_error_log` | `jsonb` | NULL | MCP ì—ëŸ¬ ë¡œê·¸ | AI ì—ì´ì „íŠ¸ ë””ë²„ê¹…ìš© |
| `created_at` | `timestamptz` | DEFAULT NOW() | ë ˆì½”ë“œ ìƒì„±ì¼ | MCP ìƒì„± ì‹œì  ì¶”ì  |
| `updated_at` | `timestamptz` | DEFAULT NOW() | ìµœì¢… ìˆ˜ì •ì¼ | MCP ë³€ê²½ ì¶”ì  |

### ğŸ”’ RLS (Row Level Security) ì •ì±…

```sql
-- ì‚¬ìš©ìë³„ êµ¬ë… ì •ë³´ ì ‘ê·¼ ì œí•œ
CREATE POLICY "ì‚¬ìš©ìëŠ” ë³¸ì¸ êµ¬ë…ë§Œ ì¡°íšŒ ê°€ëŠ¥" ON subscriptions
  FOR SELECT USING (user_id = auth.uid());

-- ê´€ë¦¬ìëŠ” ëª¨ë“  êµ¬ë… ì •ë³´ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "ê´€ë¦¬ì ì „ì²´ êµ¬ë… ì¡°íšŒ" ON subscriptions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );
```

### ğŸ“ˆ MCP ê¸°ë°˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™”

```sql
-- MCP ì„œë²„ ì—°ë™ êµ¬ë… ìƒíƒœ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì•Œë¦¼ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION notify_mcp_subscription_change()
RETURNS TRIGGER AS $$
BEGIN
  -- MCP ì„œë²„ ì´ë²¤íŠ¸ ë°œì†¡ (AI ì—ì´ì „íŠ¸ ì•Œë¦¼)
  PERFORM pg_notify(
    'mcp_subscription_updates',
    json_build_object(
      'user_id', NEW.user_id,
      'status', NEW.subscription_status,
      'plan', NEW.plan_type,
      'mcp_transaction_id', NEW.mcp_transaction_id,
      'payment_key', NEW.toss_payment_key,
      'korean_message', CASE 
        WHEN NEW.subscription_status = 'active' THEN 'í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!'
        WHEN NEW.subscription_status = 'expired' THEN 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
        WHEN NEW.subscription_status = 'cancelled' THEN 'êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'
        ELSE 'êµ¬ë… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'
      END,
      'mcp_event_type', 'subscription_state_change',
      'ai_agent_notify', true
    )::text
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER mcp_subscription_change_trigger
  AFTER INSERT OR UPDATE ON subscriptions
  FOR EACH ROW EXECUTE FUNCTION notify_mcp_subscription_change();
```

### ğŸŒ UTF-8 ì¸ì½”ë”© ì•ˆì „ì„± ë³´ì¥

```sql
-- í•œê¸€ í…ìŠ¤íŠ¸ í•„ë“œ UTF-8 ê²€ì¦ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION validate_korean_text(text_input TEXT)
RETURNS BOOLEAN AS $$
BEGIN
  -- UTF-8 ì¸ì½”ë”© ê²€ì¦ ë° í•œê¸€ ë¬¸ì í™•ì¸
  RETURN text_input IS NOT NULL 
    AND length(text_input) > 0 
    AND text_input ~ '[ê°€-í£]+';
EXCEPTION
  WHEN OTHERS THEN
    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- í•œê¸€ í”Œëœëª… ê²€ì¦ ì œì•½ì¡°ê±´
ALTER TABLE subscriptions 
ADD CONSTRAINT check_korean_display_name 
CHECK (validate_korean_text(korean_display_name));
```

---

## 14.3 MCP ì„œë²„ í™˜ê²½ ì„¤ì • (í† ìŠ¤í˜ì´ë¨¼ì¸  MCP ì—°ë™)

### ğŸ”§ MCP ì„œë²„ í™˜ê²½ ì„¤ì • êµ¬ì„±

| ì‚¬ìš© ì˜ì—­ | ì„¤ì • í•­ëª© | ê°’/ê²½ë¡œ | ì„¤ëª… | ë³´ì•ˆ ìˆ˜ì¤€ |
|----------|------------|------------|------|----------|
| **MCP ì„œë²„ ì„¤ì •** | `mcp_config.json` | `~/.codeium/windsurf/mcp_config.json` | í† ìŠ¤í˜ì´ë¨¼ì¸  MCP ì„œë²„ ì„¤ì • | ë¡œì»¬ ì„¤ì • |
| **MCP ì„œë²„ íŒ¨í‚¤ì§€** | `@tosspayments/integration-guide-mcp` | `npx -y @tosspayments/integration-guide-mcp@latest` | í† ìŠ¤í˜ì´ë¨¼ì¸  ê³µì‹ MCP ì„œë²„ | ê³µì‹ íŒ¨í‚¤ì§€ |
| **AI ì—ì´ì „íŠ¸ ì‹ë³„** | `MCP_CLIENT_ID` | `iepon-payment-agent` | AI ì—ì´ì „íŠ¸ ê³ ìœ  ì‹ë³„ì | ë‚´ë¶€ ID |
| **Supabase MCP ì—°ë™** | `@supabasejs/mcp` | `npx -y @supabasejs/mcp@latest` | Supabase MCP ì„œë²„ | ê³µì‹ íŒ¨í‚¤ì§€ |
| **ë³´ì•ˆ ì„¤ì •** | `MCP_SECURITY_MODE` | `strict` | MCP í†µì‹  ë³´ì•ˆ ëª¨ë“œ | ë†’ìŒ |

### ğŸ“ MCP ì„œë²„ ì„¤ì • íŒŒì¼ êµ¬ì¡°

```json
// ~/.codeium/windsurf/mcp_config.json
{
  "mcpServers": {
    "supabase-mcp-server": {
      "command": "npx",
      "args": ["-y", "@supabasejs/mcp@latest"]
    },
    "tosspayments-integration-guide": {
      "command": "npx",
      "args": ["-y", "@tosspayments/integration-guide-mcp@latest"]
    }
  },
  "security": {
    "mode": "strict",
    "allowedDomains": ["iepon.kr", "localhost"],
    "encryption": true
  }
}
```

### ğŸŒ HTML í˜ì´ì§€ì—ì„œì˜ MCP ì„œë²„ ì—°ë™

```html
<!-- payment.html -->
<script>
  // Alpine.js + MCP ì„œë²„ ê¸€ë¡œë²Œ ì„¤ì •
  window.IEPON_MCP_CONFIG = {
    mcpServerName: 'tosspayments-integration-guide',
    aiAgentId: 'iepon-payment-agent',
    paymentTools: {
      createPayment: 'createPayment',
      confirmPayment: 'confirmPayment', 
      cancelPayment: 'cancelPayment',
      getPaymentStatus: 'getPaymentStatus'
    },
    supabaseMcpName: 'supabase-mcp-server',
    paymentAmount: 9900,
    planName: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ',
    mcpSecurity: {
      encryption: true,
      validateOrigin: true
    }
  };
  
  // MCP ì„œë²„ ìƒíƒœ í™•ì¸
  window.checkMcpServerStatus = async () => {
    try {
      const status = await window.mcp?.getServerStatus?.('tosspayments-integration-guide');
      console.log('ğŸ’³ í† ìŠ¤í˜ì´ë¨¼ì¸  MCP ì„œë²„ ìƒíƒœ:', status);
      return status?.connected === true;
    } catch (error) {
      console.error('âŒ MCP ì„œë²„ ì—°ê²° ì˜¤ë¥˜:', error);
      return false;
    }
  };
</script>
```

---

## 14.4 MCP ê¸°ë°˜ ê²°ì œ íˆ´ ì—°ë™

### ğŸš€ MCP íˆ´ ê¸°ë°˜ ê²°ì œ ì‹œìŠ¤í…œ êµ¬ì¡°

> **ì—°ë™ ë¬¸ì„œ**: [07_API_ì„¤ê³„.md](./07_API_ì„¤ê³„.md)ì˜ MCP íˆ´ ê¸°ë°˜ ì„¤ê³„ì™€ ì—°ê³„í•˜ì—¬ AI ì—ì´ì „íŠ¸ ê²°ì œ íŠ¹í™”

| MCP íˆ´ ì´ë¦„ | íŒŒë¼ë¯¸í„° | AI ì—ì´ì „íŠ¸ ë°©ì‹ | Alpine.js ì—°ë™ | ì„¤ëª… |
|-----------------|-----------|-------------------|-----------------|------|
| `createPayment` | `{amount, orderId, customerInfo}` | ìë™ í˜¸ì¶œ | `x-on:click` | ê²°ì œ ìš”ì²­ ìƒì„± ë° ì£¼ë¬¸ ID ë°œê¸‰ |
| `confirmPayment` | `{paymentKey, orderId, amount}` | ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° | `x-on:load` | ê²°ì œ ì™„ë£Œ í›„ êµ¬ë… í™œì„±í™” ì²˜ë¦¬ |
| `getPaymentStatus` | `{paymentKey}` | ì‹¤ì‹œê°„ í´ë§ | `x-interval` | ê²°ì œ ì§„í–‰ ìƒíƒœ ì‹¤ì‹œê°„ ì¡°íšŒ |
| `handleWebhook` | `{webhookData, signature}` | ìë™ ì²˜ë¦¬ | ë‚´ë¶€ ì´ë²¤íŠ¸ | Toss ê²°ì œ ìƒíƒœ ë³€ê²½ ì•Œë¦¼ |
| `cancelPayment` | `{paymentKey, cancelReason}` | ì‚¬ìš©ì ìš”ì²­ | `x-on:click` | ê²°ì œ ì·¨ì†Œ ë° í™˜ë¶ˆ ì²˜ë¦¬ |
| `validatePayment` | `{paymentData}` | ì‚¬ì „ ê²€ì¦ | ì‹¤ì‹œê°„ ê²€ì¦ | ê²°ì œ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ |

### ğŸ”„ MCP ì„œë²„ ì‹¤ì‹œê°„ í†µì‹  íŒ¨í„´

```html
<!-- MCP ê¸°ë°˜ ê²°ì œ ì§„í–‰ ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ -->
<div id="payment-status" 
     x-data="mcpPaymentStatus()"
     x-init="startPaymentTracking()"
     x-interval:2000="checkPaymentStatus()">
  <span class="payment-status" x-text="paymentStatusMessage">ê²°ì œ ì§€ì¤‘...</span>
  
  <!-- MCP ì—ëŸ¬ í‘œì‹œ -->
  <div x-show="mcpError" class="error-message" x-text="mcpErrorMessage"></div>
</div>

<!-- MCP ê¸°ë°˜ ê²°ì œ ì™„ë£Œ í›„ ìë™ êµ¬ë… í™œì„±í™” -->
<div x-data="mcpPaymentConfirm()" 
     x-init="confirmPaymentOnLoad()" 
     x-on:payment-success="handlePaymentSuccess($event)">
</div>

<!-- ì—ëŸ¬ ì²˜ë¦¬ ë° í•œê¸€ ë©”ì‹œì§€ í‘œì‹œ -->
<div id="error-message" 
     hx-on::error="showKoreanErrorMessage(event.detail.xhr.responseJSON.message)">
</div>
```

### 14.4.1 MCP `confirmPayment` íˆ´ ì˜ˆì‹œ

```javascript
// MCP ê¸°ë°˜ ê²°ì œ ìŠ¹ì¸ ë° êµ¬ë… ìƒì„± ì²˜ë¦¬ í•¨ìˆ˜
// AI ì—ì´ì „íŠ¸ê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œ
const mcpConfirmPayment = async (paymentData) => {
  try {
    // MCP ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
    const mcpStatus = await window.checkMcpServerStatus();
    if (!mcpStatus) {
      throw new Error('MCP ì„œë²„ ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    // UTF-8 ì¸ì½”ë”© ì•ˆì „ì„±ì„ ìœ„í•œ ë°ì´í„° ê²€ì¦
    const { paymentKey, orderId, amount, mcpTransactionId } = paymentData;
    
    // MCP íˆ´ì„ í†µí•œ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦
    const validationResult = await window.mcp.callTool(
      'tosspayments-integration-guide',
      'validatePayment',
      { paymentKey, orderId, amount }
    );
    
    if (!validationResult.success) {
      throw new Error(`ê²°ì œ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨: ${validationResult.message}`);
    }
    
    // MCP íˆ´ì„ í†µí•œ í† ìŠ¤ ê²°ì œ ìƒíƒœ í™•ì¸
    const paymentStatus = await window.mcp.callTool(
      'tosspayments-integration-guide',
      'getPaymentStatus',
      { paymentKey }
    );
    
    if (!paymentStatus.success) {
      throw new Error(`ê²°ì œ ìƒíƒˆ í™•ì¸ ì‹¤íŒ¨: ${paymentStatus.error}`);
    }
    
    // ê²°ì œ ìƒíƒœ ë° ì£¼ë¬¸ ì •ë³´ ê²€ì¦
    if (paymentStatus.data.status === 'DONE' && 
        paymentStatus.data.orderId === orderId && 
        paymentStatus.data.totalAmount === amount) {
      
      // Supabase MCPë¥¼ í†µí•œ êµ¬ë… ì •ë³´ ìƒì„±
      const subscriptionResult = await window.mcp.callTool(
        'supabase-mcp-server',
        'create_subscription',
        {
          user_id: window.AuthGuard.getCurrentUser().id,
          payment_key: paymentKey,
          order_id: orderId,
          amount: amount,
          plan_type: 'premium',
          mcp_transaction_id: mcpTransactionId,
          korean_display_name: 'í”„ë¦¬ë¯¸ì—„ êµ¬ë…'
        }
      );
      
      if (!subscriptionResult.success) {
        throw new Error(`êµ¬ë… ìƒì„± ì‹¤íŒ¨: ${subscriptionResult.error}`);
      }
      
      // MCPë¥¼ í†µí•œ ì‚¬ìš©ì ê³„ì • í”Œëœ ì—…ë°ì´íŠ¸
      await window.mcp.callTool(
        'supabase-mcp-server',
        'update_user_plan',
        {
          user_id: window.AuthGuard.getCurrentUser().id,
          plan: 'premium',
          subscription_id: subscriptionResult.data.id
        }
      );
      
    } else {
      throw new Error('ê²°ì œ ì •ë³´ ë¶ˆì¼ì¹˜: ê²°ì œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    
    // ì„±ê³µ ì‘ë‹µ ë°˜í™˜
    return {
      success: true,
      data: {
        subscription_id: subscriptionResult.data.id,
        plan: 'premium',
        status: 'active',
        korean_message: 'í”„ë¦¬ë¯¸ì—„ êµ¬ë…ì´ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!',
        expires_at: subscriptionResult.data.subscription_expires_at,
        mcp_transaction_id: mcpTransactionId
      }
    };
    
  } catch (error) {
    // MCP ì—ëŸ¬ ë¡œê¹… ë° ì²˜ë¦¬
    console.error('ğŸ’³ MCP ê²°ì œ ìŠ¹ì¸ ì˜¤ë¥˜:', {
      error: error.message,
      mcpServer: 'tosspayments-integration-guide',
      timestamp: new Date().toISOString(),
      paymentKey: paymentData.paymentKey,
      mcpTransactionId: paymentData.mcpTransactionId
    });
    
    // MCP ì—ëŸ¬ ë¡œê·¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    await window.mcp.callTool(
      'supabase-mcp-server',
      'log_mcp_error',
      {
        error_type: 'payment_confirmation_failed',
        error_message: error.message,
        mcp_transaction_id: paymentData.mcpTransactionId,
        user_id: window.AuthGuard.getCurrentUser()?.id
      }
    );
    
    return {
      success: false,
      error: 'MCP ê²°ì œ ìŠ¹ì¸ ì¤‘ ì˜¤ë¦˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
      korean_message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.'
    };
  }
};

// MCP ê¸°ë°˜ Alpine.js ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

/**
 * MCP ì„œë²„ë¥¼ í†µí•œ êµ¬ë… ë§Œë£Œì¼ ê³„ì‚°
 * @param {number} months - ê°œì›” ìˆ˜
 * @param {string} mcpTransactionId - MCP ê±°ë˜ ID
 * @returns {Promise<string>} ISO í˜•ì‹ ë‚ ì§œ
 */
async function calculateExpirationDateMCP(months = 1, mcpTransactionId) {
  try {
    const result = await window.mcp.callTool(
      'tosspayments-integration-guide',
      'calculateExpirationDate',
      { months, transaction_id: mcpTransactionId }
    );
    
    return result.success ? result.data.expiration_date : new Date(Date.now() + months * 30 * 24 * 60 * 60 * 1000).toISOString();
  } catch (error) {
    console.error('ğŸ“… MCP ë§Œë£Œì¼ ê³„ì‚° ì˜¤ë¥˜:', error);
    // í´ë°±: ë¡œì»¬ ê³„ì‚°
    const now = new Date();
    const expirationDate = new Date(now.setMonth(now.getMonth() + months));
    return expirationDate.toISOString();
  }
}

/**
 * MCP ê¸°ë°˜ ì•ˆì „í•œ í”Œëœ ì´ë¦„ ìƒì„±
 * @param {string} planType - í”Œëœ íƒ€ì…
 * @param {string} locale - ì–¸ì–´ ë¡œì¼€ì¼
 * @returns {Promise<string>} í”Œëœ í‘œì‹œëª…
 */
async function generatePlanNameMCP(planType = 'premium', locale = 'ko') {
  try {
    const result = await window.mcp.callTool(
      'tosspayments-integration-guide',
      'getPlanDisplayName',
      { plan_type: planType, locale }
    );
    
    if (result.success) {
      return result.data.display_name;
    }
  } catch (error) {
    console.error('ğŸ·ï¸ MCP í”Œëœëª… ìƒì„± ì˜¤ë¥˜:', error);
  }
  
  // í´ë°±: ë¡œì»¬ í”Œëœëª… ë§¤í•‘
  const planNames = {
    'premium': 'Premium Plan',
    'basic': 'Basic Plan',
    'enterprise': 'Enterprise Plan'
  };
  return planNames[planType] || 'Premium Plan';
}

/**
 * Validate payment amount
 * @param {number} amount - Payment amount
 * @returns {boolean} Validity status
 */
function validatePaymentAmount(amount) {
  const validAmounts = [9900, 99000, 990000];
  return validAmounts.includes(parseInt(amount));
}
```

---

## 14.5 Alpine.js ê²°ì œ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸

### 14.5.1 HTML + Alpine.js ê²°ì œ ìœ„ì ¯ êµ¬í˜„

```html
<!-- payment.html - ë¹„ì „ê³µì ì¹œí™”ì  ê²°ì œ í˜ì´ì§€ -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IEPON Premium êµ¬ë… - ê²°ì œ</title>
  
  <!-- Alpine.js ë° HTMX CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  
  <!-- Toss Payments SDK -->
  <script src="https://js.tosspayments.com/v1/payment-widget"></script>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5" x-data="paymentWidget()">
        
  <!-- Payment Plan Display -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white text-center">
          <h2 class="h4 mb-0">IEPON Premium Plan</h2>
        </div>
        <div class="card-body text-center">
          <div class="mb-3">
            <span class="h2 text-primary">9,900 KRW</span>
            <small class="text-muted d-block">/ month</small>
          </div>
          
          <ul class="list-unstyled mb-4">
            <li class="mb-2">âœ… Unlimited student management</li>
            <li class="mb-2">ğŸ¤– AI-powered education plans</li>
            <li class="mb-2">ğŸ“Š Detailed assessment reports</li>
            <li class="mb-2">ğŸ¯ Priority customer support</li>
          </ul>
          
          <button type="button" 
                  class="btn btn-primary btn-lg w-100"
                  :disabled="paymentStatus === 'loading'"
                  @click="initiatePayment()">
            <span x-show="paymentStatus !== 'loading'">Subscribe to Premium</span>
            <span x-show="paymentStatus === 'loading'">Processing...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function paymentWidget() {
  return {
    paymentStatus: 'idle',
    tossPayments: null,
    errorMessage: '',
    
    async init() {
      try {
        this.tossPayments = await TossPayments('test_ck_D5GePWvyJnrK0W0k');
      } catch (error) {
        this.showError('Payment system initialization failed.');
      }
    },
    
    async initiatePayment() {
      if (!this.tossPayments) {
        this.showError('Payment system not ready.');
        return;
      }
      
      this.paymentStatus = 'loading';
      
      try {
        const orderData = {
          orderId: this.generateOrderId(),
          amount: 9900,
          orderName: 'IEPON Premium Plan',
          customerName: 'User',
          successUrl: `${window.location.origin}/payment-success.html`,
          failUrl: `${window.location.origin}/payment-fail.html`
        };
        
        await this.tossPayments.requestPayment('CARD', orderData);
        
      } catch (error) {
        this.showError(error.message || 'Payment request failed.');
      }
    },
    
    generateOrderId() {
      const timestamp = Date.now();
      const randomStr = Math.random().toString(36).substring(2, 8);
      return `IEPON_${timestamp}_${randomStr}`;
    },
    
    showError(message) {
      this.paymentStatus = 'error';
      this.errorMessage = message;
      setTimeout(() => {
        this.paymentStatus = 'idle';
      }, 3000);
    } finally {
      setIsLoading(false);
    }
  };
```

### 14.5.2 ê²°ì œ ì„±ê³µ í˜ì´ì§€ (payment-success.html)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Payment Success - IEPON</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5" x-data="paymentSuccess()">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card text-center">
        <div class="card-body p-5">
          <div class="mb-4">
            <div class="text-success" style="font-size: 4rem;">ğŸ‰</div>
          </div>
          <h2 class="card-title text-success mb-3">Payment Completed!</h2>
          <p class="card-text mb-4">Your premium subscription has been activated.</p>
          <a href="/dashboard.html" class="btn btn-primary btn-lg">Go to Dashboard</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function paymentSuccess() {
  return {
    init() {
      // Auto-confirm payment on page load
      const urlParams = new URLSearchParams(window.location.search);
      const paymentKey = urlParams.get('paymentKey');
      const orderId = urlParams.get('orderId');
      const amount = urlParams.get('amount');
      
      if (paymentKey && orderId && amount) {
        this.confirmPayment(paymentKey, orderId, amount);
      }
    },
    
    async confirmPayment(paymentKey, orderId, amount) {
      try {
        const response = await fetch('/api/payments/confirm', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`
          },
          body: JSON.stringify({ paymentKey, orderId, amount })
        });
        
        if (response.ok) {
          console.log('Subscription activated successfully');
        }
      } catch (error) {
        console.error('Payment confirmation error:', error);
      }
    }
  };
}
</script>

</body>
</html>
```
```

### 14.5.3 ê²°ì œ ì„±ê³µ ì²˜ë¦¬ (payment-success.html)

- URL: `/payment/success?paymentKey=...&orderId=...&amount=...`
- HTMX ìš”ì²­: `hx-post="/api/payments/confirm"` â†’ Edge Function í˜¸ì¶œ
- ì„±ê³µ ì‹œ Alpine.js `$store.subscription` ì—…ë°ì´íŠ¸, í† ìŠ¤íŠ¸ ì•Œë¦¼ 'í”„ë¦¬ë¯¸ì—„ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!'

---

## 14.6 Alpine.js êµ¬ë… ìƒíƒœ ê´€ë¦¬

```javascript
// Alpine.js Store ì •ì˜
Alpine.store('subscription', {
  plan: 'free', // 'free' | 'premium'
  status: 'active', // 'active' | 'expired' | 'pending' | 'error'
  
  async fetchSubscription() {
    // HTMXë¡œ êµ¬ë… ì •ë³´ ì¡°íšŒ
  }
});
```

- êµ¬ë… ì •ë³´ëŠ” Supabase Realtimeê³¼ Alpine.js Storeë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™”.

---

## 13.7 ë°ì´í„° íë¦„ (13_ë°ì´í„°_íë¦„_ë§µ.md ì—°ë™)

```mermaid
sequenceDiagram
  participant UI as PaymentPage
  participant Toss as Toss Widget
  participant Browser as Redirect
  participant Edge as /payments/confirm
  participant DB as subscriptions

  UI->>Toss: requestPayment()
  Toss-->>Browser: redirect successUrl?paymentKey..
  Browser->>UI: PaymentSuccessPage ë¡œë“œ
  UI->>Edge: POST paymentKey, orderId
  Edge->>Toss: GET /payments/{paymentKey}
  Toss-->>Edge: status=DONE
  Edge->>DB: INSERT subscription (active)
  DB-->>Edge: row
  Edge-->>UI: success
  UI-->>Store: invalidate subscription
```

---

## 13.8 ë³´ì•ˆ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤

### 13.8.1 ë³´ì•ˆ ì›ì¹™

#### ğŸ” API í‚¤ ë° ì‹œí¬ë¦¿ ê´€ë¦¬
- **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ**: `TOSS_CLIENT_KEY`ë§Œ ë…¸ì¶œ (ê³µê°œí‚¤)
- **ì„œë²„ ì‚¬ì´ë“œ**: `TOSS_SECRET_KEY`, `TOSS_SECURITY_KEY`ëŠ” Edge Functionsì—ì„œë§Œ ì‚¬ìš©
- **í™˜ê²½ ë³€ìˆ˜**: Supabase Dashboardì˜ Edge Functions ì„¤ì •ì—ì„œ ê´€ë¦¬

#### ğŸ›¡ï¸ Supabase Row-Level Security (RLS)
```sql
-- subscriptions í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ êµ¬ë…ë§Œ ì¡°íšŒ ê°€ëŠ¥" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ êµ¬ë…ë§Œ ìˆ˜ì • ê°€ëŠ¥" ON subscriptions
  FOR UPDATE USING (auth.uid() = user_id);
```

### 13.8.2 ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìµœì†Œí™”

#### ê²°ì œ ì‹œ ê°œì¸ì •ë³´ ìµœì†Œ ìˆ˜ì§‘
```javascript
// ê²°ì œ ìš”ì²­ ì‹œ ìµœì†Œí•œì˜ ì •ë³´ë§Œ ì „ì†¡
const paymentData = {
  amount: planPrice,
  orderId: generateOrderId(),
  orderName: `IEPON ${planName} êµ¬ë…`,
  customerName: user.name || 'ìµëª…',
  customerEmail: user.email,
  // ë¶ˆí•„ìš”í•œ ê°œì¸ì •ë³´ëŠ” ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ
};
```

#### UTF-8 ì¸ì½”ë”© ì•ˆì „ì„±
```javascript
// í•œê¸€ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì¸ì½”ë”© ê²€ì¦
function validateUTF8Payment(paymentData) {
  const textFields = ['customerName', 'orderName'];
  
  for (const field of textFields) {
    if (paymentData[field]) {
      try {
        const encoded = new TextEncoder().encode(paymentData[field]);
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(encoded);
        
        if (decoded !== paymentData[field]) {
          throw new Error(`${field} í•„ë“œì˜ UTF-8 ì¸ì½”ë”©ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        }
      } catch (error) {
        console.error('UTF-8 ê²€ì¦ ì‹¤íŒ¨:', error);
        throw new Error('ê²°ì œ ì •ë³´ì˜ ë¬¸ì ì¸ì½”ë”©ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
      }
    }
  }
  
  return true;
}
```

### 13.8.3 ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### âœ… ë³´ì•ˆ ìš”êµ¬ì‚¬í•­
- [x] API í‚¤ ì„œë²„ì‚¬ì´ë“œ ë³´ê´€
- [x] HTTPS í†µì‹  ê°•ì œ
- [x] RLS ì •ì±… ì ìš©
- [x] ê°œì¸ì •ë³´ ìµœì†Œ ìˆ˜ì§‘
- [x] UTF-8 ì¸ì½”ë”© ì•ˆì „ì„±
- [x] ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€í™”

#### âœ… ì ‘ê·¼ì„± ìš”êµ¬ì‚¬í•­ (WCAG 2.1 AA)
- [x] í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›
- [x] ìŠ¤í¬ë¦° ë¦¬ë” í˜¸í™˜ì„± (aria-label)
- [x] ê³ ëŒ€ë¹„ ìƒ‰ìƒ ì‚¬ìš©
- [x] 48px ì´ìƒ í„°ì¹˜ ì˜ì—­
- [x] ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€

---

## 13.9 ì¶”ê°€ êµ¬í˜„ í•„ìš” ì‚¬í•­

### 13.9.1 Webhook Edge Function
- Toss Payments Webhook ìˆ˜ì‹  ë° ê²€ì¦
- êµ¬ë… ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë° HMAC ì„œëª… ê²€ì¦

### 13.9.2 ê²°ì œ ì·¨ì†Œ/í™˜ë¶ˆ ì²˜ë¦¬
- ì‚¬ìš©ì ìš”ì²­ ê²°ì œ ì·¨ì†Œ í”Œë¡œìš°
- ê´€ë¦¬ì í™˜ë¶ˆ ì²˜ë¦¬ ì‹œìŠ¤í…œ
- ë¶€ë¶„ í™˜ë¶ˆ ë° í”„ë¡œë ˆì´ì…˜ ê³„ì‚°

### 13.9.3 ë¶€ê°€ ê¸°ëŠ¥
- VAT ê³„ì‚° ë° ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
- í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ ì—°ë™
- êµ¬ë… ê°±ì‹  ì•Œë¦¼ ì‹œìŠ¤í…œ
- ê²°ì œ ì‹¤íŒ¨ ì¬ì‹œë„ ë¡œì§

---

> **âœ… 14_ê²°ì œ_ì„¤ê³„.md ë¬¸ì„œ ë³€í™˜ ì™„ë£Œ**
> 
> **ë³€í™˜ ë‚´ìš© ìš”ì•½:**
> - TypeScript/React â†’ HTML + Alpine.js + HTMX êµ¬ì¡° ì „í™˜
> - Toss Payments SDK í†µí•© ë°©ì‹ ë‹¨ìˆœí™”
> - Supabase Edge Functions ê¸°ë°˜ ê²°ì œ í™•ì¸ ë¡œì§
> - UTF-8 ì¸ì½”ë”© ì•ˆì „ì„± ë° í•œê¸€ ì§€ì› ê°•í™”
> - ì ‘ê·¼ì„± ê³ ë ¤ ê²°ì œ í˜ì´ì§€ êµ¬í˜„
> - ì‹¤ì‹œê°„ êµ¬ë… ìƒíƒœ ê´€ë¦¬ (Alpine.js Store)
> - ë³´ì•ˆ ì •ì±… ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸
> 
> **ë‹¤ìŒ ë‹¨ê³„:** ì „ì²´ ë¬¸ì„œ ìµœì¢… ì ê²€ ë° ê²€ì¦
